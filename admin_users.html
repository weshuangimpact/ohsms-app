async function directActivateUser() {
            const staffId = document.getElementById('target-staff-id').value;
            const email = document.getElementById('invite-email').value.trim();
            const password = document.getElementById('invite-password').value; 
            const role = document.getElementById('invite-system-role').value;
            const name = document.getElementById('invite-name').innerText;
            
            if(!email || !password) return alert('請輸入 Email 和密碼');

            const btn = document.querySelector('#inviteModal .btn-theme');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 執行 Step 1: 建立帳號...';

            let newUserId = null;
            try {
                // Step 1: 建立 Auth 帳號
                const dummyStorage = { getItem: (key) => null, setItem: (key, value) => {}, removeItem: (key) => {} };
                const tempClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                    auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false, storage: dummyStorage }
                });
                
                const { data: authData, error: authError } = await tempClient.auth.signUp({
                    email: email, password: password, options: { data: { full_name: name, role: role } }
                });

                if (authError) {
                    if (authError.message.includes("already registered")) {
                        throw new Error("❌ 失敗：此 Email 已存在於 Auth 系統中！請至 Supabase 後台處理。");
                    }
                    throw new Error("Auth 建立失敗: " + authError.message);
                }

                if (!authData.user || !authData.user.id) {
                    throw new Error("Auth 請求完成但未回傳 ID。");
                }

                newUserId = authData.user.id;
                btn.innerHTML = '<i class="fas fa-sync fa-spin"></i> 執行 Step 2: 寫入資料...';

                // Step 2: 寫入 Profiles
                const { error: profileError } = await supabaseClient.from('profiles').upsert({
                    id: newUserId, email: email, full_name: name, role: role, status: 'active', is_active: true,
                    created_by: (await supabaseClient.auth.getUser()).data.user?.id 
                });
                if (profileError) throw new Error("Profile 寫入失敗: " + profileError.message);

                // Step 3: 更新 Medical Staff
                const { error: staffError } = await supabaseClient.from('medical_staff').update({ 
                    user_id: newUserId, system_role: role, is_active: true, email: email
                }).eq('id', staffId);
                if (staffError) throw new Error("名單綁定失敗: " + staffError.message);

                // ==========================================
                // Step 4: [新增] 呼叫 Edge Function 寄送通知信
                // ==========================================
                btn.innerHTML = '<i class="fas fa-envelope fa-spin"></i> 執行 Step 3: 寄送通知信...';
                
                // 這裡就是您原本缺少的關鍵程式碼
                const { error: mailError } = await supabaseClient.functions.invoke('send-email', {
                    body: { 
                        type: 'activate', 
                        email: email, 
                        data: { 
                            name: name, 
                            email: email,
                            password: password // 這裡會傳送前端輸入框的值 (12345678)
                        } 
                    }
                });

                if (mailError) {
                    console.error("信件 API 呼叫失敗", mailError);
                    alert(`✅ 帳號開通成功！\n(但通知信寄送失敗，請手動通知使用者)\n\nUser ID: ${newUserId}`);
                } else {
                    alert(`✅ 帳號開通完整成功！通知信已寄出。\n\nUser ID: ${newUserId}`);
                }

                bootstrap.Modal.getInstance(document.getElementById('inviteModal')).hide();
                loadUsers();

            } catch (err) {
                console.error(err);
                alert(err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
