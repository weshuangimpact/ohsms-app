<script>
async function sendInvite() {
    // 1. 取得畫面上的參數
    const staffId = document.getElementById('target-staff-id').value;
    const email = document.getElementById('invite-email').value;
    const role = document.getElementById('invite-system-role').value;
    const name = document.getElementById('invite-name').innerText;

    // 2. 設定按鈕 Loading 狀態
    const btn = document.querySelector('#inviteModal .btn-info');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 發送中...';

    try {
        // 定義您的 Anon Key (用於 Header)
        const ANON_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';

        // 3. 呼叫 Edge Function
        const response = await fetch(
            'https://yhehfucgemxnfrdvpdhw.supabase.co/functions/v1/invite-user',
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': ANON_KEY,
                    'Authorization': `Bearer ${ANON_KEY}` // [修正] 補上標準驗證頭
                },
                body: JSON.stringify({
                    email: email,
                    role: role,
                    full_name: name,
                    staff_id: staffId // 把 ID 傳給後端，後端會負責綁定
                })
            }
        );

        const result = await response.json();

        // 4. 錯誤處理
        if (!response.ok) {
            throw new Error(result.error || 'Edge Function 執行失敗');
        }

        // [修正] 移除原本在此處的前端 update 動作
        // 因為 Edge Function 已經在後端完成資料庫寫入，前端不需要再寫一次

        // 5. 成功提示與畫面重整
        alert(`✅ 邀請信已發送至 ${email}`);
        bootstrap.Modal.getInstance(document.getElementById('inviteModal')).hide();
        loadUsers(); // 重新載入列表

    } catch (err) {
        console.error(err);
        alert('❌ 發送失敗: ' + err.message);
    } finally {
        // 6. 恢復按鈕狀態
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}
</script>
