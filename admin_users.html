<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>帳號權限管理 | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #0d6efd;
            --bg-color: #f8f9fa;
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Noto Sans TC', sans-serif;
            color: #333;
        }

        /* 導覽列 */
        .navbar {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand { font-weight: 700; letter-spacing: 1px; }

        /* 卡片與表格 */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            background: #fff;
        }

        .table thead th {
            background-color: #f1f5f9;
            color: #475569;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            border-bottom: 2px solid #e2e8f0;
            padding: 12px 16px;
        }

        .table tbody td {
            vertical-align: middle;
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
        }

        .table-hover tbody tr:hover { background-color: #f8fafc; }

        /* 狀態標籤 */
        .badge-status {
            padding: 6px 10px;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
        }
        .badge-status i { margin-right: 4px; font-size: 0.7rem; }
        
        .bg-status-created { background-color: #e2e8f0; color: #475569; } /* 帳號已建立 */
        .bg-status-invited { background-color: #dbeafe; color: #1e40af; } /* 邀請已發送 */
        .bg-status-active { background-color: #dcfce7; color: #166534; }  /* 已註冊 */
        .bg-status-resigned-active { background-color: #ffedd5; color: #9a3412; } /* 離職未註銷 */
        .bg-status-revoked { background-color: #fee2e2; color: #991b1b; } /* 帳號已註銷 */

        /* 角色標籤 */
        .role-badge { font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; }
        .role-admin { background-color: #e0f2fe; color: #0369a1; }
        .role-medical { background-color: #f0fdf4; color: #15803d; }
        .role-general { background-color: #f3f4f6; color: #374151; }

        /* 頭像 */
        .avatar-circle {
            width: 36px; height: 36px;
            background-color: #e9ecef; color: #495057;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.9rem; margin-right: 10px;
        }

        /* 連結與按鈕 */
        .name-link { text-decoration: none; color: #333; font-weight: 500; cursor: pointer; transition: color 0.2s; }
        .name-link:hover { color: var(--primary-color); }
        
        .btn-action {
            width: 32px; height: 32px; padding: 0;
            display: inline-flex; align-items: center; justify-content: center;
            border-radius: 6px; transition: all 0.2s;
        }
        .btn-edit { background-color: #eff6ff; color: #3b82f6; border: none; }
        .btn-edit:hover { background-color: #3b82f6; color: white; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="dashboard.html"><i class="fas fa-shield-alt me-2"></i>OHSMS</a>
            <div class="d-flex align-items-center">
                <span class="text-light me-3 small"><i class="fas fa-user-circle me-1"></i> 管理員</span>
                <a href="dashboard.html" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left me-1"></i> 返回儀表板</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold mb-1">帳號權限管理</h4>
                <p class="text-muted mb-0 small">發送註冊邀請與管理權限 (資料來源: 醫護人員主檔)</p>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body p-3">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" class="form-control border-start-0 ps-0" id="searchInput" placeholder="搜尋姓名、Email 或 職稱...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="roleFilter">
                            <option value="">所有角色</option>
                            <option value="admin">系統管理員 (Admin)</option>
                            <option value="medical">醫護人員 (Medical)</option>
                            <option value="general">文管人員 (General)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="statusFilter">
                            <option value="">所有狀態</option>
                            <option value="created">帳號已建立</option>
                            <option value="invited">註冊邀請已發送</option>
                            <option value="active">已註冊</option>
                            <option value="resigned">已離職</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th width="25%">使用者姓名</th>
                            <th width="15%">職稱</th>
                            <th width="25%">Email (登入帳號)</th>
                            <th width="10%">系統角色</th>
                            <th width="15%">帳號狀態</th>
                            <th width="10%" class="text-end">操作</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr><td colspan="6" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>
                    </tbody>
                </table>
            </div>
            <div class="card-footer bg-white border-top-0 py-3">
                <div class="d-flex justify-content-between align-items-center small text-muted">
                    <span id="recordCount">顯示 0 筆資料</span>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold" id="modalTitle">使用者資料與權限</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" id="edit-id">
                    
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">姓名</label>
                        <input type="text" class="form-control bg-light" id="edit-name" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">Email (登入帳號)</label>
                        <div class="input-group">
                            <input type="email" class="form-control bg-light" id="edit-email" readonly>
                            <button class="btn btn-primary" type="button" id="btn-invite" onclick="confirmInvite()">
                                <i class="fas fa-envelope me-1"></i> 發送邀請
                            </button>
                        </div>
                        <div class="form-text mt-2" id="invite-hint"></div>
                    </div>

                    <hr class="my-4">

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">系統角色</label>
                            <select class="form-select" id="edit-role">
                                <option value="general">文管人員 (General)</option>
                                <option value="medical">醫護人員 (Medical)</option>
                                <option value="admin">系統管理員 (Admin)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">在職狀態</label>
                            <select class="form-select" id="edit-status">
                                <option value="active">在職中</option>
                                <option value="resigned">已離職</option>
                            </select>
                        </div>
                    </div>

                    <div id="resignation-alert" class="alert alert-danger mt-3 d-none small">
                        <i class="fas fa-exclamation-triangle me-2"></i> 
                        <strong>注意：</strong>設定為「已離職」並不會自動刪除 Auth 登入帳號。<br>
                        請確認是否已註銷其權限 (目前尚未實作自動註銷)。
                    </div>

                </div>
                <div class="modal-footer border-top-0 px-4 pb-4">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary px-4 fw-bold" onclick="saveUserChanges()">儲存設定</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh'; 
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allUsers = [];
        const userModal = new bootstrap.Modal(document.getElementById('userModal'));

        document.addEventListener('DOMContentLoaded', () => {
            fetchUsers();
            
            document.getElementById('searchInput').addEventListener('input', filterUsers);
            document.getElementById('roleFilter').addEventListener('change', filterUsers);
            document.getElementById('statusFilter').addEventListener('change', filterUsers);
            
            document.getElementById('edit-status').addEventListener('change', function() {
                const alertBox = document.getElementById('resignation-alert');
                if (this.value === 'resigned') alertBox.classList.remove('d-none');
                else alertBox.classList.add('d-none');
            });
        });

        // 1. 取得資料 (醫護人員主檔)
        async function fetchUsers() {
            try {
                const { data, error } = await supabase
                    .from('medical_staff')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                
                allUsers = data || [];
                renderTable(allUsers);
                
            } catch (err) {
                console.error('Error:', err);
                document.getElementById('usersTableBody').innerHTML = `
                    <tr><td colspan="6" class="text-center text-danger">讀取失敗: ${err.message}</td></tr>`;
            }
        }

        // 2. 渲染表格與狀態判斷
        function renderTable(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">查無資料</td></tr>';
                return;
            }

            users.forEach(user => {
                const statusObj = determineStatus(user);
                const roleBadge = getRoleBadge(user.role);
                const avatarChar = (user.name || '?').charAt(0);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar-circle">${avatarChar}</div>
                            <div>
                                <a href="#" class="name-link" onclick="openEditModal('${user.id}')">${user.name}</a>
                            </div>
                        </div>
                    </td>
                    <td><small class="text-muted">${user.job_title || '-'}</small></td>
                    <td>${user.email}</td>
                    <td>${roleBadge}</td>
                    <td><span class="badge-status ${statusObj.class}">${statusObj.icon} ${statusObj.text}</span></td>
                    <td class="text-end">
                        <button class="btn btn-action btn-edit" onclick="openEditModal('${user.id}')">
                            <i class="fas fa-cog"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('recordCount').textContent = `顯示 ${users.length} 筆資料`;
        }

        // 核心：狀態判斷邏輯
        function determineStatus(user) {
            if (user.status === 'resigned') {
                if (user.auth_user_id) {
                    return { text: '已離職未註銷', class: 'bg-status-resigned-active', icon: '<i class="fas fa-user-times"></i>' };
                } else {
                    return { text: '帳號已註銷', class: 'bg-status-revoked', icon: '<i class="fas fa-ban"></i>' };
                }
            }
            if (user.auth_user_id) {
                return { text: '已註冊', class: 'bg-status-active', icon: '<i class="fas fa-check-circle"></i>' };
            }
            if (user.invite_sent_at) {
                return { text: '註冊邀請已發送', class: 'bg-status-invited', icon: '<i class="fas fa-paper-plane"></i>' };
            }
            return { text: '帳號已建立', class: 'bg-status-created', icon: '<i class="fas fa-file-alt"></i>' };
        }

        function getRoleBadge(role) {
            const map = {
                'admin': { text: '系統管理員', class: 'role-admin' },
                'medical': { text: '醫護人員', class: 'role-medical' },
                'general': { text: '文管人員', class: 'role-general' }
            };
            const r = map[role] || { text: role || 'Unknown', class: 'bg-light text-dark' };
            return `<span class="badge role-badge ${r.class}">${r.text}</span>`;
        }

        // 3. 開啟 Modal
        function openEditModal(id) {
            const user = allUsers.find(u => u.id == id);
            if (!user) return;

            document.getElementById('edit-id').value = user.id;
            document.getElementById('edit-name').value = user.name;
            document.getElementById('edit-email').value = user.email;
            document.getElementById('edit-role').value = user.role || 'general';
            document.getElementById('edit-status').value = user.status || 'active';

            const btnInvite = document.getElementById('btn-invite');
            const hint = document.getElementById('invite-hint');
            
            // 重置按鈕狀態
            btnInvite.classList.remove('btn-success', 'btn-outline-primary', 'btn-primary', 'btn-outline-secondary');
            
            if (user.status === 'resigned') {
                 btnInvite.disabled = true;
                 btnInvite.classList.add('btn-outline-secondary');
                 btnInvite.innerHTML = '<i class="fas fa-ban me-1"></i> 無法邀請 (已離職)';
                 hint.textContent = '已離職人員無法發送邀請。';
            }
            else if (user.auth_user_id) {
                btnInvite.disabled = true;
                btnInvite.classList.add('btn-success');
                btnInvite.innerHTML = '<i class="fas fa-check me-1"></i> 已完成註冊';
                hint.textContent = '此使用者已啟用帳號，無需重複邀請。';
            } else if (user.invite_sent_at) {
                btnInvite.disabled = false;
                btnInvite.classList.add('btn-outline-primary');
                btnInvite.innerHTML = '<i class="fas fa-redo me-1"></i> 重發邀請';
                const date = new Date(user.invite_sent_at).toLocaleDateString();
                hint.textContent = `上次邀請已於 ${date} 發送，若對方未收到可再次發送。`;
            } else {
                btnInvite.disabled = false;
                btnInvite.classList.add('btn-primary');
                btnInvite.innerHTML = '<i class="fas fa-paper-plane me-1"></i> 發送註冊邀請';
                hint.textContent = '系統將發送邀請信，使用者需點擊連結設定密碼。';
            }

            document.getElementById('edit-status').dispatchEvent(new Event('change'));
            userModal.show();
        }

        // 4. 發送註冊邀請 (呼叫 Edge Function)
        async function confirmInvite() {
            const email = document.getElementById('edit-email').value;
            const name = document.getElementById('edit-name').value;
            const userId = document.getElementById('edit-id').value;

            if(!confirm(`確定要發送註冊邀請信給 ${name} (${email}) 嗎？\n\n系統將寄送 "Invite User" 郵件，引導使用者設定密碼。`)) {
                return;
            }

            const btn = document.getElementById('btn-invite');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>發送中...';

            try {
                // -----------------------------------------------------------
                // [正式串接] 呼叫 Edge Function: invite-user
                // -----------------------------------------------------------
                // Supabase SDK 會自動將請求發送至: 
                // https://yhehfucgemxnfrdvpdhw.supabase.co/functions/v1/invite-user
                
                const { data, error } = await supabase.functions.invoke('invite-user', {
                    body: { 
                        email: email,
                        // 設定重導向網址，讓使用者設完密碼後回到登入頁或首頁
                        // 假設您有製作一個 update_password.html 或者直接導回首頁
                        redirectTo: window.location.origin + '/login.html' 
                    } 
                });

                if (error) throw error;

                // -----------------------------------------------------------
                // [狀態同步] 邀請發送成功後，更新資料庫 invite_sent_at
                // -----------------------------------------------------------
                // 這樣列表上的狀態燈號才會變成藍色 (邀請已發送)
                const { error: dbError } = await supabase.from('medical_staff').update({
                    invite_sent_at: new Date().toISOString()
                }).eq('id', userId);

                if (dbError) throw dbError;

                alert('✅ 邀請信已發送！使用者將收到 Email。');
                
                fetchUsers(); // 重新整理列表
                userModal.hide();

            } catch (err) {
                console.error(err);
                alert('❌ 發送失敗: ' + (err.message || '未知錯誤'));
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // 5. 儲存變更 (角色/狀態)
        async function saveUserChanges() {
            const id = document.getElementById('edit-id').value;
            const newRole = document.getElementById('edit-role').value;
            const newStatus = document.getElementById('edit-status').value;
            
            try {
                const { error } = await supabase
                    .from('medical_staff')
                    .update({ role: newRole, status: newStatus })
                    .eq('id', id);

                if (error) throw error;

                alert('✅ 設定已儲存');
                userModal.hide();
                fetchUsers(); 
            } catch (err) {
                alert('❌ 儲存失敗: ' + err.message);
            }
        }

        // 前端過濾
        function filterUsers() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const role = document.getElementById('roleFilter').value;
            const status = document.getElementById('statusFilter').value;

            const filtered = allUsers.filter(user => {
                const matchTerm = (user.name || '').toLowerCase().includes(term) || 
                                  (user.email || '').toLowerCase().includes(term);
                const matchRole = role ? user.role === role : true;
                
                const statusObj = determineStatus(user);
                let matchStatus = true;
                if (status === 'created') matchStatus = statusObj.text === '帳號已建立';
                if (status === 'invited') matchStatus = statusObj.text === '註冊邀請已發送';
                if (status === 'active') matchStatus = statusObj.text === '已註冊';
                if (status === 'resigned') matchStatus = user.status === 'resigned';

                return matchTerm && matchRole && matchStatus;
            });
            renderTable(filtered);
        }
    </script>
</body>
</html>
