<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>帳號權限管理 | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { --primary-bg: #f4f6f9; }
        body {
            background-color: var(--primary-bg);
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            display: none; /* Auth Guard */
        }
        
        .section-title { border-left: 5px solid #0dcaf0; padding-left: 15px; margin-bottom: 20px; }
        
        .card-header { background-color: white; border-bottom: 1px solid #f0f0f0; }
        .table th { font-weight: 600; color: #555; background-color: #f8f9fa; }
        .table td { vertical-align: middle; }
        
        /* 狀態燈號 */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .bg-active { background-color: #198754; }
        .bg-inactive { background-color: #dc3545; }

        .role-badge { font-size: 0.85em; padding: 5px 10px; border-radius: 20px; }
        /* 系統權限顏色 */
        .sys-admin { background-color: #dc3545; color: white; } /* 紅 */
        .sys-medical { background-color: #0d6efd; color: white; } /* 藍 */
        .sys-general { background-color: #6c757d; color: white; } /* 灰 */
        
        /* 註冊狀態 Badge */
        .reg-pending { background-color: #ffc107; color: #000; } /* 黃: 未註冊 */
        .reg-done { background-color: #198754; color: white; }   /* 綠: 已註冊 */
        .reg-void { background-color: #343a40; color: white; }   /* 黑: 已註銷 */
    </style>

    <script>
        // 簡單的權限檢查
        document.addEventListener('DOMContentLoaded', function() {
            const role = sessionStorage.getItem('currentUserRole');
            if (role !== 'admin') {
                alert('權限不足：此頁面僅限系統管理員存取。');
                window.location.href = 'dashboard.html';
                return;
            }
            document.body.style.display = 'block';
        });
    </script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3 mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold" href="dashboard.html"><i class="fas fa-shield-alt me-2"></i>OHSMS</a>
            <div class="d-flex align-items-center">
                <span class="text-light small me-3">系統管理後台</span>
                <a href="dashboard.html" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left me-1"></i> 返回儀表板</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4 pb-5">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="section-title mb-0">
                <h4 class="fw-bold text-dark mb-0">帳號權限管理 (Account Mgmt)</h4>
                <small class="text-muted">發送系統邀請與管理醫護人員登入權限</small>
            </div>
            </div>

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4 bg-light rounded">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold small text-muted">關鍵字搜尋</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" id="search-input" class="form-control border-start-0" placeholder="輸入姓名、Email...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold small text-muted">系統權限篩選</label>
                        <select class="form-select" id="filter-role">
                            <option value="">全部權限</option>
                            <option value="admin">Admin (管理員)</option>
                            <option value="medical">Medical (醫護/顧問)</option>
                            <option value="general">General (文管)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold small text-muted">註冊狀態篩選</label>
                        <select class="form-select" id="filter-reg-status">
                            <option value="">全部狀態</option>
                            <option value="pending">帳戶已建立 / 未註冊</option>
                            <option value="done">帳戶已註冊</option>
                            <option value="void">帳戶已註銷</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-primary w-100 fw-bold" onclick="loadUsers()">
                            <i class="fas fa-filter me-1"></i> 套用篩選
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-users me-2"></i>醫護人員名單 (Medical Staff)</h6>
                <span class="badge bg-light text-dark border" id="total-count">共 0 筆</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead>
                            <tr>
                                <th class="ps-4">任職狀態</th>
                                <th>姓名</th>
                                <th>系統權限 (System Role)</th>
                                <th>Email (登入帳號)</th>
                                <th>系統綁定</th>
                                <th>帳戶註冊狀態</th>
                                <th class="text-end pe-4">管理動作</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <tr><td colspan="7" class="text-center py-5 text-muted">資料載入中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="inviteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold"><i class="fas fa-paper-plane me-2"></i>發送註冊邀請</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="target-staff-id">
                    
                    <div class="alert alert-info border-0 bg-info bg-opacity-10 small">
                        <i class="fas fa-info-circle me-1"></i> 系統將寄送邀請信至該信箱，使用者點擊後即可設定密碼並完成註冊。
                    </div>

                    <div class="mb-3 text-center">
                        <h5 class="fw-bold mb-0" id="invite-name">User Name</h5>
                        <p class="text-muted small mb-0">準備發送邀請...</p>
                    </div>
                    <hr>

                    <form id="inviteForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">收件 Email</label>
                            <input type="email" class="form-control bg-light" id="invite-email" readonly>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">分配系統權限 (System Role)</label>
                            <select class="form-select" id="invite-system-role">
                                <option value="medical">medical (一般醫護/顧問)</option>
                                <option value="admin">admin (系統管理員)</option>
                                <option value="general">general (一般文管)</option>
                            </select>
                            <div class="form-text text-muted">請確認權限等級，Admin 擁有所有資料存取權。</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary fw-bold" onclick="sendInvite()">
                        <i class="fas fa-envelope-open-text me-1"></i> 發送邀請連結
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let mergedData = []; 

        document.addEventListener('DOMContentLoaded', () => {
            loadUsers(); 
        });

        // ==========================================
        // 1. 讀取與整合資料 (Logic 2)
        // ==========================================
        async function loadUsers() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5"><div class="spinner-border text-primary"></div><div class="mt-2 text-muted">讀取醫護名單與註冊狀態中...</div></td></tr>';

            try {
                // 平行撈取兩張表
                const [staffRes, profileRes] = await Promise.all([
                    supabaseClient.from('medical_staff').select('*').order('created_at', { ascending: false }),
                    supabaseClient.from('profiles').select('*')
                ]);

                if (staffRes.error) throw staffRes.error;
                if (profileRes.error) throw profileRes.error;

                const staffList = staffRes.data;
                const profileList = profileRes.data;

                // 整合邏輯：以 medical_staff 為主，Mapping profiles
                mergedData = staffList.map(staff => {
                    // 找對應的 profile
                    const linkedProfile = profileList.find(p => p.id === staff.user_id);
                    
                    // 判斷註冊狀態 (Logic 2)
                    let regStatus = 'pending'; // 預設：帳戶已建立未註冊
                    if (staff.user_id) {
                        if (linkedProfile) {
                            // profiles 存在，通常視為已註冊
                            // 這裡假設 profiles.status != 'active' 為已註銷，若無 status 欄位則預設 active
                            if (linkedProfile.status === 'inactive' || linkedProfile.status === 'suspended') {
                                regStatus = 'void'; // 帳戶已註銷
                            } else {
                                regStatus = 'done'; // 帳戶已註冊
                            }
                        } else {
                            // 有 ID 但沒 Profile (理論上不該發生，除非資料不同步)
                            regStatus = 'pending'; 
                        }
                    } else {
                        regStatus = 'pending'; // user_id 是空 -> 未註冊
                    }

                    return {
                        ...staff,
                        regStatus: regStatus,
                        profileData: linkedProfile
                    };
                });

                applyFilter(); // 執行篩選與渲染

            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-5 text-danger">讀取失敗: ${err.message}</td></tr>`;
            }
        }

        function applyFilter() {
            const keyword = document.getElementById('search-input').value.toLowerCase();
            const roleFilter = document.getElementById('filter-role').value;
            const regFilter = document.getElementById('filter-reg-status').value;

            const filtered = mergedData.filter(item => {
                // 關鍵字
                const matchKeyword = !keyword || 
                    (item.name && item.name.toLowerCase().includes(keyword)) ||
                    (item.email && item.email.toLowerCase().includes(keyword));

                // 系統權限 (Logic 1: 改撈 system_role)
                const sysRole = item.system_role || 'medical';
                const matchRole = !roleFilter || sysRole === roleFilter;

                // 註冊狀態
                const matchReg = !regFilter || item.regStatus === regFilter;

                return matchKeyword && matchRole && matchReg;
            });

            renderTable(filtered);
        }

        function renderTable(data) {
            const tbody = document.getElementById('userTableBody');
            document.getElementById('total-count').innerText = `共 ${data.length} 筆`;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted">查無符合條件的資料</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => {
                // 任職狀態
                const isWorking = item.is_active; 
                const workStatusHtml = isWorking 
                    ? `<span class="text-success fw-bold"><span class="status-dot bg-active"></span>在職中</span>`
                    : `<span class="text-secondary"><span class="status-dot bg-inactive"></span>已離職</span>`;

                // 系統權限 (Logic 1)
                const sysRole = item.system_role || 'medical';
                let roleBadgeClass = 'sys-medical';
                if(sysRole === 'admin') roleBadgeClass = 'sys-admin';
                if(sysRole === 'general') roleBadgeClass = 'sys-general';
                const roleBadge = `<span class="role-badge ${roleBadgeClass}">${sysRole}</span>`;

                // 系統綁定
                const isBound = item.user_id ? '<span class="text-primary"><i class="fas fa-link me-1"></i>已綁定</span>' : '<span class="text-muted"><i class="fas fa-unlink me-1"></i>未綁定</span>';

                // 註冊狀態 (Logic 2)
                let regBadge = '';
                if (item.regStatus === 'pending') regBadge = `<span class="badge reg-pending">未註冊</span>`;
                else if (item.regStatus === 'done') regBadge = `<span class="badge reg-done">已註冊</span>`;
                else if (item.regStatus === 'void') regBadge = `<span class="badge reg-void">已註銷</span>`;

                // JSON for modal
                const itemJson = encodeURIComponent(JSON.stringify(item));

                return `
                <tr class="animate__animated animate__fadeIn">
                    <td class="ps-4">${workStatusHtml}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="bg-light rounded-circle text-center me-2 d-flex align-items-center justify-content-center" style="width:35px; height:35px; font-weight:bold; color:#666;">
                                ${item.name.charAt(0)}
                            </div>
                            <span class="fw-bold text-dark">${item.name}</span>
                        </div>
                    </td>
                    <td>${roleBadge}</td>
                    <td class="font-monospace text-muted small">${item.email || '-'}</td>
                    <td>${isBound}</td>
                    <td>${regBadge}</td>
                    <td class="text-end pe-4">
                        <button class="btn btn-sm btn-outline-primary" onclick="openInviteModal('${itemJson}')">
                            <i class="fas fa-envelope me-1"></i> 發送註冊邀請
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // ==========================================
        // 2. 開啟發送邀請 Modal (Logic 3)
        // ==========================================
        function openInviteModal(jsonStr) {
            const item = JSON.parse(decodeURIComponent(jsonStr));
            
            document.getElementById('target-staff-id').value = item.id;
            document.getElementById('invite-name').innerText = item.name;
            document.getElementById('invite-email').value = item.email || '';
            document.getElementById('invite-system-role').value = item.system_role || 'medical';

            // 檢查是否有 Email
            const btn = document.querySelector('#inviteModal .btn-primary');
            if (!item.email) {
                alert('該人員尚未設定 Email，請先至「基本資料建立」補齊資料。');
                return; // 阻止開啟
            }
            
            // 如果已經註冊，提示使用者
            if (item.regStatus === 'done') {
                if(!confirm('此帳號顯示「已註冊」，確定要重新發送邀請信嗎？\n(這通常用於重設密碼或權限變更通知)')) return;
            }

            const modal = new bootstrap.Modal(document.getElementById('inviteModal'));
            modal.show();
        }

        // ==========================================
        // 3. 呼叫 Edge Function 發送邀請 (Logic 3)
        // ==========================================
        async function sendInvite() {
            const staffId = document.getElementById('target-staff-id').value;
            const email = document.getElementById('invite-email').value;
            const role = document.getElementById('invite-system-role').value;
            const name = document.getElementById('invite-name').innerText;

            const btn = document.querySelector('#inviteModal .btn-primary');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 發送中...';

            try {
                // 1. 呼叫 Edge Function
                // URL: https://yhehfucgemxnfrdvpdhw.supabase.co/functions/v1/invite-user
                const { data, error } = await supabaseClient.functions.invoke('invite-user', {
                    body: { 
                        email: email, 
                        role: role, 
                        full_name: name,
                        staff_id: staffId // 傳遞 staff_id 讓後端可以更新 medical_staff 的 user_id (如果後端有寫這段邏輯)
                    }
                });

                if (error) {
                    // 解析 Edge Function 回傳的錯誤
                    let errMsg = error.message;
                    try {
                        // 嘗試讀取 body 錯誤訊息
                        if(error.context && error.context.json) {
                            const body = await error.context.json();
                            if(body.error) errMsg = body.error;
                        }
                    } catch(e){}
                    throw new Error(errMsg);
                }

                // 2. 同步更新 medical_staff 的 system_role (因為邀請時可能變更了權限)
                // 注意: Edge Function 通常負責 Auth 註冊，我們這邊順便更新 DB 紀錄
                await supabaseClient
                    .from('medical_staff')
                    .update({ system_role: role })
                    .eq('id', staffId);

                alert(`✅ 邀請信已發送至 ${email}`);
                bootstrap.Modal.getInstance(document.getElementById('inviteModal')).hide();
                loadUsers(); // 重整列表

            } catch (err) {
                console.error(err);
                alert('❌ 發送失敗: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    </script>
</body>
</html>
