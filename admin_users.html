<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>帳號權限管理 | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { --primary-bg: #f4f6f9; }
        body {
            background-color: var(--primary-bg);
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            display: none; /* Auth Guard */
        }
        
        .section-title { border-left: 5px solid #0dcaf0; padding-left: 15px; margin-bottom: 20px; }
        
        .card-header { background-color: white; border-bottom: 1px solid #f0f0f0; }
        .table th { font-weight: 600; color: #555; background-color: #f8f9fa; }
        .table td { vertical-align: middle; }
        
        /* 狀態燈號 */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .bg-active { background-color: #198754; }
        .bg-inactive { background-color: #dc3545; }

        .role-badge { font-size: 0.85em; padding: 5px 10px; border-radius: 20px; }
        .role-admin { background-color: #cfe2ff; color: #084298; }
        .role-medical { background-color: #d1e7dd; color: #0f5132; }
        .role-user { background-color: #f8f9fa; color: #666; border: 1px solid #ddd; }
    </style>

    <script>
        // 簡單的權限檢查
        document.addEventListener('DOMContentLoaded', function() {
            const role = sessionStorage.getItem('currentUserRole');
            if (role !== 'admin') {
                alert('權限不足：此頁面僅限系統管理員存取。');
                window.location.href = 'dashboard.html';
                return;
            }
            document.body.style.display = 'block';
        });
    </script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3 mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold" href="dashboard.html"><i class="fas fa-shield-alt me-2"></i>OHSMS</a>
            <div class="d-flex align-items-center">
                <span class="text-light small me-3">系統管理後台</span>
                <a href="dashboard.html" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left me-1"></i> 返回儀表板</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4 pb-5">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="section-title mb-0">
                <h4 class="fw-bold text-dark mb-0">帳號權限管理 (Account Mgmt)</h4>
                <small class="text-muted">管理醫護人員的系統登入權限與狀態</small>
            </div>
            
            </div>

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4 bg-light rounded">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold small text-muted">關鍵字搜尋</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" id="search-input" class="form-control border-start-0" placeholder="輸入姓名、Email 或 職稱...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold small text-muted">角色篩選</label>
                        <select class="form-select" id="filter-role">
                            <option value="">全部角色</option>
                            <option value="醫師">醫師</option>
                            <option value="護理人員">護理人員</option>
                            <option value="顧問">顧問</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold small text-muted">狀態篩選</label>
                        <select class="form-select" id="filter-status">
                            <option value="">全部狀態</option>
                            <option value="active">使用中 (Active)</option>
                            <option value="inactive">停用/離職 (Inactive)</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-primary w-100 fw-bold" onclick="loadUsers()">
                            <i class="fas fa-filter me-1"></i> 套用篩選
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-users me-2"></i>醫護人員名單 (Medical Staff)</h6>
                <span class="badge bg-light text-dark border" id="total-count">共 0 筆</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead>
                            <tr>
                                <th class="ps-4">狀態</th>
                                <th>姓名</th>
                                <th>職務角色 (Role)</th>
                                <th>Email (登入帳號)</th>
                                <th>系統綁定</th>
                                <th class="text-end pe-4">管理動作</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <tr><td colspan="6" class="text-center py-5 text-muted">資料載入中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title fw-bold" id="modalTitle">編輯帳號權限</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="target-id"> <div class="mb-3 text-center">
                        <div class="avatar-circle bg-light text-secondary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" style="width:60px; height:60px; font-size:1.5rem; font-weight:bold;">
                            <span id="display-avatar">U</span>
                        </div>
                        <h5 class="fw-bold mb-0" id="display-name">User Name</h5>
                        <p class="text-muted small" id="display-role">Role</p>
                    </div>

                    <hr>

                    <form id="userForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Email (登入帳號)</label>
                            <input type="email" class="form-control" id="edit-email" readonly disabled>
                            <div class="form-text text-muted">若需修改 Email，請至「基本資料建立 > 醫護人員」修改。</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">系統權限群組 (System Role)</label>
                            <select class="form-select" id="edit-system-role">
                                <option value="medical">medical (一般醫護/顧問)</option>
                                <option value="admin">admin (系統管理員)</option>
                                <option value="general">general (一般文管)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">帳號狀態</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="edit-is-active">
                                <label class="form-check-label" for="edit-is-active">允許登入 (Active)</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-info text-white fw-bold" onclick="saveUserChanges()">儲存設定</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allStaffData = []; // 暫存所有醫護資料

        document.addEventListener('DOMContentLoaded', () => {
            loadUsers(); // 3. 修改重點：頁面載入時直接撈取名單
        });

        // ==========================================
        // 1. 讀取醫護人員名單 (取代原本讀取 profiles 的邏輯)
        // ==========================================
        async function loadUsers() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5"><div class="spinner-border text-primary"></div><div class="mt-2 text-muted">讀取醫護名單中...</div></td></tr>';

            const keyword = document.getElementById('search-input').value.toLowerCase();
            const roleFilter = document.getElementById('filter-role').value;
            const statusFilter = document.getElementById('filter-status').value;

            try {
                // 直接查詢 medical_staff 表格
                const { data, error } = await supabaseClient
                    .from('medical_staff')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allStaffData = data; // 保存原始資料供後續使用

                // 前端篩選邏輯
                let filtered = data.filter(user => {
                    // 關鍵字搜尋 (姓名 或 Email 或 職稱)
                    const matchKeyword = !keyword || 
                        (user.name && user.name.toLowerCase().includes(keyword)) ||
                        (user.email && user.email.toLowerCase().includes(keyword)) ||
                        (user.role && user.role.toLowerCase().includes(keyword));

                    // 角色篩選 (對應 medical_staff 的 role 欄位)
                    const matchRole = !roleFilter || user.role === roleFilter;

                    // 狀態篩選 (is_active)
                    const isActive = user.is_active;
                    const matchStatus = !statusFilter || 
                        (statusFilter === 'active' && isActive) ||
                        (statusFilter === 'inactive' && !isActive);

                    return matchKeyword && matchRole && matchStatus;
                });

                renderTable(filtered);

            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-5 text-danger">讀取失敗: ${err.message}</td></tr>`;
            }
        }

        function renderTable(users) {
            const tbody = document.getElementById('userTableBody');
            document.getElementById('total-count').innerText = `共 ${users.length} 筆`;

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted">查無符合條件的資料</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                // 狀態顯示
                const isActive = user.is_active;
                const statusHtml = isActive 
                    ? `<span class="text-success fw-bold"><span class="status-dot bg-active"></span>Active</span>`
                    : `<span class="text-danger"><span class="status-dot bg-inactive"></span>Inactive</span>`;
                
                // 角色樣式 (顯示職稱 role)
                let roleClass = 'role-user';
                if (user.role === '醫師') roleClass = 'role-admin'; // 借用樣式
                if (user.role === '護理人員') roleClass = 'role-medical'; // 借用樣式
                
                // 系統綁定狀態 (檢查 user_id 是否有值)
                const isBound = user.user_id ? '<span class="badge bg-primary">已綁定 Auth</span>' : '<span class="badge bg-secondary">未綁定</span>';

                // 資料轉 JSON 供編輯按鈕使用
                const userJson = encodeURIComponent(JSON.stringify(user));

                return `
                <tr class="animate__animated animate__fadeIn">
                    <td class="ps-4">${statusHtml}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="bg-light rounded-circle text-center me-2 d-flex align-items-center justify-content-center" style="width:35px; height:35px; font-weight:bold; color:#666;">
                                ${user.name.charAt(0)}
                            </div>
                            <span class="fw-bold text-dark">${user.name}</span>
                        </div>
                    </td>
                    <td><span class="role-badge ${roleClass}">${user.role || '未設定'}</span></td>
                    <td class="font-monospace text-muted">${user.email || '<span class="text-warning">無 Email</span>'}</td>
                    <td>${isBound}</td>
                    <td class="text-end pe-4">
                        <button class="btn btn-sm btn-outline-info" onclick="openEditModal('${userJson}')">
                            <i class="fas fa-cog me-1"></i> 設定
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // ==========================================
        // 2. 開啟編輯 Modal (針對 medical_staff)
        // ==========================================
        function openEditModal(jsonStr) {
            const user = JSON.parse(decodeURIComponent(jsonStr));
            
            document.getElementById('target-id').value = user.id;
            document.getElementById('display-name').innerText = user.name;
            document.getElementById('display-avatar').innerText = user.name.charAt(0);
            document.getElementById('display-role').innerText = user.role;
            
            document.getElementById('edit-email').value = user.email || '';
            document.getElementById('edit-system-role').value = user.system_role || 'medical'; // 預設 medical
            document.getElementById('edit-is-active').checked = user.is_active;

            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            modal.show();
        }

        // ==========================================
        // 3. 儲存變更 (更新 medical_staff)
        // ==========================================
        async function saveUserChanges() {
            const id = document.getElementById('target-id').value;
            const newSystemRole = document.getElementById('edit-system-role').value;
            const newIsActive = document.getElementById('edit-is-active').checked;
            
            const btn = document.querySelector('#userModal .btn-info');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 儲存中...';

            try {
                // 更新 medical_staff 資料表
                const { error } = await supabaseClient
                    .from('medical_staff')
                    .update({
                        system_role: newSystemRole,
                        is_active: newIsActive,
                        // 如果有 user_id，未來可能也需要同步更新 auth.users 或 profiles，
                        // 但依據您的指示，目前專注於 medical_staff。
                        updated_by: sessionStorage.getItem('currentUserId') // 紀錄操作者
                    })
                    .eq('id', id);

                if (error) throw error;

                // 寫入稽核日誌 (Audit Log)
                await supabaseClient.from('audit_logs').insert([{
                    user_role: sessionStorage.getItem('currentUserRole'),
                    user_name: sessionStorage.getItem('currentUserName'),
                    action_type: '更新',
                    target_table: 'medical_staff',
                    details: `修改權限: ${document.getElementById('display-name').innerText} (Role: ${newSystemRole}, Active: ${newIsActive})`
                }]);

                alert('✅ 設定已更新');
                bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                loadUsers(); // 重新整理列表

            } catch (err) {
                alert('更新失敗: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    </script>
</body>
</html>
