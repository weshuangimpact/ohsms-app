<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工作儀表板 | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-bg: #f8f9fa;
            --card-hover-transform: translateY(-5px);
        }

        /* =========================================
           統一頁首/頁尾 CSS 設定 (高度統一版)
           ========================================= */
        html {
            height: 100%; /* 確保根元素高度 */
        }

        body {
            background-color: var(--primary-bg);
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            
            /* 使用 min-height: 100vh 確保背景色至少填滿一頁 */
            min-height: 100vh;
            
            display: none; /* 權限驗證前先隱藏，驗證後透過 JS 改為 flex */
            flex-direction: column; /* 垂直排列：頁首 - 內容 - 頁尾 */
            margin: 0;
        }

        /* 內容區塊自動撐開，填滿剩餘空間 */
        .container {
            flex: 1; 
            padding-bottom: 2rem; /* 避免內容貼底 */
        }

        /* 頁首設定 */
        .navbar {
            background-color: #202124 !important;
            min-height: 85px; /* 統一高度 */
            color: #fff;
            flex-shrink: 0; /* 防止頁首被壓縮 */
        }

        .navbar-brand {
            font-weight: bold;
            letter-spacing: 1px;
            color: #fff !important;
        }

        /* 頁尾設定 */
        footer {
            background-color: #202124 !important;
            color: #fff;
            flex-shrink: 0; /* 防止頁尾被壓縮 */
            text-align: center;
            padding: 1.5rem 0;
            margin-top: auto; /* 確保頁尾推至底部 */
        }

        /* =========================================
           Dashboard 專屬樣式
           ========================================= */
        .dashboard-card {
            border: none;
            border-radius: 15px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            height: 100%;
            background: white;
            position: relative;
            overflow: hidden;
        }

        .dashboard-card:hover {
            transform: var(--card-hover-transform);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .card-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: #4f46e5;
        }

        .card-title {
            font-weight: bold;
            color: #2c3e50;
        }

        .card-desc {
            font-size: 0.9rem;
            color: #6c757d;
        }

        /* 裝飾性背景圓圈 */
        .bg-circle {
            position: absolute;
            bottom: -20px;
            right: -20px;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(79, 70, 229, 0.05);
            z-index: 0;
        }

        .status-pill {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            background: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark mb-4 shadow-sm">
        <div class="container-fluid px-4">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="fas fa-heartbeat me-2 fa-lg"></i>
                <div>
                    <div style="line-height: 1.2;">OHSMS</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">職業衛生管理系統</div>
                </div>
            </a>
            
            <div class="d-flex align-items-center text-white">
                <div class="me-4 d-none d-md-block text-end">
                    <div id="header-date" class="small opacity-75"></div>
                    <div id="header-clock" class="fw-bold fs-5"></div>
                </div>
                <div class="dropdown">
                    <button class="btn btn-outline-light dropdown-toggle rounded-pill px-3" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle me-1"></i>
                        <span id="header-user">載入中...</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow">
                        <li><a class="dropdown-item" href="profile_settings.txt"><i class="fas fa-cog me-2 text-muted"></i>個人設定</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logoutSystem()"><i class="fas fa-sign-out-alt me-2"></i>登出</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container animate__animated animate__fadeIn">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold text-dark"><i class="fas fa-tachometer-alt me-2 text-primary"></i>工作儀表板</h2>
            <div class="badge bg-primary fs-6 px-3 py-2 rounded-pill">
                <i class="fas fa-briefcase me-1"></i>
                <span id="user-role-display">載入中...</span>
            </div>
        </div>

        <div class="row g-4" id="dashboard-cards">
            <div class="col-md-6 col-lg-3 card-item" id="card-plan" onclick="window.location.href='index1.html'">
                <div class="dashboard-card p-4 shadow-sm border-start border-4 border-primary">
                    <div class="card-icon text-primary"><i class="fas fa-clipboard-list"></i></div>
                    <h5 class="card-title">服務執行歷程</h5>
                    <p class="card-desc">建立與管理臨場服務紀錄，執行 PDCA 之 Plan 與 Do 階段。</p>
                    <div class="bg-circle"></div>
                </div>
            </div>

            <div class="col-md-6 col-lg-3 card-item" id="card-manager" onclick="window.location.href='index2.html'">
                <div class="dashboard-card p-4 shadow-sm border-start border-4 border-success">
                    <div class="card-icon text-success"><i class="fas fa-chart-pie"></i></div>
                    <h5 class="card-title">管理者總覽</h5>
                    <p class="card-desc">審核服務紀錄、追蹤簽核進度，執行 Check 與 Act 階段。</p>
                    <div class="bg-circle" style="background: rgba(25, 135, 84, 0.05);"></div>
                </div>
            </div>

            <div class="col-md-6 col-lg-3 card-item" id="card-eval" onclick="window.location.href='index3.html'">
                <div class="dashboard-card p-4 shadow-sm border-start border-4 border-info">
                    <div class="card-icon text-info"><i class="fas fa-robot"></i></div>
                    <h5 class="card-title">評鑑支援 AI 助理</h5>
                    <p class="card-desc">利用 AI 輔助生成評鑑建議與對話式查詢。</p>
                    <div class="bg-circle" style="background: rgba(13, 202, 240, 0.05);"></div>
                </div>
            </div>

            <div class="col-md-6 col-lg-3 card-item" id="card-service" onclick="window.location.href='index4.txt'">
                <div class="dashboard-card p-4 shadow-sm border-start border-4 border-warning">
                    <div class="card-icon text-warning"><i class="fas fa-headset"></i></div>
                    <h5 class="card-title">線上客服中心</h5>
                    <p class="card-desc">即時通訊支援與系統操作問題排解。</p>
                    <div class="bg-circle" style="background: rgba(255, 193, 7, 0.05);"></div>
                </div>
            </div>

            <div class="col-md-6 col-lg-3 card-item" id="card-act" onclick="window.location.href='index5.txt'">
                <div class="dashboard-card p-4 shadow-sm border-start border-4 border-danger">
                    <div class="card-icon text-danger"><i class="fas fa-tools"></i></div>
                    <h5 class="card-title">評鑑改善專區</h5>
                    <p class="card-desc">針對評鑑缺失進行改善回覆與追蹤 (Act)。</p>
                    <div class="bg-circle" style="background: rgba(220, 53, 69, 0.05);"></div>
                </div>
            </div>

            <div class="col-md-6 col-lg-3 card-item" id="card-maint" onclick="window.location.href='index6.html'">
                <div class="dashboard-card p-4 shadow-sm border-start border-4 border-secondary">
                    <div class="card-icon text-secondary"><i class="fas fa-history"></i></div>
                    <h5 class="card-title">日誌與稽核</h5>
                    <p class="card-desc">查看系統操作歷程與證據保全紀錄。</p>
                    <div class="bg-circle" style="background: rgba(108, 117, 125, 0.05);"></div>
                </div>
            </div>

            <div class="col-md-6 col-lg-3 card-item" id="card-master" onclick="window.location.href='index7.html'">
                <div class="dashboard-card p-4 shadow-sm border-start border-4 border-dark">
                    <div class="card-icon text-dark"><i class="fas fa-database"></i></div>
                    <h5 class="card-title">基本資料建立</h5>
                    <p class="card-desc">匯入與維護公司、場所、員工等基礎資料。</p>
                    <div class="bg-circle" style="background: rgba(33, 37, 41, 0.05);"></div>
                </div>
            </div>

            <div class="col-md-6 col-lg-3 card-item" id="card-users" onclick="window.location.href='admin_users.txt'">
                <div class="dashboard-card p-4 shadow-sm border-start border-4 border-primary">
                    <div class="card-icon text-primary"><i class="fas fa-users-cog"></i></div>
                    <h5 class="card-title">帳號權限管理</h5>
                    <p class="card-desc">新增使用者、發送開通通知、管理角色權限。</p>
                    <div class="bg-circle"></div>
                </div>
            </div>

             <div class="col-md-6 col-lg-3 card-item" id="card-profile" onclick="window.location.href='profile_settings.txt'">
                <div class="dashboard-card p-4 shadow-sm border-start border-4 border-secondary">
                    <div class="card-icon text-secondary"><i class="fas fa-user-edit"></i></div>
                    <h5 class="card-title">個人帳號設定</h5>
                    <p class="card-desc">修改密碼、更新個人基本資料。</p>
                    <div class="bg-circle" style="background: rgba(108, 117, 125, 0.05);"></div>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-5">
        <div class="container">
            <p class="mb-0">&copy; 2026 OHSMS 職業衛生管理系統. All rights reserved.</p>
        </div>
    </footer>

    <div class="modal fade" id="recoveryModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-key me-2"></i>請設定新密碼</h5>
                </div>
                <div class="modal-body p-4">
                    <p class="text-muted mb-4">系統偵測到您透過重設密碼連結登入。為了您的帳號安全，請立即設定一組新密碼。</p>
                    <form id="recoveryForm" onsubmit="handleRecoverySubmit(event)">
                        <div class="mb-3">
                            <label class="form-label fw-bold">新密碼</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                <input type="password" id="recovery-pass" class="form-control" placeholder="請輸入新密碼 (至少6碼)" required minlength="6">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="form-label fw-bold">確認新密碼</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-check-circle"></i></span>
                                <input type="password" id="recovery-pass-confirm" class="form-control" placeholder="請再次輸入新密碼" required minlength="6">
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-info text-white fw-bold">
                                <i class="fas fa-save me-2"></i>更新密碼並進入系統
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InloZWhmdWNnZW14bmZyZHZwZGh3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg1NTE4ODQsImV4cCI6MjA1NDEyNzg4NH0.K19i-g0QdJvX2nQ9uQJ8vVjX9w1Xz6sO5yQ1z5v9w1';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- [新增] 監聽 Auth 狀態變化 (針對重設密碼流程) ---
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            if (event === 'PASSWORD_RECOVERY') {
                const recoveryModal = new bootstrap.Modal(document.getElementById('recoveryModal'));
                recoveryModal.show();
            }
        });
        // ------------------------------------------------

        // 權限檢查與初始化
        (async function init() {
            try {
                // 1. 檢查登入
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                if (error || !user) {
                    window.location.href = 'login.html';
                    return;
                }

                // 2. 顯示 UI
                document.body.style.display = 'flex';
                updateClock();
                setInterval(updateClock, 1000);

                // 3. 獲取使用者資料
                const { data: profile } = await supabaseClient
                    .from('medical_staff')
                    .select('name, system_role')
                    .eq('email', user.email)
                    .single();

                const userName = profile?.name || user.email;
                const userRole = profile?.system_role || 'consultant'; // 預設

                // 寫入 Session 以供其他頁面使用
                sessionStorage.setItem('currentUserId', user.id);
                sessionStorage.setItem('currentUserEmail', user.email);
                sessionStorage.setItem('currentUserName', userName);
                sessionStorage.setItem('currentUserRole', userRole);

                document.getElementById('header-user').innerText = `Hi! ${userName}`;
                
                // 角色對照
                const roleMap = {
                    'admin': '系統管理員',
                    'consultant': '職業衛生顧問',
                    'doc_control': '文管中心'
                };
                document.getElementById('user-role-display').innerText = roleMap[userRole] || userRole;

                // 4. 根據角色顯示卡片
                // 先全部隱藏，再根據權限打開
                const allCards = ['plan', 'manager', 'eval', 'act', 'maint', 'master', 'users', 'profile', 'service'];
                const cards = {};
                allCards.forEach(id => {
                    cards[id] = document.getElementById(`card-${id}`);
                });

                // 權限邏輯 Helper
                const show = (el) => { if(el) el.style.display = 'block'; };
                const hide = (el) => { if(el) el.style.display = 'none'; };

                // 初始化：全部隱藏 (除了 service 與 profile 大家都可能有)
                allCards.forEach(id => hide(cards[id]));

                if (userRole === 'admin') {
                    // Admin: 全開
                    allCards.forEach(id => show(cards[id]));
                } 
                else if (userRole === 'doc_control') {
                    // Doc Control: 2, 4, 6, 7, profile, users(view only? 暫不給)
                    hide(cards.plan);      // 1
                    show(cards.manager);   // 2
                    hide(cards.eval);      // 3
                    show(cards.service);   // 4
                    hide(cards.act);       // 5 (文控不用改進)
                    show(cards.maint);     // 6
                    show(cards.master);    // 7
                    hide(cards.users);     // Users
                    show(cards.profile);   // Profile
                }
                else if (userRole === 'consultant') {
                    // Consultant: 1, 5, profile, 4 (隱藏 2, 3, 6, 7, users)
                    show(cards.plan);      // 1
                    hide(cards.manager);   // 2
                    hide(cards.eval);      // 3
                    show(cards.act);       // 5 (顧問需要填寫改善紀錄)
                    hide(cards.maint);     // 6
                    hide(cards.master);    // 7
                    hide(cards.users);     // Users
                    show(cards.profile);   // Profile
                    show(cards.service);   // 4
                }

            } catch (err) {
                console.error(err);
                alert('系統初始化失敗，請重新登入');
                window.location.href = 'login.html';
            }
        })();

        // ------------------------------------------
        // 功能函式
        // ------------------------------------------
        function logoutSystem() {
            if(confirm('確定要登出系統嗎？')) {
                sessionStorage.clear();
                supabaseClient.auth.signOut().then(() => {
                     window.location.href = 'login.html';
                });
            }
        }

        function updateClock() {
            const now = new Date();
            const clockEl = document.getElementById('header-clock');
            if(clockEl) {
                clockEl.textContent = now.toLocaleTimeString('zh-TW', { hour12: false });
            }

            const dateEl = document.getElementById('header-date');
            if(dateEl) {
                const days = ['日', '一', '二', '三', '四', '五', '六'];
                const formattedDate = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}(${days[now.getDay()]})`;
                dateEl.innerHTML = `<i class="far fa-calendar-alt me-1"></i>今日是 ${formattedDate}`;
            }
        }

        // --- [新增] 處理密碼更新送出 ---
        async function handleRecoverySubmit(e) {
            e.preventDefault();
            
            const p1 = document.getElementById('recovery-pass').value;
            const p2 = document.getElementById('recovery-pass-confirm').value;
            const btn = document.querySelector('#recoveryForm button');
            
            if (p1 !== p2) {
                alert('❌ 兩次密碼輸入不一致，請重新輸入。');
                return;
            }

            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>更新中...';

            try {
                // 呼叫 Supabase 更新密碼 (因為此時使用者已透過連結登入，所以有權限改自己的密碼)
                const { data, error } = await supabaseClient.auth.updateUser({ 
                    password: p1 
                });

                if (error) throw error;

                alert('✅ 密碼更新成功！\n您現在可以開始使用系統。');
                
                const modalInstance = bootstrap.Modal.getInstance(document.getElementById('recoveryModal'));
                modalInstance.hide();
                
                // 移除 URL 中的 token hash，避免重新整理又觸發
                history.replaceState(null, '', window.location.pathname);

            } catch (err) {
                console.error(err);
                alert('❌ 更新失敗: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    </script>
</body>
</html>
