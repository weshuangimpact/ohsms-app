<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>勞工健康服務資料上傳 | OHSMS</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{background:linear-gradient(135deg,#eef5ff,#ffffff);font-family:'Segoe UI','Microsoft JhengHei',sans-serif}
.card{border-radius:18px;border:none;box-shadow:0 12px 30px rgba(0,0,0,.08)}
.upload{border:2px dashed #60a5fa;border-radius:16px;padding:48px;text-align:center;cursor:pointer;background:#f0f7ff}
.upload:hover{background:#e0ecff}
footer{position:sticky;bottom:0;background:#fff;padding:16px;border-top:1px solid #e5e7eb}
textarea{min-height:120px}
</style>
</head>

<body>

<div class="container py-5">

<h2 class="fw-bold mb-2">勞工健康服務資料上傳</h2>
<p class="text-muted">自動辨識 → 校對 → 送審</p>

<div class="card p-5 mb-4">
  <h5 class="fw-bold mb-3">STEP 1｜上傳執行紀錄表</h5>
  <div class="upload" onclick="file.click()">
    <i class="fa-solid fa-cloud-arrow-up fa-3x text-primary mb-3"></i>
    <div class="fw-bold">點擊上傳 PDF / 圖檔</div>
  </div>
  <input type="file" id="file" hidden accept=".pdf,.jpg,.png">
  <div id="loading" class="alert alert-info mt-4 d-none">
    <i class="fa-solid fa-spinner fa-spin me-2"></i>OCR 辨識中…
  </div>
</div>

<div id="step2" class="card p-5 d-none">
  <h5 class="fw-bold mb-4">STEP 2｜自動填入（可校對）</h5>

  <label class="fw-bold">執行日期</label>
  <input type="date" id="execDate" class="form-control mb-3">

  <label class="fw-bold">一、作業場所基本資料</label>
  <textarea id="sec1" class="form-control mb-3"></textarea>

  <label class="fw-bold">二、作業流程與危害概況</label>
  <textarea id="sec2" class="form-control mb-3"></textarea>

  <label class="fw-bold">三、臨場健康服務執行情形</label>
  <textarea id="sec3" class="form-control mb-4"></textarea>

  <label class="fw-bold mb-2">辦理事項</label>
  <div class="row" id="items"></div>
</div>

</div>

<footer class="text-end d-none" id="footer">
  <button class="btn btn-outline-secondary me-2" onclick="location.reload()">重新上傳</button>
  <button class="btn btn-primary fw-bold px-4" onclick="submit()">確認送出審核</button>
</footer>

<script>
const SUPABASE_URL='https://ghpxaeenikochgrnczic.supabase.co';
const SUPABASE_KEY='sb_publishable_v0ZN2OY08lh-8EC8ps8NdQ_ChYo1FRW';
const db=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

const itemCodes=['9-1','9-2','9-3','9-4','9-5','9-6','11-1','11-2','12','13'];
itemCodes.forEach(c=>{
  items.innerHTML+=`
  <div class="col-6 col-md-3">
    <div class="form-check">
      <input class="form-check-input" id="i${c}" value="${c}" type="checkbox">
      <label class="form-check-label fw-bold">${c}</label>
    </div>
  </div>`;
});

file.addEventListener('change', async ()=>{
  if(!file.files[0])return;
  loading.classList.remove('d-none');

  const fd=new FormData();
  fd.append('file',file.files[0]);

  const res=await fetch(
    'https://ghpxaeenikochgrnczic.supabase.co/functions/v1/ocr',
    {method:'POST',body:fd}
  );

  const data=await res.json();

  execDate.value=data.execution_date||'';
  sec1.value=data.section1||'';
  sec2.value=data.section2||'';
  sec3.value=data.section3||'';

  itemCodes.forEach(c=>{
    if(data.items.includes(c))document.getElementById('i'+c).checked=true;
  });

  loading.classList.add('d-none');
  step2.classList.remove('d-none');
  footer.classList.remove('d-none');
});

async function submit(){
  const checked=[...document.querySelectorAll('#items input:checked')].map(i=>i.value);

  const payload={
    execution_date:execDate.value,
    section1:sec1.value,
    section2:sec2.value,
    section3:sec3.value,
    items:checked
  };

  const {error}=await db.from('document_staging').insert([{
    uploader_name:sessionStorage.getItem('currentUserName')||'consultant',
    main_file_name:file.files[0].name,
    main_file_type:'pdf',
    category:'勞工健康服務執行紀錄表',
    extracted_data:payload,
    status:'pending'
  }]);

  if(error){alert(error.message);return;}
  alert('已送交審核');
  location.href='dashboard.html';
}
</script>

</body>
</html>
