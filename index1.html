<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>顧問資料上傳 (Plan/Do) | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary-bg: #f4f6f9; }
        body { background-color: var(--primary-bg); font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; display: none; }

        /* 樣式保持不變 */
        .demo-info-card { background-color: #fffbeb; border-left: 4px solid #f59e0b; color: #92400e; padding: 1rem; border-radius: 0.375rem; font-size: 0.9rem; }
        .input-readonly { background-color: #f8fafc; border: 1px solid #cbd5e1; color: #475569; cursor: default; }
        .input-editable { background-color: #ffffff; border: 1px solid #3b82f6; }
        .step-title { border-left: 4px solid #0d6efd; padding-left: 10px; font-weight: bold; color: #0d6efd; margin-bottom: 1rem; margin-top: 2rem; }
        
        /* 模式卡片 */
        .mode-card { border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .mode-card:hover { border-color: #0d6efd; background-color: #f8f9fa; transform: translateY(-3px); }
        .mode-card.active { border-color: #0d6efd; background-color: #e7f1ff; }
        
        /* [修正] 分項上傳樣式 */
        .check-row {
            border-bottom: 1px solid #f0f0f0;
            padding: 12px 0;
            transition: background-color 0.2s;
        }
        .check-row:hover { background-color: #fafafa; }
        
        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        /* 隱藏原生 File Input，改用按鈕觸發 */
        .btn-upload-sm {
            border: 1px solid #dee2e6;
            background-color: white;
            color: #6c757d;
            font-size: 0.85rem;
            padding: 4px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-upload-sm:hover {
            border-color: #0d6efd;
            color: #0d6efd;
            background-color: #f0f7ff;
        }
        .btn-upload-sm.has-file {
            background-color: #e6fffa;
            border-color: #20c997;
            color: #198754;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3 mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="dashboard.html"><i class="fas fa-shield-alt me-2"></i>OHSMS</a>
            <div class="d-flex align-items-center">
                <span class="text-light me-3" id="user-display"></span>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <h2 class="fw-bold text-dark mb-4"><i class="fas fa-file-arrow-up me-2 text-primary"></i>顧問資料上傳</h2>
        
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4 p-md-5">

                <div class="bg-light p-4 rounded mb-4 border">
                    <h5 class="step-title" style="margin-top:0;">Step 1：選擇對象與模式</h5>
                    <div class="row g-3 align-items-end">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" id="input-tax-id" class="form-control" placeholder="輸入統編 或 直接點擊查詢">
                                <button class="btn btn-primary" onclick="fetchCompanyData(this)">查詢</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="company-data-section" style="display: none;">
                    <hr class="my-5">
                    <input type="hidden" id="hidden-company-id">
                    <input type="hidden" id="hidden-workplace-id">
                    <input type="hidden" id="current-mode"> 
                    <input type="hidden" id="target-year">

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <span class="badge bg-primary me-2" id="mode-badge">模式</span>
                            <span id="mode-text" class="fw-bold text-dark"></span>
                        </div>
                        <button id="edit-btn" onclick="toggleEditMode()" class="btn btn-light btn-sm border fw-bold">
                            <i class="fas fa-pen-to-square me-1"></i> 啟用編輯
                        </button>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6"><label class="small text-muted fw-bold">事業單位</label><input type="text" id="disp-name" class="form-control input-readonly" readonly></div>
                        <div class="col-md-6"><label class="small text-muted fw-bold">部門</label><input type="text" id="disp-dept" class="form-control input-readonly" readonly></div>
                    </div>
                    
                    <input type="hidden" id="disp-hazard-type" class="data-field"><input type="hidden" id="disp-hazard-count" class="data-field">
                    <input type="hidden" id="disp-process"><input type="hidden" id="disp-pattern"><input type="hidden" id="disp-desc">
                    <div style="display:none;"><input id="disp-admin-m"><input id="disp-admin-f"><input id="disp-site-m"><input id="disp-site-f"></div>


                    <h5 class="step-title">Step 2：設定執行時間</h5>
                    <div class="card border bg-light">
                        <div class="card-body">
                            <div class="row g-3 align-items-center">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">執行日期</label>
                                    <input type="date" id="visit-date" class="form-control border-primary">
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label fw-bold">執行時間</label>
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="time" id="start-time" class="form-control" value="09:00">
                                        <span>至</span>
                                        <input type="time" id="end-time" class="form-control" value="12:00">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h5 class="step-title">Step 3：臨場服務項目與佐證上傳</h5>
                    <div class="alert alert-info py-2 small"><i class="fas fa-info-circle me-1"></i> 請勾選本次執行項目，並於後方直接上傳對應檔案 (支援 PDF/圖片)。</div>
                    
                    <div class="card border border-primary bg-primary bg-opacity-10 mb-3">
                        <div class="card-body py-2">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <input class="form-check-input me-3" type="checkbox" checked disabled style="transform: scale(1.2);">
                                    <h6 class="mb-0 fw-bold text-primary">勞工健康服務執行紀錄表 (核心必要)</h6>
                                </div>
                                <div class="upload-area">
                                    <input type="file" id="file-core" class="d-none item-file" data-code="core" onchange="handleFileSelect(this)">
                                    <button class="btn-upload-sm" onclick="document.getElementById('file-core').click()">
                                        <i class="fas fa-cloud-upload-alt me-1"></i> 上傳檔案
                                    </button>
                                    <span class="ms-2 small text-muted file-name-disp"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="checklist-container">
                        </div>

                    <div class="d-flex justify-content-end mt-5 pt-4 border-top">
                        <button class="btn btn-primary px-5 py-2 fw-bold shadow rounded-pill" onclick="submitServiceRecord(this)">
                            <i class="fas fa-paper-plane me-2"></i>確認完工並提交
                        </button>
                    </div>

                </div> 
            </div>
        </div>
    </div>

    <div class="modal fade" id="companySelectModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-body"><div class="list-group" id="companyListContainer"></div></div></div></div></div>
    <div class="modal fade" id="modeSelectModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-body p-4"><div class="row g-3"><div class="col-6"><div class="mode-card h-100" onclick="selectMode('new')"><h5>新增歷程</h5></div></div><div class="col-6"><div class="mode-card h-100" onclick="selectMode('amend')"><h5>補件/修正</h5></div></div></div><div id="year-selector-area" class="mt-3" style="display:none;"><select id="mode-year-select" class="form-select"><option value="2025">2025</option></select><button class="btn btn-success w-100 mt-2" onclick="confirmMode()">確定</button></div></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentCompany = null;
        let selectedMode = '';

        document.addEventListener('DOMContentLoaded', () => {
            document.body.style.display = 'block';
            document.getElementById('user-display').innerHTML = `<small>Hi, ${sessionStorage.getItem('currentUserName') || 'User'}</small>`;
            renderChecklist(); // 渲染檢核表
            
            // 設定預設日期為今天
            document.getElementById('visit-date').valueAsDate = new Date();
        });

        // 定義法規項目清單
        const CHECKLIST_ITEMS = [
            { code: '9-1', text: '勞工體格(健康)檢查結果之分析與評估、健康管理及資料保存。' },
            { code: '9-2', text: '協助雇主選配勞工從事適當之工作。' },
            { code: '9-3', text: '辦理健康檢查結果異常者之追蹤管理及健康指導。' },
            { code: '9-4', text: '辦理未滿十八歲勞工、有母性健康危害之虞之勞工...之評估及個案管理。' },
            { code: '9-5', text: '職業衛生或職業健康之相關研究報告及傷害、疾病紀錄之保存。' },
            { code: '9-6', text: '勞工之健康教育、衛生指導、身心健康保護、健康促進...之策劃及實施。' },
            { code: '9-7', text: '工作相關傷病之預防、健康諮詢與急救及緊急處置。' },
            { code: '9-8', text: '定期向雇主報告及勞工健康服務之建議。' },
            { code: '11-1', text: '辨識與評估工作場所環境、作業及組織內部影響勞工身心健康之危害因子。' },
            { code: '11-2', text: '提出作業環境安全衛生設施改善規劃之建議。' },
            { code: '11-3', text: '調查勞工健康情形與作業之關連性。' },
            { code: '11-4', text: '提供復工勞工之職能評估、職務再設計或調整之諮詢及建議。' },
            { code: '11-5', text: '其他經中央主管機關指定公告者。' },
            { code: '12', text: '訂定勞工健康服務計畫，據以執行，每年評估成效及檢討。' },
            { code: '13', text: '訂定勞工健康管理方案，據以辦理，每年評估成效及檢討。' },
            { code: 'other', text: '其他附件' }
        ];

        function renderChecklist() {
            const container = document.getElementById('checklist-container');
            let html = '';
            CHECKLIST_ITEMS.forEach(item => {
                html += `
                <div class="check-row d-flex align-items-center justify-content-between px-2">
                    <div class="d-flex align-items-center flex-grow-1 me-2">
                        <div class="form-check">
                            <input class="form-check-input check-item" type="checkbox" id="c${item.code}" value="${item.code}">
                            <label class="form-check-label" for="c${item.code}">
                                <span class="fw-bold text-dark me-1">${item.code}</span> ${item.text}
                            </label>
                        </div>
                    </div>
                    <div class="upload-area flex-shrink-0" style="min-width: 200px; text-align: right;">
                        <input type="file" id="file-${item.code}" class="d-none item-file" data-code="${item.code}" onchange="handleFileSelect(this)">
                        <button class="btn-upload-sm" onclick="document.getElementById('file-${item.code}').click()">
                            <i class="fas fa-paperclip me-1"></i> 上傳
                        </button>
                        <span class="d-block small text-muted file-name-disp text-truncate" style="max-width: 200px; float: right;"></span>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // 檔案選擇後的 UI 更新
        function handleFileSelect(input) {
            const btn = input.previousElementSibling; // 按鈕
            const span = input.nextElementSibling;    // 檔名顯示區
            const checkboxId = 'c' + input.dataset.code;
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                btn.classList.add('has-file');
                btn.innerHTML = '<i class="fas fa-check me-1"></i> 已選取';
                span.innerText = file.name;
                span.title = file.name;
                
                // 自動勾選前面的 checkbox
                if(input.dataset.code !== 'core') {
                    document.getElementById(checkboxId).checked = true;
                }
            } else {
                btn.classList.remove('has-file');
                btn.innerHTML = '<i class="fas fa-paperclip me-1"></i> 上傳';
                span.innerText = '';
            }
        }

        // --- 核心查詢與模式邏輯 (與舊版相同，簡化顯示) ---
        async function fetchCompanyData(btn) {
            const val = document.getElementById('input-tax-id').value;
            if(!val) return alert('請輸入統編');
            btn.disabled = true;
            const { data } = await supabaseClient.from('companies').select('*').or(`tax_id.eq.${val},name.ilike.%${val}%`);
            btn.disabled = false;
            if(data?.length === 1) openModeModal(data[0]);
            else if(data?.length > 1) { /* 顯示列表邏輯同前 */ }
            else alert('查無資料');
        }
        function openModeModal(co) { currentCompany = co; new bootstrap.Modal(document.getElementById('modeSelectModal')).show(); }
        function selectMode(m) { selectedMode = m; document.getElementById('year-selector-area').style.display='block'; }
        async function confirmMode() {
            const year = document.getElementById('mode-year-select').value;
            // 填寫基本資料
            document.getElementById('hidden-company-id').value = currentCompany.id;
            document.getElementById('disp-name').value = currentCompany.name;
            document.getElementById('hidden-workplace-id').value = 'loading...'; 
            document.getElementById('target-year').value = year;
            document.getElementById('current-mode').value = selectedMode;

            // 取得 Workplace ID
            const { data: wp } = await supabaseClient.from('workplaces').select('id, department_name').eq('company_id', currentCompany.id).single();
            if(wp) {
                document.getElementById('hidden-workplace-id').value = wp.id;
                document.getElementById('disp-dept').value = wp.department_name;
            }

            bootstrap.Modal.getInstance(document.getElementById('modeSelectModal')).hide();
            document.getElementById('company-data-section').style.display = 'block';
        }

        // ★ 核心功能：提交並自動歸檔
        async function submitServiceRecord(btn) {
            const workplaceId = document.getElementById('hidden-workplace-id').value;
            const year = document.getElementById('target-year').value;
            const mode = document.getElementById('current-mode').value;
            
            // 1. 取得時間
            const visitDate = document.getElementById('visit-date').value;
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;

            if (!workplaceId || workplaceId === 'loading...') return alert('資料載入未完成，請重試');
            if (!visitDate) return alert('請選擇執行日期');

            // 2. 收集所有已選檔案
            const fileInputs = document.querySelectorAll('.item-file');
            let filesToUpload = [];
            let checkItems = [];

            // 檢查核心檔案
            const coreInput = document.getElementById('file-core');
            if (!coreInput.files[0]) return alert('錯誤：必須上傳「勞工健康服務執行紀錄表 (核心必要)」');
            filesToUpload.push({ code: 'core', file: coreInput.files[0] });

            // 檢查其他項目
            fileInputs.forEach(input => {
                const code = input.dataset.code;
                if (code !== 'core' && input.files[0]) {
                    filesToUpload.push({ code: code, file: input.files[0] });
                    
                    // 紀錄勾選項目文字
                    const itemText = CHECKLIST_ITEMS.find(i => i.code === code)?.text || '';
                    checkItems.push(`${code} ${itemText}`);
                }
            });

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在建立歸檔資料夾...';

            try {
                // 3. 準備上傳路徑： staging/service_records/{Year}/{WorkplaceID}/{Timestamp}/
                const timestamp = Date.now();
                const folderPath = `service_records/${year}/${workplaceId}/${timestamp}`;
                let uploadedAttachments = [];

                // 4. 迴圈上傳
                for (const item of filesToUpload) {
                    // 檔名格式： {代碼}_{原檔名} (例如: 9-1_體格檢查分析.pdf)
                    const newFileName = `${item.code}_${item.file.name}`;
                    const fullPath = `${folderPath}/${newFileName}`;

                    const { error } = await supabaseClient.storage
                        .from('staging')
                        .upload(fullPath, item.file);

                    if (error) throw error;

                    uploadedAttachments.push({
                        item_code: item.code,
                        name: item.file.name,
                        bucket: 'staging',
                        path: fullPath,
                        type: item.file.type,
                        size: item.file.size
                    });
                }

                // 5. 寫入資料庫
                const stagingContent = {
                    note: mode === 'new' ? "年度訪視" : "文件補件",
                    checklist: checkItems
                };

                const { error: dbError } = await supabaseClient.from('service_record_staging').insert([{
                    workplace_id: workplaceId,
                    service_year: parseInt(year),
                    
                    // 新增的時間欄位
                    visit_date: visitDate,     // 執行日期
                    start_time: startTime,     // 開始時間
                    end_time: endTime,         // 結束時間
                    service_date: new Date().toISOString(), // 提交時間 (系統時間)

                    service_type: mode === 'new' ? 'Plan/Do' : '補件',
                    status: 'pending',
                    service_desc: JSON.stringify(stagingContent),
                    attachment_files: uploadedAttachments
                }]);

                if (dbError) throw new Error(dbError.message);

                alert('✅ 提交成功！\n檔案已自動歸檔至暫存區，等待管理員審核。');
                location.reload();

            } catch (e) {
                console.error(e);
                alert('上傳失敗: ' + e.message);
                btn.disabled = false;
                btn.innerHTML = '確認完工並提交';
            }
        }
        
        function toggleEditMode() { /* 保持原樣 */ }
    </script>
</body>
</html>
