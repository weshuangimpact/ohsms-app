<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>勞工健康服務資料上傳 | OHSMS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  background:#f4f6f9;
  font-family:'Microsoft JhengHei','Segoe UI';
  display:none;
}
.step-card {
  border:0;
  border-radius:12px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
}
.upload-box {
  border:2px dashed #c7d2fe;
  background:#eef2ff;
  border-radius:12px;
  padding:40px;
  text-align:center;
  cursor:pointer;
  transition:.2s;
}
.upload-box:hover {
  background:#e0e7ff;
  border-color:#6366f1;
}
.step-badge {
  font-size:.8rem;
  letter-spacing:.5px;
}
</style>

<script>
const role = sessionStorage.getItem('currentUserRole');
if (!role) location.href='login.html';

const db = supabase.createClient(
  'https://ghpxaeenikochgrnczic.supabase.co',
  'sb_publishable_v0ZN2OY08lh-8EC8ps8NdQ_ChYo1FRW'
);
</script>
</head>

<body>

<nav class="navbar navbar-dark bg-dark px-4">
  <span class="navbar-brand fw-bold">
    <i class="fas fa-shield-alt me-2"></i>OHSMS
  </span>
  <a href="dashboard.html" class="btn btn-sm btn-outline-light">
    <i class="fas fa-arrow-left me-1"></i>返回儀表板
  </a>
</nav>

<div class="container py-5">

<h3 class="fw-bold mb-1">勞工健康服務資料上傳</h3>
<p class="text-muted mb-4">請上傳「勞工健康服務執行紀錄表」及相關附件</p>

<div class="card step-card p-4 mb-4">
  <span class="badge bg-primary step-badge mb-2">STEP 1</span>
  <h5 class="fw-bold">主文件（執行紀錄表）</h5>
  <div class="upload-box mt-3" onclick="document.getElementById('mainFile').click()">
    <i class="fas fa-file-pdf fa-3x text-primary mb-3"></i>
    <div class="fw-bold">點擊上傳 PDF / 圖檔</div>
    <small class="text-muted">勞工健康服務執行紀錄表</small>
  </div>
  <input type="file" id="mainFile" hidden accept=".pdf,.jpg,.png" onchange="handleMainFile(this)">
</div>

<div id="step2" class="card step-card p-4 mb-4" style="display:none;">
  <span class="badge bg-secondary step-badge mb-2">STEP 2</span>
  <h5 class="fw-bold">附件（佐證文件）</h5>
  <input type="file" id="attachments" class="form-control mt-3" multiple>
</div>

<div id="step3" class="text-end" style="display:none;">
  <button class="btn btn-primary fw-bold px-4" onclick="submitToSupabase()">
    確認送出審核
  </button>
</div>

</div>

<script>
document.body.style.display='block';
let mainFileObj = null;

function handleMainFile(input){
  if(!input.files[0]) return;
  mainFileObj = input.files[0];
  document.getElementById('step2').style.display='block';
  document.getElementById('step3').style.display='block';
}

async function submitToSupabase(){
  const uploader = sessionStorage.getItem('currentUserName') || 'consultant';

  const { data, error } = await db
    .from('document_staging')
    .insert({
      uploader_name: uploader,
      main_file_name: mainFileObj.name,
      main_file_type: mainFileObj.type,
      category: '勞工健康服務執行紀錄表',
      status: 'pending',
      extracted_data: {
        note: '等待 OCR 與條款解析'
      }
    })
    .select()
    .single();

  if(error){
    alert(error.message);
    return;
  }

  const files = document.getElementById('attachments').files;
  for(const f of files){
    await db.from('document_attachments').insert({
      staging_id: data.id,
      file_name: f.name,
      file_type: f.type
    });
  }

  alert('已送出，等待管理者審核');
  location.href='dashboard.html';
}
</script>

</body>
</html>
