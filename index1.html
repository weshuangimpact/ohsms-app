<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>顧問資料上傳 (Plan/Do) | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary-bg: #f4f6f9; }
        body {
            background-color: var(--primary-bg);
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            display: none; /* Auth Guard */
        }

        .section-title { border-left: 5px solid #0d6efd; padding-left: 15px; margin-bottom: 20px; }
        .upload-item-card {
            border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 10px;
            background: white; transition: all 0.2s;
        }
        .upload-item-card:hover { border-color: #b3d7ff; background: #f8fbff; }
        .btn-upload { display: none; }
        .btn-upload.visible { display: inline-block; }
        .btn-upload.has-file { background-color: #198754; border-color: #198754; color: white; }
    </style>

    <script>
        // 權限檢查
        document.addEventListener('DOMContentLoaded', () => {
            const role = sessionStorage.getItem('currentUserRole');
            if (!role) window.location.href = 'login.html';
            document.body.style.display = 'block';
            
            // 初始化
            initPage();
        });
    </script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3 mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="dashboard.html"><i class="fas fa-shield-alt me-2"></i>OHSMS</a>
            <div class="d-flex align-items-center">
                <span class="text-light me-3" id="user-display"></span>
                <a href="dashboard.html" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left me-1"></i> 返回儀表板</a>
            </div>
        </div>
    </nav>

    <div class="container pb-5" style="max-width: 900px;">
        
        <div class="section-title">
            <h4 class="fw-bold text-dark mb-0">Plan / Do：顧問資料上傳</h4>
            <small class="text-muted">建立訪視紀錄並上傳相關佐證資料</small>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3">
                <h6 class="fw-bold mb-0 text-primary">Step 1：選擇服務對象與日期</h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">事業單位</label>
                        <select class="form-select" id="input-company">
                            <option value="" disabled selected>載入中...</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">訪視日期</label>
                        <input type="date" class="form-control" id="input-date">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">服務類型</label>
                        <select class="form-select" id="input-type">
                            <option value="臨場健康服務">臨場健康服務</option>
                            <option value="教育訓練">教育訓練</option>
                            <option value="專案輔導">專案輔導</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h6 class="fw-bold mb-0 text-primary">Step 2：勾選執行項目並上傳佐證 (PDF)</h6>
                <small class="text-muted"><i class="fas fa-info-circle me-1"></i>系統將自動進行檔案分類排序 (A~Q)</small>
            </div>
            <div class="card-body bg-light">
                <div id="upload-list-container">
                    </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3">
                <h6 class="fw-bold mb-0 text-primary">Step 3：特殊狀況說明與其他附件 (選填)</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label text-muted small">若有無法執行項目或特殊情況，請在此說明（將顯示於審查預覽）：</label>
                    <textarea class="form-control" id="input-special-note" rows="3" placeholder="例如：因產線歲修無法進入拍攝..."></textarea>
                </div>
                <div class="upload-item-card">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="other" id="chk-other" onchange="toggleUploadBtn(this)">
                        <label class="form-check-label fw-bold" for="chk-other">other 其他附件</label>
                    </div>
                    <div class="mt-2 ps-4">
                        <input type="file" id="file-other" data-code="other" class="d-none" accept=".pdf" onchange="updateFileState(this)">
                        <button type="button" class="btn btn-outline-secondary btn-sm btn-upload" id="btn-other" onclick="document.getElementById('file-other').click()">
                            <i class="fas fa-paperclip me-1"></i> <span class="btn-text">上傳佐證</span>
                        </button>
                        <small class="text-muted ms-2 file-name-display" id="name-other"></small>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-grid gap-2 mb-5">
            <button class="btn btn-primary fw-bold py-3" onclick="saveData()">
                <i class="fas fa-cloud-upload-alt me-2"></i> 提交送審
            </button>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ★★★ 核心設定：檔案命名對照表 (A~Q) ★★★
        // 僅用於 saveData 內部邏輯，不影響 UI 顯示
        const FILE_CODE_MAP = {
            'core': 'A',
            '9-1': 'B', '9-2': 'C', '9-3': 'D', '9-4': 'E',
            '9-5': 'F', '9-6': 'G', '9-7': 'H', '9-8': 'I',
            '11-1': 'J', '11-2': 'K', '11-3': 'L', '11-4': 'M', '11-5': 'N',
            '12': 'O', '13': 'P',
            'other': 'Q'
        };

        // 項目清單 (維持原本 UI 顯示文字)
        const UPLOAD_ITEMS = [
            { code: 'core', label: 'core 勞工健康服務執行紀錄表 (核心必要) 限PDF' },
            { code: '9-1', label: '9-1 勞工體格(健康)檢查結果之分析與評估、健康管理及資料保存。' },
            { code: '9-2', label: '9-2 協助雇主選配勞工從事適當之工作。' },
            { code: '9-3', label: '9-3 辦理健康檢查結果異常者之追蹤管理及健康指導。' },
            { code: '9-4', label: '9-4 辦理未滿十八歲勞工、有母性健康危害之虞之勞工...評估及個案管理。' },
            { code: '9-5', label: '9-5 職業衛生或職業健康之相關研究報告及傷害、疾病紀錄之保存。' },
            { code: '9-6', label: '9-6 勞工之健康教育、衛生指導、身心健康保護...策劃及實施。' },
            { code: '9-7', label: '9-7 工作相關傷病之預防、健康諮詢與急救及緊急處置。' },
            { code: '9-8', label: '9-8 定期向雇主報告及勞工健康服務之建議。' },
            { code: '11-1', label: '11-1 辨識與評估工作場所環境、作業及組織內部影響勞工身心健康之危害因子。' },
            { code: '11-2', label: '11-2 提出作業環境安全衛生設施改善規劃之建議。' },
            { code: '11-3', label: '11-3 調查勞工健康情形與作業之關連性。' },
            { code: '11-4', label: '11-4 提供復工勞工之職能評估、職務再設計或調整之諮詢及建議。' },
            { code: '11-5', label: '11-5 其他經中央主管機關指定公告者。' },
            { code: '12', label: '12 訂定勞工健康服務計畫，據以執行，每年評估成效及檢討。' },
            { code: '13', label: '13 訂定勞工健康管理方案，據以辦理，每年評估成效及檢討。' }
        ];

        async function initPage() {
            // 1. 顯示使用者
            const userName = sessionStorage.getItem('currentUserName');
            document.getElementById('user-display').innerText = userName || 'User';

            // 2. 載入公司列表
            try {
                const { data, error } = await supabaseClient.from('companies').select('id, name, tax_id').eq('is_active', true);
                if (error) throw error;
                
                const select = document.getElementById('input-company');
                select.innerHTML = '<option value="" disabled selected>請選擇服務對象...</option>';
                data.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.name} (${c.tax_id})</option>`;
                });
            } catch (e) {
                console.error(e);
                alert('載入公司列表失敗');
            }

            // 3. 設定預設日期 (今天)
            document.getElementById('input-date').valueAsDate = new Date();

            // 4. 生成上傳項目
            renderUploadList();
        }

        function renderUploadList() {
            const container = document.getElementById('upload-list-container');
            let html = '';
            UPLOAD_ITEMS.forEach(item => {
                html += `
                <div class="upload-item-card">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${item.code}" id="chk-${item.code}" onchange="toggleUploadBtn(this)">
                        <label class="form-check-label fw-bold" for="chk-${item.code}">
                            ${item.label}
                        </label>
                    </div>
                    <div class="mt-2 ps-4">
                        <input type="file" id="file-${item.code}" data-code="${item.code}" class="d-none" accept=".pdf" onchange="updateFileState(this)">
                        <button type="button" class="btn btn-outline-secondary btn-sm btn-upload" id="btn-${item.code}" onclick="document.getElementById('file-${item.code}').click()">
                            <i class="fas fa-paperclip me-1"></i> <span class="btn-text">上傳佐證</span>
                        </button>
                        <small class="text-muted ms-2 file-name-display" id="name-${item.code}"></small>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function toggleUploadBtn(checkbox) {
            const code = checkbox.value;
            const btn = document.getElementById(`btn-${code}`);
            if (checkbox.checked) {
                btn.classList.add('visible');
            } else {
                btn.classList.remove('visible');
                // 清除已選檔案
                const fileInput = document.getElementById(`file-${code}`);
                fileInput.value = ''; 
                updateFileState(fileInput);
            }
        }

        function updateFileState(input) {
            const code = input.dataset.code;
            const btn = document.getElementById(`btn-${code}`);
            const nameDisplay = document.getElementById(`name-${code}`);
            
            if (input.files && input.files[0]) {
                btn.classList.add('has-file');
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-success');
                btn.innerHTML = '<i class="fas fa-check me-1"></i> 已選取';
                nameDisplay.innerText = input.files[0].name;
            } else {
                btn.classList.remove('has-file');
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
                btn.innerHTML = '<i class="fas fa-paperclip me-1"></i> 上傳佐證';
                nameDisplay.innerText = '';
            }
        }

        // ★★★ 送出與上傳邏輯 ★★★
        async function saveData() {
            const companyId = document.getElementById('input-company').value;
            const visitDate = document.getElementById('input-date').value;
            const type = document.getElementById('input-type').value;
            const specialNote = document.getElementById('input-special-note').value;
            const consultantId = sessionStorage.getItem('currentUserId'); 

            if (!companyId || !visitDate) return alert('請選擇公司與日期');

            // 1. 收集要上傳的檔案 (維持原邏輯)
            const filesToUpload = [];
            
            // 檢查標準清單
            UPLOAD_ITEMS.forEach(item => {
                const chk = document.getElementById(`chk-${item.code}`);
                const fileInput = document.getElementById(`file-${item.code}`);
                if (chk.checked && fileInput.files[0]) {
                    filesToUpload.push({ code: item.code, file: fileInput.files[0] });
                }
            });
            
            // 檢查 Other
            const chkOther = document.getElementById('chk-other');
            const fileOther = document.getElementById('file-other');
            if (chkOther && chkOther.checked && fileOther.files[0]) {
                filesToUpload.push({ code: 'other', file: fileOther.files[0] });
            }

            if (filesToUpload.length === 0) return alert('請至少勾選並上傳一個檔案');

            // UI 鎖定
            const submitBtn = document.querySelector('button[onclick="saveData()"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>資料上傳中...';

            try {
                // 2. 建立 service_record_staging 資料
                const serviceDescObj = {
                    process_summary: `[${type}] 系統自動建立`,
                    special_note: specialNote // Step 3 備註
                };

                const recordData = {
                    company_id: companyId, 
                    visit_date: visitDate,
                    service_type: type,
                    consultant_id: consultantId, 
                    service_desc: JSON.stringify(serviceDescObj), 
                    status: 'pending',
                    attachment_files: [] 
                };

                // 先 Insert 取得 ID
                const { data: record, error: dbError } = await supabaseClient
                    .from('service_record_staging')
                    .insert([recordData])
                    .select()
                    .single();

                if (dbError) throw dbError;
                const recordId = record.id;
                const year = new Date(visitDate).getFullYear();

                // 3. 執行檔案上傳 (★ 修改點：在此處執行 A~Q 改名)
                const attachments = [];

                for (const item of filesToUpload) {
                    const file = item.file;
                    
                    // --- 改名邏輯開始 ---
                    const fileCode = FILE_CODE_MAP[item.code] || 'Z'; // 將 core 轉為 A
                    const fileExt = file.name.split('.').pop().toLowerCase(); // 取得副檔名
                    const newFileName = `${fileCode}.${fileExt}`; // 例如 A.pdf
                    // --- 改名邏輯結束 ---
                    
                    // 路徑: service_records/2026/record_uuid/A.pdf
                    const filePath = `service_records/${year}/${recordId}/${newFileName}`;

                    const { data: uploadData, error: uploadError } = await supabaseClient.storage
                        .from('staging') 
                        .upload(filePath, file, {
                            cacheControl: '3600',
                            upsert: true
                        });

                    if (uploadError) throw uploadError;

                    // 記錄檔案資訊 (供 Index2/3 讀取)
                    attachments.push({
                        name: newFileName,        // 存入 A.pdf
                        original_name: file.name, // 保留原始檔名 (metadata)
                        code: item.code,          // 保留原始代碼 (metadata)
                        path: filePath,
                        type: file.type
                    });
                }

                // 4. 更新 staging 表的 attachment_files 欄位
                const { error: updateError } = await supabaseClient
                    .from('service_record_staging')
                    .update({ attachment_files: attachments }) 
                    .eq('id', recordId);

                if (updateError) throw updateError;

                alert('✅ 上傳成功！案件已進入審核流程。');
                window.location.reload();

            } catch (e) {
                console.error(e);
                alert('上傳失敗: ' + e.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }
    </script>
</body>
</html>
