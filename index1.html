<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>勞工健康服務資料上傳 | OHSMS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{background:#f5f7fb}
.card{border-radius:12px}
textarea{min-height:120px}
.badge-miss{background:#dc3545}
.badge-ok{background:#198754}
</style>
</head>

<body class="p-4">

<div class="container">
<h3 class="fw-bold mb-3">勞工健康服務資料上傳</h3>
<p class="text-muted">上傳後系統自動填入，可人工校對，確認無誤才送審</p>

<!-- STEP 1 -->
<div class="card p-4 mb-4">
<h5 class="fw-bold">STEP 1｜上傳執行紀錄表</h5>
<input type="file" id="mainFile" accept=".pdf">
<div id="scanWarn" class="alert alert-warning mt-3 d-none">
此檔案為「掃描 PDF」，無法自動填入，請人工補填或改上傳可編輯版本。
</div>
</div>

<!-- STEP 2 -->
<div id="autoFill" class="card p-4 mb-4 d-none">
<h5 class="fw-bold mb-3">STEP 2｜自動填入（可校對）</h5>

<label class="fw-bold">執行日期</label>
<input type="date" id="executionDate" class="form-control mb-3">

<label class="fw-bold">一、作業場所基本資料</label>
<textarea id="sec1" class="form-control mb-3"></textarea>

<label class="fw-bold">二、作業流程與危害概況</label>
<textarea id="sec2" class="form-control mb-3"></textarea>

<label class="fw-bold">三、臨場健康服務執行情形</label>
<textarea id="sec3" class="form-control mb-3"></textarea>

<label class="fw-bold">辦理事項</label>
<div id="itemsArea" class="mb-3"></div>
</div>

<!-- STEP 3 -->
<div id="attachArea" class="card p-4 mb-4 d-none">
<h5 class="fw-bold">STEP 3｜附件上傳（可多檔）</h5>
<input type="file" id="attachFiles" multiple accept=".pdf,.jpg,.png">
<div id="attachCheck" class="mt-3"></div>
</div>

<button id="submitBtn" class="btn btn-primary fw-bold d-none">確認送審</button>

</div>

<script>
/* ===== Supabase ===== */
const db = supabase.createClient(
  'https://ghpxaeenikochgrnczic.supabase.co',
  'sb_publishable_v0ZN2OY08lh-8EC8ps8NdQ_ChYo1FRW'
);

/* ===== DOM ===== */
const mainFile=document.getElementById('mainFile');
const autoFill=document.getElementById('autoFill');
const attachArea=document.getElementById('attachArea');
const scanWarn=document.getElementById('scanWarn');
const itemsArea=document.getElementById('itemsArea');
const attachCheck=document.getElementById('attachCheck');
const submitBtn=document.getElementById('submitBtn');

let ocrText='';
let selectedItems=[];
let attachments=[];

/* ===== PDF 文字擷取 + 掃描判斷 ===== */
async function extractText(file){
 const buf=await file.arrayBuffer();
 const pdf=await pdfjsLib.getDocument({data:buf}).promise;
 let text='';
 for(let i=1;i<=pdf.numPages;i++){
   const page=await pdf.getPage(i);
   const c=await page.getTextContent();
   text+=c.items.map(it=>it.str).join(' ');
 }
 return text.trim();
}

/* ===== Section 擷取 ===== */
function section(text,start,end){
 const s=text.indexOf(start);
 if(s<0)return '';
 const e=end?text.indexOf(end,s+start.length):-1;
 return text.substring(s+start.length,e>0?e:text.length).trim();
}

/* ===== 主檔上傳 ===== */
mainFile.onchange=async()=>{
 if(!mainFile.files[0])return;
 const text=await extractText(mainFile.files[0]);
 if(text.length<50){
   scanWarn.classList.remove('d-none');
   autoFill.classList.remove('d-none');
   attachArea.classList.remove('d-none');
   submitBtn.classList.remove('d-none');
   return;
 }

 ocrText=text;
 autoFill.classList.remove('d-none');
 attachArea.classList.remove('d-none');
 submitBtn.classList.remove('d-none');

 // 日期
 const m=text.match(/(\d{3,4})[\/\-年](\d{1,2})[\/\-月](\d{1,2})/);
 if(m){
   const y=m[1].length===3?Number(m[1])+1911:m[1];
   executionDate.value=`${y}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`;
 }

 sec1.value=section(text,'一、作業場所基本資料','二、');
 sec2.value=section(text,'二、作業流程','三、');
 sec3.value=section(text,'三、臨場','四、');

 const codes=['9-1','9-2','9-3','9-4','9-5','9-6','11-1','11-2','12','13'];
 itemsArea.innerHTML='';
 codes.forEach(c=>{
   const checked=new RegExp(c.replace('-','\\-')).test(text);
   if(checked)selectedItems.push(c);
   itemsArea.innerHTML+=`
    <div class="form-check">
     <input class="form-check-input" type="checkbox" ${checked?'checked':''} data-code="${c}">
     <label class="form-check-label">${c}</label>
    </div>`;
 });
};

/* ===== 附件比對 ===== */
attachFiles.onchange=()=>{
 attachments=[...attachFiles.files];
 renderAttachCheck();
};

function renderAttachCheck(){
 attachCheck.innerHTML='';
 selectedItems.forEach(i=>{
   const ok=attachments.some(f=>f.name.includes(i));
   attachCheck.innerHTML+=`
    <span class="badge ${ok?'badge-ok':'badge-miss'} me-2">
     ${i} ${ok?'✔':'缺附件'}
    </span>`;
 });
}

/* ===== 送審 ===== */
submitBtn.onclick=async()=>{
 for(const i of selectedItems){
   if(!attachments.some(f=>f.name.includes(i))){
     alert(`辦理事項 ${i} 缺附件`);
     return;
   }
 }

 const {data,error}=await db.from('document_staging').insert([{
   uploader_name:sessionStorage.getItem('currentUserName'),
   main_file_name:mainFile.files[0].name,
   main_file_type:'pdf',
   category:'勞工健康服務執行紀錄',
   execution_date:executionDate.value,
   extracted_data:{
     sec1:sec1.value,
     sec2:sec2.value,
     sec3:sec3.value,
     items:selectedItems
   }
 }]).select().single();

 for(const f of attachments){
   await db.from('document_attachments').insert({
     staging_id:data.id,
     file_name:f.name,
     file_type:f.type
   });
 }

 for(const i of selectedItems){
   await db.from('document_item_check').insert({
     staging_id:data.id,
     item_code:i,
     is_checked:true,
     has_attachment:true,
     check_status:'ok'
   });
 }

 alert('已送交暫存審核');
 location.reload();
};
</script>

</body>
</html>
