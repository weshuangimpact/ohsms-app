<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>顧問資料上傳 (Plan/Do) | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary-bg: #f4f6f9; }
        body {
            background-color: var(--primary-bg);
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            display: none; /* Auth Guard */
        }

        /* 保持您原本的 UI 風格設定 */
        .demo-info-card { background-color: #fffbeb; border-left: 4px solid #f59e0b; color: #92400e; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.375rem; font-size: 0.9rem; line-height: 1.6; }
        .section-title { font-weight: bold; color: #495057; border-bottom: 2px solid #e9ecef; padding-bottom: 0.5rem; margin-bottom: 1rem; margin-top: 2rem; }
        .input-readonly { background-color: #e9ecef; cursor: not-allowed; border: 1px solid #ced4da; color: #6c757d; }
        .input-editable { background-color: #fff; border: 1px solid #86b7fe; color: #212529; transition: all 0.3s; }
        .hazard-tag { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 20px; padding: 5px 15px; display: inline-flex; align-items: center; margin-right: 8px; margin-bottom: 8px; }
        .hazard-tag i { color: #dc3545; cursor: pointer; margin-left: 8px; }
        .btn-edit-mode { position: fixed; bottom: 30px; right: 30px; border-radius: 50px; padding: 12px 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; font-weight: bold; }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const role = sessionStorage.getItem('currentUserRole');
            if (!role) {
                alert('請先登入系統');
                window.location.href = 'login.html';
                return;
            }
            document.body.style.display = 'block';
        });
    </script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3 mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold" href="dashboard.html"><i class="fas fa-shield-alt me-2"></i>OHSMS</a>
            <div class="d-flex align-items-center">
                <span class="text-light small me-3">顧問作業系統</span>
                <a href="dashboard.html" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left me-1"></i> 返回儀表板</a>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold text-dark mb-0">1. 作業場所基本資料維護 (Master Data)</h4>
        </div>

        <div class="demo-info-card shadow-sm">
            <strong><i class="fas fa-info-circle me-2"></i>作業說明：</strong>
            此頁面用於維護場所基本資料。您所做的變更將會送至 <strong>「待審核區」</strong>，經主管核准後才會更新至正式資料庫。
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body bg-light">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">事業單位 (Company)</label>
                        <select class="form-select" id="company-select" onchange="loadWorkplaces(this.value)">
                            <option value="">載入中...</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">作業場所 (Workplace)</label>
                        <select class="form-select" id="workplace-select" disabled onchange="loadWorkplaceData(this.value)">
                            <option value="">請先選擇事業單位</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div id="data-area" style="opacity: 0.5; pointer-events: none;">
            
            <h5 class="section-title"><i class="fas fa-users me-2"></i>人數結構與配置</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label small text-muted">行政人員 (男)</label>
                    <input type="number" class="form-control input-readonly edit-field" id="admin-male" readonly>
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted">行政人員 (女)</label>
                    <input type="number" class="form-control input-readonly edit-field" id="admin-female" readonly>
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted">現場作業 (男)</label>
                    <input type="number" class="form-control input-readonly edit-field" id="site-male" readonly>
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted">現場作業 (女)</label>
                    <input type="number" class="form-control input-readonly edit-field" id="site-female" readonly>
                </div>
            </div>

            <h5 class="section-title"><i class="fas fa-biohazard me-2"></i>危害辨識 (Hazard ID)</h5>
            <div class="mb-3">
                <div id="hazard-list" class="mb-2">
                    <span class="text-muted small">尚未載入資料</span>
                </div>
                <div class="input-group mt-2" id="add-hazard-group" style="display:none;">
                    <select class="form-select" id="new-hazard-type">
                        <option value="噪音">噪音</option>
                        <option value="粉塵">粉塵</option>
                        <option value="化學品">化學品</option>
                        <option value="高溫">高溫</option>
                        <option value="游離輻射">游離輻射</option>
                        <option value="人因工程">人因工程</option>
                        <option value="異常氣壓">異常氣壓</option>
                    </select>
                    <button class="btn btn-outline-primary" type="button" onclick="addHazard()">新增危害</button>
                </div>
            </div>

        </div>
    </div>

    <button id="btn-edit-toggle" class="btn btn-secondary btn-edit-mode" onclick="toggleEditMode()" disabled>
        <i class="fas fa-pen-to-square me-1"></i> 啟用編輯
    </button>

    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; text-align: center; padding-top: 20%;">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
        <h4 class="fw-bold text-dark">資料傳輸中...</h4>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentWorkplaceId = null;
        let isEditMode = false;
        let currentHazards = []; 

        // 1. 初始化
        document.addEventListener('DOMContentLoaded', async () => {
            const { data, error } = await supabaseClient.from('companies').select('id, name');
            const select = document.getElementById('company-select');
            if (data) {
                select.innerHTML = '<option value="">請選擇...</option>' + 
                    data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }
        });

        // 2. 載入作業場所
        async function loadWorkplaces(companyId) {
            const wpSelect = document.getElementById('workplace-select');
            wpSelect.innerHTML = '<option value="">載入中...</option>';
            wpSelect.disabled = true;
            resetForm();

            if (!companyId) {
                wpSelect.innerHTML = '<option value="">請先選擇事業單位</option>';
                return;
            }

            const { data } = await supabaseClient.from('workplaces').select('id, department_name').eq('company_id', companyId);
            if (data) {
                wpSelect.innerHTML = '<option value="">請選擇...</option>' + 
                    data.map(w => `<option value="${w.id}">${w.department_name}</option>`).join('');
                wpSelect.disabled = false;
            }
        }

        // 3. 載入詳細資料 (Read-Only)
        async function loadWorkplaceData(workplaceId) {
            if (!workplaceId) {
                resetForm();
                return;
            }
            currentWorkplaceId = workplaceId;
            document.getElementById('loadingOverlay').style.display = 'block';

            try {
                // 讀取 DB 現況
                const { data: wpData } = await supabaseClient.from('workplaces').select('*').eq('id', workplaceId).single();
                const { data: hazardData } = await supabaseClient.from('workplace_hazards').select('hazard_type').eq('workplace_id', workplaceId);

                if (wpData) {
                    document.getElementById('admin-male').value = wpData.admin_male || 0;
                    document.getElementById('admin-female').value = wpData.admin_female || 0;
                    document.getElementById('site-male').value = wpData.site_male || 0;
                    document.getElementById('site-female').value = wpData.site_female || 0;
                }

                currentHazards = hazardData ? hazardData.map(h => h.hazard_type) : [];
                renderHazards();

                // 解鎖介面 (唯讀狀態)
                document.getElementById('data-area').style.opacity = '1';
                document.getElementById('data-area').style.pointerEvents = 'auto'; 
                document.getElementById('btn-edit-toggle').disabled = false;

            } catch (e) {
                alert('載入失敗');
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        // 4. 切換編輯模式 / 儲存 (關鍵邏輯修改)
        function toggleEditMode() {
            const btn = document.getElementById('btn-edit-toggle');
            const inputs = document.querySelectorAll('.edit-field');
            const addGroup = document.getElementById('add-hazard-group');

            if (!isEditMode) {
                // [進入編輯]：UI 變更為可輸入
                isEditMode = true;
                inputs.forEach(el => {
                    el.readOnly = false;
                    el.classList.replace('input-readonly', 'input-editable');
                });
                addGroup.style.display = 'flex';
                renderHazards(); // 重繪以顯示刪除按鈕
                
                btn.innerHTML = '<i class="fas fa-paper-plane me-1"></i> 提交審核';
                btn.classList.replace('btn-secondary', 'btn-primary');
            } else {
                // [執行儲存]：呼叫暫存區寫入函式
                saveToStaging();
            }
        }

        // 5. ★ 寫入暫存表 (Staging) 邏輯
        async function saveToStaging() {
            if (!confirm('確定要提交變更嗎？\n資料將送至待審核區 (Staging)，待主管核准後生效。')) return;

            document.getElementById('loadingOverlay').style.display = 'block';
            const btn = document.getElementById('btn-edit-toggle');

            try {
                // 5a. 收集表單資料
                const payload = {
                    admin_male: parseInt(document.getElementById('admin-male').value),
                    admin_female: parseInt(document.getElementById('admin-female').value),
                    site_male: parseInt(document.getElementById('site-male').value),
                    site_female: parseInt(document.getElementById('site-female').value),
                    hazards: currentHazards
                };

                // 5b. 製作人類可讀的摘要
                const summary = `基本資料變更申請：
- 人數：行政(男${payload.admin_male}/女${payload.admin_female})、現場(男${payload.site_male}/女${payload.site_female})
- 危害：${currentHazards.join(', ') || '無'}`;

                // 5c. 取得 User ID
                const { data: { user } } = await supabaseClient.auth.getUser();

                // 5d. 寫入 service_record_staging
                // 注意：這裡將詳細資料打包成 JSON 放在 service_desc 中，方便後續審核介面解析
                const { error } = await supabaseClient.from('service_record_staging').insert({
                    workplace_id: currentWorkplaceId,
                    submitter_id: user ? user.id : null,
                    service_date: new Date(),
                    service_type: '基本資料維護',
                    service_desc: JSON.stringify(payload), // 將 JSON 存入文字欄位 (或您有開 payload 欄位則存入 payload)
                    status: 'pending' // 待審核
                });

                if (error) throw error;

                alert('✅ 申請已送出！\n主管審核通過後，資料庫將自動更新。');
                
                // 5e. 還原 UI (重新載入舊資料，證明尚未直接修改 DB)
                isEditMode = false;
                const inputs = document.querySelectorAll('.edit-field');
                inputs.forEach(el => {
                    el.readOnly = true;
                    el.classList.replace('input-editable', 'input-readonly');
                });
                document.getElementById('add-hazard-group').style.display = 'none';
                
                btn.innerHTML = '<i class="fas fa-pen-to-square me-1"></i> 啟用編輯';
                btn.classList.replace('btn-primary', 'btn-secondary');
                
                loadWorkplaceData(currentWorkplaceId); // 重新載入，畫面會跳回原本的數值

            } catch (e) {
                console.error(e);
                alert('提交失敗: ' + e.message);
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        // 6. 危害操作 (UI 邏輯)
        function renderHazards() {
            const container = document.getElementById('hazard-list');
            if (currentHazards.length === 0) {
                container.innerHTML = '<span class="text-muted small">無危害資料</span>';
                return;
            }
            
            container.innerHTML = currentHazards.map((h, index) => `
                <span class="hazard-tag">
                    ${h}
                    ${isEditMode ? `<i class="fas fa-times" onclick="removeHazard(${index})"></i>` : ''}
                </span>
            `).join('');
        }

        function addHazard() {
            const val = document.getElementById('new-hazard-type').value;
            if (!currentHazards.includes(val)) {
                currentHazards.push(val);
                renderHazards();
            }
        }

        function removeHazard(index) {
            currentHazards.splice(index, 1);
            renderHazards();
        }

        function resetForm() {
            document.getElementById('admin-male').value = '';
            document.getElementById('admin-female').value = '';
            document.getElementById('site-male').value = '';
            document.getElementById('site-female').value = '';
            document.getElementById('hazard-list').innerHTML = '<span class="text-muted small">尚未載入資料</span>';
            document.getElementById('data-area').style.opacity = '0.5';
            document.getElementById('data-area').style.pointerEvents = 'none';
            document.getElementById('btn-edit-toggle').disabled = true;
        }
    </script>
</body>
</html>
