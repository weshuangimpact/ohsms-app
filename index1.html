<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>服務執行歷程管理 (Plan/Do) | OHACSS</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<style>
/* =========================================
   1. 統一頁首/頁尾 CSS 設定 (內頁專用 / 高度統一版)
   ========================================= */
html, body {
height: 100%;
}

body {
display: none; /* 權限驗證前先隱藏，JS 載入後改為 flex */
flex-direction: column;
min-height: 100vh;
background-color: #f8f9fa; /* 預設背景色 */
font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
}

/* 內容區塊自動撐開 */
.container, .main-content {
    flex: 1; 
    max-width: 100% !important; 
    padding-left: 1.5rem !important; 
    padding-right: 1.5rem !important;
}

/* 頁首設定 */
.navbar {
background-color: #202124 !important;
min-height: 85px; /* [修正] 統一高度為 85px */
color: #fff;
flex-shrink: 0;
}

/* 頁尾設定 */
footer {
background-color: #202124 !important;
color: #fff;
flex-shrink: 0;
font-size: 0.9rem;
letter-spacing: 0.5px;
display: flex;
flex-direction: column; /* 垂直排列 */
align-items: center;
justify-content: center;
margin-top: auto;
padding: 15px 0;
min-height: 85px; /* 雙行高度 */
}

/* =========================================
   2. 統一標題與字卡 CSS 設定 (Do Blue)
   ========================================= */
:root { 
    --primary-bg: #f4f6f9; 
    --theme-color: #0d6efd; /* Do 階段的主題藍色 */
}

/* PDCA 字卡 (白色區塊) 設定 */
.instruction-box {
    background-color: #fff; /* 白色背景 */
    border-left: 5px solid var(--theme-color); /* 左側主題色飾條 */
    padding: 20px 25px; /* 內距 */
    border-radius: 4px; /* 圓角 */
    margin-bottom: 30px; /* 下方留白 */
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* 輕微陰影 */
    width: 100%;
    text-align: left;
}

/* PDCA 字卡標題設定 */
.instruction-title {
    color: var(--theme-color); /* 字體顏色跟隨主題色 */
    font-weight: 700; /* 粗體 */
    margin-bottom: 10px; /* 與內文的間距 */
}

/* =========================================
   3. 既有功能 UI 設定 (保留不變)
   ========================================= */
.section-title { border-left: 5px solid var(--theme-color); padding-left: 15px; margin-bottom: 20px; }
.form-section { background-color: #fff; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075); margin-bottom: 2rem; }
.file-upload-area { border: 2px dashed #dee2e6; border-radius: 0.5rem; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s ease; background-color: #f8f9fa; }
.file-upload-area:hover { border-color: var(--theme-color); background-color: #e9ecef; }
.file-list-item { background-color: #f8f9fa; border-radius: 0.25rem; padding: 0.5rem 1rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }

/* 改善紀錄區塊樣式 */
.improvement-history-item {
    border-left: 3px solid #198754;
    background-color: #f1f8f5;
    padding: 10px 15px;
    margin-bottom: 10px;
    border-radius: 0 4px 4px 0;
}
.improvement-timestamp {
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: bold;
    margin-bottom: 5px;
    display: block;
}
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark px-4">
    <div class="container-fluid d-flex justify-content-between align-items-center p-0">
        <a class="navbar-brand d-flex align-items-center fw-bold" href="dashboard.html">
            <i class="fas fa-shield-alt me-2"></i>
            OHACSS 職業健康評鑑與合規支援系統
        </a>

        <div class="d-flex align-items-center">
            <span class="text-white me-3 small" id="header-date">
                <i class="fas fa-spinner fa-spin"></i>
            </span>
            
            <span class="text-white me-4 small border-start ps-3 border-secondary" id="header-clock" style="opacity: 0.9;">
                --:--
            </span>
            
            <span class="text-white me-4 fw-bold" id="header-user">
                Hi! 使用者
            </span>
            
            <a class="btn btn-outline-light btn-sm me-2" href="dashboard.html">
                <i class="fas fa-reply me-1"></i>回到儀表板
            </a>
            
            <button class="btn btn-outline-light btn-sm" onclick="logoutSystem()">
                <i class="fas fa-sign-out-alt me-1"></i>登出
            </button>
        </div>
    </div>
</nav>

<div class="container main-content mt-4 pb-5">
    
    <div class="mb-4">
        <h2 class="fw-bold text-dark mb-1">服務執行歷程管理 (Plan/Do)</h2>
        <p class="text-secondary">臨場服務紀錄填報與歷程追蹤</p>
    </div>

    <div class="instruction-box">
        <div class="instruction-title">
            <i class="fas fa-tasks me-2"></i>PDCA 設計理念：Plan（計畫）與 Do（執行）—— 資料與行動的整合
        </div>
        <p class="mb-0 text-dark" style="line-height: 1.6;">
            本模組為 PDCA 循環中的執行核心，系統自動載入規劃階段（Plan）的企業需求與預定排程。顧問在此介面落實執行（Do），上傳訪視紀錄、照片及相關佐證，並即時針對現場狀況進行回饋。
        </p>
    </div>

    <div class="form-section">
        <h5 class="section-title"><i class="fas fa-info-circle me-2"></i>本次服務資訊 (Plan Data)</h5>
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label text-muted">企業名稱</label>
                <input type="text" class="form-control bg-light" id="company-name" readonly>
            </div>
            <div class="col-md-4">
                <label class="form-label text-muted">服務顧問</label>
                <input type="text" class="form-control bg-light" id="consultant-name" readonly>
            </div>
            <div class="col-md-4">
                <label class="form-label text-muted">預定日期</label>
                <input type="date" class="form-control bg-light" id="service-date" readonly>
            </div>
        </div>
    </div>

    <div class="form-section">
        <h5 class="section-title"><i class="fas fa-edit me-2"></i>執行內容填報 (Execution Log)</h5>
        
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <label class="form-label fw-bold">實際訪視日期 <span class="text-danger">*</span></label>
                <input type="date" class="form-control" id="visit-date">
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold">開始時間 <span class="text-danger">*</span></label>
                <input type="time" class="form-control" id="start-time">
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold">結束時間 <span class="text-danger">*</span></label>
                <input type="time" class="form-control" id="end-time">
            </div>
        </div>

        <div class="mb-4">
            <label class="form-label fw-bold">本次服務類型 <span class="text-danger">*</span></label>
            <select class="form-select" id="service-type">
                <option value="" selected disabled>請選擇服務類型...</option>
                <option value="臨場健康服務">臨場健康服務</option>
                <option value="職業病預防">職業病預防</option>
                <option value="健康促進活動">健康促進活動</option>
                <option value="急救人員訓練">急救人員訓練</option>
                <option value="其他">其他</option>
            </select>
        </div>

        <div class="mb-4">
            <label class="form-label fw-bold">執行項目勾選 (多選) <span class="text-danger">*</span></label>
            <div class="card p-3 bg-light border-0">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" value="main" id="check-main">
                    <label class="form-check-label" for="check-main">主要訪視與巡檢</label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" value="9-1" id="check-9-1">
                    <label class="form-check-label" for="check-9-1">9-1 異常工作負荷促發疾病預防</label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" value="9-2" id="check-9-2">
                    <label class="form-check-label" for="check-9-2">9-2 人因性危害預防</label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" value="9-3" id="check-9-3">
                    <label class="form-check-label" for="check-9-3">9-3 母性健康保護</label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" value="other" id="check-other" onchange="toggleOtherInput()">
                    <label class="form-check-label" for="check-other">其他事項</label>
                </div>
                <input type="text" class="form-control mt-2 d-none" id="other-specify" placeholder="請說明其他事項...">
            </div>
        </div>

        <div class="card border-success mb-4" id="improvement-section">
            <div class="card-header bg-success text-white fw-bold">
                <i class="fas fa-tools me-2"></i>PDCA 改善作業紀錄 / 補件回覆 (Correction Log)
            </div>
            <div class="card-body">
                <div id="improvement-history-list" class="mb-3">
                    </div>

                <label class="form-label fw-bold text-success">
                    <i class="fas fa-pen me-1"></i>本次改善說明 / 針對主管要求之回覆：
                </label>
                <textarea class="form-control border-success" id="current-improvement-note" rows="3" placeholder="請在此說明您針對本次補件要求做了哪些改善或修正 (例如：已補上缺漏的附件A)..."></textarea>
                <div class="form-text text-muted">
                    <i class="fas fa-info-circle me-1"></i>若此為補件重送，請務必填寫此欄位，系統將會記錄時間戳記供主管查核。
                </div>
            </div>
        </div>

        <div class="mb-4">
            <label class="form-label fw-bold">特殊事項備註 / 允許結案理由 (選填)</label>
            <textarea class="form-control" id="user-remark" rows="3" placeholder="例如：因工廠歲修，部分區域無法進入..."></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">佐證資料上傳 (Evidence Upload)</label>
            <div class="file-upload-area" id="drop-zone">
                <i class="fas fa-cloud-upload-alt fa-3x text-secondary mb-3"></i>
                <p class="mb-1 text-dark fw-bold">點擊或拖這檔案至此處上傳</p>
                <p class="text-muted small">支援 PDF, JPG, PNG (單檔限 10MB)</p>
                <input type="file" id="file-input" multiple hidden accept=".pdf,.jpg,.jpeg,.png">
            </div>
            <div id="file-list" class="mt-3"></div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-5">
            <button class="btn btn-secondary px-4" onclick="window.location.href='dashboard.html'">取消</button>
            <button class="btn btn-primary px-4 fw-bold" onclick="submitRecord()">
                <i class="fas fa-save me-2"></i>暫存並提交審查 (Save)
            </button>
        </div>
    </div>

</div>

<footer>
    <div class="mb-1">可信智慧整合有限公司 42917004</div>
    <div class="small opacity-75" style="font-family: 'Segoe UI', sans-serif; letter-spacing: 1px;">
        WesmartAI , Making Trust Transparent.
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // ==========================================
    // 統一頁首與系統初始化邏輯
    // ==========================================
    document.addEventListener('DOMContentLoaded', function() {
        document.body.style.display = 'flex';

        setInterval(() => {
            const now = new Date();
            const clockEl = document.getElementById('header-clock');
            if(clockEl) clockEl.textContent = now.toLocaleTimeString('zh-TW', { hour12: false });
        }, 1000);

        const dateEl = document.getElementById('header-date');
        if(dateEl) {
            const now = new Date();
            const days = ['日', '一', '二', '三', '四', '五', '六'];
            const formattedDate = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}(${days[now.getDay()]})`;
            dateEl.innerHTML = `<i class="far fa-calendar-alt me-1"></i>今日是 ${formattedDate}`;
        }

        const role = sessionStorage.getItem('currentUserRole') || 'admin';
        const userName = sessionStorage.getItem('currentUserName') || '使用者';
        const userEl = document.getElementById('header-user');
        if(userEl) userEl.innerText = `Hi! ${userName}`;

        initPage();
    });

    function logoutSystem() {
        if(confirm('確定要登出系統嗎？')) {
            sessionStorage.clear();
            window.location.href = 'login.html';
        }
    }

    // ==========================================
    // Index1 專屬邏輯 (保留並整合)
    // ==========================================
    const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh'; 
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentRecordId = null;
    let currentStagingId = null; 
    let currentCaseNumber = null;
    let recordData = {}; 
    let uploadedFiles = []; 
    let existingImprovementRecords = []; // 儲存已有的改善歷史

    async function initPage() {
        const params = new URLSearchParams(window.location.search);
        currentRecordId = params.get('id');

        if (!currentRecordId) {
            Swal.fire('錯誤', '無效的服務紀錄 ID', 'error').then(() => window.location.href = 'dashboard.html');
            return;
        }

        await loadDraft(); 
        setupFileUpload();
    }

    // [核心邏輯修正] 優先讀取 Staging，若無則讀取原始 Record
    async function loadDraft() {
        try {
            // 1. 先找 Staging (暫存/被退回)
            const { data: staging, error: stagingError } = await supabaseClient
                .from('service_record_staging')
                .select('*')
                .eq('origin_record_id', currentRecordId)
                .maybeSingle(); // 使用 maybeSingle 避免 0 筆時報錯

            if (staging) {
                console.log("Loading from Staging...");
                currentStagingId = staging.id;
                currentCaseNumber = staging.case_number;
                
                // 檢查是否被退回 (Correction Requested)
                if (staging.status === 'correction_requested') {
                    checkCorrectionStatus(staging);
                }

                // 載入改善歷程
                existingImprovementRecords = staging.improvement_records || [];
                renderImprovementHistory();

                // 填入 Staging 資料
                // 注意：origin_record_id 關聯回 service_records 拿公司名稱等靜態資料
                const { data: original } = await supabaseClient
                    .from('service_records')
                    .select('*, workplaces(companies(name)), medical_staff(name)')
                    .eq('id', currentRecordId)
                    .single();
                
                if (original) {
                    fillBasicInfo(original);
                    recordData = original; 
                }

                // 填回表單
                document.getElementById('visit-date').value = staging.visit_date || '';
                document.getElementById('start-time').value = staging.start_time || '';
                document.getElementById('end-time').value = staging.end_time || '';
                document.getElementById('service-type').value = staging.service_type || '';
                
                // 解析 service_desc
                if (staging.service_desc) {
                    try {
                        const desc = JSON.parse(staging.service_desc);
                        document.getElementById('user-remark').value = desc.user_remark || '';
                        // 勾選項目
                        if (desc.items && Array.isArray(desc.items)) {
                            desc.items.forEach(val => {
                                if (val.startsWith('other-')) { // other-SpecificText
                                    document.getElementById('check-other').checked = true;
                                    document.getElementById('other-specify').classList.remove('d-none');
                                    document.getElementById('other-specify').value = val.replace('other-', '');
                                } else {
                                    const cb = document.querySelector(`input[type="checkbox"][value="${val}"]`);
                                    if (cb) cb.checked = true;
                                }
                            });
                        }
                    } catch(e) { console.error('JSON parse error', e); }
                }

                // 載入檔案列表
                if (staging.attachment_files) {
                    let files = staging.attachment_files;
                    if (typeof files === 'string') {
                        try { files = JSON.parse(files); } catch(e) { files = []; }
                    }
                    if (Array.isArray(files)) {
                        uploadedFiles = files; // 存入全域變數
                        renderFileList();
                    }
                }

            } else {
                // 2. 若無 Staging，讀取原始 service_records (第一次填寫)
                console.log("Loading new record...");
                const { data: original, error: originalError } = await supabaseClient
                    .from('service_records')
                    .select('*, workplaces(companies(name)), medical_staff(name)')
                    .eq('id', currentRecordId)
                    .single();

                if (originalError || !original) throw new Error('無法讀取服務紀錄');

                recordData = original;
                fillBasicInfo(original);
                
                // 預設帶入 Plan 的日期
                if (original.visit_date) document.getElementById('visit-date').value = original.visit_date;
                if (original.start_time) document.getElementById('start-time').value = original.start_time;
                if (original.end_time) document.getElementById('end-time').value = original.end_time;
            }

        } catch (err) {
            console.error(err);
            Swal.fire('讀取失敗', err.message, 'error');
        }
    }

    function fillBasicInfo(data) {
        document.getElementById('company-name').value = data.workplaces?.companies?.name || '未知企業';
        document.getElementById('consultant-name').value = data.medical_staff?.name || '未知顧問';
        document.getElementById('service-date').value = data.visit_date || '';
    }

    function toggleOtherInput() {
        const otherCheck = document.getElementById('check-other');
        const otherInput = document.getElementById('other-specify');
        if (otherCheck.checked) {
            otherInput.classList.remove('d-none');
        } else {
            otherInput.classList.add('d-none');
            otherInput.value = '';
        }
    }

    function checkCorrectionStatus(staging) {
        if (staging.reviewer_comment) {
            Swal.fire({
                title: '主管要求補件',
                html: `
                    <div class="text-start alert alert-warning">
                        <strong><i class="fas fa-exclamation-triangle me-1"></i>需補正原因：</strong><br>
                        ${staging.reviewer_comment}
                    </div>
                    <p class="small text-muted">請依據上述原因修正內容或補齊附件後，於下方「改善作業紀錄」說明並再次提交。</p>
                `,
                icon: 'warning',
                confirmButtonText: '收到，我會進行修正',
                confirmButtonColor: '#d33'
            });
        }
    }

    // 渲染改善歷程列表
    function renderImprovementHistory() {
        const container = document.getElementById('improvement-history-list');
        container.innerHTML = '';

        if (existingImprovementRecords.length === 0) {
            container.innerHTML = '<span class="text-muted small ms-2">尚無改善紀錄</span>';
            return;
        }

        existingImprovementRecords.forEach((record, index) => {
            const item = document.createElement('div');
            item.className = 'improvement-history-item animate__animated animate__fadeIn';
            item.innerHTML = `
                <span class="improvement-timestamp"><i class="far fa-clock me-1"></i>${record.date}</span>
                <div class="text-dark">${record.content}</div>
            `;
            container.appendChild(item);
        });
    }

    // ==========================================
    // 檔案上傳邏輯 (模擬與整合)
    // ==========================================
    function setupFileUpload() {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = '#e9ecef';
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.style.backgroundColor = '#f8f9fa';
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = '#f8f9fa';
            handleFiles(e.dataTransfer.files);
        });
    }

    async function handleFiles(files) {
        if (!files.length) return;
        
        // 如果還沒有 staging ID，先產生一個臨時的 UUID 作為資料夾 (或直接存檔後再上傳)
        // 為了簡化，這裡假設上傳即會觸發 Supabase Storage Upload
        // 實際作法通常是 File Object 存 Array，按 Submit 才真的 Upload。
        // 但為了符合 "index1" 原本可能有的邏輯，這裡採用 "先加入列表，Submit 時上傳" 的模式。

        const userId = sessionStorage.getItem('currentUserId');
        
        for (let file of files) {
            if (file.size > 10 * 1024 * 1024) {
                alert(`檔案 ${file.name} 超過 10MB`);
                continue;
            }
            // 暫存 file object (尚未上傳)
            // 這裡為了 UI 顯示，先模擬結構
            uploadedFiles.push({
                name: file.name,
                fileObj: file, // 重要：保留原始檔案物件以便上傳
                size: file.size,
                type: file.type,
                path: '' // 尚未上傳
            });
        }
        renderFileList();
    }

    function renderFileList() {
        const list = document.getElementById('file-list');
        list.innerHTML = '';
        uploadedFiles.forEach((f, idx) => {
            const div = document.createElement('div');
            div.className = 'file-list-item';
            
            // 判斷是新檔案(有 fileObj) 還是舊檔案 (有 path)
            const isNew = !!f.fileObj;
            const badge = isNew ? '<span class="badge bg-info text-dark ms-2">待上傳</span>' : '<span class="badge bg-success ms-2">已存檔</span>';

            div.innerHTML = `
                <div>
                    <i class="far fa-file-alt me-2 text-secondary"></i>
                    ${f.name}
                    ${badge}
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="removeFile(${idx})"><i class="fas fa-times"></i></button>
            `;
            list.appendChild(div);
        });
    }

    window.removeFile = function(idx) {
        uploadedFiles.splice(idx, 1);
        renderFileList();
    }

    // ==========================================
    // 存檔與提交 (Submit)
    // ==========================================
    async function submitRecord() {
        const visitDate = document.getElementById('visit-date').value;
        const startTime = document.getElementById('start-time').value;
        const endTime = document.getElementById('end-time').value;
        const serviceType = document.getElementById('service-type').value;
        const remark = document.getElementById('user-remark').value;
        const currentImprovement = document.getElementById('current-improvement-note').value.trim();

        if (!visitDate || !startTime || !endTime || !serviceType) {
            return Swal.fire('欄位未填', '請填寫必填欄位 (日期、時間、類型)', 'warning');
        }

        // 收集勾選項目
        const selectedItems = [];
        ['main', '9-1', '9-2', '9-3', 'other'].forEach(id => {
            if (document.getElementById(`check-${id}`).checked) {
                if (id === 'other') {
                    const otherText = document.getElementById('other-specify').value;
                    selectedItems.push(`other-${otherText}`);
                } else {
                    selectedItems.push(id);
                }
            }
        });

        // 處理改善歷程 (Push New Record)
        let newImprovementRecords = [...existingImprovementRecords];
        if (currentImprovement) {
            const nowStr = new Date().toLocaleString('zh-TW', { hour12: false });
            newImprovementRecords.push({
                date: nowStr,
                content: currentImprovement
            });
        }

        Swal.fire({
            title: '處理中...',
            text: '正在上傳檔案並儲存...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            const userId = sessionStorage.getItem('currentUserId') || 'unknown'; // 實際上應從 Auth 拿

            // 1. 如果有新檔案，先執行上傳
            // 若是第一次存檔，沒有 staging ID，先產生 UUID? 
            // Supabase 建議先 Insert 拿 ID 再 Upload，或是前端先產 UUID。
            // 這裡採用：如果沒有 currentStagingId，先產一個 UUID 給 Folder 用
            if (!currentStagingId) {
                // 簡單作法：先 Insert 一筆空的拿 ID (或用 crypto.randomUUID)
                currentStagingId = crypto.randomUUID(); 
            }

            const attachments = [];
            for (let f of uploadedFiles) {
                if (f.fileObj) {
                    // 需要上傳
                    const fileExt = f.name.split('.').pop();
                    const fileName = `Upload_${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
                    const filePath = `${currentStagingId}/${fileName}`;
                    
                    const { error: uploadError } = await supabaseClient.storage
                        .from('staging')
                        .upload(filePath, f.fileObj);
                    
                    if (uploadError) throw uploadError;
                    
                    attachments.push({
                        name: f.name,
                        path: filePath,
                        type: f.type,
                        size: f.size
                    });
                } else {
                    // 既有檔案
                    attachments.push(f);
                }
            }

            // 2. 準備 Payload
            // 產生案號 (如果沒有)
            let finalCaseNumber = currentCaseNumber;
            if (!finalCaseNumber) {
                const now = new Date();
                const dateStr = now.getFullYear().toString() + (now.getMonth() + 1).toString().padStart(2, '0') + now.getDate().toString().padStart(2, '0');
                const randomSeq = String(Date.now()).slice(-3);
                finalCaseNumber = `SR-${dateStr}-${randomSeq}`;
                currentCaseNumber = finalCaseNumber;
            }

            const payload = {
                id: currentStagingId, 
                origin_record_id: currentRecordId,
                workplace_id: recordData.workplace_id,
                submitter_id: userId,
                consultant_id: recordData.consultant_id,
                service_year: recordData.service_year,
                
                service_date: visitDate, 
                visit_date: visitDate,   
                start_time: startTime,
                end_time: endTime,

                service_type: serviceType, 
                service_desc: JSON.stringify({
                    items: selectedItems, 
                    note: '由顧問端上傳之執行紀錄',
                    user_remark: remark 
                }),
                attachment_files: attachments,
                case_number: finalCaseNumber,
                status: 'pending', // [關鍵] 每次提交都重置為 pending，讓主管重審
                improvement_records: newImprovementRecords, // [新增] 寫入改善歷程 JSONB
                updated_at: new Date()
            };

            // 3. 寫入 Staging
            const { error } = await supabaseClient.from('service_record_staging').upsert(payload);
            if (error) throw error;

            // 4. [修正] 將剛才產生的 ID 寫回全域變數，避免重複 Insert
            // (因 upsert 若 ID 存在會 update)
            // 這裡已經用了 currentStagingId，邏輯正確。

            await Swal.fire('提交成功', '紀錄已送出審查', 'success');
            window.location.href = 'dashboard.html';

        } catch (err) {
            console.error(err);
            Swal.fire('儲存失敗', err.message, 'error');
        }
    }

</script>
</body>
</html>
