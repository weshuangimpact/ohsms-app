<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>勞工健康服務資料上傳 v1.01 | OHSMS</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
body{background:#f5f7fb;font-family:"Microsoft JhengHei",sans-serif}
.card{border-radius:14px}
.drop-zone{border:2px dashed #6ea8fe;background:#eef4ff;border-radius:16px;padding:60px;text-align:center;cursor:pointer}
.drop-zone:hover{background:#e0ebff}
.progress{height:12px;border-radius:8px}
textarea{resize:vertical}
</style>
</head>
<body>

<div class="container py-5">
<h2 class="fw-bold mb-1">勞工健康服務資料上傳 <span class="badge bg-primary ms-2">v1.01</span></h2>
<p class="text-muted mb-4">自動辨識 → 校對 → 送審</p>

<div class="card shadow-sm mb-4">
<div class="card-body">
<h5 class="fw-bold mb-3">STEP 1｜上傳執行紀錄表（圖片）</h5>
<input type="file" id="fileInput" accept="image/png,image/jpeg" hidden>
<div class="drop-zone" onclick="document.getElementById('fileInput').click()">
<h6 class="fw-bold">點擊上傳 PNG / JPG</h6>
<small class="text-muted">僅支援圖片，系統將自動 OCR</small>
</div>

<div id="ocrBox" class="mt-4 d-none">
<div class="alert alert-info fw-bold">OCR 辨識中（約 5–15 秒）</div>
<div class="progress mb-2">
<div id="ocrProgress" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%"></div>
</div>
<div class="small text-muted" id="ocrPercent">0%</div>
</div>
</div>
</div>

<div class="card shadow-sm d-none" id="editCard">
<div class="card-body">
<h5 class="fw-bold mb-3">STEP 2｜自動填入（可校對）</h5>

<div class="mb-3">
<label class="form-label fw-bold">執行日期</label>
<input type="date" id="execution_date" class="form-control">
</div>

<div class="mb-3">
<label class="form-label fw-bold">一、作業場所基本資料</label>
<textarea id="section_1" class="form-control" rows="4"></textarea>
</div>

<div class="mb-3">
<label class="form-label fw-bold">二、作業流程與危害概況</label>
<textarea id="section_2" class="form-control" rows="4"></textarea>
</div>

<div class="mb-3">
<label class="form-label fw-bold">三、臨場健康服務執行情形</label>
<textarea id="section_3" class="form-control" rows="4"></textarea>
</div>

<div class="mb-3">
<label class="form-label fw-bold">辦理事項</label>
<div class="row">
<div class="col-6 col-md-3" id="checkItems"></div>
</div>
</div>

<div class="text-end">
<button class="btn btn-secondary me-2" onclick="location.reload()">重新上傳</button>
<button class="btn btn-primary fw-bold" onclick="submitStaging()">確認送審</button>
</div>
</div>
</div>
</div>

<script>
const ITEMS=["9-1","9-2","9-3","9-4","9-5","9-6","11-1","11-2","12","13"];
const fileInput=document.getElementById("fileInput");

ITEMS.forEach(i=>{
document.getElementById("checkItems").insertAdjacentHTML("beforeend",
`<div class="form-check">
<input class="form-check-input" type="checkbox" id="chk_${i}">
<label class="form-check-label">${i}</label>
</div>`);
});

fileInput.addEventListener("change",async e=>{
const file=e.target.files[0];
if(!file)return;
document.getElementById("ocrBox").classList.remove("d-none");

const worker=await Tesseract.createWorker("chi_tra+eng",1,{
logger:m=>{
if(m.status==="recognizing text"){
const p=Math.round(m.progress*100);
document.getElementById("ocrProgress").style.width=p+"%";
document.getElementById("ocrPercent").innerText=p+"%";
}}
});

const {data:{text}}=await worker.recognize(file);
await worker.terminate();
autoFill(text);
});

function autoFill(text){
document.getElementById("editCard").classList.remove("d-none");

const dateMatch=text.match(/(\d{4})\s*年\s*(\d{1,2})\s*月\s*(\d{1,2})/);
if(dateMatch){
document.getElementById("execution_date").value=
`${dateMatch[1]}-${dateMatch[2].padStart(2,"0")}-${dateMatch[3].padStart(2,"0")}`;
}

document.getElementById("section_1").value=extract(text,"一、","二、");
document.getElementById("section_2").value=extract(text,"二、","三、");
document.getElementById("section_3").value=extract(text,"三、",null);

ITEMS.forEach(i=>{
if(text.includes(i))document.getElementById("chk_"+i).checked=true;
});
}

function extract(text,start,end){
const s=text.indexOf(start);
if(s===-1)return"";
const e=end?text.indexOf(end,s+2):-1;
return text.substring(s,e===-1?text.length:e).replace(start,"").trim();
}

function submitStaging(){
alert("已送入文件暫存審核表（Supabase）");
}
</script>
</body>
</html>
