<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>勞工健康服務資料上傳 | OHSMS</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  background:linear-gradient(135deg,#f0f7ff,#f9fbff);
  font-family:'Segoe UI','Microsoft JhengHei',sans-serif;
}
.hero{
  background:linear-gradient(120deg,#2563eb,#3b82f6);
  color:#fff;
  border-radius:18px;
  padding:32px;
  margin-bottom:32px;
}
.step-card{
  border-radius:18px;
  border:none;
  box-shadow:0 10px 30px rgba(0,0,0,.08);
}
.upload-zone{
  border:2px dashed #60a5fa;
  border-radius:16px;
  padding:48px;
  text-align:center;
  background:#f0f7ff;
  cursor:pointer;
  transition:.3s;
}
.upload-zone:hover{
  background:#e0ecff;
  transform:translateY(-4px);
}
.upload-icon{
  width:80px;
  height:80px;
  border-radius:50%;
  background:#2563eb;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:36px;
  margin:0 auto 16px;
}
.step-title{
  font-weight:800;
  letter-spacing:.5px;
}
textarea{
  min-height:110px;
}
.badge-step{
  background:#2563eb;
  font-size:.8rem;
}
.check-grid label{
  cursor:pointer;
}
.footer-bar{
  position:sticky;
  bottom:0;
  background:#fff;
  padding:16px;
  border-top:1px solid #e5e7eb;
}
</style>
</head>

<body>

<div class="container py-5">

<div class="hero">
  <h2 class="fw-bold mb-1"><i class="fa-solid fa-file-shield me-2"></i>勞工健康服務資料上傳</h2>
  <p class="mb-0 opacity-75">自動辨識 → 人工校對 → 送交審查</p>
</div>

<!-- STEP 1 -->
<div class="card step-card mb-4">
  <div class="card-body p-5">
    <span class="badge badge-step mb-3">STEP 1</span>
    <h5 class="step-title mb-4">上傳勞工健康服務執行紀錄表</h5>

    <div class="upload-zone" onclick="document.getElementById('file').click()">
      <div class="upload-icon"><i class="fa-solid fa-cloud-arrow-up"></i></div>
      <h6 class="fw-bold">點擊上傳 PDF / 圖檔</h6>
      <small class="text-muted">系統將自動 OCR 辨識</small>
    </div>

    <input type="file" id="file" accept=".pdf,.jpg,.png" hidden>
    <div id="loading" class="alert alert-info mt-4 d-none">
      <i class="fa-solid fa-spinner fa-spin me-2"></i>OCR 辨識中，請稍候…
    </div>
  </div>
</div>

<!-- STEP 2 -->
<div id="step2" class="card step-card mb-5 d-none">
  <div class="card-body p-5">
    <span class="badge badge-step mb-3">STEP 2</span>
    <h5 class="step-title mb-4">自動填入（可校對）</h5>

    <label class="form-label fw-bold">執行日期</label>
    <input type="date" id="execDate" class="form-control mb-3">

    <label class="form-label fw-bold">一、作業場所基本資料</label>
    <textarea id="sec1" class="form-control mb-3"></textarea>

    <label class="form-label fw-bold">二、作業流程與危害概況</label>
    <textarea id="sec2" class="form-control mb-3"></textarea>

    <label class="form-label fw-bold">三、臨場健康服務執行情形</label>
    <textarea id="sec3" class="form-control mb-4"></textarea>

    <label class="form-label fw-bold mb-2">辦理事項</label>
    <div class="row check-grid" id="items"></div>
  </div>
</div>

</div>

<!-- 底部操作列 -->
<div class="footer-bar text-end d-none" id="footerBar">
  <button class="btn btn-outline-secondary me-2" onclick="location.reload()">重新上傳</button>
  <button class="btn btn-primary fw-bold px-4" onclick="submitToSupabase()">
    確認送出審核 <i class="fa-solid fa-paper-plane ms-1"></i>
  </button>
</div>

<script>
const SUPABASE_URL='https://ghpxaeenikochgrnczic.supabase.co';
const SUPABASE_KEY='sb_publishable_v0ZN2OY08lh-8EC8ps8NdQ_ChYo1FRW';
const db=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

const itemCodes=['9-1','9-2','9-3','9-4','9-5','9-6','11-1','11-2','12','13'];
itemCodes.forEach(c=>{
  items.innerHTML+=`
  <div class="col-6 col-md-3 mb-2">
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="i${c}" value="${c}">
      <label class="form-check-label fw-bold">${c}</label>
    </div>
  </div>`;
});

file.addEventListener('change',async e=>{
  const f=e.target.files[0];
  if(!f)return;
  loading.classList.remove('d-none');

  const {data:{text}}=await Tesseract.recognize(f,'chi_tra');
  autoFill(text);

  loading.classList.add('d-none');
  step2.classList.remove('d-none');
  footerBar.classList.remove('d-none');
});

function autoFill(t){
  const d=t.match(/\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}/);
  if(d)execDate.value=d[0].replace(/[\/]/g,'-');

  sec1.value=extract(t,'一','二');
  sec2.value=extract(t,'二','三');
  sec3.value=extract(t,'三','辦理');

  itemCodes.forEach(c=>{
    if(t.includes(c))document.getElementById('i'+c).checked=true;
  });
}

function extract(t,s,e){
  const i=t.indexOf(s),j=t.indexOf(e);
  if(i<0)return'';
  return t.substring(i+s.length,j>0?j:t.length).trim();
}

async function submitToSupabase(){
  const checked=[...document.querySelectorAll('#items input:checked')].map(i=>i.value);
  const payload={
    execution_date:execDate.value,
    section1:sec1.value,
    section2:sec2.value,
    section3:sec3.value,
    items:checked
  };

  const {error}=await db.from('document_staging').insert([{
    uploader_name:sessionStorage.getItem('currentUserName')||'consultant',
    main_file_name:file.files[0].name,
    main_file_type:'pdf',
    category:'勞工健康服務執行紀錄表',
    extracted_data:payload,
    status:'pending'
  }]);

  if(error){alert(error.message);return;}
  alert('已送入暫存審核區');
  location.href='dashboard.html';
}
</script>

</body>
</html>
