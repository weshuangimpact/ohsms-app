<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服務執行歷程管理 (Plan/Do) | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        /* =========================================
           1. 統一頁首/頁尾 CSS 設定 (內頁專用 / 高度統一版)
           ========================================= */
        html, body {
            height: 100%;
        }

        body {
            display: none; /* 權限驗證前先隱藏，JS 載入後改為 flex */
            flex-direction: column;
            min-height: 100vh;
            background-color: #f8f9fa; /* 預設背景色 */
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }

        /* 內容區塊自動撐開 */
        .container, .main-content {
            flex: 1; 
            max-width: 100% !important; 
            padding-left: 1.5rem !important; 
            padding-right: 1.5rem !important;
        }

        /* 頁首設定 */
        .navbar {
            background-color: #202124 !important;
            min-height: 85px; 
            color: #fff;
            flex-shrink: 0; 
        }

        /* 頁尾設定 */
        footer {
            background-color: #202124 !important;
            color: #fff;
            flex-shrink: 0; 
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: auto; 
            padding: 15px 0;
            min-height: 85px; 
        }

        /* =========================================
           2. PDCA 字卡與標題 CSS
           ========================================= */
        .instruction-box {
            background-color: #fff;
            border-left: 5px solid #0d6efd;
            padding: 20px 25px;
            border-radius: 4px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .instruction-title {
            color: #0d6efd;
            font-weight: 700;
            margin-bottom: 10px;
        }

        /* =========================================
           3. 本頁特定樣式 (左側列表與右側內容)
           ========================================= */
        .card-header {
            background-color: white;
            border-bottom: 1px solid #f0f0f0;
        }
        
        /* 左側列表樣式 */
        .list-group-item {
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        .list-group-item:hover {
            background-color: #f8f9fa;
        }
        .list-group-item.active {
            background-color: #eef2ff;
            color: #4f46e5;
            border-left-color: #4f46e5;
            border-color: #dee2e6;
        }
        
        .item-badge {
            width: 24px; 
            height: 24px; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            background: #eee; 
            border-radius: 50%; 
            font-size: 12px; 
            margin-right: 8px;
        }
        .list-group-item.active .item-badge {
            background: #4f46e5; 
            color: white;
        }

        /* 右側編輯區 */
        .service-item-row {
            transition: background 0.3s;
        }
        .service-item-row:hover {
            background-color: #fdfdfd;
        }
        
        .form-check-input:checked {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
    </style>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const role = sessionStorage.getItem('currentUserRole');
            // 權限檢查：僅允許 consultant (顧問) 與 admin (管理員) 進入
            // doc_control (文管) 僅能檢視但此頁面主要為編輯，暫不阻擋但後續邏輯可控制
            if (!role) {
                alert('請先登入');
                window.location.href = 'login.html';
                return;
            }
            document.body.style.display = 'flex';
        });
    </script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark px-4">
        <div class="container-fluid d-flex justify-content-between align-items-center p-0">
            <a class="navbar-brand d-flex align-items-center fw-bold" href="dashboard.html">
                <i class="fas fa-shield-alt me-2"></i>
                OHSMS 職安管理系統
            </a>

            <div class="d-flex align-items-center">
                <span class="text-white me-3 small" id="header-date">
                    <i class="fas fa-spinner fa-spin"></i>
                </span>
                
                <span class="text-white me-4 small border-start ps-3 border-secondary" id="header-clock" style="opacity: 0.9;">
                    --:--
                </span>
             
                <span class="text-white me-4 fw-bold" id="header-user">
                    Hi! 使用者
                </span>
                
                <a class="btn btn-outline-light btn-sm me-2" href="dashboard.html">
                    <i class="fas fa-reply me-1"></i>回到儀表板
                </a>
                
                <button class="btn btn-outline-light btn-sm" onclick="logoutSystem()">
                    <i class="fas fa-sign-out-alt me-1"></i>登出
                </button>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="mt-4 mb-4">
            <h2 class="fw-bold text-dark mb-1">服務執行歷程管理</h2>
            <p class="text-secondary">建立與編輯年度服務計畫之執行紀錄 (Plan/Do)</p>
        </div>

        <div class="instruction-box">
            <div class="instruction-title">
                <i class="fas fa-info-circle me-2"></i>功能說明：母案關聯與執行紀錄上傳
            </div>
            <p class="mb-0 text-dark" style="line-height: 1.6;">
                本模組用於將「服務執行歷程 (母案)」轉換為實際的執行紀錄。請點選左側待執行的母案，填寫右側的執行細節並上傳佐證照片。系統將自動生成正式案號 (SR-YYYYMMDD-XXX) 並暫存於資料庫，待文管人員確認後歸檔。
            </p>
        </div>

        <div class="row g-4 h-100">
            <div class="col-lg-4 d-flex flex-column">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header py-3 fw-bold text-dark">
                        <i class="fas fa-list-ul me-2 text-primary"></i>待執行服務 (Pending)
                    </div>
                    <div class="card-body p-0" style="overflow-y: auto; max-height: 600px;">
                        <div class="list-group list-group-flush" id="recordList">
                            <div class="text-center py-4 text-muted">
                                <div class="spinner-border spinner-border-sm text-primary mb-2"></div>
                                <p class="small">載入中...</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-white small text-muted">
                        <i class="fas fa-filter me-1"></i> 僅顯示當年度未結案之紀錄
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card border-0 shadow-sm">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <span class="fw-bold text-dark" id="edit-header">
                            <i class="fas fa-edit me-2 text-primary"></i>執行紀錄編輯
                        </span>
                        <span class="badge bg-secondary" id="case-status">請選擇左側項目</span>
                    </div>
                    <div class="card-body">
                        <form id="executionForm" style="display:none;">
                            <input type="hidden" id="current-record-id">
                            <input type="hidden" id="current-staging-id">

                            <div class="alert alert-light border mb-4">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="small text-muted fw-bold">客戶公司</label>
                                        <div class="fw-bold text-dark fs-5" id="display-company">-</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small text-muted fw-bold">作業場所</label>
                                        <div class="text-dark" id="display-workplace">-</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small text-muted fw-bold">負責顧問</label>
                                        <div class="text-dark" id="display-consultant">-</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small text-muted fw-bold">預定月份</label>
                                        <div class="text-dark" id="display-month">-</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small text-muted fw-bold">目前案號</label>
                                        <div class="font-monospace text-primary" id="display-caseno">新案自動生成</div>
                                    </div>
                                </div>
                            </div>

                            <h6 class="fw-bold text-dark border-start border-4 border-primary ps-2 mb-3">執行細節 (Details)</h6>
                            
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">實際訪視日期 *</label>
                                    <input type="date" class="form-control" id="input-date" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">開始時間</label>
                                    <input type="time" class="form-control" id="input-start">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">結束時間</label>
                                    <input type="time" class="form-control" id="input-end">
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="form-label small fw-bold">服務類別 *</label>
                                <select class="form-select" id="input-type">
                                    <option value="臨場服務">臨場服務</option>
                                    <option value="教育訓練">教育訓練</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>

                            <h6 class="fw-bold text-dark border-start border-4 border-success ps-2 mb-3">執行項目與佐證 (Items & Evidence)</h6>
                            <div class="alert alert-info small py-2">
                                <i class="fas fa-camera me-1"></i> 請勾選本次執行項目，並於後方上傳照片。
                            </div>

                            <div class="service-items-container border rounded p-3 mb-4 bg-light" style="max-height: 400px; overflow-y: auto;">
                                <div id="service-items-list"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small fw-bold">備註 / 建議事項</label>
                                <textarea class="form-control" id="input-remark" rows="3" placeholder="請輸入本次訪視之重點摘要或建議..."></textarea>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-4">
                                <span class="small text-muted" id="last-update"></span>
                                <div>
                                    <button type="button" class="btn btn-secondary me-2" onclick="resetForm()">重置</button>
                                    <button type="button" class="btn btn-primary" onclick="saveStaging()">
                                        <i class="fas fa-save me-1"></i> 儲存並送出
                                    </button>
                                </div>
                            </div>

                        </form>
                        
                        <div id="empty-state" class="text-center py-5">
                            <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" alt="Select" style="width: 80px; opacity: 0.5;" class="mb-3">
                            <h5 class="text-muted">請選擇左側服務紀錄以開始編輯</h5>
                            <p class="small text-secondary">系統將自動載入該紀錄之基本資料</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <footer>
        <div class="mb-1">可信智慧整合有限公司 42917004</div>
        <div class="small opacity-75" style="font-family: 'Segoe UI', sans-serif; letter-spacing: 1px;">
            WesmartAI , Making Trust Transparent.
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 服務項目定義
        const serviceItems = [
            { id: 'A', text: '勞工健康服務計畫之執行' },
            { id: 'B', text: '作業環境危害辨識/評估/控制' },
            { id: 'C', text: '個人防護具之管理' },
            { id: 'D', text: '人因性危害預防計畫' },
            { id: 'E', text: '異常工作負荷促發疾病預防' },
            { id: 'F', text: '母性健康保護計畫' },
            { id: 'G', text: '不法侵害預防計畫' },
            { id: 'H', text: '中高齡/高齡者職務再設計' },
            { id: 'I', text: '年度健康檢查結果分析/評估' },
            { id: 'J', text: '健康檢查結果之分級/管理' },
            { id: 'K', text: '適性配工/復工之評估' },
            { id: 'L', text: '影響健康危害風險之管理' },
            { id: 'M', text: '四大計畫執行紀錄與績效評估' },
            { id: 'N', text: '急救人員與急救物資之管理' },
            { id: 'O', text: '衛生教育與健康指導' },
            { id: 'P', text: '身心健康諮詢與轉介' },
            { id: 'Q', text: '其他附件(Q)' }
        ];

        // 頁面初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 時鐘與日期
            setInterval(() => {
                const now = new Date();
                const clockEl = document.getElementById('header-clock');
                if(clockEl) clockEl.textContent = now.toLocaleTimeString('zh-TW', { hour12: false });
            }, 1000);
            
            const dateEl = document.getElementById('header-date');
            if(dateEl) {
                const now = new Date();
                const days = ['日', '一', '二', '三', '四', '五', '六'];
                dateEl.innerHTML = `<i class="far fa-calendar-alt me-1"></i>今日是 ${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}(${days[now.getDay()]})`;
            }

            const userName = sessionStorage.getItem('currentUserName');
            if(userName) document.getElementById('header-user').innerText = `Hi! ${userName}`;

            // 初始化功能
            loadRecordList();
            renderServiceItems();
        });

        function logoutSystem() {
            if(confirm('確定要登出系統嗎？')) {
                sessionStorage.clear();
                window.location.href = 'login.html';
            }
        }

        // 1. 載入服務紀錄列表 (左側)
        async function loadRecordList() {
            const listContainer = document.getElementById('recordList');
            const userId = sessionStorage.getItem('currentUserId');
            const role = sessionStorage.getItem('currentUserRole');

            let query = supabaseClient
                .from('service_records')
                .select(`
                    id, visit_date, service_year,
                    workplaces!inner (
                        id, department_name,
                        companies!inner ( name )
                    ),
                    medical_staff ( name ),
                    service_record_staging ( id, case_number, status )
                `)
                .order('visit_date', { ascending: true }); // 先顯示舊的

            // 顧問只能看自己的，管理員可看全部
            if (role === 'consultant') {
                query = query.eq('consultant_id', userId);
            }

            const { data, error } = await query;

            if (error) {
                listContainer.innerHTML = `<div class="p-3 text-danger text-center">載入失敗: ${error.message}</div>`;
                return;
            }

            if (!data || data.length === 0) {
                listContainer.innerHTML = `<div class="p-3 text-muted text-center">目前無待執行之任務</div>`;
                return;
            }

            // 渲染列表
            listContainer.innerHTML = data.map(r => {
                const companyName = r.workplaces?.companies?.name || '未知公司';
                const deptName = r.workplaces?.department_name || '';
                const dateDisplay = r.visit_date || `<span class="badge bg-secondary">尚未排程</span>`;
                
                // 檢查是否有 staging 資料
                const staging = (r.service_record_staging && r.service_record_staging.length > 0) ? r.service_record_staging[0] : null;
                const statusBadge = staging 
                    ? `<span class="badge bg-warning text-dark">暫存: ${staging.case_number}</span>`
                    : `<span class="badge bg-light text-secondary border">新案件</span>`;
                
                const activeClass = ''; // 點擊後由 JS 控制

                return `
                <div class="list-group-item list-group-item-action py-3 ${activeClass}" onclick="selectRecord('${r.id}', this)">
                    <div class="d-flex w-100 justify-content-between mb-1">
                        <small class="text-muted"><i class="far fa-calendar me-1"></i>${dateDisplay}</small>
                        ${statusBadge}
                    </div>
                    <h6 class="mb-1 fw-bold text-dark">${companyName}</h6>
                    <div class="small text-secondary">
                        <i class="fas fa-map-marker-alt me-1"></i>${deptName}
                    </div>
                </div>
                `;
            }).join('');
        }

        // 2. 渲染服務項目 (A-Q)
        function renderServiceItems() {
            const container = document.getElementById('service-items-list');
            container.innerHTML = serviceItems.map(item => {
                // 為 Q 項目添加額外按鈕容器
                let extraHtml = '';
                if (item.id === 'Q') {
                    extraHtml = `
                        <div class="input-group input-group-sm mt-1" id="file-container-${item.id}">
                             <input type="file" class="form-control" id="file-${item.id}">
                             <button class="btn btn-outline-secondary" type="button" onclick="addQFile()">
                                <i class="fas fa-plus"></i>
                             </button>
                        </div>
                        <div id="extra-q-files-container" class="ps-3 border-start ms-1 mt-1"></div>
                    `;
                } else {
                    extraHtml = `<input type="file" class="form-control form-control-sm mt-1" id="file-${item.id}" disabled>`;
                }

                return `
                <div class="service-item-row p-2 border-bottom">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${item.id}" id="check-${item.id}" onchange="toggleFile('${item.id}')">
                        <label class="form-check-label fw-bold small text-dark" for="check-${item.id}">
                            <span class="item-badge">${item.id}</span>${item.text}
                        </label>
                    </div>
                    <div class="ms-4 ps-2">
                        ${extraHtml}
                    </div>
                </div>
                `;
            }).join('');
        }
        
        function toggleFile(itemId) {
            const checkbox = document.getElementById(`check-${itemId}`);
            const fileInput = document.getElementById(`file-${itemId}`);
            if (fileInput) fileInput.disabled = !checkbox.checked;
            
            // 如果是 Q，也要連動 QA-QZ
            if (itemId === 'Q') {
                const extraInputs = document.querySelectorAll('[id^="file-Q"]');
                extraInputs.forEach(input => {
                    // file-Q 已經處理過了，這裡處理 file-QA, file-QB...
                    if (input.id !== 'file-Q') {
                         input.disabled = !checkbox.checked;
                    }
                });
                
                // 控制 + 號按鈕
                const btn = document.querySelector('#file-container-Q button');
                if(btn) btn.disabled = !checkbox.checked;
            }
        }

        // Q 選項新增檔案功能
        const qSuffixes = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
        let currentQIndex = 0;

        function addQFile() {
            if (currentQIndex >= qSuffixes.length) {
                alert('已達到附件數量上限 (QZ)');
                return;
            }
            const suffix = qSuffixes[currentQIndex];
            const newId = `QA${suffix}`; // 修正邏輯：原本是 Q + A, B... 但使用者說 QA~QZ
            // 使用者需求：增加的就用 QA~QZ
            // 第一個新增的叫 QA, 第二個 QB...
            
            // 由於原 id 是 'Q'，顯示文字是 "其他附件(Q)"
            // 新增的 input id 設為 file-QA, file-QB...
            const itemId = `Q${suffix}`;
            
            const container = document.getElementById('extra-q-files-container');
            const div = document.createElement('div');
            div.className = 'mt-1 d-flex align-items-center animate__animated animate__fadeIn';
            div.innerHTML = `
                <span class="badge bg-light text-dark border me-2" style="min-width:35px;">${itemId}</span>
                <input type="file" class="form-control form-control-sm" id="file-${itemId}">
                <button type="button" class="btn btn-sm btn-link text-danger ms-1" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(div);
            currentQIndex++;
        }

        // 3. 選擇紀錄並載入資料
        async function selectRecord(recordId, element) {
            // UI更新
            document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('executionForm').style.display = 'block';
            document.getElementById('executionForm').reset();
            
            // 重置 Q 的額外欄位
            document.getElementById('extra-q-files-container').innerHTML = '';
            currentQIndex = 0;

            // 載入資料
            try {
                // 1. 抓取基本資料 (Service Record)
                const { data: record, error } = await supabaseClient
                    .from('service_records')
                    .select(`
                        *,
                        workplaces ( id, department_name, companies(name) ),
                        medical_staff ( name ),
                        service_record_staging (*) 
                    `)
                    .eq('id', recordId)
                    .single();

                if (error) throw error;

                // 2. 填入顯示欄位
                document.getElementById('current-record-id').value = record.id;
                document.getElementById('display-company').innerText = record.workplaces?.companies?.name || '-';
                document.getElementById('display-workplace').innerText = record.workplaces?.department_name || '-';
                document.getElementById('display-consultant').innerText = record.medical_staff?.name || '-';
                document.getElementById('display-month').innerText = record.visit_date ? record.visit_date.slice(0, 7) : '-'; // YYYY-MM
                
                // 預填值 (若有母案資料)
                if (record.visit_date) document.getElementById('input-date').value = record.visit_date;
                if (record.start_time) document.getElementById('input-start').value = record.start_time;
                if (record.end_time) document.getElementById('input-end').value = record.end_time;

                // 3. 檢查是否有暫存資料 (Staging)
                const staging = (record.service_record_staging && record.service_record_staging.length > 0) ? record.service_record_staging[0] : null;

                if (staging) {
                    document.getElementById('current-staging-id').value = staging.id;
                    document.getElementById('display-caseno').innerText = staging.case_number;
                    document.getElementById('case-status').className = 'badge bg-warning text-dark';
                    document.getElementById('case-status').innerText = '編輯暫存中';
                    
                    // 回填表單
                    document.getElementById('input-date').value = staging.service_date || record.visit_date;
                    document.getElementById('input-start').value = staging.start_time || '';
                    document.getElementById('input-end').value = staging.end_time || '';
                    document.getElementById('input-type').value = staging.service_type || '臨場服務';
                    
                    // 解析 JSON 回填勾選項目與備註
                    if (staging.service_desc) {
                        try {
                            const desc = JSON.parse(staging.service_desc);
                            document.getElementById('input-remark').value = desc.user_remark || '';
                            
                            // 勾選項目回填
                            if (desc.items && Array.isArray(desc.items)) {
                                desc.items.forEach(itemId => {
                                    // 注意：若 itemId 是 QA, QB 等，屬於 Q 的子集，主勾選框應勾選 Q
                                    let checkId = itemId;
                                    if (itemId.startsWith('Q') && itemId.length > 1) { // QA, QB...
                                        checkId = 'Q';
                                    }
                                    
                                    const checkbox = document.getElementById(`check-${checkId}`);
                                    if (checkbox) {
                                        checkbox.checked = true;
                                        toggleFile(checkId);
                                    }
                                });
                            }
                        } catch (e) { console.error('JSON parse error', e); }
                    }
                    
                    document.getElementById('last-update').innerText = `上次儲存: ${new Date(staging.updated_at).toLocaleString()}`;
                } else {
                    // 新案件
                    document.getElementById('current-staging-id').value = '';
                    document.getElementById('display-caseno').innerText = '系統自動生成';
                    document.getElementById('case-status').className = 'badge bg-info text-dark';
                    document.getElementById('case-status').innerText = '新填寫';
                    document.getElementById('last-update').innerText = '';
                }

            } catch (err) {
                console.error(err);
                alert('載入詳細資料失敗');
            }
        }

        function resetForm() {
            if(confirm('確定要重置表單內容嗎？(已儲存的暫存檔不會被刪除)')) {
                document.getElementById('executionForm').reset();
                document.querySelectorAll('.form-check-input').forEach(el => {
                    el.checked = false;
                    toggleFile(el.value);
                });
                document.getElementById('extra-q-files-container').innerHTML = '';
                currentQIndex = 0;
            }
        }

        // 4. 儲存暫存檔 (Upsert)
        async function saveStaging() {
            const btn = document.querySelector('button[onclick="saveStaging()"]');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 儲存中...';

            try {
                const currentRecordId = document.getElementById('current-record-id').value;
                const currentStagingId = document.getElementById('current-staging-id').value || undefined; // undefined for new insert
                const userId = sessionStorage.getItem('currentUserId');

                const visitDate = document.getElementById('input-date').value;
                const startTime = document.getElementById('input-start').value;
                const endTime = document.getElementById('input-end').value;
                const serviceType = document.getElementById('input-type').value;
                const remark = document.getElementById('input-remark').value;

                if (!visitDate) throw new Error('請填寫實際訪視日期');

                // 收集勾選項目
                const selectedItems = [];
                document.querySelectorAll('.form-check-input:checked').forEach(el => {
                    selectedItems.push(el.value);
                });

                // 上傳檔案處理
                const attachments = {};
                for (const item of selectedItems) {
                    
                    // 處理標準項目 (A-P) 與 Q 的主檔案
                    const fileInput = document.getElementById(`file-${item}`);
                    if (fileInput && fileInput.files.length > 0) {
                        const file = fileInput.files[0];
                        const path = await uploadFileToStorage(file, item);
                        if (path) attachments[item] = path;
                    }

                    // 特別處理 Q 的額外檔案 (QA-QZ)
                    if (item === 'Q') {
                        // 找出所有 QA, QB... 的 input
                        const extraInputs = document.querySelectorAll('input[id^="file-Q"]');
                        for (const input of extraInputs) {
                            if (input.id === 'file-Q') continue; // 跳過主 Q
                            
                            const suffixId = input.id.replace('file-', ''); // 取得 QA, QB...
                            if (input.files.length > 0) {
                                const file = input.files[0];
                                const path = await uploadFileToStorage(file, suffixId);
                                if (path) {
                                    attachments[suffixId] = path;
                                    // 將 QA, QB 也加入 selectedItems 紀錄中以便回填識別? 
                                    // 為了不影響 selectedItems 的顯示邏輯，這裡僅存入 attachment
                                    // 但為了上面 staging 回填時能識別，我們應該把 key 也放入 items 陣列嗎？
                                    // 為了單純化，items 陣列維持 A-Q，但 attachment_files 會有額外 keys
                                }
                            }
                        }
                    }
                }

                // 準備寫入資料
                // 為了取得 service_year 等資訊，需再次確認 (或從畫面上拿)
                const { data: recordData } = await supabaseClient.from('service_records').select('workplace_id, consultant_id, service_year').eq('id', currentRecordId).single();
                
                // 產生案號 (Format: SR-YYYYMMDD-隨機流水碼)
                // 若已有案號則不變，若無則生成
                let caseNumber = document.getElementById('display-caseno').innerText;
                if (caseNumber === '新案自動生成' || caseNumber === '系統自動生成') {
                    const now = new Date();
                    const dateStr = now.getFullYear().toString() + (now.getMonth() + 1).toString().padStart(2, '0') + now.getDate().toString().padStart(2, '0');
                    const randomSeq = String(Date.now()).slice(-3);
                    caseNumber = `SR-${dateStr}-${randomSeq}`;
                }

                const payload = {
                    id: currentStagingId, // 若有值則更新，無則新增
                    origin_record_id: currentRecordId,
                    workplace_id: recordData.workplace_id,
                    submitter_id: userId,
                    consultant_id: recordData.consultant_id,
                    service_year: recordData.service_year,
                    
                    service_date: visitDate, 
                    visit_date: visitDate,   
                    start_time: startTime,
                    end_time: endTime,
                    
                    service_type: serviceType, 
                    service_desc: JSON.stringify({
                        items: selectedItems,
                        note: '由顧問端上傳之執行紀錄',
                        user_remark: remark 
                    }),
                    attachment_files: attachments, // JSONB: { "A": "url", "Q": "url", "QA": "url"... }
                    case_number: caseNumber,
                    status: 'pending',
                    updated_at: new Date()
                };

                const { data: upsertData, error } = await supabaseClient.from('service_record_staging').upsert(payload).select();

                if (error) throw error;

                // 成功後更新畫面
                alert('✅ 儲存成功！');
                document.getElementById('display-caseno').innerText = caseNumber;
                document.getElementById('case-status').innerText = '編輯暫存中';
                document.getElementById('case-status').className = 'badge bg-warning text-dark';
                
                // 刷新左側列表 (更新狀態標籤)
                loadRecordList();

                // 更新 currentStagingId
                if (upsertData && upsertData.length > 0) {
                     document.getElementById('current-staging-id').value = upsertData[0].id;
                }

            } catch (err) {
                console.error(err);
                alert('儲存失敗: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save me-1"></i> 儲存並送出';
            }
        }

        async function uploadFileToStorage(file, itemId) {
            // 檔名: YYYYMMDD_RecordID_Item.ext
            const recordId = document.getElementById('current-record-id').value;
            const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
            const ext = file.name.split('.').pop();
            const fileName = `${dateStr}_${recordId}_${itemId}.${ext}`;
            const filePath = `evidence/${fileName}`;

            const { data, error } = await supabaseClient.storage
                .from('service-evidence') // 確保 Bucket 名稱正確
                .upload(filePath, file, { upsert: true });

            if (error) {
                console.error(`上傳 ${itemId} 失敗:`, error);
                throw error;
            }
            
            // 取得公開 URL
            const { data: urlData } = supabaseClient.storage.from('service-evidence').getPublicUrl(filePath);
            return urlData.publicUrl;
        }

    </script>
</body>
</html>
