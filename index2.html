<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理者總覽 (Evaluation) | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { --primary-bg: #f4f6f9; --admin-color: #4f46e5; }
        body { background-color: var(--primary-bg); font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; }
        .section-title { border-left: 5px solid var(--admin-color); padding-left: 15px; margin-bottom: 20px; }
        .info-card { padding: 1.25rem; border-radius: 0.5rem; background-color: white; border: none; }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--admin-color); }
        .chart-container { position: relative; height: 260px; width: 100%; }
        .table-pending thead { background-color: #f8fafc; }
        
        /* 預覽視窗專用樣式 (無浮水印) */
        .preview-body { background: #f8f9fa; min-height: 400px; padding: 20px; }
        .file-item { background: white; border: 1px solid #dee2e6; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        .attachment-img { max-width: 100%; height: auto; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-top: 10px; }
        .attachment-pdf-frame { width: 100%; height: 500px; border: 1px solid #ddd; margin-top: 10px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3 mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="dashboard.html"><i class="fas fa-shield-alt me-2"></i>OHSMS 管理者控制台</a>
            <div class="d-flex align-items-center">
                <span class="text-light me-3" id="user-display"></span>
                <a href="dashboard.html" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left me-1"></i> 返回儀表板</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4 pb-5">
        
        <div class="section-title">
            <h4 class="fw-bold text-dark mb-0">管理者服務監控總覽</h4>
            <small class="text-muted">即時年度結案達成率與暫存資料審查</small>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-5">
                <div class="card info-card shadow-sm h-100">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-primary text-white rounded-circle p-2 me-3">
                            <i class="fas fa-calculator fa-fw"></i>
                        </div>
                        <h5 class="fw-bold mb-0">年度結案達成率公式</h5>
                    </div>
                    <div class="p-3 bg-light rounded border-start border-4 border-primary mb-3">
                        <code class="text-dark fw-bold" style="font-size: 1.1rem;">
                            已核定入庫 / ( 已核定入庫 + 暫存待審核 ) × 100%
                        </code>
                    </div>
                    <p class="text-muted small mb-0">
                        <i class="fas fa-info-circle me-1"></i> <strong>說明：</strong><br>
                        系統會掃描 <code>service_record_staging</code> 中狀態為 <code>pending</code> 的所有資料。若當年度無待審核案件，達成率即為 <span class="text-success fw-bold">100%</span>。
                    </p>
                </div>
            </div>

            <div class="col-md-7">
                <div class="card info-card shadow-sm h-100">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold mb-0">當前年度達成率 (即時計算)</h5>
                        <select class="form-select w-auto fw-bold text-primary" id="target-year" onchange="refreshData()">
                            <option value="2026">2026 年度</option>
                            <option value="2025" selected>2025 年度</option>
                            <option value="2024">2024 年度</option>
                        </select>
                    </div>
                    
                    <div class="row align-items-center">
                        <div class="col-md-6 text-center">
                            <div class="chart-container">
                                <canvas id="rateChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6 border-start">
                            <div class="ps-3">
                                <div class="mb-3">
                                    <label class="text-muted small d-block">已核定入庫 (Formal)</label>
                                    <span class="stat-value text-success" id="val-approved">0</span> <small class="text-muted">筆</small>
                                </div>
                                <div class="mb-3">
                                    <label class="text-muted small d-block">暫存待審核 (Pending)</label>
                                    <span class="stat-value text-warning" id="val-pending">0</span> <small class="text-muted">筆</small>
                                </div>
                                <hr>
                                <div>
                                    <label class="fw-bold d-block text-secondary">年度總達成率</label>
                                    <span class="stat-value text-primary" id="val-rate" style="font-size: 2.8rem;">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm mt-4">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-list-ul me-2 text-warning"></i>待核定暫存清單 (Staging Area)</h6>
                <button class="btn btn-sm btn-outline-secondary" onclick="refreshData()"><i class="fas fa-sync-alt"></i></button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-pending">
                            <tr>
                                <th class="ps-4">日期</th>
                                <th>顧問姓名</th>
                                <th>服務類型</th>
                                <th>描述摘要</th>
                                <th class="text-end pe-4">管理動作</th>
                            </tr>
                        </thead>
                        <tbody id="pendingTableBody">
                            <tr><td colspan="5" class="text-center py-4 text-muted">正在載入暫存資料...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="reviewModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-search-plus me-2"></i>案件審核預覽</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body preview-body" id="reviewContainer">
                    <div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2">正在讀取 Staging 暫存區檔案...</p></div>
                </div>
                <div class="modal-footer bg-light justify-content-between">
                    <div class="text-muted small">此模式僅供預覽，不包含浮水印。</div>
                    <div>
                        <button type="button" class="btn btn-success fw-bold" onclick="alert('核定功能開發中')"><i class="fas fa-check me-1"></i>核定入庫</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // 初始化 Supabase
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let rateChart = null;
        let currentStagingData = []; 

        document.addEventListener('DOMContentLoaded', () => {
            const role = sessionStorage.getItem('currentUserRole') || 'admin';
            const userName = sessionStorage.getItem('currentUserName') || '管理員';
            document.getElementById('user-display').innerHTML = `<small>${role}: ${userName}</small>`;
            
            initChart();
            refreshData();
        });

        function initChart() {
            const ctx = document.getElementById('rateChart').getContext('2d');
            rateChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['已核定', '待審核'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#10b981', '#f59e0b'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    cutout: '75%',
                    plugins: { legend: { display: false } },
                    maintainAspectRatio: false
                }
            });
        }

        async function refreshData() {
            const year = parseInt(document.getElementById('target-year').value);
            const tbody = document.getElementById('pendingTableBody');
            
            try {
                // 1. 讀取正式庫統計
                const { count: approvedCount, error: err1 } = await supabaseClient
                    .from('service_records')
                    .select('*', { count: 'exact', head: true })
                    .eq('service_year', year);

                // 2. 讀取 Pending 暫存資料
                const { data: stagingData, error: err2 } = await supabaseClient
                    .from('service_record_staging')
                    .select(`
                        *,
                        medical_staff:consultant_id ( name )
                    `)
                    .eq('status', 'pending');

                if (err1 || err2) throw (err1 || err2);

                const filteredPending = stagingData.filter(d => {
                    const d1 = d.visit_date ? new Date(d.visit_date).getFullYear() : null;
                    const d2 = d.service_date ? new Date(d.service_date).getFullYear() : null;
                    return d1 === year || d2 === year;
                });

                currentStagingData = filteredPending; 
                const pendingCount = filteredPending.length;

                // 更新統計 UI
                const total = approvedCount + pendingCount;
                const rate = total === 0 ? 100 : Math.round((approvedCount / total) * 100);

                document.getElementById('val-approved').innerText = approvedCount;
                document.getElementById('val-pending').innerText = pendingCount;
                document.getElementById('val-rate').innerText = rate + '%';

                rateChart.data.datasets[0].data = [approvedCount, pendingCount];
                if (total === 0) {
                    rateChart.data.datasets[0].backgroundColor = ['#e2e8f0', '#f59e0b'];
                    rateChart.data.datasets[0].data = [1, 0];
                } else {
                    rateChart.data.datasets[0].backgroundColor = ['#10b981', '#f59e0b'];
                }
                rateChart.update();

                // 渲染列表 (UI 調整：恢復原始按鈕群組)
                tbody.innerHTML = filteredPending.map((p, index) => {
                    let descText = p.service_desc;
                    try {
                        const parsed = JSON.parse(p.service_desc);
                        if(parsed.process_summary) descText = parsed.process_summary;
                        else if (parsed.note) descText = parsed.note;
                    } catch(e) {} 

                    const consultantName = p.medical_staff?.name || '未知顧問';
                    const displayDate = p.visit_date || p.service_date;

                    return `
                    <tr class="animate__animated animate__fadeIn">
                        <td class="ps-4 fw-bold font-monospace">${displayDate}</td>
                        <td>${consultantName}</td>
                        <td><span class="badge bg-light text-dark border">${p.service_type || '一般訪視'}</span></td>
                        <td class="text-truncate" style="max-width: 250px;">${descText || '-'}</td>
                        <td class="text-end pe-4">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary" onclick="openStagingPreview('${p.id}')" title="檢視預覽">
                                    <i class="far fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="alert('通知信已發送至: ${consultantName}')" title="發送通知信">
                                    <i class="far fa-envelope"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="alert('催收提醒已發送！')" title="催收提醒">
                                    <i class="far fa-bell"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `}).join('') || '<tr><td colspan="5" class="text-center py-4 text-muted">當前年度無待處理資料</td></tr>';

            } catch (e) {
                console.error('Data loading error:', e);
                alert('載入失敗，請檢查網路連接或資料庫權限設定。');
            }
        }

        async function openStagingPreview(id) {
            const record = currentStagingData.find(r => r.id === id);
            if (!record) return;

            const container = document.getElementById('reviewContainer');
            container.innerHTML = `<div class="text-center py-5"><div class="spinner-border text-primary"></div><p>正在從暫存區 (Staging) 讀取檔案...</p></div>`;
            
            new bootstrap.Modal(document.getElementById('reviewModal')).show();

            try {
                let files = record.attachment_files;
                // 安全性檢查：處理 undefined 或字串型別
                if (typeof files === 'string') {
                    try {
                        files = JSON.parse(files);
                    } catch(e) {
                        files = [];
                    }
                }
                if (!files || !Array.isArray(files)) files = [];

                if (files.length === 0) {
                    container.innerHTML = `<div class="alert alert-warning text-center">此案件沒有上傳任何附件。</div>`;
                    return;
                }

                // 產生 Signed URL
                const filesWithUrl = await Promise.all(files.map(async (f) => {
                    const { data } = await supabaseClient.storage
                        .from('staging') 
                        .createSignedUrl(f.path, 600);
                    return { ...f, url: data?.signedUrl };
                }));

                const htmlContent = filesWithUrl.map(f => {
                    if (!f.url) return `<div class="alert alert-danger">無法讀取檔案: ${f.name}</div>`;
                    
                    const isImg = f.name.match(/\.(jpeg|jpg|png|gif)$/i);
                    const isPdf = f.name.match(/\.pdf$/i);
                    let display = '';

                    if (isImg) {
                        display = `<img src="${f.url}" class="attachment-img">`;
                    } else if (isPdf) {
                        display = `<iframe src="${f.url}#toolbar=0" class="attachment-pdf-frame"></iframe>`;
                    } else {
                        display = `<div class="p-3 bg-white border mt-2"><a href="${f.url}" target="_blank" class="btn btn-outline-primary"><i class="fas fa-download me-2"></i>下載查看 (${f.name})</a></div>`;
                    }

                    return `
                        <div class="file-item">
                            <div class="d-flex justify-content-between align-items-center border-bottom pb-2">
                                <span class="fw-bold text-primary"><i class="fas fa-file me-2"></i>${f.name}</span>
                                <span class="badge bg-secondary">Staging</span>
                            </div>
                            ${display}
                        </div>
                    `;
                }).join('');

                container.innerHTML = `
                    <div class="alert alert-info py-2 small">
                        <strong>案件 ID:</strong> ${record.id} | 
                        <strong>顧問:</strong> ${record.medical_staff?.name || 'Unknown'} | 
                        <strong>日期:</strong> ${record.visit_date}
                    </div>
                    ${htmlContent}
                `;

            } catch (e) {
                console.error(e);
                container.innerHTML = `<div class="alert alert-danger">讀取失敗: ${e.message}</div>`;
            }
        }
    </script>
</body>
</html>
