<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理者總覽 (Check / Act) | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* 核心配色 (Check Green) */
        :root { 
            --primary-bg: #f4f6f9; 
            --theme-color: #198754; 
        }
        
        body { background-color: var(--primary-bg); font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; display: none; /* 預設隱藏，待Auth通過後顯示 */ }
        
        /* 1. 字卡樣式 (Instruction Box) - 補回 */
        .instruction-box { 
            background-color: #fff; 
            border-left: 5px solid var(--theme-color); 
            padding: 20px 25px; 
            border-radius: 4px; 
            margin-bottom: 30px; 
            text-align: left; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        .instruction-title { 
            color: var(--theme-color); 
            font-weight: 700; 
            margin-bottom: 10px; 
            font-size: 1.1rem;
        }

        /* 2. KPI 卡片樣式 */
        .kpi-card { border: 0; shadow: 0 2px 5px rgba(0,0,0,0.05); height: 100%; border-left: 4px solid transparent; background: #fff; border-radius: 8px; }
        .kpi-card.primary { border-left-color: #0d6efd; }
        .kpi-card.warning { border-left-color: #ffc107; }
        .kpi-card.success { border-left-color: #198754; }
        .kpi-card.danger { border-left-color: #dc3545; }

        /* 表格優化 */
        .table-hover tbody tr:hover { background-color: rgba(25, 135, 84, 0.05); cursor: pointer; }
        
        /* 圓餅圖容器 */
        .chart-container { position: relative; height: 300px; width: 100%; }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Auth Guard
            if (!sessionStorage.getItem('currentUserId')) {
                window.location.href = 'login.html';
            } else {
                // ★ 關鍵修正：驗證通過後顯示畫面
                document.body.style.display = 'block';
            }
        });
    </script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3 mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold" href="dashboard.html"><i class="fas fa-shield-alt me-2"></i>OHSMS</a>
            <div class="d-flex align-items-center">
                <span class="text-light small me-3">管理者模式</span>
                <a href="dashboard.html" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left me-1"></i> 返回儀表板</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4 pb-5">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-dark"><i class="fas fa-clipboard-check me-2" style="color: var(--theme-color);"></i>管理者總覽</h2>
                <p class="text-muted mb-0">Check & Act 階段：審核顧問上傳資料，確保服務品質與法規合規性</p>
            </div>
            <div>
                <button class="btn btn-success text-white" onclick="location.reload()"><i class="fas fa-sync-alt me-1"></i> 刷新數據</button>
            </div>
        </div>

        <div class="instruction-box">
            <div class="instruction-title"><i class="fas fa-tasks me-2"></i>PDCA 設計理念：Check (查核) & Act (行動)</div>
            <p class="mb-0 text-dark" style="line-height: 1.6;">
                本模組作為品質把關的核心樞紐。<strong>Check</strong>：管理者透過數據儀表板與詳細紀錄，檢視顧問服務之完整性與合規性；<strong>Act</strong>：針對未達標或異常案件進行退回、催辦或特案處理，完成改善循環，並將合格資料正式歸檔以供評鑑使用。
            </p>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card kpi-card primary p-3 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center">
                        <div><h6 class="text-muted mb-1">本年度案件總數</h6><h3 class="fw-bold mb-0" id="kpi-total">0</h3></div>
                        <div class="bg-primary bg-opacity-10 p-3 rounded-circle text-primary"><i class="fas fa-folder fa-2x"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card kpi-card warning p-3 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center">
                        <div><h6 class="text-muted mb-1">待審核案件</h6><h3 class="fw-bold mb-0 text-warning" id="kpi-pending">0</h3></div>
                        <div class="bg-warning bg-opacity-10 p-3 rounded-circle text-warning"><i class="fas fa-clock fa-2x"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card kpi-card success p-3 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center">
                        <div><h6 class="text-muted mb-1">已結案數</h6><h3 class="fw-bold mb-0 text-success" id="kpi-closed">0</h3></div>
                        <div class="bg-success bg-opacity-10 p-3 rounded-circle text-success"><i class="fas fa-check-circle fa-2x"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card kpi-card danger p-3 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center">
                        <div><h6 class="text-muted mb-1">異常/退回</h6><h3 class="fw-bold mb-0 text-danger" id="kpi-rejected">0</h3></div>
                        <div class="bg-danger bg-opacity-10 p-3 rounded-circle text-danger"><i class="fas fa-exclamation-triangle fa-2x"></i></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-list-ul me-2"></i>待審核執行紀錄 (Pending Reviews)</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-4">申請日期</th>
                                        <th>客戶公司</th>
                                        <th>執行顧問</th>
                                        <th>執行事項</th>
                                        <th>狀態</th>
                                        <th class="text-end pe-4">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="review-table-body">
                                    <tr><td colspan="6" class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin me-2"></i>資料載入中...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3">
                        <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-chart-pie me-2 text-primary"></i>待審案件類型分析</h6>
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <div class="chart-container">
                            <canvas id="reviewPieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="reminderEmailModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="fas fa-bell me-2"></i>發送補件催辦通知</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>您即將發送 Email 通知顧問進行補件或說明。</p>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">收件人 (顧問)</label>
                        <input type="text" class="form-control" id="remind-consultant-name" readonly>
                    </div>
                    <div class="alert alert-light border small">
                        <strong>預覽內容：</strong><br>
                        親愛的 <span class="remind-preview-name"></span> 顧問您好，<br>
                        您所負責的 <span id="remind-company-name" class="fw-bold"></span> 案件，因資料不齊全/有誤，請盡速登入系統進行補件，以利案件結案。<br>
                        <br>OHSMS 系統自動發送
                    </div>
                    <div style="display:none;" id="remind-consultant-addr"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-warning text-dark fw-bold" onclick="sendReminderEmail()">確認發送</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // 定義 Bucket
        const STAGING_BUCKET = 'staging';
        const RECORD_BUCKET = 'service-records';

        let pendingDataList = [];
        let pieChartInstance = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadKPIs();
            loadPendingReviews();
        });

        // ==========================================
        // 1. KPI 載入
        // ==========================================
        async function loadKPIs() {
            // 總母案
            const { count: totalCount } = await supabaseClient.from('service_records').select('*', { count: 'exact', head: true });
            document.getElementById('kpi-total').innerText = totalCount || 0;

            // 待審 (Staging)
            const { count: pendingCount } = await supabaseClient.from('service_record_staging').select('*', { count: 'exact', head: true }).eq('status', 'pending');
            document.getElementById('kpi-pending').innerText = pendingCount || 0;

            // 已結案 (假設 execution_items 不為空代表已執行)
            const { count: closedCount } = await supabaseClient.from('service_records').select('*', { count: 'exact', head: true }).not('execution_items', 'is', null);
            document.getElementById('kpi-closed').innerText = closedCount || 0;
        }

        // ==========================================
        // 2. 載入待審列表 + 更新圓餅圖
        // ==========================================
        async function loadPendingReviews() {
            const tbody = document.getElementById('review-table-body');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted"><div class="spinner-border text-success"></div> 資料載入中...</td></tr>';

            const { data, error } = await supabaseClient
                .from('service_record_staging')
                .select(`
                    *,
                    workplaces ( companies ( name ) ),
                    medical_staff!submitter_id ( name, email )
                `)
                .eq('status', 'pending')
                .order('created_at', { ascending: false });

            if (error) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">載入失敗: ${error.message}</td></tr>`;
                return;
            }

            pendingDataList = data; // 存全域供預覽用

            // 渲染圓餅圖
            renderPieChart(data);

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted"><i class="fas fa-check-circle fa-3x mb-3 text-success bg-light rounded-circle p-3"></i><p>太棒了！目前沒有待審核的案件。</p></td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => {
                return `
                <tr onclick="openPreviewWindow('${item.id}')">
                    <td class="ps-4 font-monospace">${item.service_date || '-'}</td>
                    <td class="fw-bold text-dark">${item.workplaces?.companies?.name || '未知公司'}</td>
                    <td><span class="badge bg-light text-dark border">${item.medical_staff?.name || '未知'}</span></td>
                    <td>${item.service_type || '-'}</td>
                    <td><span class="badge bg-warning text-dark">待審核</span></td>
                    <td class="text-end pe-4" onclick="event.stopPropagation()">
                        <button class="btn btn-sm btn-outline-success me-1" onclick="openPreviewWindow('${item.id}')"><i class="fas fa-eye"></i> 審核</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="openReminderModal('${item.id}')"><i class="fas fa-bell"></i></button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function renderPieChart(data) {
            const ctx = document.getElementById('reviewPieChart').getContext('2d');
            
            // 統計 Service Type
            const typeCounts = {};
            if(data) {
                data.forEach(item => {
                    const type = item.service_type || '未分類';
                    typeCounts[type] = (typeCounts[type] || 0) + 1;
                });
            }

            const labels = Object.keys(typeCounts);
            const counts = Object.values(typeCounts);

            if (pieChartInstance) { pieChartInstance.destroy(); }

            if (labels.length === 0) {
                // 無資料顯示空圖
                pieChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['無資料'],
                        datasets: [{ data: [1], backgroundColor: ['#e9ecef'] }]
                    },
                    options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
                return;
            }

            pieChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: [
                            '#0d6efd', '#198754', '#ffc107', '#dc3545', '#0dcaf0', '#6610f2'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } }
                    }
                }
            });
        }

        // ==========================================
        // 3. 全頁預覽功能 (Window.open)
        // ==========================================
        async function openPreviewWindow(stagingId) {
            const record = pendingDataList.find(r => r.id === stagingId);
            if (!record) return alert('找不到資料');

            // 解析備註
            let fullRemark = '無';
            if (record.service_desc) {
                try {
                    const desc = JSON.parse(record.service_desc);
                    if (desc.user_remark) fullRemark = desc.user_remark;
                } catch(e) {}
            }

            // 準備檔案顯示 HTML
            let attachmentsHtml = '<div class="alert alert-secondary text-center">無上傳附件</div>';
            
            if (record.attachment_files && record.attachment_files.length > 0) {
                const fileElements = record.attachment_files.map(file => {
                    const { data } = supabaseClient.storage.from(STAGING_BUCKET).getPublicUrl(file.path);
                    const url = data.publicUrl;
                    const isPdf = file.name.toLowerCase().endsWith('.pdf');
                    
                    if (isPdf) {
                        return `
                            <div class="mb-4 shadow-sm border rounded overflow-hidden">
                                <div class="bg-light p-2 border-bottom small fw-bold text-dark d-flex justify-content-between">
                                    <span><i class="fas fa-file-pdf text-danger me-2"></i>${file.name}</span>
                                    <a href="${url}" target="_blank" class="text-decoration-none">下載</a>
                                </div>
                                <embed src="${url}" type="application/pdf" width="100%" height="800px" />
                            </div>
                        `;
                    } else {
                        return `
                            <div class="mb-3 p-3 border rounded bg-white d-flex align-items-center">
                                <i class="fas fa-file-image fa-2x text-primary me-3"></i>
                                <div>
                                    <h6 class="mb-1">${file.name}</h6>
                                    <a href="${url}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-external-link-alt me-1"></i> 點擊開啟預覽</a>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
                attachmentsHtml = fileElements;
            }

            // 構建新視窗 HTML
            const pageContent = `
                <!DOCTYPE html>
                <html lang="zh-TW">
                <head>
                    <title>案件審核預覽 - ${record.workplaces?.companies?.name}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
                    <style>
                        body { background-color: #f8f9fa; padding: 20px; font-family: 'Microsoft JhengHei'; }
                        .sticky-header { position: sticky; top: 0; z-index: 1000; background: white; border-bottom: 1px solid #ddd; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin: -20px -20px 20px -20px; }
                        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
                        .info-item { background: white; padding: 10px; border-radius: 5px; border: 1px solid #eee; }
                        .info-label { font-size: 0.85rem; color: #666; margin-bottom: 3px; }
                        .info-value { font-weight: bold; color: #333; }
                        .remark-box { background-color: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; border: 1px solid #ffeeba; margin-bottom: 20px; }
                    </style>
                </head>
                <body>
                    <div class="sticky-header d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="fw-bold mb-0 text-success"><i class="fas fa-check-double me-2"></i>案件審核</h4>
                            <small class="text-muted">ID: ${stagingId}</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-secondary" onclick="window.close()">關閉</button>
                            <button class="btn btn-warning text-dark" onclick="window.opener.approveRecord('special', '${stagingId}', '${record.origin_record_id}')"><i class="fas fa-exclamation-circle me-1"></i> 特案核定</button>
                            <button class="btn btn-success" onclick="window.opener.approveRecord('standard', '${stagingId}', '${record.origin_record_id}')"><i class="fas fa-check me-1"></i> 標準核定 (結案)</button>
                        </div>
                    </div>

                    <div class="container">
                        <div class="info-grid">
                            <div class="info-item"><div class="info-label">客戶公司</div><div class="info-value">${record.workplaces?.companies?.name}</div></div>
                            <div class="info-item"><div class="info-label">執行事項</div><div class="info-value">${record.service_type || '-'}</div></div>
                            <div class="info-item"><div class="info-label">執行日期</div><div class="info-value">${record.visit_date}</div></div>
                            <div class="info-item"><div class="info-label">執行期間</div><div class="info-value">${record.start_time || '--:--'} ~ ${record.end_time || '--:--'}</div></div>
                            <div class="info-item"><div class="info-label">執行顧問</div><div class="info-value">${record.medical_staff?.name}</div></div>
                        </div>

                        ${fullRemark !== '無' ? `<div class="remark-box"><i class="fas fa-sticky-note me-2"></i><strong>特殊事項備註：</strong><p class="mb-0 mt-1">${fullRemark}</p></div>` : ''}

                        <h5 class="border-bottom pb-2 mb-3 fw-bold"><i class="fas fa-paperclip me-2 text-primary"></i>佐證附件預覽</h5>
                        ${attachmentsHtml}
                    </div>
                </body>
                </html>
            `;

            const newWindow = window.open('', '_blank');
            if (newWindow) {
                newWindow.document.write(pageContent);
                newWindow.document.close();
            } else {
                alert('請允許開啟彈跳視窗以進行預覽。');
            }
        }

        // ==========================================
        // 4. 核定結案 (物理轉移邏輯)
        // ==========================================
        window.approveRecord = async function(type, stagingId, originId) {
            let auditNote = '標準審核通過';
            if (type === 'special') {
                const reason = prompt("【特案允許結案】\n請輸入允許結案的原因或備註 (必填)：");
                if (reason === null) return; 
                if (reason.trim() === '') return alert('特案結案必須填寫原因！');
                auditNote = '【特案】' + reason;
            } else {
                if(!confirm(`確定要核定此案件並正式結案嗎？\n(系統將移動檔案並建立正式紀錄)`)) return;
            }

            try {
                // 1. 取得 Staging 資料
                const { data: stagingData, error: fetchError } = await supabaseClient.from('service_record_staging').select('*').eq('id', stagingId).single();
                if (fetchError) throw new Error('讀取暫存資料失敗');

                // 2. 處理檔案轉移
                if (stagingData.attachment_files && stagingData.attachment_files.length > 0) {
                    for (const file of stagingData.attachment_files) {
                        const oldPath = file.path; 
                        const newPath = `${originId}/${file.name}`; 

                        // 下載 -> 上傳 -> 刪除舊檔
                        const { data: fileBlob, error: dlError } = await supabaseClient.storage.from(STAGING_BUCKET).download(oldPath);
                        if (dlError) throw new Error(`下載失敗 (${file.name}): ` + dlError.message);

                        const { error: ulError } = await supabaseClient.storage.from(RECORD_BUCKET).upload(newPath, fileBlob, { upsert: true });
                        if (ulError) throw new Error(`上傳失敗 (${file.name}): ` + ulError.message);

                        await supabaseClient.storage.from(STAGING_BUCKET).remove([oldPath]);
                    }
                }

                // 3. 更新母案 (service_records)
                const { error: updateError } = await supabaseClient.from('service_records').update({
                    visit_date: stagingData.visit_date,
                    start_time: stagingData.start_time,
                    end_time: stagingData.end_time,
                    execution_items: stagingData.service_type, 
                    updated_at: new Date()
                }).eq('id', originId);

                if (updateError) throw new Error('更新母案失敗: ' + updateError.message);

                // 4. 刪除 Staging
                await supabaseClient.from('service_record_staging').delete().eq('id', stagingId);

                alert('✅ 結案成功！資料已轉移。');
                loadPendingReviews();
                loadKPIs();

            } catch (err) {
                console.error(err);
                alert('❌ 核定失敗: ' + err.message);
            }
        }

        // ==========================================
        // 5. 催辦 Modal
        // ==========================================
        function openReminderModal(stagingId) {
            const record = pendingDataList.find(r => r.id === stagingId);
            if (!record) return;
            document.getElementById('remind-company-name').innerText = record.workplaces?.companies?.name || '未知公司';
            document.getElementById('remind-consultant-name').value = record.medical_staff?.name || '未知';
            document.getElementById('remind-consultant-addr').innerText = record.medical_staff?.email || '無 Email 資料';
            document.querySelectorAll('.remind-preview-name').forEach(el => el.innerText = record.medical_staff?.name || 'XXX');
            new bootstrap.Modal(document.getElementById('reminderEmailModal')).show();
        }

        function sendReminderEmail() {
            const name = document.getElementById('remind-consultant-name').value;
            alert(`[系統模擬發信]\n已通知 ${name} 顧問進行補件。`);
            bootstrap.Modal.getInstance(document.getElementById('reminderEmailModal')).hide();
        }
    </script>
</body>
</html>
