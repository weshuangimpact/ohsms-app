<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理者總覽 (Check/Act) | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { --primary-bg: #f4f6f9; --admin-color: #4f46e5; }
        body { background-color: var(--primary-bg); font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; }
        .section-title { border-left: 5px solid var(--admin-color); padding-left: 15px; margin-bottom: 20px; }
        .info-card { padding: 1.25rem; border-radius: 0.5rem; font-size: 0.95rem; background-color: white; border: none; }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--admin-color); }
        .chart-container { position: relative; height: 300px; width: 100%; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3 mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="#"><i class="fas fa-chart-line me-2"></i>OHSMS 管理者控制台</a>
            <div class="d-flex align-items-center">
                <span class="text-light me-3" id="user-display"><small>Admin: 管理員</small></span>
                <a href="dashboard.html" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left me-1"></i> 返回主選單</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4 pb-5">
        
        <div class="section-title">
            <h4 class="fw-bold text-dark mb-0">服務進度總覽</h4>
            <small class="text-muted">即時監控年度結案效率與待辦事項</small>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-5">
                <div class="card info-card shadow-sm h-100">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-primary text-white rounded-circle p-2 me-3">
                            <i class="fas fa-calculator fa-fw"></i>
                        </div>
                        <h5 class="fw-bold mb-0">年度結案達成率公式</h5>
                    </div>
                    <div class="p-3 bg-light rounded border-start border-4 border-primary mb-3">
                        <code class="text-dark fw-bold">已核定入庫 / ( 已核定入庫 + 暫存待審核 ) × 100%</code>
                    </div>
                    <p class="text-muted small mb-0">
                        <i class="fas fa-info-circle me-1"></i> <strong>說明：</strong><br>
                        本數據採即時計算。若當年度無待審核案件，達成率即為 <span class="text-success fw-bold">100%</span>。已核定資料指已進入正式資料庫之紀錄。
                    </p>
                </div>
            </div>

            <div class="col-md-7">
                <div class="card info-card shadow-sm h-100">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold mb-0">達成率分析</h5>
                        <select class="form-select w-auto fw-bold text-primary" id="target-year" onchange="calculateRate()">
                            <option value="2026" selected>2026 年度</option>
                            <option value="2025">2025 年度</option>
                            <option value="2024">2024 年度</option>
                        </select>
                    </div>
                    
                    <div class="row align-items-center">
                        <div class="col-md-6 text-center">
                            <div class="chart-container">
                                <canvas id="rateChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="text-muted small d-block">已核定入庫 (正式紀錄)</label>
                                <span class="stat-value text-success" id="val-approved">0</span> <small>筆</small>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small d-block">暫存待審核 (pending)</label>
                                <span class="stat-value text-warning" id="val-pending">0</span> <small>筆</small>
                            </div>
                            <hr>
                            <div>
                                <label class="fw-bold d-block">當年度總達成率</label>
                                <span class="stat-value" id="val-rate" style="font-size: 2.5rem;">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // 初始化 Supabase 
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let rateChart = null;

        document.addEventListener('DOMContentLoaded', () => {
            initChart();
            calculateRate();
        });

        function initChart() {
            const ctx = document.getElementById('rateChart').getContext('2d');
            rateChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['已入庫', '待審核'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#059669', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '70%',
                    plugins: { legend: { display: false } }
                }
            });
        }

        async function calculateRate() {
            const year = parseInt(document.getElementById('target-year').value);
            
            try {
                // 1. 讀取正式庫 service_records (已核定) [cite: 696, 703]
                const { count: approvedCount, error: err1 } = await supabaseClient
                    .from('service_records')
                    .select('*', { count: 'exact', head: true })
                    .eq('service_year', year);

                // 2. 讀取暫存庫 service_record_staging (待審核) [cite: 667, 675]
                // 註：staging 表中年度判斷以 visit_date 為主 [cite: 346, 679]
                const { data: stagingData, error: err2 } = await supabaseClient
                    .from('service_record_staging')
                    .select('visit_date')
                    .eq('status', 'pending');

                if (err1 || err2) throw (err1 || err2);

                // 篩選 staging 符合年度的資料
                const pendingCount = stagingData.filter(d => 
                    d.visit_date && new Date(d.visit_date).getFullYear() === year
                ).length;

                // 3. 計算達成率
                const total = approvedCount + pendingCount;
                const rate = total === 0 ? 100 : Math.round((approvedCount / total) * 100);

                // 4. 更新 UI
                document.getElementById('val-approved').innerText = approvedCount;
                document.getElementById('val-pending').innerText = pendingCount;
                document.getElementById('val-rate').innerText = rate + '%';

                // 5. 更新圖表
                rateChart.data.datasets[0].data = [approvedCount, pendingCount];
                if (total === 0) {
                    rateChart.data.datasets[0].data = [1, 0]; // 預設顯示 100%
                    rateChart.data.datasets[0].backgroundColor = ['#e5e7eb', '#f59e0b'];
                } else {
                    rateChart.data.datasets[0].backgroundColor = ['#059669', '#f59e0b'];
                }
                rateChart.update();

            } catch (e) {
                console.error('計算失敗:', e);
                alert('數據載入失敗');
            }
        }
    </script>
</body>
</html>
