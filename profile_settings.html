<script>
const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentEmail = '';
let currentUserId = '';
let medicalStaffId = '';

document.addEventListener('DOMContentLoaded', async () => {

    /* 1. 取得登入 Session（Auth 是唯一可信來源） */
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
        alert('登入狀態失效，請重新登入');
        window.location.href = 'login.html';
        return;
    }

    const user = session.user;
    currentUserId = user.id;
    currentEmail = user.email;

    /* 2. 從 medical_staff 撈「真實姓名 / 角色」 */
    const { data: staff, error } = await supabase
        .from('medical_staff')
        .select('id, name, system_role, email')
        .eq('user_id', user.id)
        .single();

    if (error || !staff) {
        alert('找不到對應的人員資料，請聯絡管理員');
        console.error(error);
        return;
    }

    medicalStaffId = staff.id;

    /* 3. 填充畫面（真實資料） */
    document.getElementById('user-email').value = user.email;
    document.getElementById('display-name').textContent = staff.name;
    document.getElementById('display-role').textContent = getRoleName(staff.system_role);
    document.getElementById('user-avatar').textContent = staff.name.charAt(0).toUpperCase();

    if (user.last_sign_in_at) {
        document.getElementById('last-login-time').textContent =
            new Date(user.last_sign_in_at).toLocaleString();
    }
});

/* ============================
   更新 Email / Password
============================ */
async function handleUpdate(e) {
    e.preventDefault();

    const newEmail = document.getElementById('user-email').value.trim();
    const newPwd = document.getElementById('new-password').value;
    const confirmPwd = document.getElementById('confirm-password').value;

    if (newPwd && newPwd !== confirmPwd) {
        document.getElementById('confirm-password').classList.add('is-invalid');
        return;
    }

    const updates = {};
    if (newEmail !== currentEmail) updates.email = newEmail;
    if (newPwd) updates.password = newPwd;

    if (Object.keys(updates).length === 0) {
        alert('未偵測到任何變更');
        return;
    }

    const btn = document.getElementById('btn-save');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> 寫入中...';

    try {
        /* 1. 更新 Auth */
        const { error: authErr } = await supabase.auth.updateUser(updates);
        if (authErr) throw authErr;

        /* 2. 若 Email 有改，同步更新 medical_staff */
        if (updates.email) {
            const { error: staffErr } = await supabase
                .from('medical_staff')
                .update({ email: updates.email })
                .eq('id', medicalStaffId);

            if (staffErr) throw staffErr;
            currentEmail = updates.email;
        }

        alert(
            '✅ 更新成功\n' +
            (updates.email ? '※ Email 可能需要至信箱確認後才會正式生效\n' : '') +
            (updates.password ? '※ 下次登入請使用新密碼' : '')
        );

        document.getElementById('new-password').value = '';
        document.getElementById('confirm-password').value = '';

    } catch (err) {
        alert('更新失敗：' + err.message);
        console.error(err);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '儲存變更 (寫入資料庫)';
    }
}

/* ============================
   密碼顯示切換（強化）
============================ */
function togglePassword(inputId, icon) {
    const input = document.getElementById(inputId);
    input.type = input.type === 'password' ? 'text' : 'password';

    icon.classList.toggle('fa-eye');
    icon.classList.toggle('fa-eye-slash');
}

/* ============================
   角色顯示
============================ */
function getRoleName(role) {
    return {
        admin: '系統管理員',
        consultant: '外部顧問',
        medical: '醫護人員',
        general: '一般用戶'
    }[role] || role;
}
</script>
