<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å£“åŠ›æ¸¬è©¦ä»£ç†äºº (Auto-Agent) | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary-bg: #0f172a; --card-bg: #1e293b; --text-main: #e2e8f0; --accent: #38bdf8; }
        body {
            background-color: var(--primary-bg);
            font-family: 'Segoe UI', 'Microsoft JhengHei', monospace;
            color: var(--text-main);
            display: none; /* Auth Guard */
        }
        
        .agent-card {
            background-color: var(--card-bg);
            border: 1px solid #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .console-screen {
            background-color: #000;
            border: 1px solid #333;
            color: #4ade80; /* Hacker Green */
            font-family: 'Consolas', monospace;
            height: 500px;
            overflow-y: auto;
            padding: 1rem;
            font-size: 0.9rem;
            border-radius: 4px;
            line-height: 1.5;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }

        .status-dot {
            width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px;
        }
        .status-ready { background-color: #94a3b8; box-shadow: 0 0 5px #94a3b8; }
        .status-active { background-color: #4ade80; box-shadow: 0 0 10px #4ade80; animation: pulse 1.5s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* è¼¸å…¥æ¡†ç¾åŒ– */
        .form-control-dark {
            background-color: #0f172a; border: 1px solid #475569; color: white;
        }
        .form-control-dark:focus {
            background-color: #0f172a; border-color: var(--accent); color: white; box-shadow: 0 0 0 0.25rem rgba(56, 189, 248, 0.25);
        }
        
        optgroup { color: #aaa; font-style: italic; }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ç°¡æ˜“æ¬Šé™æª¢æŸ¥
            const role = sessionStorage.getItem('currentUserRole');
            if (role !== 'admin') {
                alert('æ¬Šé™ä¸è¶³ï¼šæ­¤å€åŸŸåƒ…é™ç³»çµ±ç®¡ç†å“¡é€²è¡Œå£“åŠ›æ¸¬è©¦ã€‚');
                window.location.href = 'dashboard.html';
                return;
            }
            document.body.style.display = 'block';
        });
    </script>
</head>
<body>

    <nav class="navbar navbar-dark bg-black py-3 border-bottom border-secondary">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold text-info" href="#"><i class="fas fa-robot me-2"></i>OHSMS è‡ªå‹•åŒ–å£“åŠ›æ¸¬è©¦ä»£ç†äºº (Agent V2)</a>
            <a href="dashboard.html" class="btn btn-outline-secondary btn-sm">é€€å‡ºæ¸¬è©¦ (EXIT)</a>
        </div>
    </nav>

    <div class="container-fluid px-4 py-4">
        <div class="row g-4">
            
            <div class="col-lg-4">
                <div class="agent-card h-100 p-4 rounded-3">
                    <h5 class="fw-bold mb-4 text-white border-bottom border-secondary pb-2">
                        <i class="fas fa-sliders-h me-2"></i>åƒæ•¸è¨­å®š (Parameters)
                    </h5>

                    <div class="mb-4">
                        <label class="form-label text-secondary small fw-bold">1. æ¸¬è©¦æƒ…å¢ƒ (Scenario)</label>
                        <select class="form-select form-control-dark" id="scenarioSelect">
                            <optgroup label="è³‡æ–™åº«å¡«å…… (Data Generation)">
                                <option value="full_suite" selected>ğŸŒŸ å…¨å¥—ç”Ÿæˆ (å…¬å¸+é†«è­·+è¡Œäº‹æ›†)</option>
                                <option value="company_only">åƒ…ç”Ÿæˆå…¬å¸è³‡æ–™ (Companies)</option>
                                <option value="event_only">åƒ…ç”Ÿæˆè¡Œäº‹æ›† (Events)</option>
                            </optgroup>
                            <optgroup label="è¡Œç‚ºæ¨¡æ“¬ (Behavior Stress Test)">
                                <option value="user_behavior">ğŸ‘¥ æ¨¡æ“¬ä½¿ç”¨è€…è¡Œç‚º (ç™»å…¥/æ“ä½œ/è³‡å®‰è­¦ç¤º)</option>
                            </optgroup>
                        </select>
                        <div class="form-text text-secondary opacity-75 mt-2 small">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>å…¨å¥—ç”Ÿæˆ</strong>ï¼šå»ºç«‹éœæ…‹ä¸»æª”è³‡æ–™ã€‚<br>
                            <strong>ä½¿ç”¨è€…è¡Œç‚º</strong>ï¼šæ¨¡æ“¬ç™»å…¥/ç™»å‡º/ä¸‹è¼‰èˆ‡å…¥ä¾µå˜—è©¦ï¼Œç”¢ç”Ÿå¤§é‡ Logã€‚
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-secondary small fw-bold">2. ç”Ÿæˆæ•¸é‡ (Transactions)</label>
                        <div class="input-group">
                            <input type="number" class="form-control form-control-dark fw-bold text-center fs-5" id="qtyInput" value="50" min="1" max="1000">
                            <span class="input-group-text bg-secondary border-secondary text-white">ç­†</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-secondary small fw-bold">3. åŸ·è¡Œé€Ÿåº¦ (Rate Limit)</label>
                        <select class="form-select form-control-dark" id="speedSelect">
                            <option value="100">ğŸ”¥ æ¥µé€Ÿ (0.1s/ç­†) - æš´åŠ›æ¸¬è©¦</option>
                            <option value="500" selected>âš¡ å¿«é€Ÿ (0.5s/ç­†) - æ•ˆç‡å„ªå…ˆ</option>
                            <option value="1000">ğŸš¶ æ­£å¸¸ (1.0s/ç­†) - æ¨¡æ“¬äººå·¥</option>
                        </select>
                    </div>

                    <hr class="border-secondary my-4">

                    <div class="d-grid gap-3">
                        <button class="btn btn-success fw-bold py-2 shadow" id="btnStart" onclick="startAgent()">
                            <i class="fas fa-play me-2"></i>å•Ÿå‹•ä»£ç†äºº (EXECUTE)
                        </button>
                        <button class="btn btn-danger fw-bold py-2" id="btnStop" onclick="stopAgent()" disabled>
                            <i class="fas fa-power-off me-2"></i>ç·Šæ€¥ä¸­æ­¢ (ABORT)
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="agent-card h-100 rounded-3 d-flex flex-column">
                    <div class="p-3 bg-black border-bottom border-secondary d-flex justify-content-between align-items-center rounded-top">
                        <div>
                            <span id="statusDot" class="status-dot status-ready"></span>
                            <span id="statusText" class="fw-bold text-secondary font-monospace">SYSTEM READY</span>
                        </div>
                        <div class="text-secondary small font-monospace">LOG_STREAM_V2.1</div>
                    </div>
                    
                    <div class="console-screen flex-grow-1" id="consoleOutput">
                        <div class="text-secondary">> Initializing Supabase Connection... [OK]</div>
                        <div class="text-secondary">> Agent Module Loaded: Built-in Data Generator</div>
                        <div class="text-secondary">> Waiting for command...</div>
                    </div>

                    <div class="p-3 bg-dark border-top border-secondary rounded-bottom">
                        <div class="d-flex justify-content-between text-info small mb-1 font-monospace">
                            <span>PROGRESS</span>
                            <span id="progressText">0 / 0</span>
                        </div>
                        <div class="progress bg-secondary" style="height: 6px;">
                            <div class="progress-bar bg-info" role="progressbar" style="width: 0%" id="progressBar"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // =================================================
        // 1. Supabase è¨­å®š (å·²ä¿®æ­£è®Šæ•¸åç¨±è¡çª)
        // =================================================
        const SUPABASE_URL = 'https://ghpxaeenikochgrnczic.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_v0ZN2OY08lh-8EC8ps8NdQ_ChYo1FRW';
        
        // ä¿®æ­£ï¼šä½¿ç”¨ db ä½œç‚ºå®¢æˆ¶ç«¯è®Šæ•¸ï¼Œé¿å…èˆ‡å…¨åŸŸ supabase è¡çª
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // =================================================
        // 2. å…§å»ºå‡è³‡æ–™ç”Ÿæˆå™¨ (Built-in Faker)
        // =================================================
        // ç‚ºäº†ç¢ºä¿ä¸ä¾è³´å¤–éƒ¨ CDNï¼Œæˆ‘å€‘è‡ªå·±å¯«ä¸€å€‹ç°¡å–®çš„ç”Ÿæˆå™¨
        const FakeGen = {
            surnames: ['ç‹', 'æ', 'å¼µ', 'é™³', 'æ—', 'é»ƒ', 'å³', 'åŠ‰', 'è”¡', 'æ¥Š'],
            names: ['å¤§æ˜', 'å°è¯', 'ç¾éº—', 'å¿—è±ª', 'é›…å©·', 'å»ºåœ‹', 'æ·‘èŠ¬', 'å† å®‡', 'æ€¡å›'],
            industries: ['ç§‘æŠ€', 'ç”ŸæŠ€', 'å¡‘è† ', 'é‹¼éµ', 'ç‰©æµ', 'é£Ÿå“', 'é›»å­', 'ç²¾å¯†'],
            cities: ['å°åŒ—', 'æ–°åŒ—', 'æ¡ƒåœ’', 'å°ä¸­', 'å°å—', 'é«˜é›„', 'æ–°ç«¹'],
            
            getName: function() {
                return this.surnames[Math.floor(Math.random() * this.surnames.length)] + 
                       this.names[Math.floor(Math.random() * this.names.length)];
            },
            
            getCompany: function() {
                return this.getName() + 'æ°' + 
                       this.industries[Math.floor(Math.random() * this.industries.length)] + 
                       'è‚¡ä»½æœ‰é™å…¬å¸';
            },
            
            getPhone: function() {
                return '09' + Math.floor(Math.random() * 100000000).toString().padStart(8, '0');
            },
            
            getTaxId: function() {
                return Math.floor(Math.random() * 90000000 + 10000000).toString();
            },
            
            getAddress: function() {
                return this.cities[Math.floor(Math.random() * this.cities.length)] + 
                       'å¸‚å·¥æ¥­è·¯' + Math.floor(Math.random() * 500) + 'è™Ÿ';
            },

            getIp: function() {
                return `${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`;
            }
        };

        // =================================================
        // 3. æ ¸å¿ƒè®Šæ•¸èˆ‡æ§åˆ¶
        // =================================================
        let isRunning = false;
        let shouldStop = false;
        const consoleEl = document.getElementById('consoleOutput');

        async function startAgent() {
            if (isRunning) return;

            // UI é–å®š
            isRunning = true;
            shouldStop = false;
            document.getElementById('btnStart').disabled = true;
            document.getElementById('btnStop').disabled = false;
            document.getElementById('statusDot').className = 'status-dot status-active';
            document.getElementById('statusText').className = 'fw-bold text-success font-monospace';
            document.getElementById('statusText').innerText = 'AGENT RUNNING...';

            const qty = parseInt(document.getElementById('qtyInput').value);
            const speed = parseInt(document.getElementById('speedSelect').value);
            const scenario = document.getElementById('scenarioSelect').value;

            log(`>>> ä»»å‹™å•Ÿå‹•: ç›®æ¨™ ${qty} ç­† | æ¨¡å¼: ${scenario.toUpperCase()}`, 'system');

            let successCount = 0;

            for (let i = 0; i < qty; i++) {
                if (shouldStop) {
                    log('!!! ä½¿ç”¨è€…å¼·åˆ¶ä¸­æ­¢ä»»å‹™ !!!', 'error');
                    break;
                }

                try {
                    // æ ¹æ“šé¸æ“‡çš„æƒ…å¢ƒåŸ·è¡Œä¸åŒé‚è¼¯
                    if (scenario === 'full_suite') {
                        await generateFullSuite();
                    } else if (scenario === 'company_only') {
                        await generateCompanyOnly();
                    } else if (scenario === 'event_only') {
                        await generateEventOnly();
                    } else if (scenario === 'user_behavior') {
                        await generateUserBehavior();
                    }
                    successCount++;
                } catch (e) {
                    console.error(e);
                    log(`[ERROR] ç¬¬ ${i+1} ç­†å¤±æ•—: ${e.message}`, 'error');
                }

                // æ›´æ–°é€²åº¦æ¢
                const percent = Math.round(((i + 1) / qty) * 100);
                document.getElementById('progressBar').style.width = percent + '%';
                document.getElementById('progressText').innerText = `${i + 1} / ${qty}`;

                // æ¨¡æ“¬å»¶é²
                await new Promise(r => setTimeout(r, speed));
            }

            // çµæŸ
            log(`<<< ä»»å‹™å®Œæˆã€‚æˆåŠŸåŸ·è¡Œ ${successCount} æ¬¡æ“ä½œã€‚`, 'success');
            resetUI();
        }

        function stopAgent() {
            shouldStop = true;
            log('æ­£åœ¨ä¸­æ­¢...', 'warning');
        }

        function resetUI() {
            isRunning = false;
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnStop').disabled = true;
            document.getElementById('statusDot').className = 'status-dot status-ready';
            document.getElementById('statusText').className = 'fw-bold text-secondary font-monospace';
            document.getElementById('statusText').innerText = 'SYSTEM READY';
        }

        function log(msg, type = 'info') {
            const time = new Date().toLocaleTimeString('zh-TW', { hour12: false });
            let color = '#ccc';
            if (type === 'success') color = '#4ade80'; // Green
            if (type === 'error') color = '#f87171';   // Red
            if (type === 'warning') color = '#fbbf24'; // Yellow
            if (type === 'system') color = '#38bdf8';  // Blue
            if (type === 'security') color = '#f472b6'; // Pink

            const line = document.createElement('div');
            line.style.color = color;
            line.style.marginBottom = '4px';
            line.innerHTML = `<span style="opacity:0.5; font-size:0.8em;">[${time}]</span> ${msg}`;
            consoleEl.appendChild(line);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        // =================================================
        // 4. è³‡æ–™ç”Ÿæˆå™¨ (Generators)
        // =================================================
        
        // 4-1. å…¨å¥—è³‡æ–™ç”Ÿæˆ
        async function generateFullSuite() {
            const companyName = FakeGen.getCompany();
            const taxId = FakeGen.getTaxId();
            
            // å¯«å…¥å…¬å¸
            const { data: coData, error: coError } = await db.from('companies').insert([{
                tax_id: taxId,
                name: companyName,
                address: FakeGen.getAddress(),
                contact_person: FakeGen.getName() + 'ç¶“ç†',
                phone: FakeGen.getPhone()
            }]).select();

            if (coError) throw new Error(coError.message);
            const companyId = coData[0].id;
            log(`[DATA] å»ºç«‹å…¬å¸: ${companyName} (${taxId})`);

            // å¯«å…¥ç¨½æ ¸
            await db.from('audit_logs').insert([{
                user_role: 'admin', user_name: 'AI_Agent', action_type: 'è³‡æ–™ç”Ÿæˆ', target_table: 'companies', details: `è‡ªå‹•ç”Ÿæˆå…¬å¸è³‡æ–™: ${companyName}`
            }]);

            // é †ä¾¿å»ºç«‹è¡Œç¨‹
            const pastDate = new Date(); pastDate.setDate(pastDate.getDate() - Math.floor(Math.random() * 20));
            await db.from('compliance_events').insert([{
                title: `æ€¥æ•‘äººå“¡è¤‡è¨“ (${companyName})`,
                event_type: 'training',
                event_date: pastDate.toISOString().split('T')[0],
                priority: 'high',
                company_id: companyId,
                status: 'pending'
            }]);
        }

        // 4-2. å–®ç¨ç”Ÿæˆå…¬å¸
        async function generateCompanyOnly() {
            const name = FakeGen.getCompany();
            const tax = FakeGen.getTaxId();
            const { error } = await db.from('companies').insert([{ tax_id: tax, name: name }]);
            if (error) throw error;
            log(`[DATA] å»ºç«‹å…¬å¸: ${name}`);
        }

        // 4-3. å–®ç¨ç”Ÿæˆäº‹ä»¶
        async function generateEventOnly() {
            const title = "å¹´åº¦æ³•è¦æŸ¥æ ¸-" + FakeGen.getTaxId();
            await db.from('compliance_events').insert([{
                title: title, event_type: 'document', event_date: new Date().toISOString().split('T')[0]
            }]);
            log(`[DATA] å»ºç«‹äº‹ä»¶: ${title}`);
        }

        // 4-4. è¡Œç‚ºæ¨¡æ“¬å™¨
        async function generateUserBehavior() {
            const dice = Math.random();
            let role, user, action, target, detail, type = 'info';

            // 10% æ©Ÿç‡è³‡å®‰äº‹ä»¶
            if (dice < 0.1) {
                role = 'unknown'; user = 'Anonymous';
                if (Math.random() > 0.5) {
                    action = 'ç•°å¸¸ç™»å…¥'; target = 'Login Page'; detail = `å¯†ç¢¼éŒ¯èª¤æ¬¡æ•¸éå¤š (IP: ${FakeGen.getIp()})`; type = 'error';
                } else {
                    action = 'è¶Šæ¬Šå­˜å–'; target = 'admin_dashboard'; detail = `å˜—è©¦å­˜å–å—ä¿è­·é é¢ (IP: ${FakeGen.getIp()})`; type = 'security';
                }
            } else {
                const users = [{r:'admin',n:'Admin'}, {r:'medical',n:'Dr. Wang'}, {r:'general',n:'User Chen'}];
                const u = users[Math.floor(Math.random()*users.length)];
                role = u.r; user = u.n;
                const acts = ['ç™»å…¥', 'ç™»å‡º', 'ç€è¦½', 'ä¸‹è¼‰', 'ä¿®æ”¹'];
                action = acts[Math.floor(Math.random()*acts.length)];
                target = 'System'; detail = 'ä¸€èˆ¬æ“ä½œ';
            }

            const { error } = await db.from('audit_logs').insert([{
                user_role: role, user_name: user, action_type: action, target_table: target, details: detail, ip_address: FakeGen.getIp()
            }]);

            if (error) throw error;
            log(`[BEHAVIOR] ${user} -> ${action}`, type);
        }

    </script>
</body>
</html>
