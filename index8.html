<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å£“åŠ›æ¸¬è©¦ä»£ç†äºº (Auto-Agent) | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary-bg: #0f172a; --card-bg: #1e293b; --text-main: #e2e8f0; --accent: #38bdf8; }
        body {
            background-color: var(--primary-bg);
            font-family: 'Segoe UI', 'Microsoft JhengHei', monospace;
            color: var(--text-main);
            display: none; /* Auth Guard */
        }
        
        .agent-card {
            background-color: var(--card-bg);
            border: 1px solid #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .console-screen {
            background-color: #000;
            border: 1px solid #333;
            color: #4ade80; /* Hacker Green */
            font-family: 'Consolas', monospace;
            height: 500px;
            overflow-y: auto;
            padding: 1rem;
            font-size: 0.9rem;
            border-radius: 4px;
            line-height: 1.5;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }

        .status-dot {
            width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px;
        }
        .status-ready { background-color: #94a3b8; box-shadow: 0 0 5px #94a3b8; }
        .status-active { background-color: #4ade80; box-shadow: 0 0 10px #4ade80; animation: pulse 1.5s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        .form-control-dark {
            background-color: #0f172a; border: 1px solid #475569; color: white;
        }
        .form-control-dark:focus {
            background-color: #0f172a; border-color: var(--accent); color: white; box-shadow: 0 0 0 0.25rem rgba(56, 189, 248, 0.25);
        }
        
        optgroup { color: #aaa; font-style: italic; }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const role = sessionStorage.getItem('currentUserRole');
            if (role !== 'admin') {
                alert('æ¬Šé™ä¸è¶³ï¼šæ­¤å€åŸŸåƒ…é™ç³»çµ±ç®¡ç†å“¡é€²è¡Œå£“åŠ›æ¸¬è©¦ã€‚');
                window.location.href = 'dashboard.html';
                return;
            }
            document.body.style.display = 'block';
        });
    </script>
</head>
<body>

    <nav class="navbar navbar-dark bg-black py-3 border-bottom border-secondary">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold text-info" href="#"><i class="fas fa-robot me-2"></i>OHSMS è‡ªå‹•åŒ–å£“åŠ›æ¸¬è©¦ä»£ç†äºº (Agent V4.0)</a>
            <a href="dashboard.html" class="btn btn-outline-secondary btn-sm">é€€å‡ºæ¸¬è©¦ (EXIT)</a>
        </div>
    </nav>

    <div class="container-fluid px-4 py-4">
        <div class="row g-4">
            
            <div class="col-lg-4">
                <div class="agent-card h-100 p-4 rounded-3">
                    <h5 class="fw-bold mb-4 text-white border-bottom border-secondary pb-2">
                        <i class="fas fa-sliders-h me-2"></i>åƒæ•¸è¨­å®š (Parameters)
                    </h5>

                    <div class="mb-4">
                        <label class="form-label text-secondary small fw-bold">1. æ¸¬è©¦æƒ…å¢ƒ (Scenario)</label>
                        <select class="form-select form-control-dark" id="scenarioSelect">
                            <optgroup label="å…¨æµç¨‹æ•´åˆ (Integrated)">
                                <option value="full_suite" selected>ğŸŒŸ å…¨å¥—ç”Ÿæˆ (å…¬å¸+é†«ç™‚+ç´€éŒ„+è¡Œäº‹æ›†åŒæ­¥)</option>
                            </optgroup>
                            <optgroup label="å–®é …å¡«å…… (Single Table)">
                                <option value="company_only">åƒ…ç”Ÿæˆå…¬å¸è³‡æ–™ (Companies)</option>
                                <option value="event_only">åƒ…ç”Ÿæˆè¡Œäº‹æ›† (Events)</option>
                            </optgroup>
                            <optgroup label="è¡Œç‚ºæ¨¡æ“¬ (Behavior)">
                                <option value="user_behavior">ğŸ‘¥ æ¨¡æ“¬ä½¿ç”¨è€…è¡Œç‚º (ç™»å…¥/æ“ä½œ/è³‡å®‰è­¦ç¤º)</option>
                            </optgroup>
                        </select>
                        <div class="form-text text-secondary opacity-75 mt-2 small">
                            <i class="fas fa-check-circle me-1 text-success"></i>
                            <strong>å…¨å¥—ç”Ÿæˆ V4</strong>ï¼šå»ºç«‹å…¬å¸ -> å»ºç«‹ä½œæ¥­å ´æ‰€ -> ç”¢ç”Ÿè‡¨å ´æœå‹™ç´€éŒ„ -> è‡ªå‹•åŒæ­¥è‡³è¡Œäº‹æ›† (è¨­ç‚ºå·²å®Œæˆ)ã€‚
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-secondary small fw-bold">2. ç”Ÿæˆæ•¸é‡ (Sets)</label>
                        <div class="input-group">
                            <input type="number" class="form-control form-control-dark fw-bold text-center fs-5" id="qtyInput" value="10" min="1" max="1000">
                            <span class="input-group-text bg-secondary border-secondary text-white">å¥—</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-secondary small fw-bold">3. åŸ·è¡Œé€Ÿåº¦ (Rate Limit)</label>
                        <select class="form-select form-control-dark" id="speedSelect">
                            <option value="200">æ¥µé€Ÿ (0.2s/ç­†) - å£“åŠ›æ¸¬è©¦</option>
                            <option value="800" selected>æ­£å¸¸ (0.8s/ç­†) - æ¨¡æ“¬äººå·¥</option>
                            <option value="2000">æ…¢é€Ÿ (2.0s/ç­†) - æ¼”ç¤ºç”¨</option>
                        </select>
                    </div>

                    <hr class="border-secondary my-4">

                    <div class="d-grid gap-3">
                        <button class="btn btn-success fw-bold py-2 shadow" id="btnStart" onclick="startAgent()">
                            <i class="fas fa-play me-2"></i>å•Ÿå‹•ä»£ç†äºº (EXECUTE)
                        </button>
                        <button class="btn btn-danger fw-bold py-2" id="btnStop" onclick="stopAgent()" disabled>
                            <i class="fas fa-power-off me-2"></i>ç·Šæ€¥ä¸­æ­¢ (ABORT)
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="agent-card h-100 rounded-3 d-flex flex-column">
                    <div class="p-3 bg-black border-bottom border-secondary d-flex justify-content-between align-items-center rounded-top">
                        <div>
                            <span id="statusDot" class="status-dot status-ready"></span>
                            <span id="statusText" class="fw-bold text-secondary font-monospace">SYSTEM READY</span>
                        </div>
                        <div class="text-secondary small font-monospace">LOG_STREAM_V4.0</div>
                    </div>
                    
                    <div class="console-screen flex-grow-1" id="consoleOutput">
                        <div class="text-secondary">> Initializing Supabase Connection... [OK]</div>
                        <div class="text-secondary">> Agent Module Loaded: Integrated Workflow Generator</div>
                        <div class="text-secondary">> Waiting for command...</div>
                    </div>

                    <div class="p-3 bg-dark border-top border-secondary rounded-bottom">
                        <div class="d-flex justify-content-between text-info small mb-1 font-monospace">
                            <span>PROGRESS</span>
                            <span id="progressText">0 / 0</span>
                        </div>
                        <div class="progress bg-secondary" style="height: 6px;">
                            <div class="progress-bar bg-info" role="progressbar" style="width: 0%" id="progressBar"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Faker/3.1.0/faker.min.js"></script>

    <script>
        // 1. Supabase Init
        const SUPABASE_URL = 'https://ghpxaeenikochgrnczic.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_v0ZN2OY08lh-8EC8ps8NdQ_ChYo1FRW';
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 2. Data Generators (Updated)
        const FakeGen = {
            surnames: ['ç‹', 'æ', 'å¼µ', 'é™³', 'æ—', 'é»ƒ', 'å³', 'åŠ‰', 'è”¡', 'æ¥Š'],
            names: ['å¤§æ˜', 'å°è¯', 'ç¾éº—', 'å¿—è±ª', 'é›…å©·', 'å»ºåœ‹', 'æ·‘èŠ¬', 'å† å®‡', 'æ€¡å›'],
            industries: ['ç§‘æŠ€', 'ç”ŸæŠ€', 'å¡‘è† ', 'é‹¼éµ', 'ç‰©æµ', 'é£Ÿå“', 'é›»å­', 'ç²¾å¯†'],
            cities: ['å°åŒ—', 'æ–°åŒ—', 'æ¡ƒåœ’', 'å°ä¸­', 'å°å—', 'é«˜é›„', 'æ–°ç«¹'],
            
            processes: [
                'æ•´ç¶“æ¼¿ç´— -> ç¹”å¸ƒ -> è„«æ¼¿ -> æˆå¸ƒåŠ å·¥ -> å“è³ªæª¢é©—',
                'åŸæ–™å…¥åº« -> è£åˆ‡æ²–å£“ -> è¡¨é¢è™•ç† -> çµ„è£æ¸¬è©¦ -> åŒ…è£å‡ºè²¨',
                'åŒ–å­¸å“èª¿é… -> åæ‡‰æ§½èšåˆ -> é›¢å¿ƒä¹¾ç‡¥ -> ç²‰ç¢éç¯©',
                'é€²è²¨é©—æ”¶ -> å€‰å„²ä¸Šæ¶ -> æ€è²¨ç†è²¨ -> é…é€é‹è¼¸'
            ],
            hazards: [
                {type: 'é«˜æº«', count: 5, desc: 'é‹çˆå€ä½œæ¥­ç’°å¢ƒæº«åº¦é«˜'},
                {type: 'å™ªéŸ³', count: 20, desc: 'ç¹”å¸ƒæ©Ÿé‹è½‰è²éŸ¿å¤§æ–¼85åˆ†è²'},
                {type: 'äººå› ', count: 15, desc: 'é•·æœŸæ¬é‹20kgä»¥ä¸Šç‰©æ–™'},
                {type: 'åŒ–å­¸', count: 3, desc: 'æœ‰æ©Ÿæº¶åŠ‘(ç”²è‹¯)æš´éœ²é¢¨éšª'}
            ],
            issues: [
                '9-3 è¾¦ç†å¥åº·æª¢æŸ¥çµæœç•°å¸¸è€…ä¹‹è¿½è¹¤ç®¡ç†åŠå¥åº·æŒ‡å°ã€‚',
                '11-1 è¾¨è­˜èˆ‡è©•ä¼°å·¥ä½œå ´æ‰€ç’°å¢ƒå±å®³å› å­ï¼Œå»ºè­°å¢è¨­å±€éƒ¨æ’æ°£ã€‚',
                '11-2 æå‡ºä½œæ¥­ç’°å¢ƒå®‰å…¨è¡›ç”Ÿè¨­æ–½æ”¹å–„è¦åŠƒ (é˜²éŸ³é˜²è­·å…·)ã€‚',
                '9-7 å·¥ä½œç›¸é—œå‚·ç—…ä¹‹é é˜²ï¼šäººå› æ€§è‚Œè‚‰éª¨éª¼å±å®³é é˜²å®£å°ã€‚'
            ],
            
            getCompany: function() { return this.surnames[Math.floor(Math.random()*this.surnames.length)] + this.names[Math.floor(Math.random()*this.names.length)] + this.industries[Math.floor(Math.random()*this.industries.length)] + 'è‚¡ä»½æœ‰é™å…¬å¸'; },
            getPhone: function() { return '09' + Math.floor(Math.random()*100000000).toString().padStart(8,'0'); },
            getTaxId: function() { return Math.floor(Math.random()*90000000+10000000).toString(); },
            getIp: function() { return `192.168.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`; },
            getAddress: function() { return this.cities[Math.floor(Math.random()*this.cities.length)] + 'å¸‚å·¥æ¥­è·¯' + Math.floor(Math.random()*500) + 'è™Ÿ'; },
            getName: function() { return this.surnames[Math.floor(Math.random()*this.surnames.length)] + this.names[Math.floor(Math.random()*this.names.length)]; }
        };

        // 3. Core Logic
        let isRunning = false, shouldStop = false;
        const consoleEl = document.getElementById('consoleOutput');

        async function startAgent() {
            if (isRunning) return;
            isRunning = true; shouldStop = false;
            document.getElementById('btnStart').disabled = true;
            document.getElementById('btnStop').disabled = false;
            document.getElementById('statusDot').className = 'status-dot status-active';
            document.getElementById('statusText').innerText = 'AGENT RUNNING...';

            const qty = parseInt(document.getElementById('qtyInput').value);
            const speed = parseInt(document.getElementById('speedSelect').value);
            const scenario = document.getElementById('scenarioSelect').value;

            log(`>>> ä»»å‹™å•Ÿå‹•: ç”Ÿæˆ ${qty} å¥— | æ¨¡å¼: ${scenario.toUpperCase()}`, 'system');

            try {
                let successCount = 0;
                for (let i = 0; i < qty; i++) {
                    if (shouldStop) { log('!!! å¼·åˆ¶ä¸­æ­¢ !!!', 'error'); break; }

                    try {
                        if (scenario === 'full_suite') await generateFullSuite();
                        else if (scenario === 'company_only') await generateCompanyOnly();
                        else if (scenario === 'event_only') await generateEventOnly();
                        else if (scenario === 'user_behavior') await generateUserBehavior();
                        successCount++;
                    } catch (e) {
                        log(`[ERROR] Item ${i+1}: ${e.message}`, 'error');
                    }

                    const percent = Math.round(((i+1)/qty)*100);
                    document.getElementById('progressBar').style.width = percent + '%';
                    document.getElementById('progressText').innerText = `${i+1} / ${qty}`;
                    await new Promise(r => setTimeout(r, speed));
                }
                log(`<<< ä»»å‹™å®Œæˆã€‚æˆåŠŸ ${successCount} å¥—ã€‚`, 'success');
            } catch(e) {
                log(`[CRITICAL] ${e.message}`, 'error');
            }
            resetUI();
        }

        function stopAgent() { shouldStop = true; log('æ­£åœ¨ä¸­æ­¢...', 'warning'); }
        function resetUI() {
            isRunning = false;
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnStop').disabled = true;
            document.getElementById('statusDot').className = 'status-dot status-ready';
            document.getElementById('statusText').innerText = 'SYSTEM READY';
        }
        function log(msg, type='info') {
            const time = new Date().toLocaleTimeString('zh-TW',{hour12:false});
            let color = '#ccc';
            if(type==='success') color='#4ade80'; if(type==='error') color='#f87171';
            if(type==='warning') color='#fbbf24'; if(type==='system') color='#38bdf8';
            const div = document.createElement('div');
            div.style.color = color;
            div.innerHTML = `<span style="opacity:0.5">[${time}]</span> ${msg}`;
            consoleEl.appendChild(div);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        // ================= Generator Functions ================= //

        // æ ¸å¿ƒï¼šå…¨å¥—ç”Ÿæˆ V4.0 (å…¬å¸ -> é†«è­· -> ç´€éŒ„ -> è¡Œäº‹æ›†åŒæ­¥)
        async function generateFullSuite() {
            // 1. å»ºç«‹å…¬å¸
            const coName = FakeGen.getCompany();
            const taxId = FakeGen.getTaxId();
            const { data: coData, error: coError } = await db.from('companies').insert([{
                tax_id: taxId, name: coName, address: FakeGen.getAddress(),
                contact_person: FakeGen.getName()+'ç¶“ç†', phone: FakeGen.getPhone()
            }]).select();
            if (coError) throw coError;
            const coId = coData[0].id;
            
            // 2. å»ºç«‹é†«è­· (æŒ‡æ´¾)
            const staffName = FakeGen.getName();
            const staffRole = Math.random() > 0.6 ? 'é†«å¸«' : 'è­·ç†äººå“¡';
            await db.from('medical_staff').insert([{
                name: staffName, role: staffRole, employment_type: 'å…¼è·', phone: FakeGen.getPhone()
            }]);

            // 3. å»ºç«‹ä½œæ¥­å ´æ‰€ (Workplace)
            const hazard = FakeGen.hazards[Math.floor(Math.random() * FakeGen.hazards.length)];
            const { data: wpData, error: wpError } = await db.from('workplaces').insert([{
                company_id: coId,
                department_name: 'ç”Ÿç”¢éƒ¨',
                admin_male: 10, admin_female: 10, site_male: 30, site_female: 20,
                hazard_type: hazard.type, hazard_count: hazard.count
            }]).select();
            if (wpError) throw wpError;
            const wpId = wpData[0].id;

            // 4. ç”Ÿæˆè‡¨å ´æœå‹™ç´€éŒ„ (Service Record) - æ—¥æœŸè¨­ç‚ºæœ€è¿‘ 30 å¤©å…§
            const today = new Date();
            const visitDate = new Date();
            visitDate.setDate(today.getDate() - Math.floor(Math.random() * 30));
            const visitDateStr = visitDate.toISOString().split('T')[0];

            await db.from('service_records').insert([{
                workplace_id: wpId,
                visit_date: visitDateStr,
                start_time: '09:00', end_time: '12:00',
                process_desc: FakeGen.processes[0],
                hazard_desc: hazard.desc,
                execution_items: '9-3, 11-1',
                doctor_signature: staffName + ' ' + staffRole
            }]);

            // 5. åŒæ­¥è‡³è¡Œäº‹æ›† (Calendar) - è®“ç®¡ç†è€…çŸ¥é“é€™å¤©æœ‰æœå‹™ä¸”å·²å®Œæˆ
            await db.from('compliance_events').insert([{
                title: `è‡¨å ´æœå‹™ (${coName})`,
                event_type: 'service',
                event_date: visitDateStr,
                priority: 'medium',
                company_id: coId,
                status: 'completed', // è¨­å®šç‚ºå·²å®Œæˆï¼Œå› ç‚ºç´€éŒ„å·²ç”¢ç”Ÿ
                details: `ç”± ${staffName} ${staffRole} åŸ·è¡Œã€‚å±å®³é¡å‹ï¼š${hazard.type}`
            }]);

            // 6. åŠ ä¸€ç­†æœªä¾†çš„å¾…è¾¦äº‹é … (è®“è¡Œäº‹æ›†æœ‰é»è®ŠåŒ–)
            const futureDate = new Date();
            futureDate.setDate(today.getDate() + Math.floor(Math.random() * 60) + 10);
            await db.from('compliance_events').insert([{
                title: `è¿½è¹¤æ”¹å–„äº‹é … (${coName})`,
                event_type: 'meeting',
                event_date: futureDate.toISOString().split('T')[0],
                priority: 'high',
                company_id: coId,
                status: 'pending'
            }]);

            log(`[FULL] å»ºç«‹å®Œæ•´ç”Ÿæ…‹ç³»: ${coName} (å«ç´€éŒ„èˆ‡è¡Œäº‹æ›†)`, 'success');
            
            // å¯«å…¥ Log
            await db.from('audit_logs').insert([{
                user_role: 'admin', user_name: 'AI_Agent', action_type: 'å…¨å¥—ç”Ÿæˆ', target_table: 'SYSTEM', details: `Auto-generated suite for ${coName}`
            }]);
        }

        // è¼”åŠ©ç”Ÿæˆï¼šå–®ç¨å…¬å¸
        async function generateCompanyOnly() {
            const name = FakeGen.getCompany();
            await db.from('companies').insert([{ tax_id: FakeGen.getTaxId(), name: name }]);
            log(`[DATA] å…¬å¸: ${name}`);
        }

        // è¼”åŠ©ç”Ÿæˆï¼šå–®ç¨è¡Œäº‹æ›†
        async function generateEventOnly() {
            const title = "å¹´åº¦æ³•è¦æŸ¥æ ¸";
            await db.from('compliance_events').insert([{
                title: title, event_type: 'document', event_date: new Date().toISOString().split('T')[0]
            }]);
            log(`[DATA] äº‹ä»¶: ${title}`);
        }

        // è¼”åŠ©ç”Ÿæˆï¼šä½¿ç”¨è€…è¡Œç‚º
        async function generateUserBehavior() {
            const acts = ['ç™»å…¥', 'æŸ¥è©¢', 'ä¸‹è¼‰', 'ä¿®æ”¹'];
            const act = acts[Math.floor(Math.random()*acts.length)];
            await db.from('audit_logs').insert([{
                user_role: 'general', user_name: FakeGen.getName(),
                action_type: act, target_table: 'system', details: 'å£“åŠ›æ¸¬è©¦æ¨¡æ“¬'
            }]);
            log(`[BEHAVIOR] ${act}`);
        }
    </script>
</body>
</html>
