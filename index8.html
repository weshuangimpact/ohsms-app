<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å£“åŠ›æ¸¬è©¦ä»£ç†äºº (Auto-Agent) | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary-bg: #0f172a; --card-bg: #1e293b; --text-main: #e2e8f0; --accent: #38bdf8; }
        body {
            background-color: var(--primary-bg);
            font-family: 'Segoe UI', 'Microsoft JhengHei', monospace;
            color: var(--text-main);
            display: none; /* Auth Guard */
        }
        
        .agent-card {
            background-color: var(--card-bg);
            border: 1px solid #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .console-screen {
            background-color: #000;
            border: 1px solid #333;
            color: #4ade80; /* Hacker Green */
            font-family: 'Consolas', monospace;
            height: 500px;
            overflow-y: auto;
            padding: 1rem;
            font-size: 0.9rem;
            border-radius: 4px;
            line-height: 1.5;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }

        .status-dot {
            width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px;
        }
        .status-ready { background-color: #94a3b8; box-shadow: 0 0 5px #94a3b8; }
        .status-active { background-color: #4ade80; box-shadow: 0 0 10px #4ade80; animation: pulse 1.5s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* è¼¸å…¥æ¡†ç¾åŒ– */
        .form-control-dark {
            background-color: #0f172a; border: 1px solid #475569; color: white;
        }
        .form-control-dark:focus {
            background-color: #0f172a; border-color: var(--accent); color: white; box-shadow: 0 0 0 0.25rem rgba(56, 189, 248, 0.25);
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ç°¡æ˜“æ¬Šé™æª¢æŸ¥
            const role = sessionStorage.getItem('currentUserRole');
            if (role !== 'admin') {
                alert('æ¬Šé™ä¸è¶³ï¼šæ­¤å€åŸŸåƒ…é™ç³»çµ±ç®¡ç†å“¡é€²è¡Œå£“åŠ›æ¸¬è©¦ã€‚');
                window.location.href = 'dashboard.html';
                return;
            }
            document.body.style.display = 'block';
        });
    </script>
</head>
<body>

    <nav class="navbar navbar-dark bg-black py-3 border-bottom border-secondary">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold text-info" href="#"><i class="fas fa-robot me-2"></i>OHSMS è‡ªå‹•åŒ–å£“åŠ›æ¸¬è©¦ä»£ç†äºº (Agent)</a>
            <a href="dashboard.html" class="btn btn-outline-secondary btn-sm">é€€å‡ºæ¸¬è©¦ (EXIT)</a>
        </div>
    </nav>

    <div class="container-fluid px-4 py-4">
        <div class="row g-4">
            
            <div class="col-lg-4">
                <div class="agent-card h-100 p-4 rounded-3">
                    <h5 class="fw-bold mb-4 text-white border-bottom border-secondary pb-2">
                        <i class="fas fa-sliders-h me-2"></i>åƒæ•¸è¨­å®š (Parameters)
                    </h5>

                    <div class="mb-4">
                        <label class="form-label text-secondary small fw-bold">1. æ¸¬è©¦æƒ…å¢ƒ (Scenario)</label>
                        <select class="form-select form-control-dark" id="scenarioSelect">
                            <option value="full_suite" selected>ğŸŒŸ å…¨å¥—ç”Ÿæˆ (å…¬å¸+é†«è­·+è¡Œäº‹æ›†)</option>
                            <option value="company_only">åƒ…ç”Ÿæˆå…¬å¸è³‡æ–™</option>
                            <option value="event_only">åƒ…ç”Ÿæˆè¡Œäº‹æ›†/é è­¦</option>
                        </select>
                        <div class="form-text text-secondary opacity-75 mt-2 small">
                            <i class="fas fa-info-circle me-1"></i>å…¨å¥—ç”Ÿæˆæ¨¡å¼ä¸‹ï¼Œæ¯ç”¢ç”Ÿ 1 ç­†è³‡æ–™ = å»ºç«‹ 1 å®¶å…¬å¸ + 1 ä½å°æ‡‰é†«è­· + 2 é …æ³•è¦è¡Œç¨‹ã€‚
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-secondary small fw-bold">2. ç”Ÿæˆæ•¸é‡ (Sets)</label>
                        <div class="input-group">
                            <input type="number" class="form-control form-control-dark fw-bold text-center fs-5" id="qtyInput" value="50" min="1" max="500">
                            <span class="input-group-text bg-secondary border-secondary text-white">å¥—</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-secondary small fw-bold">3. å¯«å…¥é€Ÿåº¦ (Throttle)</label>
                        <select class="form-select form-control-dark" id="speedSelect">
                            <option value="200">æ¥µé€Ÿ (0.2s/ç­†) - å£“åŠ›æ¸¬è©¦</option>
                            <option value="800" selected>æ­£å¸¸ (0.8s/ç­†) - æ¨¡æ“¬äººå·¥</option>
                            <option value="2000">æ…¢é€Ÿ (2.0s/ç­†) - æ¼”ç¤ºç”¨</option>
                        </select>
                    </div>

                    <hr class="border-secondary my-4">

                    <div class="d-grid gap-3">
                        <button class="btn btn-success fw-bold py-2 shadow" id="btnStart" onclick="startAgent()">
                            <i class="fas fa-play me-2"></i>å•Ÿå‹•ä»£ç†äºº (EXECUTE)
                        </button>
                        <button class="btn btn-danger fw-bold py-2" id="btnStop" onclick="stopAgent()" disabled>
                            <i class="fas fa-power-off me-2"></i>ç·Šæ€¥ä¸­æ­¢ (ABORT)
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="agent-card h-100 rounded-3 d-flex flex-column">
                    <div class="p-3 bg-black border-bottom border-secondary d-flex justify-content-between align-items-center rounded-top">
                        <div>
                            <span id="statusDot" class="status-dot status-ready"></span>
                            <span id="statusText" class="fw-bold text-secondary font-monospace">SYSTEM READY</span>
                        </div>
                        <div class="text-secondary small font-monospace">LOG_STREAM_V1.0</div>
                    </div>
                    
                    <div class="console-screen flex-grow-1" id="consoleOutput">
                        <div class="text-secondary">> Initializing Supabase Connection... [OK]</div>
                        <div class="text-secondary">> Waiting for command...</div>
                    </div>

                    <div class="p-3 bg-dark border-top border-secondary rounded-bottom">
                        <div class="d-flex justify-content-between text-info small mb-1 font-monospace">
                            <span>PROGRESS</span>
                            <span id="progressText">0 / 0</span>
                        </div>
                        <div class="progress bg-secondary" style="height: 6px;">
                            <div class="progress-bar bg-info" role="progressbar" style="width: 0%" id="progressBar"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Faker/3.1.0/faker.min.js"></script>

    <script>
        // =================================================
        // 1. Supabase è¨­å®š (å·²æ¤å…¥æ‚¨çš„ Key)
        // =================================================
        const SUPABASE_URL = 'https://ghpxaeenikochgrnczic.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_v0ZN2OY08lh-8EC8ps8NdQ_ChYo1FRW';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // =================================================
        // 2. æ ¸å¿ƒè®Šæ•¸
        // =================================================
        let isRunning = false;
        let shouldStop = false;
        const consoleEl = document.getElementById('consoleOutput');

        // =================================================
        // 3. æ§åˆ¶é‚è¼¯
        // =================================================
        async function startAgent() {
            if (isRunning) return;

            // UI é–å®š
            isRunning = true;
            shouldStop = false;
            document.getElementById('btnStart').disabled = true;
            document.getElementById('btnStop').disabled = false;
            document.getElementById('statusDot').className = 'status-dot status-active';
            document.getElementById('statusText').className = 'fw-bold text-success font-monospace';
            document.getElementById('statusText').innerText = 'AGENT RUNNING...';

            const qty = parseInt(document.getElementById('qtyInput').value);
            const speed = parseInt(document.getElementById('speedSelect').value);
            const scenario = document.getElementById('scenarioSelect').value;

            log(`>>> ä»»å‹™å•Ÿå‹•: ç”Ÿæˆ ${qty} å¥—è³‡æ–™ | æ¨¡å¼: ${scenario.toUpperCase()}`, 'system');

            let successCount = 0;

            for (let i = 0; i < qty; i++) {
                if (shouldStop) {
                    log('!!! ä½¿ç”¨è€…å¼·åˆ¶ä¸­æ­¢ä»»å‹™ !!!', 'error');
                    break;
                }

                try {
                    // åŸ·è¡Œç”Ÿæˆé‚è¼¯
                    if (scenario === 'full_suite') {
                        await generateFullSuite(i + 1);
                    } else if (scenario === 'company_only') {
                        await generateCompanyOnly();
                    } else {
                        await generateEventOnly();
                    }
                    successCount++;
                } catch (e) {
                    log(`[ERROR] ç¬¬ ${i+1} ç­†å¤±æ•—: ${e.message}`, 'error');
                }

                // æ›´æ–°é€²åº¦æ¢
                const percent = Math.round(((i + 1) / qty) * 100);
                document.getElementById('progressBar').style.width = percent + '%';
                document.getElementById('progressText').innerText = `${i + 1} / ${qty} Sets`;

                // æ¨¡æ“¬å»¶é²
                await new Promise(r => setTimeout(r, speed));
            }

            // çµæŸ
            log(`<<< ä»»å‹™å®Œæˆã€‚å…±ç”Ÿæˆ ${successCount} å¥—è³‡æ–™ã€‚`, 'success');
            resetUI();
        }

        function stopAgent() {
            shouldStop = true;
            log('æ­£åœ¨ä¸­æ­¢...', 'warning');
        }

        function resetUI() {
            isRunning = false;
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnStop').disabled = true;
            document.getElementById('statusDot').className = 'status-dot status-ready';
            document.getElementById('statusText').className = 'fw-bold text-secondary font-monospace';
            document.getElementById('statusText').innerText = 'SYSTEM READY';
        }

        function log(msg, type = 'info') {
            const time = new Date().toLocaleTimeString('zh-TW', { hour12: false });
            let color = '#ccc';
            if (type === 'success') color = '#4ade80'; // Green
            if (type === 'error') color = '#f87171';   // Red
            if (type === 'warning') color = '#fbbf24'; // Yellow
            if (type === 'system') color = '#38bdf8';  // Blue

            const line = document.createElement('div');
            line.style.color = color;
            line.style.marginBottom = '4px';
            line.innerHTML = `<span style="opacity:0.5; font-size:0.8em;">[${time}]</span> ${msg}`;
            consoleEl.appendChild(line);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        // =================================================
        // 4. è³‡æ–™ç”Ÿæˆå™¨ (Generators)
        // =================================================
        
        // æ ¸å¿ƒï¼šå…¨å¥—ç”Ÿæˆ (1å…¬å¸ + 1é†«è­· + 2è¡Œç¨‹)
        async function generateFullSuite(index) {
            
            // A. ç”¢ç”Ÿå…¬å¸
            const industries = ['ç§‘æŠ€', 'ç”ŸæŠ€', 'å¡‘è† ', 'é‹¼éµ', 'ç‰©æµ', 'é£Ÿå“'];
            const companyName = faker.name.lastName() + faker.name.firstName() + industries[index % industries.length] + "è‚¡ä»½æœ‰é™å…¬å¸";
            const taxId = Math.floor(Math.random() * 90000000 + 10000000).toString();
            
            // å¯«å…¥å…¬å¸
            const { data: coData, error: coError } = await supabase.from('companies').insert([{
                tax_id: taxId,
                name: companyName,
                address: faker.address.city() + 'å·¥æ¥­è·¯' + Math.floor(Math.random()*999) + 'è™Ÿ',
                contact_person: faker.name.lastName() + 'ç¶“ç†',
                phone: '09' + Math.floor(Math.random() * 100000000)
            }]).select(); // å›å‚³ ID

            if (coError) throw new Error(coError.message);
            const companyId = coData[0].id;
            log(`[DB] å»ºç«‹å…¬å¸: ${companyName} (${taxId})`);

            // B. ç”¢ç”Ÿé†«è­·äººå“¡ (æŒ‡æ´¾çµ¦é€™å®¶å…¬å¸çš„æ¦‚å¿µ - é›–ç„¶è³‡æ–™åº«ç›®å‰åˆ†é–‹å­˜ï¼Œä½†åœ¨æƒ…å¢ƒä¸Šæ˜¯ä¸€çµ„çš„)
            const staffName = faker.name.lastName() + faker.name.firstName();
            const staffRole = Math.random() > 0.6 ? 'é†«å¸«' : 'è­·ç†äººå“¡';
            
            await supabase.from('medical_staff').insert([{
                name: staffName,
                role: staffRole,
                employment_type: 'å…¼è·',
                phone: '09' + Math.floor(Math.random() * 100000000),
                email: faker.internet.email()
            }]);
            log(`[DB] å»ºç«‹äººå“¡: ${staffName} (${staffRole})`);

            // C. ç”¢ç”Ÿæ³•è¦è¡Œç¨‹ (é€£çµåˆ°è©²å…¬å¸)
            // 1. ä¸€ç­†å·²éæœŸçš„ (è£½é€ ç´…ç‡ˆ)
            // 2. ä¸€ç­†æœªä¾†çš„ (è£½é€ ç¶ ç‡ˆ/é»ƒç‡ˆ)
            const pastDate = new Date(); pastDate.setDate(pastDate.getDate() - Math.floor(Math.random() * 20));
            const futureDate = new Date(); futureDate.setDate(futureDate.getDate() + Math.floor(Math.random() * 40));

            await supabase.from('compliance_events').insert([
                {
                    title: `æ€¥æ•‘äººå“¡è¤‡è¨“ (${companyName})`,
                    event_type: 'training',
                    event_date: pastDate.toISOString().split('T')[0],
                    priority: 'high',
                    company_id: companyId,
                    status: 'pending' // éæœŸæœªè¾¦
                },
                {
                    title: `è·é†«è‡¨å ´æœå‹™ (${companyName})`,
                    event_type: 'service',
                    event_date: futureDate.toISOString().split('T')[0],
                    priority: 'medium',
                    company_id: companyId,
                    status: 'pending'
                }
            ]);
            log(`[DB] å»ºç«‹è¡Œç¨‹: 2 ç­†é—œè¯ç¨½æ ¸äº‹é …`);

            // D. å¯«å…¥ç¨½æ ¸æ—¥èªŒ (è­‰æ˜æ˜¯è‡ªå‹•ç”Ÿæˆçš„)
            await supabase.from('audit_logs').insert([{
                user_role: 'admin',
                user_name: 'AI_Agent',
                action_type: 'å…¨å¥—ç”Ÿæˆ',
                target_table: 'SYSTEM',
                details: `è‡ªå‹•ç”Ÿæˆå®¢æˆ¶ [${companyName}] å®Œæ•´è³‡æ–™å¥—ä»¶`
            }]);
        }

        // å–®ç¨ç”Ÿæˆå…¬å¸
        async function generateCompanyOnly() {
            const name = faker.name.lastName() + "æ°ä¼æ¥­ç¤¾";
            const tax = Math.floor(Math.random()*100000000).toString();
            await supabase.from('companies').insert([{ tax_id: tax, name: name }]);
            log(`[DB] å»ºç«‹å–®ä¸€å…¬å¸: ${name}`);
        }

        // å–®ç¨ç”Ÿæˆäº‹ä»¶
        async function generateEventOnly() {
            const title = "å¹´åº¦æ³•è¦æŸ¥æ ¸";
            await supabase.from('compliance_events').insert([{
                title: title,
                event_type: 'document',
                event_date: new Date().toISOString().split('T')[0]
            }]);
            log(`[DB] å»ºç«‹å–®ä¸€äº‹ä»¶: ${title}`);
        }

    </script>
</body>
</html>
