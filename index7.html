<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基本資料建立 (Master Data) | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { --primary-bg: #f4f6f9; }
        body {
            background-color: var(--primary-bg);
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            display: none; /* Auth Guard */
        }
        
        /* 區塊標題樣式 */
        .section-title {
            border-left: 5px solid #4f46e5;
            padding-left: 15px;
            margin-bottom: 20px;
            margin-top: 40px;
        }
        .section-title.staff { border-left-color: #059669; }
        .section-title.calendar { border-left-color: #dc3545; }

        /* 資訊卡片 */
        .info-card { padding: 1rem; border-radius: 0.375rem; font-size: 0.9rem; margin-bottom: 1rem; }
        .info-blue { background-color: #e0e7ff; border-left: 5px solid #4338ca; color: #312e81; }
        .info-green { background-color: #d1fae5; border-left: 5px solid #059669; color: #064e3b; }
        .info-red { background-color: #ffe5e5; border-left: 5px solid #dc3545; color: #842029; }

        .table th { font-weight: 500; color: white; }
        .th-blue { background-color: #4f46e5; }
        .th-green { background-color: #059669; }
        .th-red { background-color: #dc3545; }
        
        tbody tr:hover { background-color: #f8fafc; }
        
        .badge-event { font-size: 0.8em; padding: 5px 8px; width: 80px; text-align: center; display: inline-block;}
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const role = sessionStorage.getItem('currentUserRole');
            if (!role || role === 'medical') {
                alert('權限不足：此頁面僅限管理人員與文管人員存取。');
                window.location.href = 'dashboard.html';
                return;
            }
            document.body.style.display = 'block';
            const userName = sessionStorage.getItem('currentUserName') || 'User';
            document.getElementById('user-display').innerHTML = `<small>${role === 'admin' ? 'Admin' : '文管'}: ${userName}</small>`;
        });
    </script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3 mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="dashboard.html"><i class="fas fa-shield-alt me-2"></i>OHSMS</a>
            <div class="d-flex align-items-center">
                <span class="text-light me-3" id="user-display"></span>
                <a href="dashboard.html" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left me-1"></i> 返回儀表板</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4 pb-5">
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="section-title">
                <h4 class="fw-bold text-dark mb-0">1. 客戶主檔管理 (Companies)</h4>
                <small class="text-muted">管理服務之事業單位清單</small>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary fw-bold btn-sm" onclick="triggerImport('company')">
                    <i class="fas fa-file-import me-2"></i>匯入 (PDF/Excel)
                </button>
                <button class="btn btn-primary fw-bold btn-sm" onclick="openCompanyModal()">
                    <i class="fas fa-plus me-2"></i>新增單位
                </button>
            </div>
        </div>

        <div class="info-card info-blue shadow-sm">
            <strong><i class="fas fa-search me-2"></i>資料檢索指引</strong><br>
            系統預設不載入所有資料。請輸入「統一編號」或「公司名稱」進行查詢，或直接使用匯入功能批量建立。
        </div>

        <div class="row mb-3">
            <div class="col-md-4">
                <div class="input-group">
                    <input type="text" id="search-company-input" class="form-control" placeholder="輸入統編或名稱...">
                    <button class="btn btn-primary" onclick="searchCompanies()"><i class="fas fa-search"></i> 查詢</button>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow mb-3">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table mb-0 align-middle">
                        <thead>
                            <tr>
                                <th class="th-blue ps-4">統一編號</th>
                                <th class="th-blue">事業單位名稱</th>
                                <th class="th-blue">聯絡人</th>
                                <th class="th-blue">電話</th>
                                <th class="th-blue text-end pe-4">操作</th>
                            </tr>
                        </thead>
                        <tbody id="companyTableBody">
                            <tr><td colspan="5" class="text-center py-4 text-muted">請輸入關鍵字進行查詢</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="section-title staff">
                <h4 class="fw-bold text-dark mb-0">2. 職護與顧問人員管理 (Staff)</h4>
                <small class="text-muted">建立醫師、護理師與顧問名單</small>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-success fw-bold btn-sm" onclick="triggerImport('staff')">
                    <i class="fas fa-file-excel me-2"></i>匯入人員 (Excel)
                </button>
                <button class="btn btn-success fw-bold btn-sm" onclick="openStaffModal()">
                    <i class="fas fa-user-plus me-2"></i>新增人員
                </button>
            </div>
        </div>

        <div class="info-card info-green shadow-sm">
            <strong><i class="fas fa-user-md me-2"></i>人員資料庫</strong><br>
            請輸入姓名查詢現有人員，或建立完整的醫護團隊名單，以利系統自動計算評鑑報告中的人力配置分數。
        </div>

        <div class="row mb-3">
            <div class="col-md-4">
                <div class="input-group">
                    <input type="text" id="search-staff-input" class="form-control" placeholder="輸入人員姓名...">
                    <button class="btn btn-success" onclick="searchStaff()"><i class="fas fa-search"></i> 查詢</button>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow mb-3">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table mb-0 align-middle">
                        <thead>
                            <tr>
                                <th class="th-green ps-4">姓名</th>
                                <th class="th-green">身分角色</th>
                                <th class="th-green">職務型態</th>
                                <th class="th-green">電話</th>
                                <th class="th-green text-end pe-4">操作</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody">
                            <tr><td colspan="5" class="text-center py-4 text-muted">請輸入姓名進行查詢</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="section-title calendar">
                <h4 class="fw-bold text-dark mb-0">3. 法規行事曆與預警 (Calendar)</h4>
                <small class="text-muted">設定稽核行程、證照效期與會議排程</small>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-danger fw-bold btn-sm" onclick="triggerImport('event')">
                    <i class="fas fa-calendar-alt me-2"></i>匯入行程 (Excel)
                </button>
                <button class="btn btn-danger fw-bold btn-sm" onclick="openEventModal()">
                    <i class="fas fa-plus me-2"></i>新增事項
                </button>
            </div>
        </div>

        <div class="info-card info-red shadow-sm">
            <strong><i class="fas fa-filter me-2"></i>行程篩選</strong><br>
            請選擇年份與月份來檢視法規行程。資料將同步顯示於「工作儀表板」與「合規預警看板」。
        </div>

        <div class="row mb-3">
            <div class="col-md-6 d-flex gap-2">
                <select id="filter-year" class="form-select w-auto">
                    <option value="2026">2026</option>
                    <option value="2025" selected>2025</option>
                    <option value="2024">2024</option>
                </select>
                <select id="filter-month" class="form-select w-auto">
                    <option value="all">全年</option>
                    <option value="01">1月</option>
                    <option value="02">2月</option>
                    <option value="03">3月</option>
                    <option value="04">4月</option>
                    <option value="05">5月</option>
                    <option value="06">6月</option>
                    <option value="07">7月</option>
                    <option value="08">8月</option>
                    <option value="09">9月</option>
                    <option value="10">10月</option>
                    <option value="11">11月</option>
                    <option value="12">12月</option>
                </select>
                <button class="btn btn-danger" onclick="searchEvents()"><i class="fas fa-filter"></i> 篩選</button>
            </div>
        </div>

        <div class="card border-0 shadow">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table mb-0 align-middle">
                        <thead>
                            <tr>
                                <th class="th-red ps-4">預定日期 (Deadline)</th>
                                <th class="th-red">事項類型</th>
                                <th class="th-red">事項名稱</th>
                                <th class="th-red">優先級</th>
                                <th class="th-red">狀態</th>
                                <th class="th-red text-end pe-4">操作</th>
                            </tr>
                        </thead>
                        <tbody id="eventTableBody">
                            <tr><td colspan="6" class="text-center py-4 text-muted">請選擇年月進行篩選</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <input type="file" id="importInput" accept=".pdf, .xlsx, .xls" style="display: none;" onchange="handleFileSelect(this)">

    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; text-align: center; padding-top: 20%;">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
        <h4 class="fw-bold text-dark">資料處理中...</h4>
    </div>

    <div class="modal fade" id="companyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">事業單位資料</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div id="companyForm">
                        <div class="row g-3">
                            <div class="col-md-4"><label class="form-label fw-bold">統一編號 *</label><input type="text" class="form-control" id="co-taxid"></div>
                            <div class="col-md-8"><label class="form-label fw-bold">公司名稱 *</label><input type="text" class="form-control" id="co-name"></div>
                            <div class="col-md-12"><label class="form-label">地址</label><input type="text" class="form-control" id="co-addr"></div>
                            <div class="col-md-6"><label class="form-label">聯絡人</label><input type="text" class="form-control" id="co-contact"></div>
                            <div class="col-md-6"><label class="form-label">電話</label><input type="text" class="form-control" id="co-phone"></div>
                        </div>
                    </div>
                    <div id="previewArea" style="display:none;" class="mt-3">
                        <div class="alert alert-warning small">即將匯入 <strong id="previewCount">0</strong> 筆資料。</div>
                        <div style="max-height:300px; overflow:auto;"><table class="table table-sm table-bordered" id="previewTable"></table></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveData()">儲存資料</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="staffModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">醫護人員資料</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div id="staffForm">
                        <div class="row g-3">
                            <div class="col-md-6"><label class="form-label fw-bold">姓名 *</label><input type="text" class="form-control" id="st-name"></div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">身分角色</label>
                                <select class="form-select" id="st-role">
                                    <option value="醫師">醫師</option>
                                    <option value="護理人員">護理人員</option>
                                    <option value="顧問">顧問</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">職務型態</label>
                                <select class="form-select" id="st-type">
                                    <option value="兼職">兼職 (特約)</option>
                                    <option value="全職">全職 (專任)</option>
                                </select>
                            </div>
                            <div class="col-md-6"><label class="form-label">電話</label><input type="text" class="form-control" id="st-phone"></div>
                            <div class="col-md-12"><label class="form-label">Email</label><input type="email" class="form-control" id="st-email"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" onclick="saveData()">儲存資料</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="eventModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">行事曆與預警設定</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div id="eventForm">
                        <div class="row g-3">
                            <div class="col-md-12"><label class="form-label fw-bold">事項名稱 (Title) *</label><input type="text" class="form-control" id="ev-title" placeholder="例如：114年度急救人員複訓"></div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">事項類型 *</label>
                                <select class="form-select" id="ev-type">
                                    <option value="training">教育訓練 (Training)</option>
                                    <option value="meeting">委員會議 (Meeting)</option>
                                    <option value="service">臨場服務 (Service)</option>
                                    <option value="document">文件/計畫修訂 (Doc)</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">預定日期/期限 *</label>
                                <input type="date" class="form-control" id="ev-date">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">優先級 (Priority)</label>
                                <select class="form-select" id="ev-priority">
                                    <option value="medium">一般 (Medium)</option>
                                    <option value="high">緊急 (High)</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">指派公司 (可選)</label>
                                <select class="form-select" id="ev-company">
                                    <option value="">(通用事項)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" onclick="saveData()">儲存設定</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        const SUPABASE_URL = 'https://ghpxaeenikochgrnczic.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_v0ZN2OY08lh-8EC8ps8NdQ_ChYo1FRW';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentType = ''; 
        let batchData = [];

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            // 不自動載入，改為等使用者查詢
            loadCompanyOptions();
        });

        // ========================
        // Search Functions
        // ========================
        
        // 1. 搜尋公司
        async function searchCompanies() {
            const query = document.getElementById('search-company-input').value.trim();
            const tbody = document.getElementById('companyTableBody');
            
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border spinner-border-sm"></div> 查詢中...</td></tr>';

            let queryBuilder = supabase.from('companies').select('*').order('created_at', {ascending:false});
            
            if (query) {
                // 模糊搜尋 (Name or Tax ID)
                queryBuilder = queryBuilder.or(`name.ilike.%${query}%,tax_id.ilike.%${query}%`);
            } else {
                // 如果沒輸入，限制只抓前 20 筆
                queryBuilder = queryBuilder.limit(20);
            }

            const { data, error } = await queryBuilder;

            if(error || !data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-3">無符合資料</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(c => `
                <tr>
                    <td class="font-monospace ps-4">${c.tax_id||''}</td>
                    <td class="fw-bold text-primary">${c.name}</td>
                    <td>${c.contact_person||'-'}</td>
                    <td>${c.phone||'-'}</td>
                    <td class="text-end pe-4"><button class="btn btn-sm btn-outline-danger" onclick="deleteData('companies', '${c.id}', '${c.name}')"><i class="fas fa-trash"></i></button></td>
                </tr>`).join('');
        }

        // 2. 搜尋人員
        async function searchStaff() {
            const query = document.getElementById('search-staff-input').value.trim();
            const tbody = document.getElementById('staffTableBody');
            
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border spinner-border-sm"></div> 查詢中...</td></tr>';

            let queryBuilder = supabase.from('medical_staff').select('*').order('created_at', {ascending:false});
            
            if (query) {
                queryBuilder = queryBuilder.ilike('name', `%${query}%`);
            } else {
                queryBuilder = queryBuilder.limit(20);
            }

            const { data, error } = await queryBuilder;

            if(error || !data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-3">無符合資料</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(s => `
                <tr>
                    <td class="ps-4 fw-bold">${s.name}</td>
                    <td><span class="badge bg-success bg-opacity-10 text-success border border-success">${s.role}</span></td>
                    <td>${s.employment_type||'-'}</td>
                    <td>${s.phone||'-'}</td>
                    <td class="text-end pe-4"><button class="btn btn-sm btn-outline-danger" onclick="deleteData('medical_staff', '${s.id}', '${s.name}')"><i class="fas fa-trash"></i></button></td>
                </tr>`).join('');
        }

        // 3. 搜尋行事曆
        async function searchEvents() {
            const year = document.getElementById('filter-year').value;
            const month = document.getElementById('filter-month').value;
            const tbody = document.getElementById('eventTableBody');

            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><div class="spinner-border spinner-border-sm"></div> 載入中...</td></tr>';

            let queryBuilder = supabase.from('compliance_events').select('*').order('event_date', {ascending:true});

            // 日期區間篩選
            if (month === 'all') {
                queryBuilder = queryBuilder.gte('event_date', `${year}-01-01`).lte('event_date', `${year}-12-31`);
            } else {
                // 簡易處理每個月最後一天，這裡偷懶直接用 31，Supabase 會處理無效日期
                queryBuilder = queryBuilder.gte('event_date', `${year}-${month}-01`).lte('event_date', `${year}-${month}-31`);
            }

            const { data, error } = await queryBuilder;

            if(error || !data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-3">該期間無排程</td></tr>`;
                return;
            }

            const typeMap = {
                'training': {label:'教育訓練', class:'bg-info text-dark'},
                'meeting': {label:'會議', class:'bg-warning text-dark'},
                'service': {label:'臨場服務', class:'bg-success text-white'},
                'document': {label:'文件修訂', class:'bg-secondary text-white'}
            };

            tbody.innerHTML = data.map(e => {
                const badge = typeMap[e.event_type] || {label:e.event_type, class:'bg-light text-dark'};
                const isExpired = new Date(e.event_date) < new Date() && e.status !== 'completed';
                const dateClass = isExpired ? 'text-danger fw-bold' : '';
                
                return `
                <tr>
                    <td class="ps-4 ${dateClass}">${e.event_date} ${isExpired?'(已逾期)':''}</td>
                    <td><span class="badge ${badge.class} badge-event">${badge.label}</span></td>
                    <td class="fw-bold">${e.title}</td>
                    <td>${e.priority==='high' ? '<span class="text-danger"><i class="fas fa-exclamation-circle"></i> 緊急</span>' : '一般'}</td>
                    <td>${e.status==='pending' ? '待辦' : '已完成'}</td>
                    <td class="text-end pe-4"><button class="btn btn-sm btn-outline-danger" onclick="deleteData('compliance_events', '${e.id}', '${e.title}')"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            }).join('');
        }

        async function loadCompanyOptions() {
            const { data } = await supabase.from('companies').select('id, name').limit(100); // 限制數量避免選單過長
            const select = document.getElementById('ev-company');
            if(data) {
                data.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.text = c.name;
                    select.appendChild(opt);
                });
            }
        }

        // ========================
        // Modal & Save Logic (Same as before)
        // ========================
        function openCompanyModal() {
            currentType = 'company';
            batchData = [];
            document.getElementById('companyForm').style.display = 'block';
            document.getElementById('previewArea').style.display = 'none';
            new bootstrap.Modal(document.getElementById('companyModal')).show();
        }

        function openStaffModal() {
            currentType = 'staff';
            batchData = [];
            new bootstrap.Modal(document.getElementById('staffModal')).show();
        }

        function openEventModal() {
            currentType = 'event';
            batchData = [];
            document.getElementById('ev-title').value = '';
            document.getElementById('ev-date').value = '';
            new bootstrap.Modal(document.getElementById('eventModal')).show();
        }

        async function saveData() {
            let table = '', data = {}, conflict = null;

            if (currentType === 'company') {
                table = 'companies';
                conflict = 'tax_id';
                if(batchData.length > 0) data = batchData; 
                else data = {
                    tax_id: document.getElementById('co-taxid').value,
                    name: document.getElementById('co-name').value,
                    address: document.getElementById('co-addr').value,
                    contact_person: document.getElementById('co-contact').value,
                    phone: document.getElementById('co-phone').value
                };
            } else if (currentType === 'staff') {
                table = 'medical_staff';
                if(batchData.length > 0) data = batchData;
                else data = {
                    name: document.getElementById('st-name').value,
                    role: document.getElementById('st-role').value,
                    employment_type: document.getElementById('st-type').value,
                    phone: document.getElementById('st-phone').value,
                    email: document.getElementById('st-email').value
                };
            } else if (currentType === 'event') {
                table = 'compliance_events';
                if(batchData.length > 0) data = batchData;
                else data = {
                    title: document.getElementById('ev-title').value,
                    event_type: document.getElementById('ev-type').value,
                    event_date: document.getElementById('ev-date').value,
                    priority: document.getElementById('ev-priority').value,
                    company_id: document.getElementById('ev-company').value || null,
                    status: 'pending'
                };
            }

            if(Array.isArray(data)) {
                const { error } = await supabase.from(table).upsert(data, conflict ? {onConflict: conflict} : undefined);
                if(error) return alert('匯入失敗: ' + error.message);
                await writeLog('批量匯入', table, `匯入 ${data.length} 筆資料`);
            } else {
                if(!data.name && !data.title) return alert('請填寫必要欄位');
                const { error } = await supabase.from(table).upsert(data, conflict ? {onConflict: conflict} : undefined);
                if(error) return alert('儲存失敗: ' + error.message);
                await writeLog('新增', table, `新增資料`);
            }

            alert('✅ 儲存成功');
            document.querySelectorAll('.modal').forEach(el => bootstrap.Modal.getInstance(el)?.hide());
            
            // Refresh current view if applicable
            if(currentType === 'company') searchCompanies();
            else if(currentType === 'staff') searchStaff();
            else if(currentType === 'event') searchEvents();
        }

        // ========================
        // Import Logic (Same as before)
        // ========================
        function triggerImport(type) {
            currentType = type;
            document.getElementById('importInput').value = '';
            document.getElementById('importInput').click();
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if(!file) return;
            const ext = file.name.split('.').pop().toLowerCase();
            
            document.getElementById('loadingOverlay').style.display = 'block';

            if(ext === 'pdf' && currentType === 'company') {
                parsePDF(file);
            } else if(['xlsx','xls'].includes(ext)) {
                parseExcel(file);
            } else {
                alert('不支援的格式或功能');
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        async function parsePDF(file) {
            try {
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                const page = await pdf.getPage(1);
                const text = (await page.getTextContent()).items.map(s=>s.str).join('');
                const tax = text.match(/(?<!\d)\d{8}(?!\d)/)?.[0] || '';
                
                openCompanyModal();
                document.getElementById('co-taxid').value = tax;
                document.getElementById('co-name').value = file.name.replace('.pdf','');
            } catch(e) { alert('解析失敗'); }
            finally { document.getElementById('loadingOverlay').style.display = 'none'; }
        }

        function parseExcel(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(e.target.result, {type:'array'});
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header:1});
                
                batchData = [];
                for(let i=1; i<json.length; i++) {
                    const r = json[i];
                    if(!r.length) continue;

                    if(currentType === 'company') {
                        batchData.push({ tax_id:''+r[0], name:r[1], contact_person:r[2], phone:r[3] });
                    } else if(currentType === 'staff') {
                        batchData.push({ name:r[0], role:r[1]||'護理人員', employment_type:r[2]||'兼職', phone:r[3] });
                    } else if(currentType === 'event') {
                        batchData.push({ event_date:r[0], title:r[1], event_type:r[2]||'document', priority:r[3]||'medium' });
                    }
                }

                if(currentType === 'company') {
                    openCompanyModal();
                    document.getElementById('companyForm').style.display = 'none';
                    document.getElementById('previewArea').style.display = 'block';
                    document.getElementById('previewCount').innerText = batchData.length;
                    document.getElementById('previewTable').innerHTML = batchData.map(d => `<tr><td>${d.name}</td></tr>`).join('');
                } else {
                    if(confirm(`解析出 ${batchData.length} 筆資料，是否直接匯入？`)) saveData();
                }
                
                document.getElementById('loadingOverlay').style.display = 'none';
            };
            reader.readAsArrayBuffer(file);
        }

        // ========================
        // Utils
        // ========================
        async function deleteData(table, id, name) {
            if(!confirm('確定刪除?')) return;
            await supabase.from(table).delete().eq('id',id);
            await writeLog('刪除', table, `刪除: ${name}`);
            
            // Refresh
            if(table==='companies') searchCompanies();
            if(table==='medical_staff') searchStaff();
            if(table==='compliance_events') searchEvents();
        }

        async function writeLog(action, table, detail) {
            const role = sessionStorage.getItem('currentUserRole');
            const name = sessionStorage.getItem('currentUserName');
            await supabase.from('audit_logs').insert([{user_role:role, user_name:name, action_type:action, target_table:table, details:detail}]);
        }
    </script>
</body>
</html>
