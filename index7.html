<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基本資料建立 | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.css"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* =========================================
           1. 統一頁首/頁尾 CSS 設定 (內頁專用 / 高度統一版)
           ========================================= */
        html, body {
            height: 100%;
        }

        body {
            display: none; /* 權限驗證前先隱藏，JS 載入後改為 flex */
            flex-direction: column;
            min-height: 100vh;
            background-color: #f8f9fa; /* 預設背景色 */
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            color: #333;
        }

        /* 內容區塊自動撐開 */
        .container, .main-content, .container-fluid {
            flex: 1; 
        }

        /* 頁首設定 */
        .navbar {
            background-color: #202124 !important;
            min-height: 85px; /* [修正] 統一高度為 85px */
            color: #fff;
            flex-shrink: 0;
        }

        /* 頁尾設定 */
        footer {
            background-color: #202124 !important;
            color: #fff;
            flex-shrink: 0;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            display: flex;
            flex-direction: column; /* 垂直排列 */
            align-items: center;
            justify-content: center;
            margin-top: auto;
            padding: 15px 0;
            min-height: 85px; /* 雙行高度 */
        }

        /* =========================================
           2. 統一標題與字卡 CSS 設定 (Data Mgmt Blue)
           ========================================= */
        :root { 
            --primary-bg: #f8f9fa; 
            --theme-color: #4f46e5; /* Data Mgmt 階段的主題靛藍色 */
            --theme-light: #e0e7ff; /* 淺靛藍色背景 */
        }

        /* PDCA 字卡 (白色區塊) 設定 */
        .instruction-box {
            background-color: #fff;              /* 白色背景 */
            border-left: 5px solid var(--theme-color); /* 左側主題色飾條 */
            padding: 20px 25px;                  /* 內距 */
            border-radius: 4px;                  /* 圓角 */
            margin-bottom: 30px;                 /* 下方留白 */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* 輕微陰影 */
            width: 100%;
            text-align: left;
        }

        /* PDCA 字卡標題設定 */
        .instruction-title {
            color: var(--theme-color);           /* 字體顏色跟隨主題色 */
            font-weight: 700;                    /* 粗體 */
            margin-bottom: 10px;                 /* 與內文的間距 */
            font-size: 1.1rem;
        }

        /* =========================================
           3. 既有功能 UI 設定
           ========================================= */
        .card-header {
            background-color: #fff;
            border-bottom: 2px solid var(--theme-color);
            font-weight: bold;
            color: var(--theme-color);
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            color: var(--theme-color);
            border-top: 3px solid var(--theme-color);
        }
        .nav-tabs .nav-link { color: #555; }
        
        .btn-theme {
            background-color: var(--theme-color);
            color: white;
        }
        .btn-theme:hover {
            background-color: #4338ca;
            color: white;
        }
    </style>

    <script>
        // 權限檢查
        document.addEventListener('DOMContentLoaded', function() {
            if (!sessionStorage.getItem('currentUserId')) { 
                window.location.href = 'login.html'; 
            }
            // 顯示畫面
            document.body.style.display = 'flex';
        });
    </script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark px-4">
        <div class="container-fluid d-flex justify-content-between align-items-center p-0">
            <a class="navbar-brand d-flex align-items-center fw-bold" href="dashboard.html">
                <i class="fas fa-shield-alt me-2"></i>
                OHSMS 職安管理系統
            </a>

            <div class="d-flex align-items-center">
                <span class="text-white me-3 small" id="header-date">
                    <i class="fas fa-spinner fa-spin"></i>
                </span>
                
                <span class="text-white me-4 small border-start ps-3 border-secondary" id="header-clock" style="opacity: 0.9;">
                    --:--
                </span>
                
                <span class="text-white me-4 fw-bold" id="header-user">
                    Hi! 使用者
                </span>
                
                <a class="btn btn-outline-light btn-sm me-2" href="dashboard.html">
                    <i class="fas fa-reply me-1"></i>回到儀表板
                </a>
                
                <button class="btn btn-outline-light btn-sm" onclick="logoutSystem()">
                    <i class="fas fa-sign-out-alt me-1"></i>登出
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4 mt-4 main-content pb-5">
        
        <div class="mb-4">
            <h2 class="fw-bold text-dark mb-1">基本資料建立</h2>
            <p class="text-secondary">Data Mgmt 階段：客戶、人員與專案主檔維護</p>
        </div>

        <div class="instruction-box">
            <div class="instruction-title">
                <i class="fas fa-database me-2"></i>5W1H 設計理念：Data Management (基礎建設)
            </div>
            <p class="mb-0 text-dark" style="line-height: 1.6;">
                本模組為系統運作之基石，定義「服務對象」(Who - 客戶)、「執行人員」(Who - 顧問/醫護) 與「服務場域」(Where - 作業場所)。建立標準化、正規化的主檔資料 (Master Data)，確保後續所有服務歷程與稽核紀錄皆能精確關聯，避免資料孤島。
            </p>
        </div>

        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="companies-tab" data-bs-toggle="tab" data-bs-target="#companies" type="button" role="tab">客戶資料 (Companies)</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="staff-tab" data-bs-toggle="tab" data-bs-target="#staff" type="button" role="tab">人員名單 (Staff)</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="records-tab" data-bs-toggle="tab" data-bs-target="#records" type="button" role="tab">服務紀錄初始化 (Init Records)</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            
            <div class="tab-pane fade show active" id="companies" role="tabpanel">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-building me-2"></i>客戶列表</span>
                        <div>
                            <button class="btn btn-outline-success btn-sm me-2" onclick="openImportModal('company')"><i class="fas fa-file-import me-1"></i>匯入Excel</button>
                            <button class="btn btn-theme btn-sm" onclick="openCompanyModal()"><i class="fas fa-plus me-1"></i>新增客戶</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>統編</th>
                                    <th>公司名稱</th>
                                    <th>產業類別</th>
                                    <th>地區</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="companyTableBody">
                                <tr><td colspan="5" class="text-center">載入中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="staff" role="tabpanel">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-user-md me-2"></i>內部人員與顧問</span>
                        <div>
                            <button class="btn btn-outline-success btn-sm me-2" onclick="openImportModal('staff')"><i class="fas fa-file-import me-1"></i>匯入Excel</button>
                            <button class="btn btn-theme btn-sm" onclick="openStaffModal()"><i class="fas fa-plus me-1"></i>新增人員</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>姓名</th>
                                    <th>職稱/角色</th>
                                    <th>系統權限</th> <th>電話</th>
                                    <th>Email</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="staffTableBody">
                                <tr><td colspan="6" class="text-center">載入中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="records" role="tabpanel">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-file-contract me-2"></i>服務紀錄初始化</span>
                        <div>
                            <button class="btn btn-outline-success btn-sm" onclick="openImportModal('record')"><i class="fas fa-file-import me-1"></i>匯入年度排程Excel</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>此處僅供匯入整年度的服務排程 (Plan)，實際上傳報告請至「顧問資料上傳」功能。
                        </div>
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>服務年度</th>
                                    <th>客戶名稱</th>
                                    <th>預計訪視日</th>
                                    <th>指派顧問</th>
                                    <th>狀態</th>
                                </tr>
                            </thead>
                            <tbody id="recordTableBody">
                                <tr><td colspan="5" class="text-center">載入中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="companyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="companyModalLabel">新增客戶</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="companyForm">
                        <input type="hidden" id="compId">
                        <div class="mb-3">
                            <label class="form-label">統一編號 (Tax ID)</label>
                            <input type="text" class="form-control" id="compTaxId" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">公司名稱</label>
                            <input type="text" class="form-control" id="compName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">產業類別</label>
                            <input type="text" class="form-control" id="compIndustry">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">地區 (Region)</label>
                            <input type="text" class="form-control" id="compRegion">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-theme" onclick="saveCompany()">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="staffModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staffModalLabel">新增人員</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="staffForm">
                        <input type="hidden" id="staffId">
                        <div class="mb-3">
                            <label class="form-label">姓名</label>
                            <input type="text" class="form-control" id="staffName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">職稱 (Role)</label>
                            <select class="form-select" id="staffRole">
                                <option value="admin">管理員 (Admin)</option>
                                <option value="consultant">顧問 (Consultant)</option>
                                <option value="doc_control">文管人員 (Doc Control)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">電話</label>
                            <input type="text" class="form-control" id="staffPhone">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="staffEmail">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-theme" onclick="saveStaff()">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">匯入 Excel 資料</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">選擇 Excel 檔案 (.xlsx)</label>
                        <input type="file" class="form-control" id="importFile" accept=".xlsx, .xls">
                    </div>
                    <div id="importPreview" class="small text-muted"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="btn-confirm-import" disabled>確認匯入</button>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="mb-1">可信智慧整合有限公司 42917004 &nbsp;|&nbsp; 服務專線：0912-310570</div>
        <div class="small opacity-75" style="font-family: 'Segoe UI', sans-serif; letter-spacing: 1px;">
            WesmartAI , Making Trust Transparent.
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ==========================================
        // 統一頁首與系統初始化邏輯
        // ==========================================
        document.addEventListener('DOMContentLoaded', function() {
            setInterval(() => {
                const now = new Date();
                const clockEl = document.getElementById('header-clock');
                if(clockEl) clockEl.textContent = now.toLocaleTimeString('zh-TW', { hour12: false });
            }, 1000);

            const dateEl = document.getElementById('header-date');
            if(dateEl) {
                const now = new Date();
                const days = ['日', '一', '二', '三', '四', '五', '六'];
                const formattedDate = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}(${days[now.getDay()]})`;
                dateEl.innerHTML = `<i class="far fa-calendar-alt me-1"></i>今日是 ${formattedDate}`;
            }

            const userName = sessionStorage.getItem('currentUserName') || '使用者';
            const userEl = document.getElementById('header-user');
            if(userEl) userEl.innerText = `Hi! ${userName}`;

            // 初始化載入
            loadCompanies();
            loadStaff();
            loadRecords();
        });

        function logoutSystem() {
            if(confirm('確定要登出系統嗎？')) {
                sessionStorage.clear();
                window.location.href = 'login.html';
            }
        }

        // ==========================================
        // Supabase 設定
        // ==========================================
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ==========================================
        // 1. 公司 (Companies) 邏輯
        // ==========================================
        async function loadCompanies() {
            const tbody = document.getElementById('companyTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">載入中...</td></tr>';
            
            const { data, error } = await supabaseClient.from('companies').select('*').order('created_at', { ascending: false });
            if(error) {
                console.error(error);
                tbody.innerHTML = '<tr><td colspan="5" class="text-danger">載入失敗</td></tr>';
                return;
            }
            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">無資料</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(c => `
                <tr>
                    <td>${c.tax_id}</td>
                    <td class="fw-bold">${c.name}</td>
                    <td>${c.industry || '-'}</td>
                    <td>${c.region || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editCompany('${c.id}', '${c.tax_id}', '${c.name}', '${c.industry||''}', '${c.region||''}')">編輯</button>
                    </td>
                </tr>
            `).join('');
        }

        function openCompanyModal() {
            document.getElementById('companyForm').reset();
            document.getElementById('compId').value = '';
            document.getElementById('companyModalLabel').innerText = '新增客戶';
            new bootstrap.Modal(document.getElementById('companyModal')).show();
        }

        function editCompany(id, tax, name, ind, reg) {
            document.getElementById('compId').value = id;
            document.getElementById('compTaxId').value = tax;
            document.getElementById('compName').value = name;
            document.getElementById('compIndustry').value = ind;
            document.getElementById('compRegion').value = reg;
            document.getElementById('companyModalLabel').innerText = '編輯客戶';
            new bootstrap.Modal(document.getElementById('companyModal')).show();
        }

        async function saveCompany() {
            const id = document.getElementById('compId').value;
            const data = {
                tax_id: document.getElementById('compTaxId').value,
                name: document.getElementById('compName').value,
                industry: document.getElementById('compIndustry').value,
                region: document.getElementById('compRegion').value
            };

            if(!data.tax_id || !data.name) return alert('統編與公司名稱為必填');

            try {
                let error;
                if(id) {
                    const res = await supabaseClient.from('companies').update(data).eq('id', id);
                    error = res.error;
                } else {
                    const res = await supabaseClient.from('companies').insert(data);
                    error = res.error;
                }

                if(error) throw error;
                alert('儲存成功');
                bootstrap.Modal.getInstance(document.getElementById('companyModal')).hide();
                loadCompanies();
            } catch(e) {
                alert('儲存失敗: ' + e.message);
            }
        }

        // ==========================================
        // 2. 人員 (Staff) 邏輯
        // ==========================================
        async function loadStaff() {
            const tbody = document.getElementById('staffTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">載入中...</td></tr>';
            
            const { data, error } = await supabaseClient.from('medical_staff').select('*').order('created_at', { ascending: false });
            if(error) {
                console.error(error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-danger">載入失敗</td></tr>';
                return;
            }
            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">無資料</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(s => {
                // 顯示邏輯校正
                let displayRole = s.system_role || s.role;
                if(displayRole === 'medical') {
                    if(s.role === 'admin') displayRole = 'admin';
                    else if(s.role === 'doc_control') displayRole = 'doc_control';
                    else displayRole = 'doc_control';
                }

                return `
                <tr>
                    <td class="fw-bold">${s.name}</td>
                    <td>${s.role || '-'}</td>
                    <td><span class="badge bg-secondary">${displayRole}</span></td>
                    <td>${s.phone || '-'}</td>
                    <td>${s.email || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editStaff('${s.id}', '${s.name}', '${s.role||''}', '${s.phone||''}', '${s.email||''}')">編輯</button>
                    </td>
                </tr>
            `}).join('');
        }

        function openStaffModal() {
            document.getElementById('staffForm').reset();
            document.getElementById('staffId').value = '';
            document.getElementById('staffModalLabel').innerText = '新增人員';
            new bootstrap.Modal(document.getElementById('staffModal')).show();
        }

        function editStaff(id, name, role, phone, email) {
            document.getElementById('staffId').value = id;
            document.getElementById('staffName').value = name;
            // 嘗試對應 role
            const roleSelect = document.getElementById('staffRole');
            if(role === 'admin' || role === 'consultant' || role === 'doc_control') {
                roleSelect.value = role;
            } else {
                roleSelect.value = 'doc_control'; // default
            }
            document.getElementById('staffPhone').value = phone;
            document.getElementById('staffEmail').value = email;
            document.getElementById('staffModalLabel').innerText = '編輯人員';
            new bootstrap.Modal(document.getElementById('staffModal')).show();
        }

        async function saveStaff() {
            const id = document.getElementById('staffId').value;
            const roleVal = document.getElementById('staffRole').value;
            
            // [修正] 取得當前使用者 ID
            const { data: { user } } = await supabaseClient.auth.getUser();
            const currentUserId = user?.id;

            if (!currentUserId) return alert('無法取得使用者資訊，請重新登入');

            const data = {
                name: document.getElementById('staffName').value,
                role: roleVal,
                system_role: roleVal, // 同步設定系統權限
                phone: document.getElementById('staffPhone').value,
                email: document.getElementById('staffEmail').value,
                // [修正] 補上 created_by/updated_by
                updated_by: currentUserId
            };

            if(!id) {
                data.created_by = currentUserId; // 僅新增時需要
            }

            if(!data.name) return alert('姓名為必填');

            try {
                let error;
                if(id) {
                    const res = await supabaseClient.from('medical_staff').update(data).eq('id', id);
                    error = res.error;
                } else {
                    const res = await supabaseClient.from('medical_staff').insert(data);
                    error = res.error;
                }

                if(error) throw error;
                alert('儲存成功');
                bootstrap.Modal.getInstance(document.getElementById('staffModal')).hide();
                loadStaff();
            } catch(e) {
                alert('儲存失敗: ' + e.message);
            }
        }

        // ==========================================
        // 3. 服務紀錄 (Records) - 僅讀取
        // ==========================================
        async function loadRecords() {
            const tbody = document.getElementById('recordTableBody');
            
            const { data, error } = await supabaseClient
                .from('service_records')
                .select(`
                    id, service_year, visit_date, status,
                    medical_staff(name),
                    workplaces(companies(name))
                `)
                .order('visit_date', { ascending: false })
                .limit(20);

            if(error) {
                console.error(error);
                return;
            }
            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">無資料</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(r => `
                <tr>
                    <td>${r.service_year}</td>
                    <td>${r.workplaces?.companies?.name || 'Unknown'}</td>
                    <td>${r.visit_date}</td>
                    <td>${r.medical_staff?.name || '-'}</td>
                    <td>${r.status || 'Planned'}</td>
                </tr>
            `).join('');
        }

        // ==========================================
        // 4. Excel 匯入邏輯
        // ==========================================
        let pendingImportData = [];
        let pendingImportType = '';

        function openImportModal(type) {
            pendingImportType = type;
            document.getElementById('importFile').value = '';
            document.getElementById('importPreview').innerText = '';
            document.getElementById('btn-confirm-import').disabled = true;
            new bootstrap.Modal(document.getElementById('importModal')).show();
        }

        document.getElementById('importFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet);

                if(json.length > 0) {
                    pendingImportData = processImportData(json, pendingImportType);
                    document.getElementById('importPreview').innerText = `預覽：讀取到 ${json.length} 筆資料`;
                    document.getElementById('btn-confirm-import').disabled = false;
                } else {
                    document.getElementById('importPreview').innerText = '檔案內無資料';
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function processImportData(json, type) {
            // 這裡可以做欄位對應轉換
            return json.map(row => {
                let newRow = {};
                // 簡易對應，假設 Excel 欄位名稱對應 DB 欄位 (或英文)
                for (let key in row) {
                    // 去除空白
                    let cleanKey = key.trim();
                    let val = row[key];
                    newRow[cleanKey] = val;
                }
                
                // 針對人員匯入，補上 system_role 預設值
                if(type === 'staff') {
                    if(!newRow.system_role && newRow.role) {
                        newRow.system_role = newRow.role; 
                    }
                    // 如果還是空的
                    if(!newRow.system_role) newRow.system_role = 'doc_control';
                }

                return newRow;
            });
        }

        document.getElementById('btn-confirm-import').addEventListener('click', async function() {
            const btn = this;
            btn.disabled = true;
            btn.innerText = '匯入中...';

            // [修正] 取得當前使用者 ID
            const { data: { user } } = await supabaseClient.auth.getUser();
            const currentUserId = user?.id;

            if (!currentUserId) {
                alert('無法取得使用者資訊，請重新登入');
                btn.disabled = false;
                btn.innerText = '確認匯入';
                return;
            }

            try {
                // [修正] 為每一筆匯入資料補上 created_by
                const dataWithUser = pendingImportData.map(item => ({
                    ...item,
                    created_by: currentUserId,
                    updated_by: currentUserId
                }));

                if(pendingImportType === 'company') {
                    const { error } = await supabaseClient.from('companies').upsert(dataWithUser, { onConflict: 'tax_id' });
                    if(error) throw error;
                } else if(pendingImportType === 'staff') {
                    const { error } = await supabaseClient.from('medical_staff').insert(dataWithUser);
                    if(error) throw error;
                } else if(pendingImportType === 'record') {
                    const { error } = await supabaseClient.from('service_records').insert(dataWithUser);
                    if(error) throw error;
                }

                alert('✅ 匯入成功！');
                bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
                
                if(pendingImportType === 'company') loadCompanies();
                else if(pendingImportType === 'staff') loadStaff();
                else loadRecords();

            } catch(e) {
                console.error(e);
                alert('❌ 匯入發生錯誤: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = '確認匯入';
            }
        });

    </script>
</body>
</html>
