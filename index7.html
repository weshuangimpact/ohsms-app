<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基本資料建立 | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.css"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* =========================================
           1. 統一頁首/頁尾 CSS 設定 (內頁專用 / 高度統一版)
           ========================================= */
        html, body {
            height: 100%;
        }

        body {
            display: none; /* 權限驗證前先隱藏，JS 載入後改為 flex */
            flex-direction: column;
            min-height: 100vh;
            background-color: #f8f9fa; /* 預設背景色 */
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }

        /* 內容區塊自動撐開 */
        .container, .main-content, .container-fluid {
            flex: 1; 
        }

        /* 頁首設定 */
        .navbar {
            background-color: #202124 !important;
            min-height: 85px; /* [修正] 統一高度為 85px */
            color: #fff;
            flex-shrink: 0;
        }

        /* 頁尾設定 */
        footer {
            background-color: #202124 !important;
            color: #fff;
            flex-shrink: 0;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            display: flex;
            flex-direction: column; /* 垂直排列 */
            align-items: center;
            justify-content: center;
            margin-top: auto;
            padding: 15px 0;
            min-height: 85px; /* 雙行高度 */
        }

        /* =========================================
           2. 統一標題與字卡 CSS 設定 (Data Purple)
           ========================================= */
        :root { 
            --primary-bg: #f4f6f9; 
            --theme-color: #4f46e5; /* Data Mgmt 階段的主題紫色 */
        }

        /* PDCA/5W1H 字卡 (白色區塊) 設定 */
        .instruction-box {
            background-color: #fff;              /* 白色背景 */
            border-left: 5px solid var(--theme-color); /* 左側主題色飾條 */
            padding: 20px 25px;                  /* 內距 */
            border-radius: 4px;                  /* 圓角 */
            margin-bottom: 30px;                 /* 下方留白 */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* 輕微陰影 */
            width: 100%;
            text-align: left;
        }

        /* 字卡標題設定 */
        .instruction-title {
            color: var(--theme-color);           /* 字體顏色跟隨主題色 */
            font-weight: 700;                    /* 粗體 */
            margin-bottom: 10px;                 /* 與內文的間距 */
            font-size: 1.1rem;
        }

        /* =========================================
           3. 既有功能 UI 設定 (保留表格、分頁與匯入區塊樣式)
           ========================================= */
        .card-header { background-color: white; border-bottom: 1px solid #f0f0f0; }
        .table th { font-weight: 600; color: #555; background-color: #f8f9fa; white-space: nowrap; }
        .table td { vertical-align: middle; }
        
        .nav-pills .nav-link { color: #555; font-weight: 600; }
        .nav-pills .nav-link.active { background-color: var(--theme-color); color: white; }
        
        .import-area { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 20px; text-align: center; background: #fff; transition: all 0.3s; cursor: pointer; }
        .import-area:hover { border-color: var(--theme-color); background: #eef2ff; }
    </style>

    <script>
        // 權限檢查 (保留原有邏輯：顧問不可進入)
        document.addEventListener('DOMContentLoaded', function() {
            const role = sessionStorage.getItem('currentUserRole');
            if (role === 'consultant') {
                alert('權限不足：顧問帳號無法存取此頁面。');
                window.location.href = 'dashboard.html';
                return;
            }
            // 權限通過後顯示 (配合 Flex 佈局)
            document.body.style.display = 'flex'; 
        });
    </script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark px-4">
        <div class="container-fluid d-flex justify-content-between align-items-center p-0">
            <a class="navbar-brand d-flex align-items-center fw-bold" href="dashboard.html">
                <i class="fas fa-shield-alt me-2"></i>
                OHSMS 職安管理系統
            </a>

            <div class="d-flex align-items-center">
                <span class="text-white me-3 small" id="header-date">
                    <i class="fas fa-spinner fa-spin"></i>
                </span>
                
                <span class="text-white me-4 small border-start ps-3 border-secondary" id="header-clock" style="opacity: 0.9;">
                    --:--
                </span>
                
                <span class="text-white me-4 fw-bold" id="header-user">
                    Hi! 使用者
                </span>
                
                <a class="btn btn-outline-light btn-sm me-2" href="dashboard.html">
                    <i class="fas fa-reply me-1"></i>回到儀表板
                </a>
                
                <button class="btn btn-outline-light btn-sm" onclick="logoutSystem()">
                    <i class="fas fa-sign-out-alt me-1"></i>登出
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4 pb-5 mt-4 main-content">
        
        <div class="mb-4">
            <h2 class="fw-bold text-dark mb-1">基本資料建立</h2>
            <p class="text-secondary">Data Mgmt 階段：系統基礎資料維護與批次管理</p>
        </div>

        <div class="instruction-box">
            <div class="instruction-title">
                <i class="fas fa-cubes me-2"></i>5W1H 設計理念：Data (資料) —— 結構化與關聯性
            </div>
            <p class="mb-0 text-dark" style="line-height: 1.6;">
                透過系統化連結顧問(Who)、時間(When)、場所(Where)與事項(What)，確保服務歷程具備完整可追溯性(How) 與法規依據(Why)。此模組為所有服務紀錄的基礎，確保資料的一致性與正確性。
            </p>
        </div>

        <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pills-company-tab" data-bs-toggle="pill" data-bs-target="#pills-company" type="button" role="tab">1. 客戶公司主檔</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-staff-tab" data-bs-toggle="pill" data-bs-target="#pills-staff" type="button" role="tab">2. 醫護/顧問名單</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-record-tab" data-bs-toggle="pill" data-bs-target="#pills-record" type="button" role="tab">3. 服務執行歷程 (母案)</button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            
            <div class="tab-pane fade show active" id="pills-company" role="tabpanel">
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                                <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-building me-2 text-primary"></i>公司列表 (Companies)</h6>
                                <div class="input-group input-group-sm w-auto">
                                    <input type="text" class="form-control" placeholder="搜尋公司..." id="search-company">
                                    <button class="btn btn-outline-secondary" onclick="loadCompanies()"><i class="fas fa-search"></i></button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 600px;">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th>統編</th>
                                                <th>公司名稱</th>
                                                <th>地址</th>
                                                <th>聯絡人</th>
                                                <th>合約狀態</th>
                                                <th class="text-end">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="companyTableBody">
                                            <tr><td colspan="6" class="text-center py-4">載入中...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="d-grid gap-2 mb-4">
                            <button class="btn btn-primary fw-bold py-2" onclick="openCompanyModal()">
                                <i class="fas fa-plus me-2"></i>新增事業單位
                            </button>
                        </div>

                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-white fw-bold"><i class="fas fa-file-import me-2"></i>批次匯入公司</div>
                            <div class="card-body">
                                <div class="import-area" onclick="document.getElementById('file-company').click()">
                                    <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                    <p class="mb-0 small text-muted">點擊上傳 Excel / CSV</p>
                                    <input type="file" id="file-company" hidden accept=".csv, .xlsx, .xls" onchange="handleFileSelect(this, 'company')">
                                </div>
                                <div class="mt-2 text-end">
                                    <a href="#" class="small text-decoration-none" onclick="downloadTemplate('company')"><i class="fas fa-download me-1"></i>下載範本</a>
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm bg-light">
                            <div class="card-body">
                                <h6 class="fw-bold text-muted small">系統統計</h6>
                                <div class="d-flex justify-content-between mb-1">
                                    <span>總客戶數：</span>
                                    <strong id="stat-company-count">0</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>有效合約：</span>
                                    <strong class="text-success" id="stat-active-contract">0</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-staff" role="tabpanel">
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                                <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-user-nurse me-2 text-success"></i>人員列表 (Medical Staff)</h6>
                                <div class="input-group input-group-sm w-auto">
                                    <input type="text" class="form-control" placeholder="搜尋姓名..." id="search-staff">
                                    <button class="btn btn-outline-secondary" onclick="loadStaff()"><i class="fas fa-search"></i></button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 600px;">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th>姓名</th>
                                                <th>身分</th>
                                                <th>職務</th>
                                                <th>電話</th>
                                                <th>Email</th>
                                                <th class="text-end">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="staffTableBody">
                                            <tr><td colspan="6" class="text-center py-4">載入中...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="d-grid gap-2 mb-4">
                            <button class="btn btn-success fw-bold py-2" onclick="openStaffModal()">
                                <i class="fas fa-plus me-2"></i>新增醫護人員
                            </button>
                        </div>

                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-white fw-bold"><i class="fas fa-file-import me-2"></i>批次匯入人員</div>
                            <div class="card-body">
                                <div class="import-area" onclick="document.getElementById('file-staff').click()">
                                    <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                    <p class="mb-0 small text-muted">點擊上傳 Excel / CSV</p>
                                    <input type="file" id="file-staff" hidden accept=".csv, .xlsx, .xls" onchange="handleFileSelect(this, 'staff')">
                                </div>
                                <div class="mt-2 text-end">
                                    <a href="#" class="small text-decoration-none" onclick="downloadTemplate('staff')"><i class="fas fa-download me-1"></i>下載範本</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-record" role="tabpanel">
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                                <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-history me-2 text-warning"></i>服務歷程母案 (Service Plans)</h6>
                                <div class="input-group input-group-sm w-auto">
                                    <input type="text" class="form-control" placeholder="搜尋公司或顧問..." id="search-record">
                                    <button class="btn btn-outline-secondary" onclick="loadRecords()"><i class="fas fa-search"></i></button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 600px;">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th>建立日期</th>
                                                <th>客戶公司</th>
                                                <th>負責顧問</th>
                                                <th>預定執行事項</th>
                                                <th class="text-end">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recordTableBody">
                                            <tr><td colspan="5" class="text-center py-4">載入中...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="d-grid gap-2 mb-4">
                            <button class="btn btn-warning fw-bold py-2 text-dark" onclick="openRecordModal()">
                                <i class="fas fa-plus me-2"></i>新增母案計畫
                            </button>
                        </div>

                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-white fw-bold"><i class="fas fa-file-import me-2"></i>批次匯入計畫</div>
                            <div class="card-body">
                                <div class="import-area" onclick="document.getElementById('file-record').click()">
                                    <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                    <p class="mb-0 small text-muted">點擊上傳 Excel / CSV</p>
                                    <input type="file" id="file-record" hidden accept=".csv, .xlsx, .xls" onchange="handleFileSelect(this, 'record')">
                                </div>
                                <div class="mt-2 text-end">
                                    <small class="text-muted d-block mb-1"><i class="fas fa-info-circle"></i> 僅需建立母案基本資料</small>
                                    <a href="#" class="small text-decoration-none" onclick="downloadTemplate('record')"><i class="fas fa-download me-1"></i>下載範本</a>
                                </div>
                            </div>
                        </div>
                        
                         <div class="card border-0 shadow-sm bg-light">
                            <div class="card-body">
                                <h6 class="fw-bold text-muted small">計畫統計</h6>
                                <div class="d-flex justify-content-between mb-1">
                                    <span>總服務母案：</span>
                                    <strong id="stat-record-count">0</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="companyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="companyModalTitle">新增事業單位</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="companyForm">
                        <input type="hidden" id="company-id">
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">統一編號 *</label>
                                <input type="text" class="form-control" id="company-tax-id" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">公司名稱 *</label>
                                <input type="text" class="form-control" id="company-name" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small">地址</label>
                            <input type="text" class="form-control" id="company-address">
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">聯絡人</label>
                                <input type="text" class="form-control" id="company-contact">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">電話</label>
                                <input type="text" class="form-control" id="company-phone">
                            </div>
                        </div>
                        <hr>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold small text-primary">合約開始日</label>
                                <input type="date" class="form-control" id="contract-start">
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between">
                                    <label class="form-label fw-bold small text-primary">合約狀態</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="contract-active" checked onchange="toggleEndDate(this)">
                                        <label class="form-check-label small" for="contract-active">服務中</label>
                                    </div>
                                </div>
                                <input type="date" class="form-control" id="contract-end" disabled placeholder="合約結束日">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveCompany()">儲存變更</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="staffModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="staffModalTitle">新增醫護人員</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="staffForm">
                        <input type="hidden" id="staff-id">
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">姓名 *</label>
                                <input type="text" class="form-control" id="staff-name" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">身分角色</label>
                                <select class="form-select" id="staff-role">
                                    <option value="consultant">顧問</option>
                                    <option value="admin">管理員</option>
                                    <option value="doc_control">文管人員</option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">職務型態</label>
                                <select class="form-select" id="staff-type">
                                    <option value="全職">全職</option>
                                    <option value="兼職">兼職 (特約)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">電話</label>
                                <input type="text" class="form-control" id="staff-phone">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Email</label>
                            <input type="email" class="form-control" id="staff-email">
                        </div>
                        <hr>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold small text-success">入職日期</label>
                                <input type="date" class="form-control" id="staff-onboard">
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between">
                                    <label class="form-label fw-bold small text-success">是否在職</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="staff-active" checked onchange="toggleResignDate(this)">
                                        <label class="form-check-label small" for="staff-active">在職中</label>
                                    </div>
                                </div>
                                <input type="date" class="form-control" id="staff-resign" disabled placeholder="離職日期">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" onclick="saveStaff()">儲存變更</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="recordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="recordModalTitle">新增服務母案 (計畫)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="recordForm">
                        <input type="hidden" id="record-id">
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold small">服務客戶 (公司) *</label>
                            <select class="form-select" id="record-company" required>
                                <option value="">載入中...</option>
                            </select>
                            <div class="form-text small">系統將自動對應至該公司的作業場所 (Workplace)</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small">負責顧問 *</label>
                            <select class="form-select" id="record-consultant" required>
                                <option value="">載入中...</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small">執行事項 (Service Type) *</label>
                            <select class="form-select" id="record-item-select" onchange="toggleOtherItem()">
                                <option value="勞工身心健康管理">勞工身心健康管理</option>
                                <option value="職業病預防">職業病預防</option>
                                <option value="臨場健康服務">臨場健康服務</option>
                                <option value="健康促進規劃">健康促進規劃</option>
                                <option value="other">其他 (可填寫)</option>
                            </select>
                            <input type="text" class="form-control mt-2" id="record-item-other" style="display:none;" placeholder="請輸入其他事項">
                        </div>
                    </form>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-danger" id="btn-delete-record" onclick="deleteRecord()" style="display:none;">
                        <i class="fas fa-trash me-1"></i>刪除
                    </button>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-warning text-dark" onclick="saveRecord()">儲存母案</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">匯入資料預覽</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="import-preview-area" class="table-responsive mb-3" style="max-height: 400px;">
                        </div>
                    <div class="alert alert-info small mb-0">
                        <i class="fas fa-info-circle me-1"></i> 請確認資料無誤。公司統編若重複將更新資料；醫護人員將直接新增。
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="btn-confirm-import">確認匯入</button>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="mb-1">可信智慧整合有限公司 42917004</div>
        <div class="small opacity-75" style="font-family: 'Segoe UI', sans-serif; letter-spacing: 1px;">
            WesmartAI , Making Trust Transparent.
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
    // ==========================================
    // 統一頁首與系統初始化邏輯
    // ==========================================
    document.addEventListener('DOMContentLoaded', function() {
        setInterval(() => {
            const now = new Date();
            const clockEl = document.getElementById('header-clock');
            if(clockEl) clockEl.textContent = now.toLocaleTimeString('zh-TW', { hour12: false });
        }, 1000);

        const dateEl = document.getElementById('header-date');
        if(dateEl) {
            const now = new Date();
            const days = ['日', '一', '二', '三', '四', '五', '六'];
            const formattedDate = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}(${days[now.getDay()]})`;
            dateEl.innerHTML = `<i class="far fa-calendar-alt me-1"></i>今日是 ${formattedDate}`;
        }

        const userName = sessionStorage.getItem('currentUserName') || '使用者';
        const userEl = document.getElementById('header-user');
        if(userEl) userEl.innerText = `Hi! ${userName}`;

        // 初始化載入
        loadCompanies();
        loadStaff();
        loadRecords();
    });

    function logoutSystem() {
        if(confirm('確定要登出系統嗎？')) {
            sessionStorage.clear();
            window.location.href = 'login.html';
        }
    }

    // ==========================================
    // Supabase 設定
    // ==========================================
    const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh'; 
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ==========================================
    // 1. 公司 (Companies) 邏輯
    // ==========================================
    async function loadCompanies() {
        const tbody = document.getElementById('companyTableBody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">載入中...</td></tr>';
        
        const { data, error } = await supabaseClient.from('companies').select('*').order('created_at', { ascending: false });
        if(error) {
            console.error(error);
            tbody.innerHTML = '<tr><td colspan="5" class="text-danger">載入失敗</td></tr>';
            return;
        }
        if(data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">無資料</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(c => `
            <tr>
                <td>${c.tax_id}</td>
                <td class="fw-bold">${c.name}</td>
                <td>${c.industry || '-'}</td>
                <td>${c.region || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editCompany('${c.id}', '${c.tax_id}', '${c.name}', '${c.industry||''}', '${c.region||''}')">編輯</button>
                </td>
            </tr>
        `).join('');
    }

    function openCompanyModal() {
        document.getElementById('companyForm').reset();
        document.getElementById('compId').value = '';
        document.getElementById('companyModalLabel').innerText = '新增客戶';
        new bootstrap.Modal(document.getElementById('companyModal')).show();
    }

    function editCompany(id, tax, name, ind, reg) {
        document.getElementById('compId').value = id;
        document.getElementById('compTaxId').value = tax;
        document.getElementById('compName').value = name;
        document.getElementById('compIndustry').value = ind;
        document.getElementById('compRegion').value = reg;
        document.getElementById('companyModalLabel').innerText = '編輯客戶';
        new bootstrap.Modal(document.getElementById('companyModal')).show();
    }

    async function saveCompany() {
        const id = document.getElementById('compId').value;
        const data = {
            tax_id: document.getElementById('compTaxId').value,
            name: document.getElementById('compName').value,
            industry: document.getElementById('compIndustry').value,
            region: document.getElementById('compRegion').value
        };

        if(!data.tax_id || !data.name) return alert('統編與公司名稱為必填');

        // 取得當前使用者 ID (確保新增/修改都有紀錄)
        const { data: { user } } = await supabaseClient.auth.getUser();
        const currentUserId = user?.id;
        if (currentUserId) {
            data.updated_by = currentUserId;
            if(!id) data.created_by = currentUserId;
        }

        try {
            let error;
            if(id) {
                const res = await supabaseClient.from('companies').update(data).eq('id', id);
                error = res.error;
            } else {
                const res = await supabaseClient.from('companies').insert(data);
                error = res.error;
            }

            if(error) throw error;
            alert('儲存成功');
            bootstrap.Modal.getInstance(document.getElementById('companyModal')).hide();
            loadCompanies();
        } catch(e) {
            alert('儲存失敗: ' + e.message);
        }
    }

    // ==========================================
    // 2. 人員 (Staff) 邏輯
    // ==========================================
    async function loadStaff() {
        const tbody = document.getElementById('staffTableBody');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">載入中...</td></tr>';
        
        const { data, error } = await supabaseClient.from('medical_staff').select('*').order('created_at', { ascending: false });
        if(error) {
            console.error(error);
            tbody.innerHTML = '<tr><td colspan="6" class="text-danger">載入失敗</td></tr>';
            return;
        }
        if(data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">無資料</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(s => {
            let displayRole = s.system_role || s.role;
            if(displayRole === 'medical' || !displayRole) {
                if(s.role === 'admin') displayRole = 'admin';
                else if(s.role === 'doc_control') displayRole = 'doc_control';
                else displayRole = 'doc_control';
            }

            return `
            <tr>
                <td class="fw-bold">${s.name}</td>
                <td>${s.role || '-'}</td>
                <td><span class="badge bg-secondary">${displayRole}</span></td>
                <td>${s.phone || '-'}</td>
                <td>${s.email || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editStaff('${s.id}', '${s.name}', '${s.role||''}', '${s.phone||''}', '${s.email||''}')">編輯</button>
                </td>
            </tr>
        `}).join('');
    }

    function openStaffModal() {
        document.getElementById('staffForm').reset();
        document.getElementById('staffId').value = '';
        document.getElementById('staffModalLabel').innerText = '新增人員';
        new bootstrap.Modal(document.getElementById('staffModal')).show();
    }

    function editStaff(id, name, role, phone, email) {
        document.getElementById('staffId').value = id;
        document.getElementById('staffName').value = name;
        const roleSelect = document.getElementById('staffRole');
        
        // 修正下拉選單預設值
        const validRoles = ['admin', 'consultant', 'doc_control'];
        if(validRoles.includes(role)) {
            roleSelect.value = role;
        } else {
            roleSelect.value = 'doc_control'; 
        }
        
        document.getElementById('staffPhone').value = phone;
        document.getElementById('staffEmail').value = email;
        document.getElementById('staffModalLabel').innerText = '編輯人員';
        new bootstrap.Modal(document.getElementById('staffModal')).show();
    }

    async function saveStaff() {
        const id = document.getElementById('staffId').value;
        const roleVal = document.getElementById('staffRole').value;
        
        const { data: { user } } = await supabaseClient.auth.getUser();
        const currentUserId = user?.id;

        if (!currentUserId) return alert('無法取得使用者資訊，請重新登入');

        const data = {
            name: document.getElementById('staffName').value,
            role: roleVal,
            system_role: roleVal, 
            phone: document.getElementById('staffPhone').value,
            email: document.getElementById('staffEmail').value,
            updated_by: currentUserId
        };

        if(!id) {
            data.created_by = currentUserId; 
        }

        if(!data.name) return alert('姓名為必填');

        try {
            let error;
            if(id) {
                const res = await supabaseClient.from('medical_staff').update(data).eq('id', id);
                error = res.error;
            } else {
                const res = await supabaseClient.from('medical_staff').insert(data);
                error = res.error;
            }

            if(error) throw error;
            alert('儲存成功');
            bootstrap.Modal.getInstance(document.getElementById('staffModal')).hide();
            loadStaff();
        } catch(e) {
            alert('儲存失敗: ' + e.message);
        }
    }

    // ==========================================
    // 3. 服務紀錄 (Records) - 僅讀取
    // ==========================================
    async function loadRecords() {
        const tbody = document.getElementById('recordTableBody');
        
        const { data, error } = await supabaseClient
            .from('service_records')
            .select(`
                id, service_year, visit_date, status,
                workplaces ( companies (name) ),
                medical_staff (name)
            `)
            .order('visit_date', { ascending: false })
            .limit(20);

        if(error) {
            console.error(error);
            return;
        }
        if(data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">無資料</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(r => `
            <tr>
                <td>${r.service_year || 'N/A'}</td>
                <td>${r.workplaces?.companies?.name || 'Unknown'}</td>
                <td>${r.visit_date || 'N/A'}</td>
                <td>${r.medical_staff?.name || '-'}</td>
                <td>${r.status || 'Planned'}</td>
            </tr>
        `).join('');
    }

    // ==========================================
    // 4. Excel 匯入邏輯 (含自動 Mapping)
    // ==========================================
    let pendingImportData = [];
    let pendingImportType = '';

    function openImportModal(type) {
        pendingImportType = type;
        document.getElementById('importFile').value = '';
        document.getElementById('importPreview').innerText = '';
        document.getElementById('btn-confirm-import').disabled = true;
        new bootstrap.Modal(document.getElementById('importModal')).show();
    }

    document.getElementById('importFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(sheet);

            if(json.length > 0) {
                pendingImportData = processImportData(json, pendingImportType);
                document.getElementById('importPreview').innerText = `預覽：讀取到 ${json.length} 筆資料`;
                document.getElementById('btn-confirm-import').disabled = false;
            } else {
                document.getElementById('importPreview').innerText = '檔案內無資料';
            }
        };
        reader.readAsArrayBuffer(file);
    });

    function processImportData(json, type) {
        return json.map(row => {
            let newRow = {};
            for (let key in row) {
                let cleanKey = key.trim();
                let val = row[key];
                newRow[cleanKey] = val;
            }
            
            // 人員匯入預處理：若無系統角色，預設給 Doc Control
            if(type === 'staff') {
                if(!newRow.system_role && newRow.role) {
                    newRow.system_role = newRow.role; 
                }
                if(!newRow.system_role) newRow.system_role = 'doc_control';
            }

            return newRow;
        });
    }

    document.getElementById('btn-confirm-import').addEventListener('click', async function() {
        const btn = this;
        btn.disabled = true;
        btn.innerText = '匯入中...';

        const { data: { user } } = await supabaseClient.auth.getUser();
        const currentUserId = user?.id;

        if (!currentUserId) {
            alert('無法取得使用者資訊，請重新登入');
            btn.disabled = false;
            btn.innerText = '確認匯入';
            return;
        }

        try {
            // =======================================================
            // [關鍵修正] 服務紀錄匯入：自動查表與建立關聯
            // =======================================================
            if (pendingImportType === 'record') {
                
                // 1. 撈取對照表 (Reference Data)
                const { data: companies } = await supabaseClient.from('companies').select('id, name');
                const { data: staffList } = await supabaseClient.from('medical_staff').select('id, name');
                const { data: workplaces } = await supabaseClient.from('workplaces').select('id, company_id');
                
                const mappedRecords = [];
                const errors = [];
                
                // 2. 逐筆處理
                for (const row of pendingImportData) {
                    const compName = row['公司名稱']; 
                    const staffName = row['顧問姓名'];
                    
                    if (!compName) continue; // 跳過空行

                    // (A) 找公司 ID
                    const comp = companies?.find(c => c.name === compName);
                    if (!comp) {
                        errors.push(`找不到公司: ${compName} (請先匯入客戶資料)`);
                        continue;
                    }

                    // (B) 找顧問 ID (若無則留空)
                    let staffId = null;
                    if (staffName) {
                        const staff = staffList?.find(s => s.name === staffName);
                        if (staff) staffId = staff.id;
                    }

                    // (C) 找廠區 ID (Workplace)
                    let wp = workplaces?.find(w => w.company_id === comp.id);
                    let wpId = wp ? wp.id : null;

                    // (D) [自動補救] 如果沒有廠區，自動建立「預設廠區」
                    if (!wpId) {
                        // console.log(`自動為 ${compName} 建立預設廠區...`);
                        const { data: newWp, error: wpErr } = await supabaseClient
                            .from('workplaces')
                            .insert({
                                company_id: comp.id,
                                name: compName + ' (預設廠區)',
                                created_by: currentUserId,
                                updated_by: currentUserId
                            })
                            .select()
                            .single();
                        
                        if (wpErr) {
                            errors.push(`建立廠區失敗 (${compName}): ${wpErr.message}`);
                            continue;
                        }
                        wpId = newWp.id;
                        // 更新快取，避免下一筆重複建立
                        if(workplaces) workplaces.push(newWp);
                    }

                    // (E) 準備寫入 DB 的格式 (對應 Template CSV 欄位)
                    // 公司名稱, 顧問姓名, 執行事項, 預計訪視日, 年度, 狀態
                    mappedRecords.push({
                        workplace_id: wpId,
                        consultant_id: staffId,
                        visit_date: row['預計訪視日'] || null, 
                        service_year: row['年度'] || new Date().getFullYear(),
                        status: row['狀態'] || 'planned',
                        created_by: currentUserId,
                        updated_by: currentUserId
                    });
                }

                if (errors.length > 0) {
                    alert('⚠️ 部分資料匯入失敗 (前5筆錯誤):\n' + errors.slice(0, 5).join('\n'));
                    if (mappedRecords.length === 0) throw new Error("所有資料皆無法對應，請檢查公司資料是否已匯入");
                }

                // 3. 寫入服務紀錄
                if (mappedRecords.length > 0) {
                    const { error } = await supabaseClient.from('service_records').insert(mappedRecords);
                    if(error) throw error;
                }

            } else {
                // =======================================================
                // 其他類型 (Company, Staff) 的一般匯入邏輯
                // =======================================================
                
                // 為每一筆資料補上 created_by
                const dataWithUser = pendingImportData.map(item => ({
                    ...item,
                    created_by: currentUserId,
                    updated_by: currentUserId
                }));

                if(pendingImportType === 'company') {
                    // 對應 template: 統一編號, 事業單位名稱, 公司地址, 聯絡人, 電話...
                    // 需要將 Excel 中文欄位轉為 DB 英文欄位
                    const companiesToInsert = dataWithUser.map(row => ({
                        tax_id: row['統一編號'],
                        name: row['事業單位名稱'] || row['公司名稱'],
                        industry: row['產業類別'] || '', 
                        region: row['公司地址'] || '', // 簡易對應
                        created_by: currentUserId,
                        updated_by: currentUserId
                    }));
                    
                    const { error } = await supabaseClient.from('companies').upsert(companiesToInsert, { onConflict: 'tax_id' });
                    if(error) throw error;

                } else if(pendingImportType === 'staff') {
                    // 對應 template: 姓名, 身分角色, 職務型態, 電話, Email...
                    const staffToInsert = dataWithUser.map(row => {
                        let role = 'doc_control'; // default
                        // 簡易轉換中文角色
                        const rawRole = row['身分角色'] || row['職稱/角色'] || '';
                        if(rawRole.includes('顧問')) role = 'consultant';
                        else if(rawRole.includes('管理')) role = 'admin';

                        return {
                            name: row['姓名'],
                            role: role,
                            system_role: role,
                            phone: row['電話'],
                            email: row['Email'],
                            created_by: currentUserId,
                            updated_by: currentUserId
                        };
                    });

                    const { error } = await supabaseClient.from('medical_staff').insert(staffToInsert);
                    if(error) throw error;
                }
            }

            alert('✅ 匯入成功！');
            bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
            
            if(pendingImportType === 'company') loadCompanies();
            else if(pendingImportType === 'staff') loadStaff();
            else loadRecords();

        } catch(e) {
            console.error(e);
            alert('❌ 匯入發生錯誤: ' + e.message);
        } finally {
            btn.disabled = false;
            btn.innerText = '確認匯入';
        }
    });
    </script>
</body>
</html>
