<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基本資料建立 (Master Data) | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { --primary-bg: #f4f6f9; }
        body {
            background-color: var(--primary-bg);
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            display: none; /* Auth Guard */
        }
        
        .master-info-card {
            background-color: #e0e7ff;
            border-left: 5px solid #4338ca;
            color: #312e81;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border-radius: 0.375rem;
        }

        .client-table th { background-color: #4f46e5; color: white; font-weight: 500; }
        .client-table tbody tr:hover { background-color: #eef2ff; }
        
        .upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            background-color: #f8fafc;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upload-zone:hover {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }
    </style>

    <script>
        // 權限檢查
        document.addEventListener('DOMContentLoaded', function() {
            const role = sessionStorage.getItem('currentUserRole');
            if (!role || role === 'medical') {
                alert('權限不足：此頁面僅限管理人員與文管人員存取。');
                window.location.href = 'dashboard.html';
                return;
            }
            document.body.style.display = 'block';
            const userName = sessionStorage.getItem('currentUserName') || 'User';
            document.getElementById('user-display').innerHTML = `<small>${role === 'admin' ? 'Admin' : '文管'}: ${userName}</small>`;
        });
    </script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3 mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="dashboard.html"><i class="fas fa-shield-alt me-2"></i>OHSMS</a>
            <div class="d-flex align-items-center">
                <span class="text-light me-3" id="user-display"></span>
                <a href="dashboard.html" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left me-1"></i> 返回儀表板</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4 pb-5">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-dark"><i class="fas fa-database me-2" style="color: #4f46e5;"></i>基本資料建立</h2>
                <p class="text-muted mb-0">客戶主檔管理與合約設定</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary fw-bold" onclick="triggerImport()">
                    <i class="fas fa-file-import me-2"></i>匯入歷史資料 (PDF/Excel)
                </button>
                <button class="btn btn-primary fw-bold" onclick="openCreateModal()">
                    <i class="fas fa-plus me-2"></i>手動新增
                </button>
            </div>
        </div>

        <input type="file" id="importInput" accept=".pdf, .xlsx, .xls" style="display: none;" onchange="handleFileSelect(this)">

        <div class="master-info-card shadow-sm">
            <strong><i class="fas fa-info-circle me-2"></i>操作指引</strong><br>
            您可以使用 <strong>PDF (單筆辨識)</strong> 或 <strong>Excel (批量匯入)</strong> 來建立資料。所有操作皆會記錄於「系統稽核日誌」中供日後查核。
        </div>

        <div class="card border-0 shadow">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table client-table mb-0 align-middle">
                        <thead>
                            <tr>
                                <th class="ps-4">統一編號</th>
                                <th>事業單位名稱</th>
                                <th>聯絡人</th>
                                <th>電話</th>
                                <th>建立日期</th>
                                <th class="text-end pe-4">操作</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="6" class="text-center py-4 text-muted">
                                    <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                                    連線資料庫中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; text-align: center; padding-top: 20%;">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
        <h4 class="fw-bold text-dark">資料解析中...</h4>
        <p class="text-muted">正在處理檔案內容</p>
    </div>

    <div class="modal fade" id="createModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" id="modalTitle"><i class="fas fa-edit me-2"></i>資料確認與建立</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    
                    <div id="singleModeForm">
                        <div class="alert alert-light border-start border-4 border-primary shadow-sm mb-4">
                            <i class="fas fa-user-check me-2 text-primary"></i>
                            請確認下方資料正確無誤。按下儲存後，系統將寫入資料庫並記錄操作日誌。
                        </div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">統一編號 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="inp-taxid" placeholder="8碼數字">
                            </div>
                            <div class="col-md-8">
                                <label class="form-label fw-bold">事業單位名稱 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="inp-name">
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">公司地址</label>
                                <input type="text" class="form-control" id="inp-address">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">聯絡人</label>
                                <input type="text" class="form-control" id="inp-contact">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">電話</label>
                                <input type="text" class="form-control" id="inp-phone">
                            </div>
                        </div>
                    </div>

                    <div id="batchModeForm" style="display: none;">
                        <div class="alert alert-success border-start border-4 border-success shadow-sm mb-3">
                            <i class="fas fa-file-excel me-2"></i>
                            已讀取 Excel 檔案，共發現 <strong id="batchCount">0</strong> 筆資料。請檢視後確認匯入。
                        </div>
                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-bordered table-striped table-sm small">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>統一編號</th>
                                        <th>事業單位名稱</th>
                                        <th>聯絡人</th>
                                        <th>電話</th>
                                    </tr>
                                </thead>
                                <tbody id="batchTableBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary fw-bold px-4" onclick="handleSaveRouter()">
                        <i class="fas fa-save me-2"></i>確認並寫入資料庫
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        // 1. Supabase 連線
        const SUPABASE_URL = 'https://ghpxaeenikochgrnczic.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_v0ZN2OY08lh-8EC8ps8NdQ_ChYo1FRW';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 全域變數用來存 Excel 暫存檔
        let currentBatchData = []; 
        let currentMode = 'single'; // 'single' or 'batch'

        // 2. 初始載入
        document.addEventListener('DOMContentLoaded', loadCompanies);

        async function loadCompanies() {
            const tableBody = document.getElementById('tableBody');
            const { data, error } = await supabase.from('companies').select('*').order('created_at', { ascending: false });

            if (error) return tableBody.innerHTML = `<tr><td colspan="6" class="text-danger">讀取失敗：${error.message}</td></tr>`;
            if (!data || data.length === 0) return tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-muted">無資料</td></tr>`;

            tableBody.innerHTML = '';
            data.forEach(c => {
                tableBody.innerHTML += `
                    <tr class="animate__animated animate__fadeIn">
                        <td class="ps-4 font-monospace">${c.tax_id || '-'}</td>
                        <td class="fw-bold">${c.name}</td>
                        <td>${c.contact_person || '-'}</td>
                        <td>${c.phone || '-'}</td>
                        <td class="small text-muted">${new Date(c.created_at).toLocaleDateString()}</td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCompany('${c.id}', '${c.name}')"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>`;
            });
        }

        // 3. 檔案處理路由 (PDF vs Excel)
        function triggerImport() {
            document.getElementById('importInput').value = ''; 
            document.getElementById('importInput').click();
        }

        function handleFileSelect(input) {
            if (!input.files[0]) return;
            const file = input.files[0];
            const fileType = file.name.split('.').pop().toLowerCase();

            document.getElementById('loadingOverlay').style.display = 'block';

            if (fileType === 'pdf') {
                parsePDF(file);
            } else if (fileType === 'xlsx' || fileType === 'xls') {
                parseExcel(file);
            } else {
                alert('不支援的檔案格式，請上傳 PDF 或 Excel。');
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        // 3-A. 解析 PDF
        async function parsePDF(file) {
            try {
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                const page = await pdf.getPage(1);
                const text = (await page.getTextContent()).items.map(s => s.str).join(' ');

                // 簡單規則抓取
                const taxMatch = text.match(/(?<!\d)\d{8}(?!\d)/);
                const extractedTax = taxMatch ? taxMatch[0] : '';
                const extractedName = file.name.replace('.pdf', ''); // 預設用檔名

                // 設定介面為單筆模式
                setupSingleMode(extractedTax, extractedName, '', '', '');
                
            } catch (err) {
                alert('PDF 解析失敗: ' + err.message);
                setupSingleMode('', '', '', '', '');
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
                new bootstrap.Modal(document.getElementById('createModal')).show();
            }
        }

        // 3-B. 解析 Excel
        function parseExcel(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    // 轉成 JSON, 假設第一列是標題
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1}); // 陣列的陣列

                    // 簡單對應：假設 A欄=統編, B欄=名稱, C欄=聯絡人, D欄=電話
                    // 跳過標題列 (Index 0)
                    currentBatchData = [];
                    for(let i=1; i<jsonData.length; i++) {
                        const row = jsonData[i];
                        if(row.length > 0) {
                            currentBatchData.push({
                                tax_id: row[0] ? String(row[0]).trim() : '',
                                name: row[1] ? String(row[1]).trim() : '',
                                contact_person: row[2] || '',
                                phone: row[3] || ''
                            });
                        }
                    }

                    setupBatchMode();

                } catch (err) {
                    alert('Excel 解析失敗: ' + err.message);
                } finally {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    new bootstrap.Modal(document.getElementById('createModal')).show();
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // 4. 介面切換邏輯
        function setupSingleMode(tax, name, addr, contact, phone) {
            currentMode = 'single';
            document.getElementById('singleModeForm').style.display = 'block';
            document.getElementById('batchModeForm').style.display = 'none';
            
            document.getElementById('inp-taxid').value = tax;
            document.getElementById('inp-name').value = name;
            document.getElementById('inp-address').value = addr;
            document.getElementById('inp-contact').value = contact;
            document.getElementById('inp-phone').value = phone;
        }

        function setupBatchMode() {
            currentMode = 'batch';
            document.getElementById('singleModeForm').style.display = 'none';
            document.getElementById('batchModeForm').style.display = 'block';
            
            document.getElementById('batchCount').innerText = currentBatchData.length;
            const tbody = document.getElementById('batchTableBody');
            tbody.innerHTML = '';
            currentBatchData.forEach(row => {
                tbody.innerHTML += `
                    <tr>
                        <td>${row.tax_id}</td>
                        <td>${row.name}</td>
                        <td>${row.contact_person}</td>
                        <td>${row.phone}</td>
                    </tr>
                `;
            });
        }

        function openCreateModal() {
            setupSingleMode('', '', '', '', '');
            new bootstrap.Modal(document.getElementById('createModal')).show();
        }

        // 5. 儲存路由 (Save Router)
        async function handleSaveRouter() {
            if (currentMode === 'single') {
                await saveSingle();
            } else {
                await saveBatch();
            }
        }

        async function saveSingle() {
            const data = {
                tax_id: document.getElementById('inp-taxid').value.trim(),
                name: document.getElementById('inp-name').value.trim(),
                address: document.getElementById('inp-address').value.trim(),
                contact_person: document.getElementById('inp-contact').value.trim(),
                phone: document.getElementById('inp-phone').value.trim()
            };

            if (!data.tax_id || !data.name) return alert('統編與名稱為必填');

            // 1. 寫入資料
            const { error } = await supabase.from('companies').upsert(data, { onConflict: 'tax_id' });
            if (error) return alert('儲存失敗: ' + error.message);

            // 2. 寫入 Log (重要!)
            await writeLog('新增/修改', 'companies', `單筆編輯: ${data.name} (${data.tax_id})`);

            alert('✅ 儲存成功');
            finishSave();
        }

        async function saveBatch() {
            if (currentBatchData.length === 0) return alert('沒有資料可匯入');

            // 1. 批量寫入
            const { error } = await supabase.from('companies').upsert(currentBatchData, { onConflict: 'tax_id' });
            if (error) return alert('匯入失敗: ' + error.message);

            // 2. 寫入 Log
            await writeLog('批量匯入', 'companies', `Excel 匯入 ${currentBatchData.length} 筆資料`);

            alert(`✅ 成功匯入 ${currentBatchData.length} 筆資料`);
            finishSave();
        }

        function finishSave() {
            bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
            loadCompanies();
        }

        // 6. 核心功能: 寫入 Log 到 Supabase
        async function writeLog(action, table, detail) {
            const userRole = sessionStorage.getItem('currentUserRole') || 'unknown';
            const userName = sessionStorage.getItem('currentUserName') || 'unknown';

            await supabase.from('audit_logs').insert([{
                user_role: userRole,
                user_name: userName,
                action_type: action,
                target_table: table,
                details: detail
            }]);
        }

        // 7. 刪除
        async function deleteCompany(id, name) {
            if (!confirm('確定要刪除嗎？此操作將被記錄。')) return;

            const { error } = await supabase.from('companies').delete().eq('id', id);
            if (error) return alert('刪除失敗');

            // 寫入 Log
            await writeLog('刪除', 'companies', `刪除公司: ${name}`);
            
            loadCompanies();
        }

    </script>
</body>
</html>
