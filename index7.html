<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基本資料建立 (Data Mgmt) | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* =========================================
           1. 統一頁首/頁尾 CSS 設定
           ========================================= */
        html, body { height: 100%; }
        body {
            display: none; /* 權限驗證前先隱藏 */
            flex-direction: column;
            min-height: 100vh;
            background-color: #f8f9fa;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }
        .container, .main-content, .container-fluid { flex: 1; }
        .navbar {
            background-color: #202124 !important;
            min-height: 85px;
            color: #fff;
            flex-shrink: 0;
        }
        footer {
            background-color: #202124 !important;
            color: #fff;
            flex-shrink: 0;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: auto;
            padding: 15px 0;
            min-height: 85px;
        }

        /* =========================================
           2. 標題與字卡 CSS 設定 (Data Mgmt Indigo)
           ========================================= */
        :root { 
            --theme-color: #4f46e5; /* Data Mgmt 階段的主題靛青色 */
            --theme-light: #e0e7ff;
        }
        .instruction-box {
            background-color: #fff;
            border-left: 5px solid var(--theme-color);
            padding: 20px 25px;
            border-radius: 4px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            width: 100%;
            text-align: left;
        }
        .instruction-title {
            color: var(--theme-color);
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        /* 列表與卡片樣式 */
        .data-card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s;
            cursor: pointer;
            background: #fff;
        }
        .data-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .section-header {
            border-left: 4px solid var(--theme-color);
            padding-left: 15px;
            margin-bottom: 20px;
            color: #333;
        }
    </style>

    <script>
        // 權限檢查
        if (!sessionStorage.getItem('currentUserId')) { window.location.href = 'login.html'; }
    </script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark px-4">
        <div class="container-fluid d-flex justify-content-between align-items-center p-0">
            <a class="navbar-brand d-flex align-items-center fw-bold" href="dashboard.html">
                <i class="fas fa-shield-alt me-2"></i>
                OHSMS 職安管理系統
            </a>

            <div class="d-flex align-items-center">
                <span class="text-white me-3 small" id="header-date">
                    <i class="fas fa-spinner fa-spin"></i>
                </span>
                <span class="text-white me-4 small border-start ps-3 border-secondary" id="header-clock" style="opacity: 0.9;">--:--</span>
                <span class="text-white me-4 fw-bold" id="header-user">Hi! 使用者</span>
                
                <a class="btn btn-outline-light btn-sm me-2" href="dashboard.html">
                    <i class="fas fa-reply me-1"></i>回到儀表板
                </a>
                <button class="btn btn-outline-light btn-sm" onclick="logoutSystem()">
                    <i class="fas fa-sign-out-alt me-1"></i>登出
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4 mt-4 main-content pb-5">
        
        <div class="mb-4">
            <h2 class="fw-bold text-dark mb-1">基本資料建立 (Data Mgmt)</h2>
            <p class="text-secondary">Data Mgmt 階段：建立客戶主檔、作業場所資料與合約期程設定</p>
        </div>

        <div class="instruction-box">
            <div class="instruction-title">
                <i class="fas fa-database me-2"></i>系統基礎：資料結構化與正規化
            </div>
            <p class="mb-0 text-dark" style="line-height: 1.6;">
                本模組負責維護「公司 (Companies)」與「作業場所 (Workplaces)」之主檔資料。
                正確的資料建立是後續服務歷程 (Plan/Do) 與 績效分析 (Check) 的基石。
            </p>
        </div>

        <div class="row mb-4">
            <div class="col-12 text-end">
                <button class="btn btn-primary" onclick="openAddModal()">
                    <i class="fas fa-plus-circle me-1"></i> 新增服務執行歷程 (建立客戶/場所)
                </button>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-list-ul me-2 text-primary"></i>現有客戶與場所清單</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">公司名稱 (統編)</th>
                                <th>作業場所 / 部門</th>
                                <th>服務年度</th>
                                <th>聯絡人</th>
                                <th>狀態</th>
                                <th class="text-end pe-4">管理</th>
                            </tr>
                        </thead>
                        <tbody id="companyTableBody">
                            <tr><td colspan="6" class="text-center py-5 text-muted">資料載入中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="addServiceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header text-white" style="background-color: var(--theme-color);">
                    <h5 class="modal-title fw-bold"><i class="fas fa-folder-plus me-2"></i>新增服務執行歷程 (Plan)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="servicePlanForm">
                        <h6 class="section-header">1. 公司基本資料 (Companies)</h6>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">統一編號</label>
                                <input type="text" class="form-control" id="input-tax-id" placeholder="8碼統編" maxlength="8" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">公司名稱</label>
                                <input type="text" class="form-control" id="input-comp-name" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">聯絡人</label>
                                <input type="text" class="form-control" id="input-contact">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">聯絡電話</label>
                                <input type="text" class="form-control" id="input-phone">
                            </div>
                        </div>

                        <h6 class="section-header">2. 作業場所設定 (Workplaces)</h6>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">部門/場所名稱</label>
                                <input type="text" class="form-control" id="input-dept-name" value="全廠" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">危害風險類型</label>
                                <select class="form-select" id="input-hazard-type">
                                    <option value="一般">一般作業</option>
                                    <option value="化學">化學性危害</option>
                                    <option value="物理">物理性危害 (噪音/高溫)</option>
                                    <option value="綜合">綜合性危害</option>
                                </select>
                            </div>
                        </div>

                        <h6 class="section-header">3. 服務期程設定</h6>
                        <div class="alert alert-light border-start border-4 border-info">
                            <i class="fas fa-info-circle text-info me-1"></i> 
                            此步驟將建立該年度的服務計畫基準。
                        </div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold small">服務年度</label>
                                <input type="number" class="form-control" id="input-service-year" value="2026" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold small text-primary">立案日期 (Contract Date)</label>
                                <input type="date" class="form-control" id="input-contract-date" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold small">歸屬顧問</label>
                                <select class="form-select" id="input-consultant">
                                    <option value="">請選擇...</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn text-white fw-bold" style="background-color: var(--theme-color);" onclick="submitServicePlan()">
                        <i class="fas fa-save me-1"></i> 確認建立
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="mb-1">可信智慧整合有限公司 42917004</div>
        <div class="small opacity-75" style="font-family: 'Segoe UI', sans-serif; letter-spacing: 1px;">
            WesmartAI , Making Trust Transparent.
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ==========================================
        // 初始化與時鐘 (與 Dashboard 一致)
        // ==========================================
        document.addEventListener('DOMContentLoaded', function() {
            document.body.style.display = 'flex';
            
            setInterval(() => {
                const now = new Date();
                const clockEl = document.getElementById('header-clock');
                if(clockEl) clockEl.textContent = now.toLocaleTimeString('zh-TW', { hour12: false });
            }, 1000);

            const dateEl = document.getElementById('header-date');
            if(dateEl) {
                const now = new Date();
                const days = ['日', '一', '二', '三', '四', '五', '六'];
                const formattedDate = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}(${days[now.getDay()]})`;
                dateEl.innerHTML = `<i class="far fa-calendar-alt me-1"></i>今日是 ${formattedDate}`;
            }

            const userName = sessionStorage.getItem('currentUserName');
            const userEl = document.getElementById('header-user');
            if(userEl && userName) userEl.innerText = `Hi! ${userName}`;

            loadData();
            loadConsultants();
        });

        function logoutSystem() {
            if(confirm('確定要登出系統嗎？')) {
                sessionStorage.clear();
                window.location.href = 'login.html';
            }
        }

        // ==========================================
        // Supabase 邏輯
        // ==========================================
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function loadData() {
            const tbody = document.getElementById('companyTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted"><span class="spinner-border spinner-border-sm me-2"></span>資料讀取中...</td></tr>';
            
            try {
                // 讀取 Workplaces 並關聯 Companies
                const { data, error } = await supabaseClient
                    .from('workplaces')
                    .select(`
                        id, department_name, hazard_type,
                        companies ( id, name, tax_id, service_year, contact_person, is_active )
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted">目前尚無資料，請點擊上方按鈕新增。</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map(wp => {
                    const comp = wp.companies || {};
                    const badge = comp.is_active 
                        ? '<span class="badge bg-success bg-opacity-10 text-success">服務中</span>' 
                        : '<span class="badge bg-secondary">已結案</span>';
                    
                    return `
                        <tr>
                            <td class="ps-4">
                                <div class="fw-bold">${comp.name || '未命名'}</div>
                                <small class="text-muted font-monospace">${comp.tax_id || ''}</small>
                            </td>
                            <td>
                                <div>${wp.department_name || '全廠'}</div>
                                <small class="text-secondary">${wp.hazard_type || '一般'}</small>
                            </td>
                            <td><span class="badge bg-light text-dark border">${comp.service_year || '-'}</span></td>
                            <td>${comp.contact_person || '-'}</td>
                            <td>${badge}</td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-outline-primary" title="編輯"><i class="fas fa-edit"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-5 text-danger">讀取失敗: ${e.message}</td></tr>`;
            }
        }

        async function loadConsultants() {
            const select = document.getElementById('input-consultant');
            const { data } = await supabaseClient.from('medical_staff').select('id, name').eq('is_active', true);
            if(data) {
                data.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.innerText = c.name;
                    select.appendChild(opt);
                });
            }
        }

        function openAddModal() {
            document.getElementById('servicePlanForm').reset();
            document.getElementById('input-contract-date').valueAsDate = new Date();
            new bootstrap.Modal(document.getElementById('addServiceModal')).show();
        }

        async function submitServicePlan() {
            // 收集表單資料
            const taxId = document.getElementById('input-tax-id').value.trim();
            const compName = document.getElementById('input-comp-name').value.trim();
            const contact = document.getElementById('input-contact').value.trim();
            const phone = document.getElementById('input-phone').value.trim();
            
            const deptName = document.getElementById('input-dept-name').value.trim();
            const hazardType = document.getElementById('input-hazard-type').value;
            
            const serviceYear = document.getElementById('input-service-year').value;
            const contractDate = document.getElementById('input-contract-date').value; // 立案日期
            const consultantId = document.getElementById('input-consultant').value;

            if(!taxId || !compName || !contractDate) return alert('請填寫完整必要資訊 (統編、名稱、立案日期)');

            const { data: user } = await supabaseClient.auth.getUser();
            const userId = user?.user?.id;

            if(!confirm('確定要建立此客戶資料與作業場所嗎？')) return;

            try {
                // 1. 建立或更新 Company
                const { data: compData, error: compError } = await supabaseClient
                    .from('companies')
                    .upsert({ 
                        tax_id: taxId, 
                        name: compName, 
                        contact_person: contact, 
                        phone: phone,
                        service_year: serviceYear,
                        contract_start_date: contractDate,
                        consultant_id: consultantId || null,
                        created_by: userId,
                        updated_by: userId
                    }, { onConflict: 'tax_id' })
                    .select()
                    .single();

                if(compError) throw new Error('公司資料寫入失敗: ' + compError.message);

                // 2. 建立 Workplace
                // (注意：此處僅寫入 workplace，已移除原本可能存在的 service_records 寫入邏輯)
                const { error: wpError } = await supabaseClient
                    .from('workplaces')
                    .insert({
                        company_id: compData.id,
                        department_name: deptName,
                        hazard_type: hazardType,
                        created_by: userId,
                        updated_by: userId
                    });

                if(wpError) throw new Error('作業場所建立失敗: ' + wpError.message);

                /* [修正說明]
                   原先此處可能有 await supabaseClient.from('service_records').insert(...)
                   已遵照指示完全移除，避免同時產生空的服務紀錄。
                */

                alert('✅ 資料建立成功！');
                bootstrap.Modal.getInstance(document.getElementById('addServiceModal')).hide();
                loadData();

            } catch(e) {
                console.error(e);
                alert('❌ 失敗: ' + e.message);
            }
        }
    </script>
</body>
</html>
