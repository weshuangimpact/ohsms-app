<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基本資料建立 (Data Manegment) | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        /* [修正 3] 統一色調：Data Mgmt 使用 Indigo (#4f46e5) */
        :root { 
            --primary-bg: #f4f6f9; 
            --theme-color: #4f46e5; /* Indigo */
        }

        body {
            background-color: var(--primary-bg);
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            display: none; /* Auth Guard */
        }
        
        /* 標題飾條 - 使用主題色 */
        .section-title { 
            border-left: 5px solid var(--theme-color); 
            padding-left: 15px; 
            margin-bottom: 20px; 
            margin-top: 20px; 
        }
        .section-title.staff { 
            border-left-color: #059669; /* 醫護人員區塊維持綠色區隔，或也可改為主題色，這裡保留原樣以示區分 */
        }

        .info-card { padding: 1rem; border-radius: 0.375rem; font-size: 0.9rem; margin-bottom: 1rem; }
        .bg-info-soft { background-color: #e0e7ff; color: #3730a3; border: 1px solid #c7d2fe; }

        .table th { font-weight: 600; font-size: 0.9rem; background-color: #f8f9fa; }
        .table td { vertical-align: middle; font-size: 0.9rem; }

        /* [新增] 5W1H 說明區塊 (Indigo 風格) */
        .instruction-box {
            background-color: #fff;
            border-left: 5px solid var(--theme-color);
            padding: 20px 25px;
            border-radius: 4px;
            margin-bottom: 30px;
            text-align: left;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .instruction-title {
            color: var(--theme-color);
            font-weight: 700;
            margin-bottom: 10px;
        }

        /* 覆寫按鈕顏色為 Indigo */
        .btn-primary {
            background-color: var(--theme-color);
            border-color: var(--theme-color);
        }
        .btn-primary:hover {
            background-color: #4338ca;
            border-color: #4338ca;
        }
        .text-primary { color: var(--theme-color) !important; }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 9999;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const role = sessionStorage.getItem('currentUserRole');
            // 權限檢查：僅 Admin 與 文管(general/doc_control) 可見
            if (!role || (role !== 'admin' && role !== 'general' && role !== 'doc_control')) {
                alert('權限不足：此頁面僅限管理人員存取。');
                window.location.href = 'dashboard.html';
                return;
            }
            document.body.style.display = 'block';
            loadAllData();
        });
    </script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3 mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold" href="dashboard.html"><i class="fas fa-shield-alt me-2"></i>OHSMS</a>
            <div class="d-flex align-items-center">
                <span class="text-light small me-3">系統管理後台</span>
                <a href="dashboard.html" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left me-1"></i> 返回儀表板</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4 pb-5">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-dark"><i class="fas fa-database me-2" style="color: #4f46e5;"></i>基本資料建立 (Master Data)</h2>
                <p class="text-muted mb-0">建立客戶主檔、作業場所資料與合約期程設定</p>
            </div>
            <div>
                <button class="btn btn-outline-dark btn-sm me-2" onclick="document.getElementById('excelUpload').click()">
                    <i class="fas fa-file-excel me-1"></i> 批次匯入
                </button>
                <input type="file" id="excelUpload" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileUpload(this)">
            </div>
        </div>

        <div class="instruction-box">
            <div class="instruction-title">
                <i class="fas fa-sitemap me-2"></i>5W1H 設計精神：主檔定義與關聯
            </div>
            <p class="mb-0 text-dark" style="line-height: 1.6;">
                我們服務了誰 (Client)、誰提供服務 (Provider)，皆在此統一管理。此模組確立了系統運作的「主詞」與「受詞」，是資料串接與權限控管的基石。
            </p>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0 text-dark"><i class="fas fa-building me-2 text-primary"></i>企業與場所主檔 (Companies)</h5>
                        <button class="btn btn-primary btn-sm fw-bold" onclick="openCompanyModal()">
                            <i class="fas fa-plus me-1"></i> 新增企業
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="info-card bg-info-soft m-3">
                            <i class="fas fa-info-circle me-1"></i> <strong>階層架構：</strong> 先建立「公司(統編)」，再於該公司下建立多個「作業場所(廠區/部門)」。
                        </div>
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th class="ps-4">統一編號</th>
                                        <th>事業單位名稱</th>
                                        <th>合約期間</th>
                                        <th>場所數量</th>
                                        <th class="text-end pe-4">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="companyListBody">
                                    <tr><td colspan="5" class="text-center py-5">載入中...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0 text-dark"><i class="fas fa-user-nurse me-2 text-success"></i>醫護人員 (Staff)</h5>
                        <button class="btn btn-success btn-sm fw-bold" onclick="openStaffModal()">
                            <i class="fas fa-plus me-1"></i> 新增人員
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th class="ps-4">姓名</th>
                                        <th>職務</th>
                                        <th class="text-end pe-4">狀態</th>
                                    </tr>
                                </thead>
                                <tbody id="staffListBody">
                                    <tr><td colspan="3" class="text-center py-5">載入中...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="companyModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold" id="companyModalTitle">新增/編輯 企業資料</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="companyForm">
                        <input type="hidden" id="co-id">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">統一編號 <span class="text-danger">*</span></label>
                                <input type="text" id="co-taxid" class="form-control" placeholder="8碼數字" required>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label fw-bold">事業單位名稱 <span class="text-danger">*</span></label>
                                <input type="text" id="co-name" class="form-control" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">登記地址</label>
                                <input type="text" id="co-addr" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">聯絡人</label>
                                <input type="text" id="co-contact" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">聯絡電話</label>
                                <input type="text" id="co-phone" class="form-control">
                            </div>
                            <div class="col-12"><hr></div>
                            <div class="col-12">
                                <h6 class="fw-bold text-primary mb-3">合約與服務設定</h6>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">合約開始日</label>
                                <input type="date" id="co-start" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">合約結束日</label>
                                <input type="date" id="co-end" class="form-control">
                            </div>
                        </div>
                    </form>
                    
                    <div id="previewArea" style="display:none;">
                        <div class="alert alert-info">
                            <i class="fas fa-file-import me-1"></i> 準備匯入 <strong id="previewCount">0</strong> 筆資料
                        </div>
                        <div style="max-height:300px; overflow:auto;">
                            <table class="table table-sm table-bordered">
                                <tbody id="previewTable"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="workplaceSection" class="mt-4 pt-3 border-top" style="display:none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold mb-0 text-dark">所屬作業場所 (Workplaces)</h6>
                            <button class="btn btn-outline-primary btn-sm" onclick="addWorkplaceRow()">
                                <i class="fas fa-plus me-1"></i> 新增場所
                            </button>
                        </div>
                        <table class="table table-sm table-bordered bg-light">
                            <thead>
                                <tr>
                                    <th>部門/廠區名稱</th>
                                    <th>危害分類</th>
                                    <th style="width:100px;">總人數</th>
                                    <th style="width:60px;">動作</th>
                                </tr>
                            </thead>
                            <tbody id="workplaceList"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary fw-bold" onclick="saveCompany()">儲存資料</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="staffModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title fw-bold" id="staffModalTitle">新增人員</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="st-id">
                    <div class="mb-3">
                        <label class="form-label fw-bold">姓名 <span class="text-danger">*</span></label>
                        <input type="text" id="st-name" class="form-control" required>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">職務角色</label>
                            <select id="st-role" class="form-select">
                                <option value="醫師">醫師</option>
                                <option value="護理人員">護理人員</option>
                                <option value="顧問">顧問</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">聘僱類型</label>
                            <select id="st-type" class="form-select">
                                <option value="特約">特約</option>
                                <option value="專職">專職</option>
                                <option value="兼職">兼職</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Email (登入帳號)</label>
                        <input type="email" id="st-email" class="form-control" placeholder="將作為系統登入帳號">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">聯絡電話</label>
                        <input type="text" id="st-phone" class="form-control">
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="st-active" checked>
                        <label class="form-check-label" for="st-active">帳號啟用狀態 (Active)</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success fw-bold" onclick="saveStaff()">確認儲存</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
        <h5 class="text-dark fw-bold">資料處理中...</h5>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let companyList = [];
        let staffList = [];
        let currentWorkplaces = [];
        let batchData = [];
        let currentType = 'company';

        // 1. 載入資料
        async function loadAllData() {
            try {
                // Companies (包含場所數量統計)
                const { data: coData, error: coErr } = await supabaseClient
                    .from('companies')
                    .select('*, workplaces(count)')
                    .order('created_at', {ascending: false});
                
                if (coErr) throw coErr;
                companyList = coData || [];
                renderCompanyList();

                // Staff
                const { data: stData, error: stErr } = await supabaseClient
                    .from('medical_staff')
                    .select('*')
                    .order('created_at', {ascending: false});

                if (stErr) throw stErr;
                staffList = stData || [];
                renderStaffList();

            } catch (e) {
                console.error(e);
                alert('資料載入失敗');
            }
        }

        // 2. 渲染公司列表
        function renderCompanyList() {
            const tbody = document.getElementById('companyListBody');
            if(companyList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">目前無資料</td></tr>';
                return;
            }
            
            tbody.innerHTML = companyList.map(co => {
                const wpCount = co.workplaces ? co.workplaces[0].count : 0;
                const dateRange = (co.contract_start_date && co.contract_end_date) 
                    ? `<small class="text-muted">${co.contract_start_date} ~ ${co.contract_end_date}</small>`
                    : '<span class="text-muted">-</span>';

                return `
                <tr class="animate__animated animate__fadeIn">
                    <td class="ps-4 font-monospace fw-bold text-primary">${co.tax_id}</td>
                    <td class="fw-bold">${co.name}</td>
                    <td>${dateRange}</td>
                    <td><span class="badge bg-light text-dark border">${wpCount} 處</span></td>
                    <td class="text-end pe-4">
                        <button class="btn btn-sm btn-outline-secondary" onclick="editCompany('${co.id}')">
                            <i class="fas fa-edit"></i> 編輯
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }

        // 3. 渲染人員列表
        function renderStaffList() {
            const tbody = document.getElementById('staffListBody');
            if(staffList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-muted">無資料</td></tr>';
                return;
            }

            tbody.innerHTML = staffList.map(st => {
                const statusDot = st.is_active 
                    ? '<span class="text-success"><i class="fas fa-circle fa-xs me-1"></i>在職</span>' 
                    : '<span class="text-danger"><i class="fas fa-circle fa-xs me-1"></i>離職</span>';
                
                return `
                <tr class="animate__animated animate__fadeIn">
                    <td class="ps-4 fw-bold">${st.name}</td>
                    <td><small class="text-muted">${st.role}</small></td>
                    <td class="text-end pe-4">
                        <button class="btn btn-sm btn-link text-decoration-none p-0 me-2" onclick="editStaff('${st.id}')">${statusDot}</button>
                    </td>
                </tr>`;
            }).join('');
        }

        // 4. 新增/編輯 公司邏輯
        function openCompanyModal() {
            document.getElementById('companyForm').reset();
            document.getElementById('co-id').value = '';
            document.getElementById('companyModalTitle').innerText = '新增企業資料';
            document.getElementById('workplaceSection').style.display = 'none';
            document.getElementById('previewArea').style.display = 'none';
            document.getElementById('companyForm').style.display = 'block';
            currentWorkplaces = [];
            new bootstrap.Modal(document.getElementById('companyModal')).show();
        }

        async function editCompany(id) {
            const co = companyList.find(c => c.id === id);
            if(!co) return;

            document.getElementById('co-id').value = co.id;
            document.getElementById('co-taxid').value = co.tax_id;
            document.getElementById('co-name').value = co.name;
            document.getElementById('co-addr').value = co.address || '';
            document.getElementById('co-contact').value = co.contact_person || '';
            document.getElementById('co-phone').value = co.phone || '';
            document.getElementById('co-start').value = co.contract_start_date || '';
            document.getElementById('co-end').value = co.contract_end_date || '';

            document.getElementById('companyModalTitle').innerText = '編輯企業資料';
            document.getElementById('workplaceSection').style.display = 'block';
            document.getElementById('previewArea').style.display = 'none';
            document.getElementById('companyForm').style.display = 'block';

            // Load Workplaces
            const { data } = await supabaseClient.from('workplaces').select('*').eq('company_id', id);
            currentWorkplaces = data || [];
            renderWorkplaces();

            new bootstrap.Modal(document.getElementById('companyModal')).show();
        }

        function renderWorkplaces() {
            const tbody = document.getElementById('workplaceList');
            tbody.innerHTML = currentWorkplaces.map((wp, idx) => `
                <tr>
                    <td><input type="text" class="form-control form-control-sm" value="${wp.department_name}" onchange="updateWp(${idx}, 'department_name', this.value)"></td>
                    <td><input type="text" class="form-control form-control-sm" value="${wp.hazard_type || ''}" onchange="updateWp(${idx}, 'hazard_type', this.value)"></td>
                    <td><input type="number" class="form-control form-control-sm" value="${wp.hazard_count || 0}" onchange="updateWp(${idx}, 'hazard_count', this.value)"></td>
                    <td class="text-center">
                        ${wp.id ? '<span class="badge bg-secondary">存</span>' : '<button class="btn btn-xs btn-danger" onclick="removeWp('+idx+')"><i class="fas fa-times"></i></button>'}
                    </td>
                </tr>
            `).join('');
        }

        function addWorkplaceRow() {
            currentWorkplaces.push({ department_name: '新廠區/部門', hazard_type: '', hazard_count: 0 });
            renderWorkplaces();
        }

        function updateWp(idx, field, val) {
            currentWorkplaces[idx][field] = val;
        }

        function removeWp(idx) {
            currentWorkplaces.splice(idx, 1);
            renderWorkplaces();
        }

        async function saveCompany() {
            const id = document.getElementById('co-id').value;
            const payload = {
                tax_id: document.getElementById('co-taxid').value,
                name: document.getElementById('co-name').value,
                address: document.getElementById('co-addr').value,
                contact_person: document.getElementById('co-contact').value,
                phone: document.getElementById('co-phone').value,
                contract_start_date: document.getElementById('co-start').value || null,
                contract_end_date: document.getElementById('co-end').value || null,
            };

            if(!payload.tax_id || !payload.name) return alert('統編與名稱為必填');

            // 批次匯入模式
            if(batchData.length > 0 && document.getElementById('previewArea').style.display !== 'none') {
                saveBatchData('company');
                return;
            }

            try {
                let newCoId = id;
                if(id) {
                    await supabaseClient.from('companies').update(payload).eq('id', id);
                    await writeLog('更新', 'companies', `更新公司: ${payload.name}`);
                } else {
                    const { data, error } = await supabaseClient.from('companies').insert([payload]).select();
                    if(error) throw error;
                    newCoId = data[0].id;
                    await writeLog('新增', 'companies', `新增公司: ${payload.name}`);
                }

                // Save Workplaces
                if(currentWorkplaces.length > 0) {
                    const inserts = currentWorkplaces.filter(w => !w.id).map(w => ({...w, company_id: newCoId}));
                    const updates = currentWorkplaces.filter(w => w.id);
                    
                    if(inserts.length > 0) await supabaseClient.from('workplaces').insert(inserts);
                    for(const w of updates) {
                        await supabaseClient.from('workplaces').update({
                            department_name: w.department_name,
                            hazard_type: w.hazard_type,
                            hazard_count: w.hazard_count
                        }).eq('id', w.id);
                    }
                }

                alert('儲存成功');
                bootstrap.Modal.getInstance(document.getElementById('companyModal')).hide();
                loadAllData();

            } catch(e) {
                console.error(e);
                alert('儲存失敗: ' + e.message);
            }
        }

        // 5. 新增/編輯 人員邏輯
        function openStaffModal() {
            document.getElementById('st-id').value = '';
            document.getElementById('st-name').value = '';
            document.getElementById('st-email').value = '';
            document.getElementById('st-phone').value = '';
            document.getElementById('st-active').checked = true;
            document.getElementById('staffModalTitle').innerText = '新增醫護人員';
            new bootstrap.Modal(document.getElementById('staffModal')).show();
        }

        function editStaff(id) {
            const st = staffList.find(s => s.id === id);
            document.getElementById('st-id').value = st.id;
            document.getElementById('st-name').value = st.name;
            document.getElementById('st-role').value = st.role;
            document.getElementById('st-type').value = st.employment_type;
            document.getElementById('st-email').value = st.email;
            document.getElementById('st-phone').value = st.phone;
            document.getElementById('st-active').checked = st.is_active;
            document.getElementById('staffModalTitle').innerText = '編輯人員資料';
            new bootstrap.Modal(document.getElementById('staffModal')).show();
        }

        async function saveStaff() {
            const id = document.getElementById('st-id').value;
            const payload = {
                name: document.getElementById('st-name').value,
                role: document.getElementById('st-role').value,
                employment_type: document.getElementById('st-type').value,
                email: document.getElementById('st-email').value,
                phone: document.getElementById('st-phone').value,
                is_active: document.getElementById('st-active').checked
            };

            if(!payload.name) return alert('姓名為必填');

            try {
                if(id) {
                    await supabaseClient.from('medical_staff').update(payload).eq('id', id);
                    await writeLog('更新', 'medical_staff', `更新人員: ${payload.name}`);
                } else {
                    await supabaseClient.from('medical_staff').insert([payload]);
                    await writeLog('新增', 'medical_staff', `新增人員: ${payload.name}`);
                }
                alert('儲存成功');
                bootstrap.Modal.getInstance(document.getElementById('staffModal')).hide();
                loadAllData();
            } catch(e) {
                alert('失敗: ' + e.message);
            }
        }

        // 6. 批次匯入處理 (Excel)
        function handleFileUpload(input) {
            const file = input.files[0];
            if(!file) return;

            // 判斷匯入類型 (暫時簡單用 confirm 或預設 company)
            // 實務上可讓 user 選，這裡先預設匯入 company
            currentType = confirm('點擊「確定」匯入公司，「取消」匯入人員？') ? 'company' : 'staff';

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, {header:1});

                // 移除標題列
                if(json.length > 0) json.shift();

                batchData = [];
                for(let r of json) {
                    if(r.length < 2) continue; // Skip empty rows
                    if(currentType === 'company') {
                        batchData.push({ 
                            tax_id: r[0], name: r[1], address: r[2], contact_person: r[3], 
                            contract_start_date: r[4]||null, contract_end_date: r[5]||null 
                        });
                    } else if(currentType === 'staff') {
                        batchData.push({ name:r[0], role:r[1]||'護理人員', employment_type:r[2]||'兼職', phone:r[3], email:r[4], onboard_date:r[5]||null });
                    }
                }
                if(currentType === 'company') {
                    openCompanyModal();
                    document.getElementById('companyForm').style.display = 'none';
                    document.getElementById('previewArea').style.display = 'block';
                    document.getElementById('previewCount').innerText = batchData.length;
                    document.getElementById('previewTable').innerHTML = batchData.map(d => `<tr><td>${d.name}</td></tr>`).join('');
                } else if(currentType === 'staff') {
                    if(confirm(`解析出 ${batchData.length} 筆資料，是否直接匯入？`)) saveBatchData('staff');
                }
                document.getElementById('loadingOverlay').style.display = 'none';
            };
            reader.readAsArrayBuffer(file);
        }

        async function saveBatchData(type) {
            try {
                document.getElementById('loadingOverlay').style.display = 'flex';
                const table = type === 'company' ? 'companies' : 'medical_staff';
                
                // 分批寫入避免過大
                const chunkSize = 50;
                for (let i = 0; i < batchData.length; i += chunkSize) {
                    const chunk = batchData.slice(i, i + chunkSize);
                    const { error } = await supabaseClient.from(table).insert(chunk);
                    if(error) throw error;
                }
                
                await writeLog('批量匯入', table, `匯入 ${batchData.length} 筆資料`);
                alert('匯入完成');
                document.getElementById('loadingOverlay').style.display = 'none';
                
                if(type === 'company') bootstrap.Modal.getInstance(document.getElementById('companyModal')).hide();
                loadAllData();
            } catch(e) {
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('匯入失敗: ' + e.message);
            }
        }

        async function writeLog(action, table, detail) {
            const role = sessionStorage.getItem('currentUserRole');
            const name = sessionStorage.getItem('currentUserName');
            await supabaseClient.from('audit_logs').insert([{user_role:role, user_name:name, action_type:action, target_table:table, details:detail}]);
        }
    </script>
</body>
</html>
