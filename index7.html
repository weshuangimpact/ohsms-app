<script>
const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let currentStaff = null;

document.addEventListener('DOMContentLoaded', async () => {

    /* 1️⃣ 驗證 Auth（唯一可信） */
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) {
        alert('請先登入系統');
        location.href = 'login.html';
        return;
    }

    currentUser = session.user;

    /* 2️⃣ 從 medical_staff 取得系統角色 */
    const { data: staff, error } = await supabaseClient
        .from('medical_staff')
        .select('id, name, system_role')
        .eq('user_id', currentUser.id)
        .single();

    if (error || !staff) {
        alert('找不到對應的人員資料，請聯絡管理員');
        console.error(error);
        return;
    }

    currentStaff = staff;

    /* 3️⃣ 權限判斷（正式） */
    if (!['admin', 'general'].includes(staff.system_role)) {
        alert('權限不足：此頁面僅限管理人員與文管人員');
        location.href = 'dashboard.html';
        return;
    }

    /* 4️⃣ 顯示頁面 */
    document.body.style.display = 'block';
    document.getElementById('user-display').innerHTML =
        `<small>${staff.system_role === 'admin' ? 'Admin' : '文管'}：${staff.name}</small>`;

    loadCompanyOptions();
});
