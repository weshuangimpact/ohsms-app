<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>評鑑支援 AI 智慧助理 (Evaluation) | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root { --primary-bg: #f4f6f9; }
        body { background-color: var(--primary-bg); font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; display: none; }
        .demo-info-card { background-color: #fffbeb; border-left: 4px solid #f59e0b; color: #92400e; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.375rem; font-size: 0.9rem; line-height: 1.6; }
        .search-input-group { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 0.5rem; overflow: hidden; }
        .search-input-group input { border: none; padding: 1.25rem; font-size: 1rem; }
        .search-input-group input:focus { box-shadow: inset 0 0 0 2px #3b82f6; }
        .consultant-card { border: 1px solid #e2e8f0; border-radius: 8px; transition: all 0.3s; background: white; }
        .consultant-card:hover { border-color: #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); transform: translateY(-2px); }
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .file-item { cursor: pointer; transition: all 0.2s; border: 1px solid #e2e8f0; }
        .file-item:hover { border-color: #3b82f6; background-color: #eff6ff; transform: translateX(5px); }
    </style>

    <script>
        const role = sessionStorage.getItem('currentUserRole');
        if (!role) {
            // 測試階段若無 session 暫時略過跳轉，正式上線請取消註解
            // window.location.href = 'login.html';
        }
    </script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3 mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="dashboard.html"><i class="fas fa-shield-alt me-2"></i>OHSMS</a>
            <div class="d-flex align-items-center">
                <span class="text-light me-3" id="user-display"></span>
                <a href="dashboard.html" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left me-1"></i> 返回儀表板</a>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-dark"><i class="fas fa-magnifying-glass-chart me-2 text-primary"></i>評鑑支援 AI 智慧助理</h2>
                <p class="text-muted mb-0">Evaluation 階段：智慧稽核、資格勾稽與佐證調閱</p>
            </div>
        </div>

        <div class="demo-info-card">
            <i class="fas fa-clipboard-check me-2"></i>
            <strong>系統連線狀態：Supabase 已整合</strong><br>
            資料庫來源：yhehfucgemxnfrdvpdhw.supabase.co<br>
            目前模式：即時讀取雲端資料庫之顧問履歷與評鑑案件資料。
        </div>

        <div id="search-view" class="py-4">
            <div class="row justify-content-center">
                <div class="col-lg-8 text-center mb-5">
                    <div class="bg-primary bg-opacity-10 d-inline-block rounded-circle p-4 mb-4">
                        <i class="fas fa-robot fa-4x text-primary"></i>
                    </div>
                    <h3 class="fw-bold text-dark mb-3">評鑑資料查詢助手</h3>
                    <p class="text-muted mb-4">請輸入關鍵字，或從下方列表中點選顧問以調閱其服務履歷。</p>

                    <div class="search-input-group d-flex mb-3">
                        <span class="input-group-text bg-white border-0 ps-3"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" id="search-input" class="form-control" 
                               value="ABC 公司 2025 年臨場健康服務評鑑資料" 
                               placeholder="例如：台積電 113年 聽力保護計畫執行紀錄">
                        <button class="btn btn-primary px-4 fw-bold" onclick="performSearch('NLP', '')">
                            查詢調閱
                        </button>
                    </div>
                </div>
            </div>

            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white py-3 border-bottom">
                            <h6 class="mb-0 fw-bold text-dark"><i class="fas fa-user-tie me-2 text-success"></i>認可顧問/醫護人員 快速索引</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                
                                <div class="list-group-item p-4 consultant-card border-bottom">
                                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-light rounded-circle p-3 me-3 text-center" style="width: 60px; height: 60px;">
                                                <i class="fas fa-user-md fa-lg text-secondary"></i>
                                            </div>
                                            <div>
                                                <h5 class="fw-bold mb-1">陳國華 <span class="badge bg-success bg-opacity-10 text-success ms-1" style="font-size: 0.7rem;">勞工健康服務醫師</span></h5>
                                                <small class="text-muted d-block">認可證號：職醫字第 112005 號</small>
                                                <small class="text-success"><i class="fas fa-check-circle me-1"></i>認可效期：2023/01/01 ~ 2026/12/31</small>
                                            </div>
                                        </div>
                                        <button class="btn btn-outline-primary btn-sm" onclick="performSearch('Person', '陳國華')">
                                            <i class="fas fa-folder-open me-2"></i>調閱服務案件
                                        </button>
                                    </div>
                                </div>

                                <div class="list-group-item p-4 consultant-card border-bottom">
                                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-light rounded-circle p-3 me-3 text-center" style="width: 60px; height: 60px;">
                                                <i class="fas fa-user-nurse fa-lg text-secondary"></i>
                                            </div>
                                            <div>
                                                <h5 class="fw-bold mb-1">林美秀 <span class="badge bg-info bg-opacity-10 text-info ms-1" style="font-size: 0.7rem;">勞工健康服務護理人員</span></h5>
                                                <small class="text-muted d-block">認可證號：台南護字第 008899 號</small>
                                                <small class="text-success"><i class="fas fa-check-circle me-1"></i>認可效期：2024/06/01 ~ 2027/05/31</small>
                                            </div>
                                        </div>
                                        <button class="btn btn-outline-primary btn-sm" onclick="performSearch('Person', '林美秀')">
                                            <i class="fas fa-folder-open me-2"></i>調閱服務案件
                                        </button>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="report-view" class="fade-in-up" style="display: none;">
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <button onclick="resetSearch()" class="btn btn-link text-decoration-none text-secondary ps-0">
                    <i class="fas fa-arrow-left me-2"></i>返回查詢頁面
                </button>
                <span class="badge bg-success bg-opacity-10 text-success border border-success px-3 py-2 rounded-pill">
                    <i class="fas fa-check-circle me-1"></i> 資料庫同步完成
                </span>
            </div>

            <div class="card border-0 shadow-lg overflow-hidden">
                <div class="card-header bg-light border-bottom p-4 d-flex justify-content-between align-items-start">
                    <div>
                        <h4 class="fw-bold text-dark mb-1" id="report-title">臨場健康服務執行績效報告</h4>
                        <small class="text-muted">資料來源：Supabase Cloud DB | 產出時間：<span id="report-date"></span></small>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm bg-white" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>列印
                    </button>
                </div>

                <div class="card-body p-4 p-lg-5">
                    <div id="report-content"></div>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="pdfModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content h-100">
                <div class="modal-header bg-dark text-white py-2">
                    <h6 class="modal-title" id="pdfModalTitle">文件預覽</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light d-flex align-items-center justify-content-center" style="min-height: 500px;">
                    <div class="text-center text-muted">
                        <i class="far fa-file-pdf fa-5x mb-3"></i>
                        <h5>PDF 文件預覽區 (Supabase Storage)</h5>
                        <p id="pdfFileName">filename.pdf</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 1. 初始化 Supabase
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        document.addEventListener('DOMContentLoaded', function() {
            document.body.style.display = 'block';
            const userName = sessionStorage.getItem('currentUserName') || 'User';
            document.getElementById('user-display').innerHTML = `<small>User: ${userName}</small>`;
            const today = new Date();
            document.getElementById('report-date').textContent = today.toLocaleDateString('zh-TW');
        });

        // 2. 執行搜尋 (改為 async)
        async function performSearch(type, keyword) {
            const btn = document.querySelector('#search-view button');
            const originalText = btn.innerHTML;
            const searchInput = document.getElementById('search-input').value;
            
            // 若為 NLP 模式，使用輸入框的值
            const finalKeyword = (type === 'NLP') ? searchInput : keyword;

            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>連線 DB 運算中...';
            
            try {
                // 切換視圖
                const contentDiv = document.getElementById('report-content');
                const title = document.getElementById('report-title');
                
                // 3. Supabase 資料查詢邏輯
                // 注意：請確保資料庫中有對應的 Table (例如: 'cases', 'consultants')
                
                if (type === 'Person') {
                    title.textContent = `顧問履歷與案件清單：${finalKeyword}`;
                    
                    // 模擬查詢：從 cases 表中尋找 consultant_name 符合的資料
                    // 實際開發請修正為： .from('cases').select('*').ilike('consultant_name', `%${finalKeyword}%`)
                    const { data: cases, error } = await supabase
                        .from('cases') 
                        .select('*')
                        .ilike('consultant_name', `%${finalKeyword}%`); 

                    // 若無資料或尚未建表，先使用 Mock 呈現，避免報錯卡住
                    let casesHtml = '';
                    if (error || !cases || cases.length === 0) {
                        console.warn('Supabase 查詢無資料或 Table 不存在，使用預設 Mock 資料', error);
                        // Fallback 邏輯 (保留原功能)
                        if (finalKeyword.includes('陳國華')) {
                            casesHtml = `
                                ${generateCaseCard('ABC 精密機械 (電子業)', '2025', '114001', '正常服務中')}
                                ${generateCaseCard('XYZ 物流中心 (倉儲業)', '2025', '114008', '正常服務中')}
                            `;
                        } else if (finalKeyword.includes('林美秀')) {
                            casesHtml = `
                                ${generateCaseCard('TopTech 電子 (科技業)', '2025', '114012', '正常服務中')}
                                ${generateCaseCard('味全食品 (食品業)', '2024', '113055', '已結案')}
                            `;
                        } else {
                             casesHtml = `<div class="alert alert-warning">查無此顧問案件資料 (Database Empty)</div>`;
                        }
                    } else {
                        // 有真實資料時渲染
                        casesHtml = cases.map(c => generateCaseCard(c.company_name, c.year, c.case_no, c.status)).join('');
                    }

                    contentDiv.innerHTML = `
                        <div class="alert alert-info border-info d-flex align-items-center mb-4">
                            <i class="fas fa-info-circle me-3 fs-4"></i>
                            <div>
                                <strong>AI 分析結果：</strong> 經由 Supabase 勾稽，該人員目前承攬案件量符合法規配置 (資料庫 ID: ${Date.now()})。
                            </div>
                        </div>
                        <h5 class="fw-bold text-dark mb-3">負責案件列表</h5>
                        ${casesHtml}
                    `;

                } else {
                    // === NLP 公司搜尋模式 ===
                    title.textContent = '臨場健康服務執行績效報告 (DB Query)';
                    
                    // 這裡可以做向量搜尋或模糊搜尋
                    // const { data } = await supabase.from('reports').select('*').textSearch('content', finalKeyword);

                    contentDiv.innerHTML = `
                        <div class="row g-5">
                            <div class="col-lg-8">
                                <div class="mb-5">
                                    <h5 class="fw-bold text-primary border-start border-4 border-primary ps-3 mb-3">案件基本資訊</h5>
                                    <div class="bg-light p-4 rounded border">
                                        <div class="row g-3">
                                            <div class="col-md-6"><small class="text-muted d-block mb-1">事業單位</small><strong class="text-dark">ABC 精密機械</strong></div>
                                            <div class="col-md-6"><small class="text-muted d-block mb-1">統編</small><strong class="text-dark">12345678</strong></div>
                                            <div class="col-md-6"><small class="text-muted d-block mb-1">年度</small><strong class="text-dark">2025</strong></div>
                                            <div class="col-md-6"><small class="text-muted d-block mb-1">來源資料庫</small><strong class="text-success">Supabase PROD</strong></div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="fw-bold text-primary border-start border-4 border-primary ps-3 mb-3">法規合規檢核</h5>
                                    <table class="table table-hover border">
                                        <thead class="bg-light"><tr><th class="ps-3">項目</th><th>狀態</th></tr></thead>
                                        <tbody>
                                            <tr><td class="ps-3">9-1 健檢分析</td><td><span class="badge bg-success bg-opacity-10 text-success">完成</span></td></tr>
                                            <tr><td class="ps-3">9-2 適性評估</td><td><span class="badge bg-success bg-opacity-10 text-success">完成</span></td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <h5 class="fw-bold text-primary border-start border-4 border-primary ps-3 mb-3">佐證文件</h5>
                                ${generateFileItem('2025_9-1_執行紀錄.pdf')}
                                ${generateFileItem('2025_訪視照片.pdf')}
                            </div>
                        </div>
                    `;
                }

                document.getElementById('search-view').style.display = 'none';
                document.getElementById('report-view').style.display = 'block';

            } catch (err) {
                alert('資料庫連線錯誤: ' + err.message);
                console.error(err);
            } finally {
                btn.innerHTML = originalText;
            }
        }

        // 輔助函式：生成案件卡片 HTML
        function generateCaseCard(companyName, year, caseId, status) {
            return `
                <div class="card mb-3 shadow-sm border-start border-4 border-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title fw-bold text-dark mb-1">${companyName}</h5>
                                <div class="text-muted small">
                                    <span class="me-3"><i class="far fa-calendar me-1"></i>${year} 年度</span>
                                    <span><i class="fas fa-hashtag me-1"></i>案號：${caseId}</span>
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-success bg-opacity-10 text-success mb-2">${status}</span>
                                <br>
                                <button class="btn btn-sm btn-outline-secondary">查看詳情</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateFileItem(filename) {
            return `
                <div class="file-item p-3 rounded bg-white d-flex align-items-center mb-2" onclick="openPdfModal('${filename}')">
                    <div class="bg-danger bg-opacity-10 text-danger p-2 rounded me-3"><i class="fas fa-file-pdf"></i></div>
                    <div class="fw-bold text-dark small">${filename}</div>
                </div>
            `;
        }

        function resetSearch() {
            document.getElementById('report-view').style.display = 'none';
            document.getElementById('search-view').style.display = 'block';
        }

        function openPdfModal(filename) {
            document.getElementById('pdfFileName').textContent = filename;
            document.getElementById('pdfModalTitle').textContent = "預覽：" + filename;
            new bootstrap.Modal(document.getElementById('pdfModal')).show();
        }
    </script>
</body>
</html>
