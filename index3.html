<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OHSMS 歷史軌跡搜尋 (History Trace)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* =========================================
           統一頁首/頁尾 CSS 設定
           ========================================= */
        html, body {
            height: 100%;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f8f9fa;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }

        .container, .main-content, .container-fluid {
            flex: 1;
        }

        /* 頁首設定 */
        .navbar {
            background-color: #202124 !important;
            min-height: 85px;
            color: #fff;
            flex-shrink: 0;
        }

        /* 頁尾設定 */
        footer {
            background-color: #202124 !important;
            color: #fff;
            flex-shrink: 0;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: auto;
            padding: 15px 0;
            min-height: 85px;
        }

        /* 搜尋區塊 */
        .search-box {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border-left: 5px solid #0d6efd; /* Blue for History */
        }

        /* 列表表格 */
        .table-hover tbody tr:hover {
            background-color: rgba(13, 110, 253, 0.05);
        }
        
        .status-badge {
            font-size: 0.85em;
            padding: 5px 10px;
            border-radius: 20px;
        }

        /* 載入遮罩 */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark px-4">
        <div class="container-fluid d-flex justify-content-between align-items-center p-0">
            <a class="navbar-brand d-flex align-items-center fw-bold" href="dashboard.html">
                <i class="fas fa-shield-alt me-2"></i>
                OHSMS 職安管理系統
            </a>
            <div class="d-flex align-items-center">
                <span class="text-white me-3 small" id="header-date"><i class="fas fa-spinner fa-spin"></i></span>
                <span class="text-white me-4 small border-start ps-3 border-secondary" id="header-clock" style="opacity: 0.9;">--:--</span>
                <span class="text-white me-4 fw-bold" id="header-user">Hi! 使用者</span>
                <a class="btn btn-outline-light btn-sm me-2" href="dashboard.html"><i class="fas fa-reply me-1"></i>回到儀表板</a>
                <button class="btn btn-outline-light btn-sm" onclick="logoutSystem()"><i class="fas fa-sign-out-alt me-1"></i>登出</button>
            </div>
        </div>
    </nav>

    <div class="container main-content mt-4">
        <div class="d-flex justify-content-between align-items-end mb-4">
            <div>
                <h2 class="fw-bold text-dark mb-1">歷史軌跡與證據查詢 (History Trace)</h2>
                <p class="text-secondary mb-0">查詢已結案之服務紀錄與數位證據</p>
            </div>
        </div>

        <div class="search-box">
            <div class="row g-3 align-items-end">
                <div class="col-md-2">
                    <label class="form-label fw-bold">年度</label>
                    <select class="form-select" id="search-year">
                        <option value="2026">2026</option>
                        <option value="2025" selected>2025</option>
                        <option value="2024">2024</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">關鍵字 (公司名稱/統編/顧問)</label>
                    <input type="text" class="form-control" id="search-keyword" placeholder="輸入關鍵字...">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100 fw-bold" onclick="performSearch()">
                        <i class="fas fa-search me-2"></i>搜尋
                    </button>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h5 class="fw-bold mb-0"><i class="fas fa-list me-2 text-primary"></i>查詢結果列表</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">執行日期</th>
                                <th>公司名稱 (統編)</th>
                                <th>執行顧問</th>
                                <th>服務項目</th>
                                <th>核定備註 (Audit Note)</th>
                                <th class="text-end pe-4">功能</th>
                            </tr>
                        </thead>
                        <tbody id="result-list">
                            <tr><td colspan="6" class="text-center py-5 text-muted">請輸入條件後點擊搜尋</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <div class="fw-bold text-dark" id="loadingText">資料讀取中...</div>
    </div>

    <footer>
        <div class="mb-1">可信智慧整合有限公司 42917004</div>
        <div class="small opacity-75" style="font-family: 'Segoe UI', sans-serif; letter-spacing: 1px;">
            WesmartAI , Making Trust Transparent.
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ==========================================
        // 1. 初始化
        // ==========================================
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        document.addEventListener('DOMContentLoaded', function() {
            // Header Timer
            setInterval(() => {
                document.getElementById('header-clock').textContent = new Date().toLocaleTimeString('zh-TW', { hour12: false });
            }, 1000);
            const now = new Date();
            const days = ['日', '一', '二', '三', '四', '五', '六'];
            document.getElementById('header-date').innerHTML = `<i class="far fa-calendar-alt me-1"></i>今日是 ${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}(${days[now.getDay()]})`;
            
            const userName = sessionStorage.getItem('currentUserName');
            if(userName) document.getElementById('header-user').innerText = `Hi! ${userName}`;

            // 自動執行一次搜尋
            performSearch();
        });

        function logoutSystem() {
            if(confirm('確定要登出嗎？')) {
                sessionStorage.clear();
                window.location.href = 'login.html';
            }
        }

        // ==========================================
        // 2. 搜尋邏輯
        // ==========================================
        async function performSearch() {
            const year = document.getElementById('search-year').value;
            const keyword = document.getElementById('search-keyword').value.trim();
            const listEl = document.getElementById('result-list');

            listEl.innerHTML = '<tr><td colspan="6" class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x"></i><br>搜尋中...</td></tr>';

            try {
                let query = supabaseClient
                    .from('evidence')
                    .select(`
                        id, visit_date, service_year, execution_items, audit_note, is_special_case, file_url,
                        workplaces!inner ( companies!inner ( name, tax_id ) ),
                        medical_staff ( name )
                    `)
                    .eq('service_year', year)
                    .order('visit_date', { ascending: false });

                // 簡單的前端關鍵字過濾 (或是後端 ILIKE)
                // 由於 Supabase 關聯查詢的 filter 較複雜，這裡先抓回來再濾，或者用 inner join filter
                // 這裡示範抓回來後端 filter (量大時建議改後端 RPC)
                
                const { data, error } = await query;
                if (error) throw error;

                let filteredData = data;
                if (keyword) {
                    const lowKey = keyword.toLowerCase();
                    filteredData = data.filter(item => {
                        const compName = item.workplaces?.companies?.name || '';
                        const taxId = item.workplaces?.companies?.tax_id || '';
                        const staff = item.medical_staff?.name || '';
                        return compName.includes(lowKey) || taxId.includes(lowKey) || staff.includes(lowKey);
                    });
                }

                if (filteredData.length === 0) {
                    listEl.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted">查無資料</td></tr>';
                    return;
                }

                listEl.innerHTML = filteredData.map(item => {
                    const compName = item.workplaces?.companies?.name || '未知公司';
                    const taxId = item.workplaces?.companies?.tax_id || '';
                    const consultant = item.medical_staff?.name || '未知顧問';
                    const badge = item.is_special_case 
                        ? '<span class="badge bg-warning text-dark border border-warning">特案結案</span>' 
                        : '<span class="badge bg-success border border-success">標準結案</span>';

                    return `
                        <tr>
                            <td class="ps-4 fw-bold font-monospace">${item.visit_date}</td>
                            <td>
                                <div class="fw-bold text-dark">${compName}</div>
                                <div class="small text-muted"><i class="fas fa-id-card me-1"></i>${taxId}</div>
                            </td>
                            <td>${consultant}</td>
                            <td><span class="badge bg-light text-secondary border">${item.execution_items || '一般訪視'}</span></td>
                            <td class="text-truncate" style="max-width: 200px;" title="${item.audit_note || ''}">${item.audit_note || '-'}</td>
                            <td class="text-end pe-4">
                                <button class="btn btn-outline-primary btn-sm fw-bold" onclick="openEvidenceDetail('${item.id}')">
                                    <i class="fas fa-external-link-alt me-1"></i>檢視
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (e) {
                console.error(e);
                listEl.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-danger">資料載入失敗</td></tr>';
            }
        }

        // ==========================================
        // 3. 核心功能：開啟新分頁預覽 (改寫版)
        // ==========================================
        async function openEvidenceDetail(id) {
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 載入中...';
            btn.disabled = true;

            try {
                // 1. 取得完整資料 (包含 additional_appendices)
                const { data: record, error } = await supabaseClient
                    .from('evidence')
                    .select(`
                        *,
                        workplaces ( companies ( name, tax_id, address ) ),
                        medical_staff ( name )
                    `)
                    .eq('id', id)
                    .single();

                if (error) throw error;

                // 2. 處理主證據 PDF 連結 (Signed URL)
                let mainPdfUrl = '';
                if (record.file_url) {
                    const { data: signedData, error: signError } = await supabaseClient
                        .storage
                        .from('evidence')
                        .createSignedUrl(record.file_url, 3600); // 1小時有效
                    
                    if (!signError) mainPdfUrl = signedData.signedUrl;
                }

                // 3. 處理其他附件 (additional_appendices)
                // 從 index2 寫入時已經是 JSON 格式的 [{name, url}, ...]
                let attachmentsHtml = '';
                let rawAppendices = record.additional_appendices;
                
                // 防呆：如果是字串就 parse，如果是 null 就給空陣列
                if (typeof rawAppendices === 'string') {
                    try { rawAppendices = JSON.parse(rawAppendices); } catch(e) { rawAppendices = []; }
                }
                if (!Array.isArray(rawAppendices)) rawAppendices = [];

                if (rawAppendices.length > 0) {
                    const links = rawAppendices.map(file => {
                        // file.url 已經是 Public URL (由 index2 生成)
                        return `
                            <a href="${file.url}" target="_blank" class="d-flex align-items-center p-2 mb-2 border rounded text-decoration-none bg-light hover-shadow">
                                <i class="fas fa-paperclip text-secondary me-3"></i>
                                <div class="text-truncate" style="max-width: 90%;">
                                    <div class="fw-bold text-dark small">${file.name}</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">點擊開啟附件</div>
                                </div>
                            </a>
                        `;
                    }).join('');

                    attachmentsHtml = `
                        <div class="mt-4 p-3 bg-white border rounded shadow-sm">
                            <h6 class="fw-bold text-secondary mb-3 border-bottom pb-2">
                                <i class="fas fa-folder-open me-2"></i>其他相關附件
                            </h6>
                            <div class="attachment-list">
                                ${links}
                            </div>
                        </div>
                    `;
                } else {
                    attachmentsHtml = `
                        <div class="mt-4 p-3 bg-light border rounded text-center text-muted small">
                            <i class="fas fa-folder-open me-1"></i> 無其他附件
                        </div>
                    `;
                }

                // 4. 開啟新分頁並寫入內容
                const newWin = window.open('', '_blank');
                if (!newWin) {
                    alert('瀏覽器阻擋了彈跳視窗，請允許開啟。');
                    return;
                }

                // 準備 5W1H 資料
                const compName = record.workplaces?.companies?.name || '-';
                const taxId = record.workplaces?.companies?.tax_id || '-';
                const consultant = record.medical_staff?.name || '-';
                const visitDate = record.visit_date || '-';
                const timeRange = (record.start_time && record.end_time) ? `${record.start_time} ~ ${record.end_time}` : '-';
                const items = record.execution_items || '-';
                const auditNote = record.audit_note || '無';
                const auditBadge = record.is_special_case 
                    ? '<span style="background:#ffc107; padding:2px 8px; border-radius:4px; font-size:0.8rem;">特案結案</span>' 
                    : '<span style="background:#198754; color:white; padding:2px 8px; border-radius:4px; font-size:0.8rem;">標準結案</span>';

                // PDF 區塊內容
                const pdfContent = mainPdfUrl 
                    ? `<iframe src="${mainPdfUrl}#toolbar=0" style="width:100%; height:100%; border:none;"></iframe>`
                    : `<div style="display:flex; align-items:center; justify-content:center; height:100%; background:#e9ecef; color:#6c757d; flex-direction:column;">
                        <div style="font-size:3rem; margin-bottom:1rem;"><i class="fas fa-file-pdf"></i></div>
                        <h4>無證據檔案</h4>
                        <p>此紀錄未包含合併後的 PDF 證據檔</p>
                       </div>`;

                const pageContent = `
                    <!DOCTYPE html>
                    <html lang="zh-TW">
                    <head>
                        <meta charset="UTF-8">
                        <title>紀錄詳情: ${compName} (${visitDate})</title>
                        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
                        <style>
                            html, body { height: 100%; margin: 0; overflow: hidden; }
                            .left-panel { width: 25%; height: 100%; overflow-y: auto; background: #f8f9fa; border-right: 1px solid #dee2e6; }
                            .right-panel { width: 75%; height: 100%; background: #525659; }
                            .detail-item { margin-bottom: 1.5rem; }
                            .detail-label { font-size: 0.85rem; font-weight: bold; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem; }
                            .detail-value { font-size: 1rem; font-weight: 500; color: #212529; word-break: break-all; }
                            .hover-shadow:hover { box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.2s; }
                        </style>
                    </head>
                    <body>
                        <div class="d-flex h-100">
                            <div class="left-panel p-4">
                                <h4 class="fw-bold mb-4 border-bottom pb-3 text-primary">
                                    <i class="fas fa-info-circle me-2"></i>執行細節
                                </h4>
                                
                                <div class="detail-item">
                                    <div class="detail-label">Who (執行對象/人員)</div>
                                    <div class="detail-value">
                                        <div>${compName} <span class="text-muted small">(${taxId})</span></div>
                                        <div class="mt-1"><i class="fas fa-user-md me-1 text-secondary"></i> 顧問: ${consultant}</div>
                                    </div>
                                </div>

                                <div class="detail-item">
                                    <div class="detail-label">When (執行時間)</div>
                                    <div class="detail-value">
                                        <div><i class="far fa-calendar-alt me-1"></i> ${visitDate}</div>
                                        <div class="small text-muted ps-4">${timeRange}</div>
                                    </div>
                                </div>

                                <div class="detail-item">
                                    <div class="detail-label">What (執行項目)</div>
                                    <div class="detail-value text-primary fw-bold">${items}</div>
                                    
                                    ${attachmentsHtml}
                                </div>

                                <div class="detail-item mt-4">
                                    <div class="detail-label">Audit Note (核定備註)</div>
                                    <div class="detail-value">
                                        <div class="mb-2">${auditBadge}</div>
                                        <div class="p-2 bg-white border rounded small text-secondary">
                                            ${auditNote}
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-5 text-center text-muted small">
                                    OHSMS Digital Evidence<br>UUID: ${id}
                                </div>
                            </div>

                            <div class="right-panel">
                                ${pdfContent}
                            </div>
                        </div>
                    </body>
                    </html>
                `;

                newWin.document.write(pageContent);
                newWin.document.close(); // 重要：確保瀏覽器停止載入並渲染

            } catch (err) {
                console.error(err);
                alert('開啟失敗: ' + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
