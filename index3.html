<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>評鑑支援 AI 智慧助理 | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
<style>
    /* =========================================
       1. 核心配色 (對應 Dashboard Eval - 黃色/Warning)
       ========================================= */
    :root { 
        --primary-bg: #f8f9fa; 
        --theme-color: #ffc107; /* Bootstrap Warning Yellow */
        --theme-dark: #b08d00;  /* 深琥珀色 (用於文字/按鈕以確保對比度) */
        --theme-light: #fff3cd; /* 淺黃色背景 */
        --theme-hover: #ffca2c; /* 按鈕互動色 */
    }

    body { 
        background-color: var(--primary-bg); 
        font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; 
        color: #333; 
    }
    
    /* 標題飾條 */
    .section-title { border-left: 5px solid var(--theme-color); padding-left: 15px; margin-bottom: 20px; }

    /* =========================================
       2. 擬真文件 (Paper Sheet) 風格
       ========================================= */
    .paper-sheet {
        background: white;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        padding: 40px;
        min-height: 800px;
        position: relative;
        overflow: hidden; /* 確保浮水印不溢出 */
        border-radius: 4px;
    }

    /* 浮水印 (Watermark) */
    .watermark {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%) rotate(-30deg);
        font-size: 8rem;
        color: rgba(0, 0, 0, 0.03);
        font-weight: bold;
        pointer-events: none;
        white-space: nowrap;
        z-index: 0;
    }

    /* 審核資訊區塊 (保持您原有的樣式) */
    .audit-stamp-box {
        background-color: #f8f9fa;
        border: 1px dashed #ccc;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        position: relative;
    }
    .audit-badge {
        position: absolute;
        top: -10px;
        right: 15px;
        background: white;
        padding: 0 10px;
        font-weight: bold;
        color: var(--theme-dark);
        border: 1px solid #ccc;
        border-radius: 20px;
        font-size: 0.85rem;
    }

    /* 附件列表樣式 */
    .attachment-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
        transition: background 0.2s;
    }
    .attachment-item:hover { background-color: #fafafa; }
    .attachment-icon { width: 40px; text-align: center; color: #6c757d; font-size: 1.2rem; }
    
    /* PDF 預覽框 */
    .pdf-frame {
        width: 100%;
        height: 800px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background-color: #525659; /* PDF Viewer Background */
    }
</style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3 mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="dashboard.html"><i class="fas fa-shield-alt me-2"></i>OHSMS 評鑑支援系統</a>
            <div class="d-flex align-items-center">
                <span class="text-light me-3" id="user-display"></span>
                <a href="dashboard.html" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left me-1"></i> 返回儀表板</a>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="section-title">
            <h4 class="fw-bold text-dark mb-0">歷史紀錄調閱 (Evaluation)</h4>
            <small class="text-muted">調閱已核定之正式服務紀錄與佐證資料</small>
        </div>

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">年度</label>
                        <select class="form-select" id="search-year">
                            <option value="2026">2026</option>
                            <option value="2025" selected>2025</option>
                            <option value="2024">2024</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">公司名稱或統編</label>
                        <input type="text" class="form-control" id="search-keyword" placeholder="輸入關鍵字...">
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-warning text-dark fw-bold w-100" onclick="searchEvidence()">
                            <i class="fas fa-search me-2"></i> 調閱紀錄
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="paper-container">
            <div class="text-center text-muted py-5">
                <i class="fas fa-archive fa-3x mb-3 text-secondary opacity-25"></i>
                <p>請輸入條件進行調閱</p>
            </div>
        </div>
    </div>

    <div class="modal fade" id="selectRecordModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title fw-bold text-dark"><i class="fas fa-list-ul me-2"></i>請選擇要調閱的紀錄</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="list-group list-group-flush" id="record-list-group">
                        </div>
                </div>
                <div class="modal-footer bg-light">
                    <small class="text-muted ms-auto">共找到 <span id="record-count">0</span> 筆資料</small>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        document.addEventListener('DOMContentLoaded', () => {
            const role = sessionStorage.getItem('currentUserRole') || 'User';
            const name = sessionStorage.getItem('currentUserName') || 'Guest';
            document.getElementById('user-display').innerText = `${role}: ${name}`;
        });

        // ===========================================
        // 1. 搜尋邏輯 (修改：改查 service_records 正式表)
        // ===========================================
        async function searchEvidence() {
            const year = document.getElementById('search-year').value;
            const keyword = document.getElementById('search-keyword').value.trim();
            const container = document.getElementById('paper-container');

            if (!keyword) return alert('請輸入公司名稱或統編');

            container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-warning"></div><p class="mt-2 text-muted">正在自加密儲存庫調閱...</p></div>';

            try {
                // 關聯查詢：Service Records -> Workplaces -> Companies
                let query = supabaseClient
                    .from('service_records')
                    .select(`
                        *,
                        workplaces!inner (
                            companies!inner ( name, tax_id )
                        )
                    `)
                    .eq('service_year', year)
                    .order('visit_date', { ascending: false });

                // 判斷是統編還是名稱
                if (/^\d{8}$/.test(keyword)) {
                    query = query.eq('workplaces.companies.tax_id', keyword);
                } else {
                    query = query.ilike('workplaces.companies.name', `%${keyword}%`);
                }

                const { data, error } = await query;
                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = `<div class="text-center text-muted py-5"><i class="fas fa-times-circle fa-3x mb-3"></i><p>查無 ${year} 年度符合「${keyword}」的正式紀錄。</p></div>`;
                    return;
                }

                // ★ 分流：單筆直接顯示，多筆跳 Modal
                if (data.length === 1) {
                    renderPaperSheet(data[0]);
                } else {
                    showSelectionModal(data);
                }

            } catch (err) {
                console.error(err);
                container.innerHTML = `<div class="alert alert-danger">系統錯誤: ${err.message}</div>`;
            }
        }

        // ===========================================
        // 2. 多筆選擇視窗 (功能新增)
        // ===========================================
        function showSelectionModal(records) {
            const listGroup = document.getElementById('record-list-group');
            document.getElementById('record-count').innerText = records.length;
            
            listGroup.innerHTML = records.map(rec => {
                // 判斷是否為特案
                const typeLabel = rec.is_special_case ? 
                    '<span class="badge bg-warning text-dark border border-dark">特案</span>' : 
                    '<span class="badge bg-success">標準</span>';
                
                return `
                <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3" onclick="selectRecord('${rec.id}')">
                    <div>
                        <div class="fw-bold">${rec.workplaces.companies.name}</div>
                        <div class="small text-muted">
                            <i class="far fa-calendar-alt me-1"></i> 訪視日期：${rec.visit_date}
                        </div>
                    </div>
                    <div class="text-end">
                        ${typeLabel}
                        <div class="small text-muted mt-1"><i class="fas fa-chevron-right"></i></div>
                    </div>
                </button>
                `;
            }).join('');

            // 把 records 暫存起來供 click 使用
            window.tempRecords = records;
            new bootstrap.Modal(document.getElementById('selectRecordModal')).show();
        }

        function selectRecord(id) {
            const record = window.tempRecords.find(r => r.id === id);
            if (record) {
                renderPaperSheet(record);
                bootstrap.Modal.getInstance(document.getElementById('selectRecordModal')).hide();
            }
        }

        // ===========================================
        // 3. 渲染文件 (Paper Sheet) - 核心修正區
        // ===========================================
        async function renderPaperSheet(record) {
            const container = document.getElementById('paper-container');
            const companyName = record.workplaces.companies.name;
            const year = record.service_year;
            
            // ★ 關鍵修正：取得 folderId (這是 Staging 的 ID)
            const folderId = record.attachment_folder_id; 

            // 1. 取得審核者名稱 (從 created_by 或另外存的欄位，這裡假設用系統管理員或從 Profile 抓)
            let reviewerName = '系統管理員'; 
            // 註：若 service_records 有存 reviewer_id 可再這裡 fetch profile

            // 2. 構建審核資訊 HTML (帶入 index2 留下的資料)
            // 使用 created_at 當作核定時間 (因為 insert 是在核定當下發生的)
            const auditTime = new Date(record.created_at).toLocaleString('zh-TW', { hour12: false });
            
            // 判斷類型與樣式
            const auditTypeBadge = record.is_special_case 
                ? `<span class="badge bg-warning text-dark border border-dark"><i class="fas fa-exclamation-triangle me-1"></i>特案允許結案</span>` 
                : `<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>標準核定結案</span>`;
            
            // 帶出 index2 填寫的備註
            const auditNote = record.audit_note || '<span class="text-muted">無審核備註</span>';

            // 3. 準備檔案連結路徑
            // A. 正式證據 PDF (位於 service-records bucket)
            const evidencePath = `${year}/${folderId}/Final_Evidence_Merged.pdf`; // 假設 index2 上傳時檔名固定，或需用 list 找
            // 若 index2 加上了 timestamp，這裡可能需要先 list service-records 找檔案
            // 為了簡化，這裡先嘗試抓取 index2 最新邏輯的檔名規則
            // 如果 index2 存檔名有 timestamp，我們需要 list
            let finalPdfUrl = '';
            
            const { data: srFiles } = await supabaseClient.storage.from('service-records').list(`${year}/${folderId}`);
            if (srFiles && srFiles.length > 0) {
                // 找出最新的 PDF
                const evidenceFile = srFiles.find(f => f.name.includes('Evidence_Final') && f.name.endsWith('.pdf')) || srFiles[0];
                if (evidenceFile) {
                    const { data } = supabaseClient.storage.from('service-records').getPublicUrl(`${year}/${folderId}/${evidenceFile.name}`);
                    finalPdfUrl = data.publicUrl;
                }
            }

            // B. 原始附件 (位於 staging bucket)
            let attachmentsHtml = '';
            const { data: rawFiles } = await supabaseClient.storage.from('staging').list(folderId);
            
            if (rawFiles && rawFiles.length > 0) {
                // 過濾掉 PDF (因為已合併)，只顯示圖片/影音
                const otherFiles = rawFiles.filter(f => !f.name.toLowerCase().endsWith('.pdf') && f.name !== '.emptyFolderPlaceholder');
                
                if (otherFiles.length > 0) {
                    const links = await Promise.all(otherFiles.map(async f => {
                        const { data } = supabaseClient.storage.from('staging').getPublicUrl(`${folderId}/${f.name}`);
                        return `
                            <a href="${data.publicUrl}" target="_blank" class="btn btn-outline-secondary btn-sm mb-2 me-2">
                                <i class="fas fa-paperclip me-1"></i> ${f.name}
                            </a>
                        `;
                    }));
                    attachmentsHtml = `<div class="mt-3 p-3 bg-light rounded border"><h6 class="small fw-bold text-muted mb-2">原始附件 (圖片/影音)：</h6>${links.join('')}</div>`;
                }
            }

            // PDF 預覽區塊 (若無 PDF 則顯示提示)
            const pdfViewerHtml = finalPdfUrl 
                ? `<iframe src="${finalPdfUrl}#toolbar=0&navpanes=0" class="pdf-frame"></iframe>
                   <div class="text-end mt-2">
                        <a href="${finalPdfUrl}" download="Evidence_${year}_${companyName}.pdf" class="btn btn-sm btn-dark">
                            <i class="fas fa-download me-1"></i> 下載完整證據包
                        </a>
                   </div>`
                : `<div class="alert alert-warning text-center py-5">
                        <i class="fas fa-file-pdf fa-3x mb-3"></i>
                        <h5>尚無正式憑證 PDF</h5>
                        <p>可能僅包含圖片附件，請查看下方原始附件區。</p>
                   </div>`;

            // 4. 渲染 HTML (保留 Paper Sheet 結構)
            container.innerHTML = `
                <div class="paper-sheet animate__animated animate__fadeInUp">
                    <div class="watermark">${companyName}</div>
                    
                    <div class="d-flex justify-content-between align-items-start border-bottom pb-3 mb-4">
                        <div>
                            <h2 class="fw-bold text-dark mb-1"><i class="fas fa-file-contract me-2 text-warning"></i>服務執行紀錄憑證</h2>
                            <div class="text-muted">
                                <span class="me-3"><i class="fas fa-building me-1"></i>${companyName}</span>
                                <span class="me-3"><i class="fas fa-calendar-day me-1"></i>訪視日期：${record.visit_date}</span>
                                <span><i class="fas fa-tag me-1"></i>年度：${year}</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=${encodeURIComponent(record.id)}" alt="QR" class="border p-1">
                            <div class="small text-muted mt-1 font-monospace">${record.id.substring(0,8)}...</div>
                        </div>
                    </div>

                    <div class="audit-stamp-box">
                        <div class="audit-badge">Audit Log</div>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <small class="text-muted d-block">審核人員</small>
                                <strong>${reviewerName}</strong>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted d-block">核定時間</small>
                                <span class="font-monospace">${auditTime}</span>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted d-block">核定類型</small>
                                ${auditTypeBadge}
                            </div>
                            <div class="col-md-12 border-top pt-2 mt-2">
                                <small class="text-muted d-block">審核意見 / 備註</small>
                                <div class="text-dark bg-white p-2 rounded border border-light">${auditNote}</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <h5 class="fw-bold text-dark border-start border-4 border-warning ps-2 mb-3">正式評鑑證據 (PDF)</h5>
                        ${pdfViewerHtml}
                    </div>

                    ${attachmentsHtml}

                    <div class="text-center mt-5 text-muted small border-top pt-3">
                        <i class="fas fa-shield-alt me-1"></i> OHSMS Secure Audit Trail System | Evidence ID: ${record.id}
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
