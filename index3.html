<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>評鑑支援 AI 智慧助理 | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
<style>
    /* =========================================
       1. 核心配色 (Evaluation - Warning/Yellow)
       ========================================= */
    :root { 
        --primary-bg: #f8f9fa; 
        --theme-color: #ffc107; 
        --theme-dark: #b08d00;
        --theme-light: #fff3cd;
    }

    body { 
        background-color: var(--primary-bg); 
        font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; 
        color: #333; 
    }
    
    .container { max-width: 100% !important; padding: 2rem; }
    .main-content { max-width: 1000px; margin: 0 auto; }

    /* Navbar */
    .navbar { background-color: #202124 !important; height: 65px; }
    .btn-back-dashboard {
        border: 1px solid rgba(255,255,255,0.8);
        color: #fff; background: transparent; padding: 5px 15px;
        border-radius: 4px; text-decoration: none; transition: all 0.3s;
    }
    .btn-back-dashboard:hover { background: rgba(255,255,255,0.1); color: #fff; }

    /* Search Box */
    .search-box-wrapper {
        background: #fff; border: 1px solid #dfe1e5; border-radius: 50px;
        padding: 15px 30px; box-shadow: 0 4px 12px rgba(32,33,36,.15);
        display: flex; align-items: center; transition: box-shadow 0.3s;
        max-width: 800px; margin: 0 auto 40px auto;
    }
    .search-box-wrapper:focus-within {
        box-shadow: 0 6px 16px rgba(255, 193, 7, 0.25); border-color: var(--theme-color);
    }
    .search-input { border: none; outline: none; width: 100%; font-size: 1.2rem; margin-left: 15px; color: #555; }
    .btn-search { background: none; border: none; color: var(--theme-dark); font-weight: bold; font-size: 1.1rem; }

    /* --- 新版結果卡片 (公司歸戶樣式) --- */
    .company-group-card {
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 25px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        transition: transform 0.2s;
    }
    .company-group-card:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    .company-header {
        padding: 15px 20px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(to right, #fff, #fdfbf7);
        border-left: 5px solid var(--theme-color);
    }
    .company-title { font-size: 1.3rem; font-weight: 700; color: #202124; margin: 0; }
    .company-tax { color: #666; font-size: 0.9rem; margin-left: 10px; background: #f1f3f4; padding: 2px 8px; border-radius: 4px; }
    
    /* 內部列表 */
    .record-list { list-style: none; padding: 0; margin: 0; }
    .record-item {
        padding: 15px 20px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s;
    }
    .record-item:last-child { border-bottom: none; }
    .record-item:hover { background-color: #fafafa; }
    
    .record-info-main { font-weight: 600; font-size: 1.05rem; color: #333; }
    .record-info-sub { font-size: 0.85rem; color: #888; display: block; margin-top: 2px; }
    
    /* 標籤樣式 */
    .tag-special { background: #fff3cd; color: #856404; font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px; border: 1px solid #ffeeba; }
    .tag-consultant-match { background: #e8f0fe; color: #1967d2; font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px; border: 1px solid #aecbfa; }

    .btn-view-report {
        font-size: 0.9rem; padding: 6px 15px; border-radius: 20px;
        background-color: #fff; color: #198754; border: 1px solid #198754;
        transition: all 0.2s;
        white-space: nowrap;
    }
    .btn-view-report:hover { background-color: #198754; color: #fff; }

</style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark px-4">
        <div class="container-fluid d-flex justify-content-between align-items-center p-0">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="fas fa-shield-alt me-2"></i>OHSMS 職安管理系統
            </a>
            <div class="d-flex align-items-center">
                <span class="text-white me-4" id="user-display">Hi ! 使用者</span>
                <a href="dashboard.html" class="btn-back-dashboard"><i class="fas fa-arrow-left me-2"></i>返回儀表板</a>
            </div>
        </div>
    </nav>

    <div class="container main-content">
        <div class="text-center mb-5 mt-4">
            <h2 class="fw-bold text-dark"><i class="fas fa-robot text-warning me-2"></i>評鑑資料調閱助手</h2>
            <p class="text-muted">全域整合搜尋：輸入公司名稱、統編或顧問姓名，系統將自動關聯並歸戶顯示。</p>
        </div>

        <div class="search-box-wrapper">
            <i class="fas fa-search text-muted fs-5"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="輸入關鍵字 (例如：林)..." autofocus>
            <button class="btn-search" onclick="executeSearch()">搜尋</button>
        </div>

        <div id="loading" class="text-center my-5" style="display:none;">
            <div class="spinner-border text-warning"></div><br><span class="text-muted">AI 正在掃描全站卷宗...</span>
        </div>
        
        <div id="resultsArea"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const TARGET_BUCKET = 'service-records';

        document.addEventListener('DOMContentLoaded', () => {
            const userName = sessionStorage.getItem('currentUserName') || '使用者';
            document.getElementById('user-display').innerText = `Hi ! ${userName}`;
        });

        document.getElementById('searchInput').addEventListener('keyup', (e) => { if(e.key === 'Enter') executeSearch(); });

        // ==========================================
        // 1. 全域搜尋與歸戶邏輯 (Omni-Search)
        // ==========================================
        async function executeSearch() {
            const query = document.getElementById('searchInput').value.trim();
            const container = document.getElementById('resultsArea');
            const loader = document.getElementById('loading');
            
            if(!query) return alert("請輸入搜尋關鍵字");
            container.innerHTML = '';
            loader.style.display = 'block';

            try {
                // 1. 撈取 100 筆最新資料 (含所有關聯欄位)
                // 為了達到「顧問」與「公司」同時搜尋，我們撈出資料後在前端進行雙重過濾
                const { data, error } = await supabaseClient
                    .from('service_records')
                    .select(`
                        id, visit_date, service_year,
                        attachment_folder_id, attachment_files,
                        is_special_case, audit_note,
                        created_by, created_at,
                        medical_staff (name, email), 
                        workplaces!inner (
                            id, department_name,
                            companies!inner (name, tax_id)
                        )
                    `)
                    .order('visit_date', { ascending: false })
                    .limit(100);

                if(error) throw error;

                const lowerQuery = query.toLowerCase();

                // 2. 雙重過濾 (Filter Logic)
                const filtered = data.filter(r => {
                    const compName = r.workplaces?.companies?.name || '';
                    const taxId = r.workplaces?.companies?.tax_id || '';
                    const consultantName = r.medical_staff?.name || '';
                    const consultantEmail = r.medical_staff?.email || '';
                    
                    // 只要「公司名」OR「統編」OR「顧問名」OR「顧問Email」有符合，就納入結果
                    return compName.toLowerCase().includes(lowerQuery) || 
                           taxId.includes(lowerQuery) ||
                           consultantName.toLowerCase().includes(lowerQuery) ||
                           consultantEmail.toLowerCase().includes(lowerQuery);
                });

                loader.style.display = 'none';
                
                if(filtered.length === 0) {
                    container.innerHTML = `<div class="text-center text-muted mt-4"><i class="fas fa-file-excel fa-3x mb-3"></i><br>查無符合「${query}」的公司或顧問紀錄</div>`;
                    return;
                }

                // 3. 資料歸戶 (Grouping by Tax ID) - 確保同一家公司顯示在一起
                const groupedData = {};

                filtered.forEach(rec => {
                    const taxId = rec.workplaces.companies.tax_id || 'UNKNOWN';
                    const compName = rec.workplaces.companies.name || '未知公司';
                    
                    if (!groupedData[taxId]) {
                        groupedData[taxId] = {
                            name: compName,
                            taxId: taxId,
                            records: []
                        };
                    }
                    groupedData[taxId].records.push(rec);
                });

                // 4. 渲染 UI
                const htmlOutput = Object.values(groupedData).map(group => {
                    
                    const recordRows = group.records.map(rec => {
                        const consultant = rec.medical_staff?.name || '未知顧問';
                        const isSpecial = rec.is_special_case;
                        const date = rec.visit_date || '未定';
                        
                        // 判斷是否為顧問匹配 (用於 UI 標示)
                        const isConsultantMatch = consultant.toLowerCase().includes(lowerQuery);
                        
                        // 編碼整筆資料傳遞
                        const recordJson = encodeURIComponent(JSON.stringify(rec));
                        const companyEnc = encodeURIComponent(group.name);

                        return `
                            <li class="record-item">
                                <div>
                                    <div class="record-info-main">
                                        ${rec.service_year} 年度訪視
                                        ${isSpecial ? '<span class="tag-special">特案結案</span>' : ''}
                                    </div>
                                    <span class="record-info-sub">
                                        <i class="far fa-calendar-alt me-1"></i>${date} &nbsp;|&nbsp; 
                                        <i class="fas fa-user-md me-1"></i>
                                        <span class="${isConsultantMatch ? 'fw-bold text-primary' : ''}">${consultant}</span>
                                        ${isConsultantMatch ? '<span class="tag-consultant-match"><i class="fas fa-check me-1"></i>關鍵字命中</span>' : ''}
                                    </span>
                                </div>
                                <button class="btn-view-report" onclick="openFullReport('${recordJson}', '${companyEnc}')">
                                    <i class="fas fa-folder-open me-1"></i>調閱卷宗
                                </button>
                            </li>
                        `;
                    }).join('');

                    return `
                        <div class="company-group-card">
                            <div class="company-header">
                                <div>
                                    <span class="company-title">${group.name}</span>
                                    <span class="company-tax">統編：${group.taxId}</span>
                                </div>
                                <div class="text-muted small"><i class="fas fa-layer-group me-1"></i>共 ${group.records.length} 筆相關紀錄</div>
                            </div>
                            <ul class="record-list">
                                ${recordRows}
                            </ul>
                        </div>
                    `;
                }).join('');

                container.innerHTML = htmlOutput;

            } catch (err) {
                loader.style.display = 'none';
                console.error(err);
                container.innerHTML = `<div class="alert alert-danger">資料讀取錯誤: ${err.message}</div>`;
            }
        }

        // ==========================================
        // 2. 開啟報表 (包含連結解析與檔案調閱)
        // ==========================================
        async function openFullReport(recordJson, companyEnc) {
            const rec = JSON.parse(decodeURIComponent(recordJson));
            const companyName = decodeURIComponent(companyEnc);
            
            const newWin = window.open('', '_blank');
            if(!newWin) return alert('請允許開啟彈跳視窗');

            newWin.document.write(`
                <html><head><title>調閱中...</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    body { display: flex; height: 100vh; justify-content: center; align-items: center; background: #f8f9fa; flex-direction: column; }
                </style>
                </head><body>
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3 text-muted">正在還原當時上傳之連結與檔案...</p>
                </body></html>
            `);

            try {
                // A. 取得審核者
                let reviewerName = '系統自動/未知';
                if(rec.created_by) {
                    const { data: profile } = await supabaseClient.from('profiles').select('full_name').eq('id', rec.created_by).single();
                    if(profile) reviewerName = profile.full_name;
                }

                // B. 解析 JSON 欄位中的「外部連結」與「原始附件」
                let linksHtml = '';
                let rawAttachments = rec.attachment_files;
                
                // 嘗試解析 JSON (相容舊資料可能為字串的情況)
                if (typeof rawAttachments === 'string') {
                    try { rawAttachments = JSON.parse(rawAttachments); } catch(e) {}
                }

                if (Array.isArray(rawAttachments) && rawAttachments.length > 0) {
                    const linkItems = rawAttachments.map(item => {
                        let linkUrl = '';
                        let linkName = '未命名附件';

                        // 相容不同結構
                        if (typeof item === 'string') {
                            linkUrl = item;
                            linkName = item.split('/').pop();
                        } else if (typeof item === 'object') {
                            linkUrl = item.link || item.url || item.path || '';
                            linkName = item.name || item.fileName || '附件資料';
                        }

                        // 判斷顯示方式
                        if (linkUrl && (linkUrl.startsWith('http') || linkUrl.startsWith('https'))) {
                            return `
                                <a href="${linkUrl}" target="_blank" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    <div><i class="fas fa-link text-primary me-2"></i><span class="fw-bold text-primary">${linkName}</span></div>
                                    <span class="badge bg-primary rounded-pill"><i class="fas fa-external-link-alt me-1"></i>點擊開啟</span>
                                </a>
                            `;
                        } else {
                            // 只有檔名沒有連結 (可能是尚未實作上傳時的紀錄)
                            return `
                                <div class="list-group-item d-flex justify-content-between align-items-center bg-light">
                                    <div><i class="fas fa-file text-secondary me-2"></i>${linkName}</div>
                                    <small class="text-muted">僅檔名紀錄 (無連結)</small>
                                </div>
                            `;
                        }
                    }).join('');

                    if (linkItems) {
                        linksHtml = `
                            <div class="card mb-4 border-info">
                                <div class="card-header bg-info text-white fw-bold">
                                    <i class="fas fa-cloud-upload-alt me-2"></i>顧問原始提交附件與外部連結 (Original Uploads)
                                </div>
                                <div class="list-group list-group-flush">
                                    ${linkItems}
                                </div>
                            </div>
                        `;
                    }
                }

                // C. 解析 Storage 封存檔案 (Evidence)
                const folderId = rec.attachment_folder_id || rec.id;
                const storagePath = `${rec.service_year}/${folderId}`;
                
                const { data: fileList, error: storageError } = await supabaseClient
                    .storage.from(TARGET_BUCKET).list(storagePath);
                
                let archiveHtml = '';
                if(!storageError && fileList && fileList.length > 0) {
                     fileList.sort((a, b) => {
                        const aIsMain = a.name.startsWith('Evidence_Final');
                        const bIsMain = b.name.startsWith('Evidence_Final');
                        if(aIsMain && !bIsMain) return -1;
                        if(!aIsMain && bIsMain) return 1;
                        return a.name.localeCompare(b.name);
                    });

                    fileList.forEach(f => {
                        if(f.name === '.emptyFolderPlaceholder') return;
                        const { data } = supabaseClient.storage.from(TARGET_BUCKET).getPublicUrl(`${storagePath}/${f.name}`);
                        const url = data.publicUrl;
                        const isMain = f.name.startsWith('Evidence_Final');
                        
                        let content = '';
                        if(f.name.toLowerCase().endsWith('.pdf')) {
                            content = `<iframe src="${url}#toolbar=0" style="width:100%; height:600px; border:1px solid #eee;"></iframe>`;
                        } else if(f.name.match(/\.(jpg|jpeg|png)$/i)) {
                            content = `<img src="${url}" style="max-width:100%; border:1px solid #eee;">`;
                        } else {
                            content = `<div class="p-3 bg-light"><a href="${url}" target="_blank" class="btn btn-sm btn-outline-dark">下載檔案</a></div>`;
                        }

                        archiveHtml += `
                            <div class="card mb-4 shadow-sm ${isMain ? 'border-success border-2' : ''}">
                                <div class="card-header ${isMain ? 'bg-success text-white' : 'bg-light'} fw-bold d-flex justify-content-between">
                                    <span>${isMain ? '<i class="fas fa-certificate me-2"></i>正式結案稽核憑證 (Official)' : '<i class="fas fa-file-archive me-2"></i>封存附件'} : ${f.name}</span>
                                </div>
                                <div class="card-body p-0">${content}</div>
                            </div>`;
                    });
                } else {
                    archiveHtml = `<div class="alert alert-secondary text-center">此案件無 Storage 封存檔案</div>`;
                }

                // D. 產生最終 HTML
                const finalHtml = `
                    <!DOCTYPE html>
                    <html lang="zh-TW">
                    <head>
                        <title>${companyName} - 稽核卷宗</title>
                        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
                        <style>
                            body { background: #525659; font-family: 'Segoe UI', sans-serif; padding: 20px; }
                            .paper { background: white; max-width: 900px; margin: 0 auto; padding: 50px; min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.5); position: relative; }
                            .audit-meta { background: #f8f9fa; border-left: 5px solid #198754; padding: 15px; margin-bottom: 30px; }
                            .watermark { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 6rem; color: rgba(0,0,0,0.03); pointer-events: none; white-space: nowrap; z-index: 999; }
                        </style>
                    </head>
                    <body>
                        <div class="watermark">${companyName} 稽核副本</div>
                        
                        <div class="paper">
                            <h2 class="fw-bold mb-4 text-center border-bottom pb-3">${companyName} 職業衛生服務卷宗</h2>
                            
                            <div class="audit-meta">
                                <div class="row">
                                    <div class="col-md-4"><strong>訪視日期：</strong> ${rec.visit_date}</div>
                                    <div class="col-md-4"><strong>負責顧問：</strong> ${rec.medical_staff?.name || '-'}</div>
                                    <div class="col-md-4"><strong>審核人員：</strong> ${reviewerName}</div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-4"><strong>結案類型：</strong> ${rec.is_special_case ? '特案 (Special)' : '一般 (Standard)'}</div>
                                    <div class="col-md-8"><strong>結案時間：</strong> ${new Date(rec.created_at).toLocaleString()}</div>
                                </div>
                                ${rec.audit_note ? `<div class="mt-2 text-muted border-top pt-2"><small>審核備註：${rec.audit_note}</small></div>` : ''}
                            </div>

                            ${linksHtml}

                            <h5 class="fw-bold mb-3 mt-5"><i class="fas fa-folder-open me-2"></i>系統封存影像 (Archived Evidence)</h5>
                            ${archiveHtml}

                            <div class="text-center text-muted mt-5 pt-3 border-top small">
                                OHSMS Audit System | Generated at ${new Date().toLocaleString()}
                            </div>
                        </div>
                    </body>
                    </html>
                `;

                newWin.document.open();
                newWin.document.write(finalHtml);
                newWin.document.close();

            } catch(e) {
                console.error(e);
                newWin.document.body.innerHTML = `<div class="alert alert-danger m-5">讀取失敗: ${e.message}</div>`;
            }
        }
    </script>
</body>
</html>
