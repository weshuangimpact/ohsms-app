<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OHSMS 評鑑支援 AI 智慧助理 - WesmartAI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .google-logo { font-size: 2.5rem; font-weight: 500; letter-spacing: -1px; margin-bottom: 2rem; }
        .g-blue { color: #4285f4; } .g-red { color: #ea4335; } .g-yellow { color: #fbbc05; } .g-green { color: #34a853; }
        
        .search-container { max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .search-inputs .form-control, .search-inputs .form-select { border-radius: 8px; border: 1px solid #dfe1e5; padding: 0.75rem 1rem; }
        .search-inputs .form-control:focus, .search-inputs .form-select:focus { box-shadow: 0 1px 6px rgba(32,33,36,.28); border-color: transparent; }
        
        .result-card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-top: 1.5rem; overflow: hidden; }
        .table-responsive { max-height: 60vh; overflow-y: auto; }
        thead th { background-color: #f8f9fa; position: sticky; top: 0; z-index: 1; border-bottom: 2px solid #dee2e6; }
        
        /* 隱藏捲軸但保留功能 */
        .table-responsive::-webkit-scrollbar { width: 6px; height: 6px; }
        .table-responsive::-webkit-scrollbar-thumb { background-color: #ced4da; border-radius: 3px; }

        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8); z-index: 9999;
            display: none; justify-content: center; align-items: center;
        }

        .status-badge { font-size: 0.85em; padding: 0.35em 0.65em; border-radius: 4px; }
        .badge-verified { background-color: #e6f4ea; color: #137333; }
        .badge-pending { background-color: #fef7e0; color: #b06000; }

        .modal-xl { max-width: 90vw; }
        .evidence-preview-frame { width: 100%; height: 75vh; border: none; background: #f1f3f4; border-radius: 8px;}
        
        .review-history-item { border-left: 3px solid #dee2e6; padding-left: 1rem; margin-bottom: 1rem; }
        .review-history-item .timestamp { font-size: 0.8rem; color: #6c757d; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom fixed-top">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1 d-flex align-items-center">
                <i class="fas fa-shield-alt g-blue me-2"></i> WesmartAI 評鑑系統
            </span>
            <div class="d-flex align-items-center">
                <span class="me-3 text-muted" id="userCredits">讀取額度...</span>
                <span class="me-3 fw-bold" id="userName">管理者</span>
                <button class="btn btn-outline-secondary btn-sm" onclick="logout()">登出</button>
            </div>
        </div>
    </nav>

    <div id="loadingOverlay">
        <div class="spinner-border g-blue" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="container" style="margin-top: 80px; padding-bottom: 2rem;">
        
        <div class="text-center mt-5 mb-4">
            <h1 class="google-logo">
                <span class="g-blue">W</span><span class="g-red">e</span><span class="g-yellow">s</span><span class="g-blue">m</span><span class="g-green">a</span><span class="g-red">r</span><span class="g-yellow">t</span>AI
            </h1>
            <p class="text-muted">OHSMS 評鑑支援 AI 智慧助理 - 證據檢索</p>
        </div>

        <div class="search-container">
            <div class="row g-3 search-inputs">
                <div class="col-md-3">
                    <label class="form-label text-muted small mb-1">評鑑年度</label>
                    <select id="searchYear" class="form-select">
                        <option value="113">113 年度</option>
                        <option value="114" selected>114 年度</option>
                        <option value="115">115 年度</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <label class="form-label text-muted small mb-1">企業關鍵字 (名稱或統編)</label>
                    <input type="text" id="searchCompany" class="form-control" placeholder="例如：台積電 或 22099131">
                </div>
                <div class="col-md-4">
                    <label class="form-label text-muted small mb-1">負責醫護顧問</label>
                    <input type="text" id="searchConsultant" class="form-control" placeholder="例如：陳大文">
                </div>
                <div class="col-12 text-center mt-4">
                    <button class="btn btn-primary px-5 py-2 rounded-pill shadow-sm" onclick="executeSearch()" id="btnSearch">
                        <i class="fas fa-search me-2"></i>開始檢索
                    </button>
                </div>
            </div>
        </div>

        <div id="resultContainer" class="d-none">
            <div class="d-flex justify-content-between align-items-center mt-5 mb-2">
                <h5 class="text-muted mb-0">檢索結果：共找到 <span id="resultCount" class="fw-bold text-dark">0</span> 筆證據鏈結</h5>
                <button class="btn btn-sm btn-outline-success"><i class="fas fa-file-export me-1"></i>匯出評鑑報表</button>
            </div>
            
            <div class="result-card p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="evidenceTable">
                        <thead>
                            <tr>
                                <th width="12%">評鑑編號</th>
                                <th width="18%">事業單位</th>
                                <th width="15%">證據主題 (What)</th>
                                <th width="12%">執行時間 (When)</th>
                                <th width="10%">負責顧問 (Who)</th>
                                <th width="10%">狀態</th>
                                <th width="23%">評鑑操作</th>
                            </tr>
                        </thead>
                        <tbody id="evidenceBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="revisionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-warning text-dark border-0">
                    <h5 class="modal-title"><i class="fas fa-envelope me-2"></i>發送評鑑補件通知</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-light">
                    <p class="text-muted small mb-3">系統將發送以下補件內容至負責顧問的電子信箱。</p>
                    
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body">
                            <h6 class="card-title text-primary"><i class="fas fa-user-tie me-1"></i>收件顧問資訊</h6>
                            <div class="mb-1"><strong>姓名：</strong><span id="rev-consultant-name">-</span></div>
                            <div><strong>信箱：</strong><span id="rev-consultant-email" class="text-muted">-</span></div>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body">
                            <h6 class="card-title text-info"><i class="fas fa-file-alt me-1"></i>待補件證據資訊</h6>
                            <div class="mb-1"><strong>事業單位：</strong><span id="rev-workplace-name">-</span></div>
                            <div><strong>證據主題：</strong><span id="rev-evidence-topic">-</span></div>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h6 class="card-title text-danger"><i class="fas fa-exclamation-triangle me-1"></i>審查紀錄 (補件原因)</h6>
                            <div id="rev-history-list" class="mt-2" style="max-height: 150px; overflow-y: auto;">
                                </div>
                        </div>
                    </div>

                    <input type="hidden" id="rev-evidence-id">
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-warning" onclick="confirmSendRevision()" id="btnSendRevision">
                        <i class="fas fa-paper-plane me-1"></i>確認發送
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-light border-0">
                    <h5 class="modal-title"><i class="fas fa-clipboard-check text-primary me-2"></i>評鑑審查紀錄</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="reviewEvidenceId">
                    <div id="reviewHistory" class="mb-4">
                        <h6 class="text-muted mb-3">歷史審查紀錄：</h6>
                        <div id="historyList"></div>
                    </div>
                    <hr>
                    <div class="form-group">
                        <label class="form-label fw-bold">新增審查備註 (此紀錄一經儲存將不可變更)</label>
                        <textarea id="newReviewText" class="form-control" rows="3" placeholder="請輸入本次審查發現之缺失或建議..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    <button type="button" class="btn btn-primary" onclick="saveReview()"><i class="fas fa-save me-1"></i>確認存檔</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // Supabase 設定 (需填入您的實際金鑰)
        const supabaseUrl = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const supabaseKey = 'YOUR_SUPABASE_ANON_KEY'; // 在實際環境中請使用您的 KEY
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 權限檢查 (簡易版)
            const userData = sessionStorage.getItem('wesmart_user');
            if(!userData) {
                // 開發測試暫時略過導向，正式機需開啟
                // window.location.href = 'index.html'; 
            } else {
                const user = JSON.parse(userData);
                document.getElementById('userName').innerText = user.name;
                document.getElementById('userCredits').innerText = `剩餘 AI 額度: ${user.credits || '無限'}`;
            }
        });

        // 登出
        function logout() {
            sessionStorage.removeItem('wesmart_user');
            window.location.href = 'index.html';
        }

        // 顯示載入遮罩
        function toggleLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // 執行檢索
        async function executeSearch() {
            toggleLoading(true);
            const year = document.getElementById('searchYear').value;
            const companyKw = document.getElementById('searchCompany').value.trim();
            const consultantKw = document.getElementById('searchConsultant').value.trim();

            try {
                // 模擬 Supabase 複雜查詢：先撈 Evidence，再關聯 Workplaces 與 Medical_staff
                let query = supabase
                    .from('evidence')
                    .select(`
                        id,
                        evidence_topic,
                        execution_date,
                        status,
                        created_at,
                        workplaces!inner ( name, tax_id ),
                        medical_staff!inner ( name, email )
                    `)
                    .eq('evidence_year', year);

                // 若有填寫統編/名稱
                if (companyKw) {
                    query = query.or(`name.ilike.%${companyKw}%,tax_id.ilike.%${companyKw}%`, { foreignTable: 'workplaces' });
                }

                // 若有填寫顧問名稱
                if (consultantKw) {
                    query = query.ilike('medical_staff.name', `%${consultantKw}%`);
                }

                const { data, error } = await query;

                if (error) throw error;

                renderTable(data);
                
                // 顯示結果區塊
                document.getElementById('resultContainer').classList.remove('d-none');
                document.getElementById('resultCount').innerText = data.length;

            } catch (err) {
                console.error(err);
                alert('檢索發生錯誤，請檢查資料庫連線或權限。');
            } finally {
                toggleLoading(false);
            }
        }

        // 渲染表格
        function renderTable(data) {
            const tbody = document.getElementById('evidenceBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-5 text-muted"><i class="fas fa-inbox fa-3x mb-3 d-block"></i>查無符合條件之證據資料。</td></tr>`;
                return;
            }

            data.forEach(row => {
                // 狀態 Badge 轉換
                let statusBadge = '';
                if (row.status === 'verified') statusBadge = '<span class="status-badge badge-verified"><i class="fas fa-check-circle me-1"></i>已認證</span>';
                else if (row.status === 'pending') statusBadge = '<span class="status-badge badge-pending"><i class="fas fa-hourglass-half me-1"></i>待補件</span>';
                else statusBadge = `<span class="status-badge bg-secondary text-white">${row.status}</span>`;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-muted font-monospace small">${row.id.substring(0,8).toUpperCase()}</td>
                    <td class="fw-bold text-dark">${row.workplaces.name} <br><small class="text-muted fw-normal">統編: ${row.workplaces.tax_id}</small></td>
                    <td>${row.evidence_topic}</td>
                    <td>${row.execution_date}</td>
                    <td>${row.medical_staff.name}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewEvidence('${row.id}')" title="檢視"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-outline-success" onclick="openReviewModal('${row.id}')" title="審查備註"><i class="fas fa-clipboard-check"></i></button>
                            <button class="btn btn-sm btn-outline-warning" onclick="sendRevisionNotice('${row.id}')" title="補件通知"><i class="fas fa-envelope"></i> 補件</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 檢視單一證據 (另開分頁純前端預覽)
        function viewEvidence(id) {
            // 實務上會導向一個唯讀的 Evidence View 頁面
            window.open(`preview_evidence.html?id=${id}`, '_blank');
        }

        // -------------------------
        // 評鑑審查紀錄 (Modal) 邏輯
        // -------------------------
        let reviewModal;
        let revisionModal;
        
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化原有的 Review Modal
            reviewModal = new bootstrap.Modal(document.getElementById('reviewModal'));
            // 初始化新增的 Revision Modal
            revisionModal = new bootstrap.Modal(document.getElementById('revisionModal'));
        });

        async function openReviewModal(id) {
            document.getElementById('reviewEvidenceId').value = id;
            document.getElementById('newReviewText').value = '';
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div> 載入中...</div>';
            reviewModal.show();

            try {
                // 抓取現有審查紀錄 (JSONB 欄位)
                const { data, error } = await supabase
                    .from('evidence')
                    .select('evaluation_reviews')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                historyList.innerHTML = '';
                const reviews = data.evaluation_reviews || [];

                if (reviews.length === 0) {
                    historyList.innerHTML = '<span class="text-muted small">尚無審查紀錄。</span>';
                } else {
                    reviews.forEach(rev => {
                        const item = document.createElement('div');
                        item.className = 'review-history-item';
                        item.innerHTML = `
                            <div class="timestamp"><i class="far fa-clock me-1"></i>${rev.timestamp} - ${rev.reviewer}</div>
                            <div class="mt-1 text-dark">${rev.content}</div>
                        `;
                        historyList.appendChild(item);
                    });
                }
            } catch (err) {
                console.error(err);
                historyList.innerHTML = '<span class="text-danger small">讀取失敗。</span>';
            }
        }

        async function saveReview() {
            const id = document.getElementById('reviewEvidenceId').value;
            const content = document.getElementById('newReviewText').value.trim();

            if (!content) {
                alert('請輸入審查備註內容。');
                return;
            }

            toggleLoading(true);

            try {
                // 1. 先取得舊紀錄
                const { data: oldData, error: fetchErr } = await supabase
                    .from('evidence')
                    .select('evaluation_reviews')
                    .eq('id', id)
                    .single();

                if (fetchErr) throw fetchErr;

                const currentReviews = oldData.evaluation_reviews || [];

                // 2. 新增紀錄 (寫入當前時間與管理者名稱)
                const newReview = {
                    timestamp: new Date().toLocaleString('zh-TW'),
                    reviewer: JSON.parse(sessionStorage.getItem('wesmart_user'))?.name || '系統管理員',
                    content: content
                };

                currentReviews.push(newReview);

                // 3. 更新回資料庫 (一經寫入前端即不提供修改，落實不可變更原則)
                const { error: updateErr } = await supabase
                    .from('evidence')
                    .update({ evaluation_reviews: currentReviews, status: 'pending' }) // 自動改為待補件狀態
                    .eq('id', id);

                if (updateErr) throw updateErr;

                alert('審查備註已存檔，證據狀態已變更為「待補件」。');
                reviewModal.hide();
                executeSearch(); // 刷新表格狀態

            } catch (err) {
                console.error(err);
                alert('存檔失敗。');
            } finally {
                toggleLoading(false);
            }
        }

        // -------------------------
        // 評鑑補件通知 (Modal + Edge Function) 邏輯
        // -------------------------
        async function sendRevisionNotice(id) {
            toggleLoading(true);
            
            try {
                // 1. 抓取所需關聯資料 (顧問信箱、單位名稱、證據名稱、審查紀錄)
                const { data, error } = await supabase
                    .from('evidence')
                    .select(`
                        id,
                        evidence_topic,
                        evaluation_reviews,
                        workplaces!inner ( name ),
                        medical_staff!inner ( name, email )
                    `)
                    .eq('id', id)
                    .single();

                if (error) throw error;

                // 2. 填入 Modal 內容
                document.getElementById('rev-evidence-id').value = data.id;
                document.getElementById('rev-consultant-name').innerText = data.medical_staff.name;
                document.getElementById('rev-consultant-email').innerText = data.medical_staff.email;
                document.getElementById('rev-workplace-name').innerText = data.workplaces.name;
                document.getElementById('rev-evidence-topic').innerText = data.evidence_topic;

                // 3. 處理審查紀錄清單
                const historyList = document.getElementById('rev-history-list');
                historyList.innerHTML = '';
                const reviews = data.evaluation_reviews || [];
                
                if (reviews.length === 0) {
                    historyList.innerHTML = '<span class="text-muted small">此證據目前尚無填寫審查紀錄，請先填寫審查紀錄後再發送補件通知。</span>';
                    document.getElementById('btnSendRevision').disabled = true;
                } else {
                    reviews.forEach(rev => {
                        const item = document.createElement('div');
                        item.className = 'review-history-item mb-2';
                        item.innerHTML = `
                            <div class="timestamp"><i class="far fa-clock me-1"></i>${rev.timestamp}</div>
                            <div class="mt-1 text-dark fw-bold">${rev.content}</div>
                        `;
                        historyList.appendChild(item);
                    });
                    document.getElementById('btnSendRevision').disabled = false;
                }

                // 4. 開啟 Modal
                revisionModal.show();

            } catch (err) {
                console.error(err);
                alert('資料抓取失敗，無法準備補件通知。');
            } finally {
                toggleLoading(false);
            }
        }

        // 確認發送至 Edge Function
        async function confirmSendRevision() {
            const btn = document.getElementById('btnSendRevision');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>發送中...';

            // 取得當前準備好的資料
            const payload = {
                evidenceId: document.getElementById('rev-evidence-id').value,
                consultantEmail: document.getElementById('rev-consultant-email').innerText,
                consultantName: document.getElementById('rev-consultant-name').innerText,
                workplaceName: document.getElementById('rev-workplace-name').innerText,
                evidenceTopic: document.getElementById('rev-evidence-topic').innerText,
                // 抓取畫面上所有的審查文字內容
                reviews: Array.from(document.getElementById('rev-history-list').querySelectorAll('.review-history-item .text-dark')).map(el => el.innerText)
            };

            try {
                // 呼叫 Supabase Edge Function
                const response = await fetch('https://yhehfucgemxnfrdvpdhw.supabase.co/functions/v1/send-evaluation-revision', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // 若 Edge Function 有設定 Authorization Header，請在此加上 Bearer Token
                        // 'Authorization': `Bearer ${supabaseKey}` 
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error('Edge Function 回傳錯誤');
                }

                alert('補件通知已成功發送至負責顧問信箱！');
                revisionModal.hide();

            } catch (err) {
                console.error('發送失敗:', err);
                alert('信件發送失敗，請稍後再試或聯繫系統管理員。');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>確認發送';
            }
        }

    </script>
</body>
</html>
