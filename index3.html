<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è©•é‘‘æ”¯æ´ AI æ™ºæ…§åŠ©ç† | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* =========================================
           1. çµ±ä¸€é é¦–/é å°¾ CSS è¨­å®š (å…§é å°ˆç”¨ / é«˜åº¦çµ±ä¸€ç‰ˆ)
           ========================================= */
        html, body {
            height: 100%;
        }

        body {
            display: none; /* æ¬Šé™é©—è­‰å‰å…ˆéš±è—ï¼ŒJS è¼‰å…¥å¾Œæ”¹ç‚º flex */
            flex-direction: column;
            min-height: 100vh;
            background-color: #f8f9fa; /* é è¨­èƒŒæ™¯è‰² */
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            color: #333;
        }

        /* å…§å®¹å€å¡Šè‡ªå‹•æ’é–‹ */
        .container, .main-content, .container-fluid {
            flex: 1; 
        }

        /* é é¦–è¨­å®š */
        .navbar {
            background-color: #202124 !important;
            min-height: 85px; /* çµ±ä¸€é«˜åº¦ */
            color: #fff;
            flex-shrink: 0;
        }

        /* é å°¾è¨­å®š */
        footer {
            background-color: #202124 !important;
            color: #fff;
            flex-shrink: 0;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            display: flex;
            flex-direction: column; /* å‚ç›´æ’åˆ— */
            align-items: center;
            justify-content: center;
            margin-top: auto;
            padding: 15px 0;
            min-height: 85px; /* é›™è¡Œé«˜åº¦ */
        }

        /* =========================================
           2. æœ¬é ç‰¹å®šæ¨£å¼ (Chat & Search)
           ========================================= */
        .chat-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 75vh;
        }

        .chat-header {
            background: #202124;
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            max-width: 85%;
        }

        .message.user {
            align-self: flex-end;
            align-items: flex-end;
        }

        .message.bot {
            align-self: flex-start;
            align-items: flex-start;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 1rem;
            line-height: 1.5;
            position: relative;
        }

        .message.user .message-content {
            background-color: #0d6efd;
            color: white;
            border-bottom-right-radius: 2px;
        }

        .message.bot .message-content {
            background-color: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .chat-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #eee;
        }

        /* è­‰æ“šå¡ç‰‡æ¨£å¼ */
        .evidence-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .evidence-card:hover {
            border-color: #0d6efd;
            box-shadow: 0 2px 8px rgba(13, 110, 253, 0.1);
        }

        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #ccc;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .tag-badge {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 12px;
            background: #e9ecef;
            color: #555;
            margin-right: 5px;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark px-4">
        <div class="container-fluid d-flex justify-content-between align-items-center p-0">
            <a class="navbar-brand d-flex align-items-center fw-bold" href="dashboard.html">
                <i class="fas fa-shield-alt me-2"></i>
                OHSMS æ™ºæ…§åŠ©ç†
            </a>

            <div class="d-flex align-items-center">
                <span class="text-white me-3 small" id="header-date">
                    <i class="fas fa-spinner fa-spin"></i>
                </span>
                
                <span class="text-white me-4 small border-start ps-3 border-secondary" id="header-clock" style="opacity: 0.9;">
                    --:--
                </span>
                
                <span class="text-white me-4 fw-bold" id="header-user">
                    Hi! ä½¿ç”¨è€…
                </span>
                
                <a class="btn btn-outline-light btn-sm me-2" href="dashboard.html">
                    <i class="fas fa-reply me-1"></i>å›åˆ°å„€è¡¨æ¿
                </a>
                
                <button class="btn btn-outline-light btn-sm" onclick="logoutSystem()">
                    <i class="fas fa-sign-out-alt me-1"></i>ç™»å‡º
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4 py-4 main-content">
        <div class="chat-container">
            <div class="chat-header">
                <div class="d-flex align-items-center">
                    <i class="fas fa-robot fa-lg me-2 text-warning"></i>
                    <div>
                        <h6 class="mb-0 fw-bold">è©•é‘‘æ”¯æ´ AI åŠ©ç†</h6>
                        <small class="opacity-75" style="font-size: 0.75rem;">Connected to OHSMS Evidence DB</small>
                    </div>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-light" onclick="clearChat()">
                        <i class="fas fa-trash-alt me-1"></i>æ¸…é™¤å°è©±
                    </button>
                </div>
            </div>

            <div class="chat-messages" id="chat-box">
                <div class="message bot">
                    <div class="message-content">
                        <strong><i class="fas fa-info-circle me-2 text-primary"></i>ä½ å¥½ï¼æˆ‘æ˜¯æ‚¨çš„è©•é‘‘æ”¯æ´åŠ©ç†ã€‚</strong><br>
                        æˆ‘å¯ä»¥å”åŠ©æ‚¨èª¿é–±æ­·å²è­‰æ“šã€ç”¢ç”Ÿè©•é‘‘æ‘˜è¦ï¼Œæˆ–å›ç­”æ³•è¦ç›¸é—œå•é¡Œã€‚<br><br>
                        æ‚¨å¯ä»¥è©¦è‘—å•ï¼š<br>
                        <span class="badge bg-light text-dark border mt-2 cursor-pointer" onclick="setInput('åˆ—å‡ºå°ç©é›»å»å¹´çš„è¨ªè¦–ç´€éŒ„')">"åˆ—å‡ºå°ç©é›»å»å¹´çš„è¨ªè¦–ç´€éŒ„"</span><br>
                        <span class="badge bg-light text-dark border mt-1 cursor-pointer" onclick="setInput('æŸ¥è©¢å™ªéŸ³æ”¹å–„çš„ç›¸é—œè­‰æ“š')">"æŸ¥è©¢å™ªéŸ³æ”¹å–„çš„ç›¸é—œè­‰æ“š"</span>
                    </div>
                </div>
            </div>

            <div class="chat-input-area">
                <form id="chat-form" onsubmit="handleSearch(event)">
                    <div class="input-group">
                        <input type="text" class="form-control border-end-0" id="user-input" placeholder="è«‹è¼¸å…¥é—œéµå­— (å¦‚ï¼šå…¬å¸åç¨±ã€å±å®³å› å­ã€æ—¥æœŸ)..." autocomplete="off">
                        <button class="btn btn-primary px-4" type="submit">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="form-text mt-2 small text-muted">
                        <i class="fas fa-shield-alt me-1"></i> è³‡æ–™ä¾†æºï¼šæ­£å¼æ ¸å®šä¹‹è­‰æ“šåº« (Evidence Table)
                    </div>
                </form>
            </div>
        </div>
    </div>

    <footer>
        <div class="mb-1">å¯ä¿¡æ™ºæ…§æ•´åˆæœ‰é™å…¬å¸ 42917004</div>
        <div class="small opacity-75" style="font-family: 'Segoe UI', sans-serif; letter-spacing: 1px;">
            WesmartAI , Making Trust Transparent.
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ==========================================
        // çµ±ä¸€é é¦–èˆ‡ç³»çµ±åˆå§‹åŒ–
        // ==========================================
        document.addEventListener('DOMContentLoaded', function() {
            document.body.style.display = 'flex';

            // æ™‚é˜èˆ‡æ—¥æœŸ
            setInterval(() => {
                const now = new Date();
                const clockEl = document.getElementById('header-clock');
                if(clockEl) clockEl.textContent = now.toLocaleTimeString('zh-TW', { hour12: false });
            }, 1000);

            const dateEl = document.getElementById('header-date');
            if(dateEl) {
                const now = new Date();
                const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                dateEl.innerHTML = `<i class="far fa-calendar-alt me-1"></i>ä»Šæ—¥æ˜¯ ${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}(${days[now.getDay()]})`;
            }

            // ä½¿ç”¨è€…åç¨±
            const userName = sessionStorage.getItem('currentUserName') || 'è¨ªå®¢';
            const userEl = document.getElementById('header-user');
            if(userEl) userEl.innerText = `Hi! ${userName}`;
        });

        function logoutSystem() {
            if(confirm('ç¢ºå®šè¦ç™»å‡ºç³»çµ±å—ï¼Ÿ')) {
                sessionStorage.clear();
                window.location.href = 'login.html';
            }
        }

        // ==========================================
        // AI åŠ©ç†æ ¸å¿ƒé‚è¼¯
        // ==========================================
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');

        function setInput(text) {
            userInput.value = text;
            userInput.focus();
        }

        function clearChat() {
            if(confirm('ç¢ºå®šæ¸…é™¤å°è©±ç´€éŒ„ï¼Ÿ')) {
                chatBox.innerHTML = '';
                addBotMessage('å°è©±å·²æ¸…é™¤ã€‚æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«æ‚¨çš„å—ï¼Ÿ');
            }
        }

        function appendMessage(role, htmlContent) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerHTML = `<div class="message-content">${htmlContent}</div>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            return div;
        }

        function addBotMessage(content) {
            return appendMessage('bot', content);
        }

        function addUserMessage(content) {
            return appendMessage('user', content);
        }

        function showTyping() {
            const id = 'typing-' + Date.now();
            const div = document.createElement('div');
            div.className = 'message bot';
            div.id = id;
            div.innerHTML = `
                <div class="message-content">
                    <div class="typing-indicator"><span></span><span></span><span></span></div>
                </div>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            return id;
        }

        function removeTyping(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
        }

        async function handleSearch(e) {
            e.preventDefault();
            const query = userInput.value.trim();
            if(!query) return;

            addUserMessage(query);
            userInput.value = '';
            
            const typingId = showTyping();

            try {
                // æ¨¡æ“¬ AI æ€è€ƒå»¶é²
                await new Promise(r => setTimeout(r, 600));

                // æœå°‹è­‰æ“šåº« (å¾ evidence è¡¨)
                const results = await searchRecords(query);
                
                removeTyping(typingId);

                if (results.length === 0) {
                    addBotMessage(`æ‰¾ä¸åˆ°èˆ‡ "<strong>${query}</strong>" ç›¸é—œçš„æ ¸å®šè­‰æ“šã€‚<br>è«‹å˜—è©¦å…¶ä»–é—œéµå­—ï¼Œæˆ–ç¢ºèªè©²æ¡ˆä»¶æ˜¯å¦å·²å®Œæˆçµæ¡ˆç¨‹åºã€‚`);
                } else {
                    let msg = `ğŸ” æ‰¾åˆ° <strong>${results.length}</strong> ç­†ç›¸é—œè­‰æ“šï¼š<br>`;
                    results.forEach(r => {
                        const companyName = r.workplaces?.companies?.name || 'æœªçŸ¥å…¬å¸';
                        const consultant = r.medical_staff?.name || 'æœªçŸ¥é¡§å•';
                        const date = r.visit_date || r.service_date || 'æœªè¨­å®š';
                        // å˜—è©¦è§£ææ‘˜è¦
                        let summary = 'ç„¡è©³ç´°èªªæ˜';
                        if (r.process_desc) {
                             summary = r.process_desc.length > 30 ? r.process_desc.substring(0,30) + '...' : r.process_desc;
                        } else if (r.execution_items) {
                             summary = r.execution_items;
                        }

                        // åˆ¤æ–·æ˜¯å¦ç‰¹æ¡ˆ
                        const badge = r.is_special_case ? '<span class="badge bg-warning text-dark me-1">ç‰¹æ¡ˆ</span>' : '';

                        msg += `
                            <div class="evidence-card" onclick="openEvidence('${r.id}')">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <strong class="text-primary">${companyName}</strong>
                                    <small class="text-muted">${date}</small>
                                </div>
                                <div class="small mb-1"><i class="fas fa-user-md me-1"></i>${consultant} ${badge}</div>
                                <div class="text-secondary small text-truncate">${summary}</div>
                            </div>
                        `;
                    });
                    addBotMessage(msg);
                }

            } catch (err) {
                console.error(err);
                removeTyping(typingId);
                addBotMessage('âŒ ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        async function searchRecords(keyword) {
            // æ–¹æ¡ˆï¼šå…ˆæœå…¬å¸ ID
            let companyIds = [];
            if (keyword) {
                const { data: comps } = await supabaseClient.from('companies').select('id').ilike('name', `%${keyword}%`);
                if (comps) companyIds = comps.map(c => c.id);
            }
            
            // å»ºç«‹æŸ¥è©¢ (target: evidence table)
            let query = supabaseClient
                .from('evidence') 
                .select(`
                    *,
                    workplaces!inner (
                        company_id,
                        companies (name)
                    ),
                    medical_staff (name)
                `)
                .order('visit_date', { ascending: false })
                .limit(10);

            // å¦‚æœæœ‰é—œéµå­—
            if (keyword) {
                query = query.or(`audit_note.ilike.%${keyword}%,execution_items.ilike.%${keyword}%`);
            }

            const { data, error } = await query;
            
            if (error) throw error;
            
            if (keyword && data) {
                const lowerKey = keyword.toLowerCase();
                return data.sort((a, b) => {
                    const nameA = a.workplaces?.companies?.name || '';
                    const nameB = b.workplaces?.companies?.name || '';
                    const matchA = nameA.toLowerCase().includes(lowerKey);
                    const matchB = nameB.toLowerCase().includes(lowerKey);
                    return (matchB ? 1 : 0) - (matchA ? 1 : 0);
                });
            }

            return data || [];
        }

        // ä¿®æ”¹ï¼šèª¿é–± evidence è©³ç´°è³‡æ–™ (å« Paper Sheet æ¨£å¼)
        async function openEvidence(id) {
            const newWin = window.open('', '_blank');
            if(!newWin) return alert('è«‹å…è¨±é–‹å•Ÿå½ˆè·³è¦–çª—');
            
            newWin.document.write('<div style="padding:20px;">è¼‰å…¥ä¸­... <div class="spinner-border spinner-border-sm"></div></div>');

            try {
                const { data: rec, error } = await supabaseClient
                    .from('evidence')
                    .select(`
                        *,
                        workplaces (
                            companies (name, tax_id, address)
                        ),
                        medical_staff (name, email)
                    `)
                    .eq('id', id)
                    .single();

                if (error) throw error;

                // æº–å‚™æª”æ¡ˆé€£çµ
                let attachmentsHtml = '<div class="alert alert-secondary">ç„¡é™„ä»¶</div>';

                // 1. æª¢æŸ¥ Evidence_Final PDF (ä½æ–¼ storage: evidence/{year}/{id}/Evidence_Final_*.pdf)
                // â˜… ä¿®æ­£ï¼šå°‡ Bucket å¾ service-records æ”¹ç‚º evidence
                if (rec.service_year && rec.id) {
                    const path = `${rec.service_year}/${rec.id}`;
                    const { data: list } = await supabaseClient.storage.from('evidence').list(path);
                    
                    if (list && list.length > 0) {
                        const pdfs = list.filter(f => f.name.startsWith('Evidence_Final') && f.name.endsWith('.pdf'));
                        if (pdfs.length > 0) {
                            // å–æœ€æ–°çš„
                            pdfs.sort((a,b) => b.created_at.localeCompare(a.created_at));
                            const lastPdf = pdfs[0];
                            const { data: pubUrl } = supabaseClient.storage.from('evidence').getPublicUrl(`${path}/${lastPdf.name}`);
                            
                            attachmentsHtml = `
                                <div class="card mb-3 border-success">
                                    <div class="card-header bg-success text-white">
                                        <i class="fas fa-file-pdf me-2"></i>æ­£å¼çµæ¡ˆè­‰æ“š (Final Evidence)
                                    </div>
                                    <div class="card-body">
                                        <iframe src="${pubUrl.publicUrl}#toolbar=0" style="width:100%; height:600px; border:none;"></iframe>
                                    </div>
                                    <div class="card-footer bg-white text-end">
                                        <a href="${pubUrl.publicUrl}" target="_blank" class="btn btn-sm btn-success">
                                            <i class="fas fa-download me-1"></i>ä¸‹è¼‰ PDF
                                        </a>
                                    </div>
                                </div>
                            `;
                        }
                    }
                }

                const companyName = rec.workplaces?.companies?.name || 'æœªçŸ¥å…¬å¸';

                // ç”¢ç”Ÿ Paper Sheet æ¨£å¼ HTML
                const finalHtml = `
                    <!DOCTYPE html>
                    <html lang="zh-TW">
                    <head>
                        <title>è­‰æ“šèª¿é–±: ${companyName}</title>
                        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
                        <style>
                            body { background: #e9ecef; padding: 20px; font-family: 'Segoe UI', sans-serif; }
                            .paper-sheet {
                                background: white;
                                max-width: 900px;
                                margin: 0 auto;
                                padding: 40px;
                                box-shadow: 0 0 15px rgba(0,0,0,0.1);
                                position: relative;
                                overflow: hidden;
                                min-height: 80vh;
                            }
                            .watermark {
                                position: absolute;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%) rotate(-30deg);
                                font-size: 6rem;
                                color: rgba(0,0,0,0.03);
                                font-weight: bold;
                                pointer-events: none;
                                white-space: nowrap;
                                user-select: none;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="paper-sheet">
                            <div class="watermark">${companyName} åŸå§‹è³‡æ–™</div>
                            
                            <div class="border-bottom pb-3 mb-4 d-flex justify-content-between align-items-center">
                                <div>
                                    <h4 class="fw-bold text-primary mb-1"><i class="fas fa-folder-open me-2"></i>åŸå§‹ä½è­‰è³‡æ–™èª¿é–±</h4>
                                    <span class="text-muted small">Evidence ID: ${rec.id}</span>
                                </div>
                                <div class="text-end">
                                    ${rec.is_special_case 
                                        ? '<span class="badge bg-warning text-dark fs-6">ç‰¹æ¡ˆå…è¨±çµæ¡ˆ</span>' 
                                        : '<span class="badge bg-success fs-6">æ¨™æº–åˆè¦çµæ¡ˆ</span>'}
                                </div>
                            </div>

                            <div class="row g-3 mb-4">
                                <div class="col-md-4">
                                    <label class="text-muted small">äº‹æ¥­å–®ä½</label>
                                    <div class="fw-bold">${companyName}</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="text-muted small">åŸ·è¡Œé¡§å•</label>
                                    <div class="fw-bold">${rec.medical_staff?.name}</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="text-muted small">æ­¸æª”å¹´åº¦/æ—¥æœŸ</label>
                                    <div class="fw-bold">${rec.service_year} / ${rec.visit_date}</div>
                                </div>
                                <div class="col-12">
                                    <label class="text-muted small">åŸ·è¡Œäº‹é …æ‘˜è¦</label>
                                    <div class="bg-light p-2 rounded border">${rec.execution_items || 'ç„¡ç´€éŒ„'}</div>
                                </div>
                                ${rec.audit_note ? `<div class="col-12"><label class="text-muted small">å¯©æ ¸å‚™è¨»</label><div class="text-danger small">${rec.audit_note}</div></div>` : ''}
                            </div>

                            <h5 class="fw-bold mb-3 border-start border-4 border-primary ps-2">ä½è­‰é™„ä»¶ (Evidence)</h5>
                            ${attachmentsHtml}

                            <div class="text-center mt-5 text-muted small border-top pt-3">
                                <i class="fas fa-shield-alt me-1"></i> OHSMS Secure Storage Access | Generated at ${new Date().toLocaleString()}
                            </div>
                        </div>
                    </body>
                    </html>
                `;

                newWin.document.open();
                newWin.document.write(finalHtml);
                newWin.document.close();

            } catch(e) {
                console.error(e);
                newWin.document.body.innerHTML = `<div style="padding:20px; color:red;"><h3>èª¿é–±å¤±æ•—</h3><p>${e.message}</p></div>`;
            }
        }
    </script>
</body>
</html>
