<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OHSMS 職業衛生管理平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- 全局變數 & 基礎設定 --- */
        :root { 
            --primary-bg: #f8f9fa; 
            --nav-bg: #202124; 
            --google-blue: #1a73e8;
            --text-dark: #202124;
            --text-gray: #5f6368;
        }
        body { background-color: var(--primary-bg); font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; color: var(--text-dark); }
        
        /* --- 1. 統一導覽列 (Navbar) --- */
        .navbar { background-color: var(--nav-bg) !important; padding: 0.8rem 1rem; }
        .navbar-brand { font-size: 1.3rem; font-weight: 500; letter-spacing: 0.5px; }
        .nav-link { color: #bdc1c6 !important; margin: 0 10px; transition: color 0.2s; }
        .nav-link.active { color: #fff !important; font-weight: bold; border-bottom: 2px solid #fff; }
        .nav-link:hover { color: #fff !important; }

        /* --- 2. 統一卡片風格 (Universal Card) --- */
        .app-card {
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 24px;
            transition: box-shadow 0.2s, transform 0.2s;
            height: 100%;
        }
        .app-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card-stat-number { font-size: 2.5rem; font-weight: 300; color: var(--google-blue); }
        .card-stat-label { color: var(--text-gray); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

        /* --- 3. 搜尋介面 (繼承自 V1.02) --- */
        .search-hero { max-width: 800px; margin: 3rem auto 2rem; text-align: center; }
        .search-box-wrapper {
            background: #fff; border: 1px solid #dfe1e5; border-radius: 24px;
            padding: 12px 25px; box-shadow: 0 1px 6px rgba(32,33,36,.28);
            display: flex; align-items: center; transition: all 0.3s;
        }
        .search-box-wrapper:focus-within { box-shadow: 0 1px 6px rgba(32,33,36,.28), 0 2px 10px rgba(0,0,0,0.1); }
        .search-input { border: none; outline: none; width: 100%; font-size: 1.1rem; margin-left: 10px; background: transparent; }
        
        /* 結果列表樣式 */
        .result-item {
            background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px;
            margin-bottom: 15px; cursor: pointer; position: relative;
        }
        .result-item:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); border-color: #d2d2d2; }
        .tag-pill { background: #e8f0fe; color: #1967d2; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }

        /* --- 4. 統一預覽視窗 (Paper Sheet Style) --- */
        .preview-modal-body {
            background: #525659; /* 深灰閱讀背景 */
            padding: 40px;
            height: 85vh;
            overflow-y: auto;
            display: flex; flex-direction: column; align-items: center;
        }
        .paper-sheet {
            background: white; width: 100%; max-width: 850px; min-height: 1100px;
            padding: 60px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            position: relative;
        }
        .watermark {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 6rem; color: rgba(0,0,0,0.05); border: 8px solid rgba(0,0,0,0.05);
            padding: 20px; pointer-events: none; white-space: nowrap; user-select: none;
        }

        /* 附件呈現 */
        .evidence-img { max-width: 100%; border: 1px solid #ddd; padding: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* 頁面切換控制 */
        .page-section { display: none; animation: fadeIn 0.3s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="#"><i class="fas fa-shield-alt me-2"></i>OHSMS 管理平台</a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="switchPage('dashboard', this)">總覽儀表板</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="switchPage('search', this)">歷程與稽核</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="alert('功能開發中')">文件管理</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center text-white">
                    <div class="dropdown">
                        <a class="text-white text-decoration-none dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle fa-lg me-1"></i> 管理員
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#">帳號設定</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#">登出</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 80px; padding-bottom: 50px;">

        <div id="page-dashboard" class="page-section active">
            <h4 class="mb-4 text-secondary">系統概況</h4>
            <div class="row g-4">
                <div class="col-md-3">
                    <div class="app-card text-center">
                        <div class="card-stat-number" id="stat-companies">-</div>
                        <div class="card-stat-label">服務企業數</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="app-card text-center">
                        <div class="card-stat-number" id="stat-records">-</div>
                        <div class="card-stat-label">總執行紀錄</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="app-card text-center">
                        <div class="card-stat-number text-danger">0</div>
                        <div class="card-stat-label">本月逾期</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="app-card text-center">
                        <div class="card-stat-number text-success">100%</div>
                        <div class="card-stat-label">資料合規率</div>
                    </div>
                </div>
            </div>

            <h5 class="mt-5 mb-3 text-secondary">最近更新的紀錄</h5>
            <div id="recentActivityArea">
                <div class="text-center py-5"><div class="spinner-border text-secondary"></div></div>
            </div>
        </div>

        <div id="page-search" class="page-section">
            <div class="search-hero">
                <h3 class="mb-3 fw-light">搜尋稽核軌跡</h3>
                <div class="search-box-wrapper">
                    <i class="fas fa-search text-muted"></i>
                    <input type="text" id="searchInput" class="search-input" placeholder="輸入公司名稱、統編或年度 (Enter 搜尋)...">
                    <button class="btn btn-link text-decoration-none fw-bold" onclick="executeSearch()">GO</button>
                </div>
                <div class="mt-2 text-muted small">支援模糊搜尋：可輸入 "2025 鐵高" 或 "愛味之"</div>
            </div>

            <div class="row justify-content-center">
                <div class="col-lg-9">
                    <div id="searchLoader" class="text-center my-5" style="display:none;">
                        <div class="spinner-border text-primary"></div><p class="mt-2 text-muted">正在檢索資料庫...</p>
                    </div>
                    <div id="searchResults">
                        <div class="text-center text-muted mt-5">
                            <i class="fas fa-folder-open fa-3x mb-3" style="opacity: 0.2;"></i>
                            <p>請輸入關鍵字開始查詢</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="universalModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="fas fa-file-contract me-2"></i>數位卷宗預覽</h5>
                    <div class="ms-auto">
                        <span class="badge bg-danger me-2">Confidential</span>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                <div class="modal-body p-0" oncontextmenu="return false;">
                    <div class="preview-modal-body" id="previewContent">
                        </div>
                </div>
                <div class="modal-footer bg-light justify-content-between">
                    <div class="small text-muted"><i class="fas fa-info-circle me-1"></i>此畫面包含主紀錄表與雲端附件，請向下滑動檢視。</div>
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // --- 初始化 Supabase ---
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 頁面載入初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardStats(); // 載入儀表板數據
            
            // 綁定搜尋框 Enter 事件
            document.getElementById('searchInput').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') executeSearch();
            });
        });

        // --- 頁面切換邏輯 ---
        function switchPage(pageId, navElement) {
            // 隱藏所有頁面
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            // 顯示目標頁面
            document.getElementById(`page-${pageId}`).classList.add('active');
            
            // 更新 Navbar 狀態
            if(navElement) {
                document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
                navElement.classList.add('active');
            }
        }

        // --- 功能 A: 儀表板數據載入 ---
        async function loadDashboardStats() {
            try {
                // 1. 獲取公司總數
                const { count: coCount } = await supabaseClient.from('companies').select('*', { count: 'exact', head: true });
                document.getElementById('stat-companies').innerText = coCount || 0;

                // 2. 獲取紀錄總數
                const { count: recCount, data: recentRecs } = await supabaseClient
                    .from('service_records')
                    .select('*, workplaces(companies(name))', { count: 'exact' })
                    .order('created_at', { ascending: false })
                    .limit(5); // 只取最近 5 筆給儀表板列表用

                document.getElementById('stat-records').innerText = recCount || 0;

                // 3. 渲染「最近活動」列表
                const recentArea = document.getElementById('recentActivityArea');
                if (recentRecs && recentRecs.length > 0) {
                    recentArea.innerHTML = recentRecs.map(rec => generateResultCard(rec)).join('');
                } else {
                    recentArea.innerHTML = '<div class="text-muted text-center">尚無活動紀錄</div>';
                }

            } catch (err) {
                console.error('Dashboard Error:', err);
            }
        }

        // --- 功能 B: 搜尋功能 (核心) ---
        async function executeSearch() {
            const query = document.getElementById('searchInput').value.trim();
            const container = document.getElementById('searchResults');
            const loader = document.getElementById('searchLoader');
            
            container.innerHTML = '';
            loader.style.display = 'block';

            try {
                // 讀取資料庫
                const { data, error } = await supabaseClient
                    .from('service_records')
                    .select('*, workplaces(companies(name, tax_id))')
                    .order('visit_date', { ascending: false })
                    .limit(50); // 限制筆數優化效能

                if(error) throw error;

                // 前端關鍵字過濾
                const filtered = data.filter(r => {
                    if (!query) return true; // 沒輸入顯示全部
                    const searchStr = `${r.workplaces?.companies?.name} ${r.service_year} ${r.visit_date}`.toLowerCase();
                    return searchStr.includes(query.toLowerCase());
                });

                loader.style.display = 'none';

                if (filtered.length === 0) {
                    container.innerHTML = `<div class="alert alert-light text-center border">查無資料</div>`;
                    return;
                }

                // 渲染結果
                container.innerHTML = filtered.map(rec => generateResultCard(rec)).join('');

            } catch (err) {
                loader.style.display = 'none';
                alert('搜尋錯誤: ' + err.message);
            }
        }

        // --- 共用組件: 產生卡片 HTML ---
        // 這是為了讓儀表板和搜尋頁的卡片長得一樣
        function generateResultCard(rec) {
            const companyName = rec.workplaces?.companies?.name || '未知公司';
            const date = rec.visit_date || '未定日期';
            const year = rec.service_year || '----';
            
            // 安全編碼資料以傳遞給 Modal
            const dataStr = encodeURIComponent(JSON.stringify(rec));
            const compStr = encodeURIComponent(companyName);

            return `
                <div class="result-item" onclick="openUniversalPreview('${rec.id}', '${compStr}', '${dataStr}')">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="m-0 text-primary fw-bold">${companyName}</h5>
                        <span class="tag-pill">${year} 年度</span>
                    </div>
                    <div class="text-muted small mb-2"><i class="far fa-calendar-alt me-1"></i>訪視日期：${date}</div>
                    <div class="text-secondary text-truncate" style="max-width: 90%;">${rec.hazard_desc || '尚無危害描述摘要...'}</div>
                    <div class="mt-2 text-end">
                        <small class="text-muted">點擊查看完整卷宗 <i class="fas fa-chevron-right ms-1"></i></small>
                    </div>
                </div>
            `;
        }

        // --- 功能 C: 全局預覽 (視覺合併) ---
        async function openUniversalPreview(recordId, compNameEnc, dataEnc) {
            const companyName = decodeURIComponent(compNameEnc);
            const recordData = JSON.parse(decodeURIComponent(dataEnc));
            const container = document.getElementById('previewContent');
            
            // 1. 初始化 Modal 狀態
            container.innerHTML = `<div class="text-white text-center mt-5"><div class="spinner-border"></div><p class="mt-2">正在調閱雲端卷宗...</p></div>`;
            const modal = new bootstrap.Modal(document.getElementById('universalModal'));
            modal.show();

            // 2. 異步抓取附件
            let attachmentsHtml = '';
            try {
                const storagePath = `service_records/${recordData.service_year}/${recordId}/`;
                const { data: fileList } = await supabaseClient.storage.from('documents').list(storagePath);

                if (fileList && fileList.length > 0) {
                    // 產生 Signed URL
                    const filesWithUrl = await Promise.all(fileList.map(async (f) => {
                        const { data } = await supabaseClient.storage.from('documents').createSignedUrl(`${storagePath}${f.name}`, 3600);
                        return { name: f.name, url: data.signedUrl };
                    }));

                    attachmentsHtml = filesWithUrl.map(f => {
                        if (f.name.match(/\.(jpg|jpeg|png)$/i)) {
                            return `<div class="mb-3"><div class="badge bg-secondary mb-1">附件照片</div><img src="${f.url}" class="evidence-img"></div>`;
                        } else if (f.name.match(/\.pdf$/i)) {
                            return `<div class="mb-3"><div class="badge bg-danger mb-1">PDF 文件</div><iframe src="${f.url}#toolbar=0" style="width:100%; height:500px; border:1px solid #ccc;"></iframe></div>`;
                        }
                        return '';
                    }).join('');
                } else {
                    attachmentsHtml = `<div class="alert alert-light border text-center text-muted">本案件尚未歸檔任何佐證附件。</div>`;
                }

            } catch (e) {
                console.error("附件讀取失敗", e);
                attachmentsHtml = `<div class="text-danger">附件讀取異常</div>`;
            }

            // 3. 組合 HTML (Paper Sheet 模擬)
            const htmlContent = `
                <div class="paper-sheet">
                    <div class="watermark">${companyName}</div>
                    <h3 class="text-center fw-bold border-bottom pb-3 mb-4">勞工健康服務執行紀錄表</h3>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-6"><label class="text-muted small">事業單位</label><div class="fw-bold">${companyName}</div></div>
                        <div class="col-md-6"><label class="text-muted small">訪視日期</label><div class="fw-bold">${recordData.visit_date}</div></div>
                    </div>

                    <div class="bg-light p-3 rounded border mb-4">
                        <h6 class="fw-bold text-dark"><i class="fas fa-exclamation-triangle me-2"></i>危害辨識與描述</h6>
                        <p class="mb-0 text-secondary">${recordData.hazard_desc || '無紀錄'}</p>
                    </div>

                    <div class="mb-4">
                        <h6 class="fw-bold text-dark"><i class="fas fa-clipboard-check me-2"></i>執行項目摘要</h6>
                        <ul class="list-group list-group-flush small">
                            <li class="list-group-item bg-transparent">1. 作業環境現場訪視與危害辨識</li>
                            <li class="list-group-item bg-transparent">2. 勞工健康檢查結果分析與評估</li>
                            <li class="list-group-item bg-transparent">3. 協助雇主選配勞工從事適當工作</li>
                        </ul>
                    </div>
                </div>

                <div class="paper-sheet">
                    <div class="watermark">Evidence</div>
                    <h4 class="border-start border-4 border-primary ps-3 mb-4">稽核佐證附件</h4>
                    ${attachmentsHtml}
                </div>
            `;

            container.innerHTML = htmlContent;
        }
    </script>
</body>
</html>
