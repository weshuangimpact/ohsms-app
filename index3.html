<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OHSMS 歷史軌跡搜尋</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* =========================================
           基本版面設定
           ========================================= */
        html, body { height: 100%; }
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f8f9fa;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }
        .container, .main-content { flex: 1; }

        /* 頁首/頁尾 */
        .navbar {
            background-color: #202124 !important;
            min-height: 85px;
            color: #fff;
            flex-shrink: 0;
        }
        footer {
            background-color: #202124 !important;
            color: #fff;
            flex-shrink: 0;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px 0;
            min-height: 85px;
            margin-top: auto;
        }

        /* 搜尋頁專用樣式 */
        .instruction-box {
            background-color: #fff;
            border-left: 5px solid #198754;
            padding: 20px 25px;
            border-radius: 4px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .instruction-title { color: #198754; font-weight: 700; margin-bottom: 10px; }
        
        .search-container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
            padding: 40px 20px;
        }
        .google-logo {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 30px;
            letter-spacing: -2px;
            color: #444;
            font-family: 'Product Sans', Arial, sans-serif;
        }
        .google-logo span { display: inline-block; }
        .g-blue { color: #4285F4; }
        .g-red { color: #EA4335; }
        .g-yellow { color: #FBBC05; }
        .g-green { color: #34A853; }

        .search-card {
            background: white;
            padding: 30px;
            border-radius: 24px;
            box-shadow: 0 4px 6px rgba(32,33,36,0.28);
            transition: all 0.3s;
        }
        .search-card:hover { box-shadow: 0 4px 12px rgba(32,33,36,0.38); }
        
        /* 詳情頁 (Detail View) 專用樣式 */
        .detail-header {
            background-color: #fff;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 20px;
        }
        .detail-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        .info-group { margin-bottom: 25px; }
        .info-label {
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #5f6368;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .info-value {
            font-size: 1.1rem;
            color: #202124;
            line-height: 1.6;
        }
        .attachment-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }
        .attachment-item {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-left: 4px solid #0d6efd;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }
        .attachment-item:hover { background-color: #e2e6ea; }
        .attachment-link {
            text-decoration: none;
            color: #0d6efd;
            font-weight: 600;
            flex: 1;
        }
        .audit-note-box {
            background-color: #fff3cd;
            border: 1px solid #ffecb5;
            padding: 15px;
            border-radius: 6px;
            color: #664d03;
        }

        /* 隱藏/顯示控制 */
        .page-section { display: none; }
        .active-section { display: block; }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark px-4">
        <div class="container-fluid d-flex justify-content-between align-items-center p-0">
            <a class="navbar-brand d-flex align-items-center fw-bold" href="dashboard.html">
                <i class="fas fa-shield-alt me-2"></i>
                OHSMS 職安管理系統
            </a>
            <div class="d-flex align-items-center">
                <span class="text-white me-3 small" id="header-date"><i class="fas fa-spinner fa-spin"></i></span>
                <span class="text-white me-4 small border-start ps-3 border-secondary" id="header-clock" style="opacity: 0.9;">--:--</span>
                <span class="text-white me-4 fw-bold" id="header-user">Hi! 使用者</span>
                <button id="closeTabBtn" class="btn btn-warning btn-sm me-2" style="display:none;" onclick="window.close()">
                    <i class="fas fa-times me-1"></i>關閉分頁
                </button>
                <a id="backBtn" class="btn btn-outline-light btn-sm me-2" href="dashboard.html">
                    <i class="fas fa-reply me-1"></i>回到儀表板
                </a>
                <button class="btn btn-outline-light btn-sm" onclick="logoutSystem()"><i class="fas fa-sign-out-alt me-1"></i>登出</button>
            </div>
        </div>
    </nav>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <div class="fw-bold text-dark" id="loadingText">正在處理...</div>
    </div>

    <div id="searchPage" class="container main-content mt-4 page-section">
        
        <div class="mb-4">
            <h2 class="fw-bold text-dark mb-1">歷史軌跡搜尋 (Check)</h2>
            <p class="text-secondary">Check 階段：服務數據查核與完整性驗證</p>
        </div>
        
        <div class="instruction-box">
            <div class="instruction-title">
                <i class="fas fa-search-location me-2"></i>PDCA 設計理念：Check (查核)
            </div>
            <p class="mb-0 text-dark">
                本模組支援多維度交叉檢索，允許管理者針對「時間軸」、「服務對象」與「執行者」進行動態篩選。點擊結果可開啟全頁檢視證據與原始檔案。
            </p>
        </div>

        <div class="search-container">
            <div class="google-logo">
                <span class="g-blue">W</span><span class="g-red">e</span><span class="g-yellow">s</span><span class="g-blue">m</span><span class="g-green">a</span><span class="g-red">r</span><span class="g-blue">t</span><span class="g-green">A</span><span class="g-red">I</span>
            </div>

            <div class="search-card">
                <form id="searchForm" onsubmit="event.preventDefault(); performSearch();">
                    <div class="row g-2 align-items-center">
                        <div class="col-md-3">
                            <div class="form-floating">
                                <input type="number" class="form-control" id="searchYear" placeholder="2026" min="2020" max="2050">
                                <label for="searchYear"><i class="far fa-calendar-alt me-1"></i>年度 (西元)</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="searchCompany" placeholder="公司名稱或統編">
                                <label for="searchCompany"><i class="fas fa-building me-1"></i>公司名稱 / 統編</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="searchConsultant" placeholder="顧問姓名">
                                <label for="searchConsultant"><i class="fas fa-user-md me-1"></i>顧問姓名</label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 d-flex justify-content-center gap-3">
                        <button type="submit" class="btn btn-primary px-4 py-2">
                            <i class="fas fa-search me-1"></i> 搜尋軌跡
                        </button>
                        <button type="button" class="btn btn-light border px-4 py-2" onclick="resetSearch()">
                            清除條件
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="resultArea" class="mt-5 mb-5" style="display: none;">
            <h5 class="fw-bold border-bottom pb-2 mb-3">
                <i class="fas fa-list-ul me-2"></i>搜尋結果 
                <span class="badge bg-secondary ms-2" id="resultCount">0 筆</span>
            </h5>
            <div class="table-responsive bg-white rounded shadow-sm p-3">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr class="table-light">
                            <th>#</th>
                            <th>服務日期</th>
                            <th>年度</th>
                            <th>企業名稱</th>
                            <th>統一編號</th>
                            <th>負責顧問</th>
                            <th class="text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody"></tbody>
                </table>
            </div>
        </div>

        <div id="noDataMessage" class="text-center mt-5 text-muted" style="display: none;">
            <i class="fas fa-inbox fa-3x mb-3 opacity-25"></i>
            <p>找不到符合條件的服務軌跡。</p>
        </div>
    </div>

    <div id="detailPage" class="container mt-4 page-section" style="max-width: 900px;">
        <div class="detail-header rounded shadow-sm d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold text-dark mb-0"><i class="fas fa-file-contract me-2 text-primary"></i>服務軌跡詳情</h2>
                <div class="text-muted small mt-1">證據保存與執行紀錄 (ID: <span id="detailIdDisplay"></span>)</div>
            </div>
            <a href="index3.html" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>返回搜尋
            </a>
        </div>

        <div class="detail-card">
            <h4 class="border-bottom pb-3 mb-4 text-primary fw-bold">執行細節 (5W1H)</h4>
            
            <div class="row">
                <div class="col-md-6 info-group">
                    <div class="info-label"><i class="fas fa-user-tag me-1"></i>Who (執行者/對象)</div>
                    <div class="info-value" id="detailWho">--</div>
                </div>
                <div class="col-md-6 info-group">
                    <div class="info-label"><i class="far fa-clock me-1"></i>When (時間)</div>
                    <div class="info-value" id="detailWhen">--</div>
                </div>
                <div class="col-md-12 info-group">
                    <div class="info-label"><i class="fas fa-map-marker-alt me-1"></i>Where (地點/公司)</div>
                    <div class="info-value" id="detailWhere">--</div>
                </div>
                
                <div class="col-md-12 info-group">
                    <div class="info-label"><i class="fas fa-tasks me-1"></i>What (執行項目)</div>
                    <div class="info-value bg-light p-3 rounded" id="detailWhat">--</div>
                    
                    <div class="mt-3">
                        <div class="info-label text-secondary"><i class="fas fa-paperclip me-1"></i>相關附件證據 (Attachments)</div>
                        <ul class="attachment-list" id="detailAttachments">
                            <li class="text-muted small">讀取中...</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="info-group mt-2">
                <div class="info-label text-danger"><i class="fas fa-clipboard-check me-1"></i>Audit Note (稽核備註)</div>
                <div class="audit-note-box" id="detailNote">
                    無備註
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="mb-1">可信智慧整合有限公司 42917004</div>
        <div class="small opacity-75">WesmartAI , Making Trust Transparent.</div>
    </footer>

    <script>
        // 1. Supabase 初始化
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 2. 系統初始化 (路由判斷)
        document.addEventListener('DOMContentLoaded', function() {
            initClock();
            
            // 檢查 URL 是否有 ?id=xxx
            const urlParams = new URLSearchParams(window.location.search);
            const evidenceId = urlParams.get('id');

            if (evidenceId) {
                // 有 ID -> 進入詳情模式
                showSection('detailPage');
                document.getElementById('backBtn').style.display = 'none'; // 隱藏一般返回
                document.getElementById('closeTabBtn').style.display = 'inline-block'; // 顯示關閉分頁
                loadDetailData(evidenceId);
            } else {
                // 無 ID -> 進入搜尋模式
                showSection('searchPage');
            }
        });

        function showSection(sectionId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active-section'));
            document.getElementById(sectionId).classList.add('active-section');
        }

        // ==========================================
        // 3. 搜尋功能 (Search)
        // ==========================================
        async function performSearch() {
            const year = document.getElementById('searchYear').value.trim();
            const company = document.getElementById('searchCompany').value.trim().toLowerCase();
            const consultant = document.getElementById('searchConsultant').value.trim().toLowerCase();
            
            toggleLoading(true, '搜尋中...');
            
            try {
                let query = supabaseClient
                    .from('evidence')
                    .select(`
                        id, visit_date, service_year,
                        workplaces!inner ( companies!inner (name, tax_id) ),
                        medical_staff (name)
                    `)
                    .order('visit_date', { ascending: false });

                if(year) query = query.eq('service_year', year);
                
                const { data, error } = await query;
                if(error) throw error;

                // 前端過濾
                let results = data.filter(item => {
                    const cName = item.workplaces?.companies?.name || '';
                    const cTax = item.workplaces?.companies?.tax_id || '';
                    const sName = item.medical_staff?.name || '';
                    
                    const matchComp = !company || cName.toLowerCase().includes(company) || cTax.includes(company);
                    const matchCons = !consultant || sName.toLowerCase().includes(consultant);
                    return matchComp && matchCons;
                });

                renderTable(results);
            } catch (err) {
                console.error(err);
                alert('搜尋發生錯誤');
            } finally {
                toggleLoading(false);
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('resultBody');
            const resultArea = document.getElementById('resultArea');
            const noData = document.getElementById('noDataMessage');
            
            tbody.innerHTML = '';
            document.getElementById('resultCount').textContent = data.length + ' 筆';

            if(data.length === 0) {
                resultArea.style.display = 'none';
                noData.style.display = 'block';
                return;
            }

            resultArea.style.display = 'block';
            noData.style.display = 'none';

            data.forEach((item, idx) => {
                const comp = item.workplaces?.companies?.name || '未知';
                const tax = item.workplaces?.companies?.tax_id || '-';
                const staff = item.medical_staff?.name || '未指派';
                
                // [修正] 按鈕改為開啟新分頁 (Open Full Page)
                // 這裡我們直接開啟 index3.html?id=xxx
                const viewUrl = `index3.html?id=${item.id}`;

                const row = `
                    <tr>
                        <td>${idx+1}</td>
                        <td>${item.visit_date || '-'}</td>
                        <td>${item.service_year}</td>
                        <td class="fw-bold text-primary">${comp}</td>
                        <td><span class="badge bg-light text-dark border">${tax}</span></td>
                        <td>${staff}</td>
                        <td class="text-center">
                            <a href="${viewUrl}" target="_blank" class="btn btn-sm btn-outline-info" title="開啟全頁詳情">
                                <i class="fas fa-external-link-alt me-1"></i>檢視
                            </a>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // ==========================================
        // 4. 詳情功能 (Detail)
        // ==========================================
        async function loadDetailData(id) {
            toggleLoading(true, '載入詳情與證據...');
            try {
                // 4-1. 抓取基本資料
                const { data, error } = await supabaseClient
                    .from('evidence')
                    .select(`
                        *,
                        workplaces ( companies (name, address) ),
                        medical_staff (name)
                    `)
                    .eq('id', id)
                    .single();

                if(error) throw error;

                // 渲染 5W1H
                document.getElementById('detailIdDisplay').textContent = data.id;
                const staff = data.medical_staff?.name || '未指派';
                const comp = data.workplaces?.companies?.name || '未知企業';
                const address = data.workplaces?.companies?.address || '';
                const timeStr = `${data.start_time || '--:--'} ~ ${data.end_time || '--:--'}`;

                document.getElementById('detailWho').innerHTML = `<strong class="text-primary">${staff}</strong> (顧問) <i class="fas fa-caret-right mx-2"></i> ${comp}`;
                document.getElementById('detailWhen').textContent = `${data.visit_date} (${timeStr}) | 年度: ${data.service_year}`;
                document.getElementById('detailWhere').innerHTML = `${comp} <span class="text-muted small ms-2">(${address})</span>`;
                document.getElementById('detailWhat').textContent = data.execution_items || '無執行項目紀錄';
                
                const noteEl = document.getElementById('detailNote');
                if(data.audit_note) {
                    noteEl.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${data.audit_note}`;
                } else {
                    noteEl.innerHTML = '<span class="text-success"><i class="fas fa-check-circle me-1"></i>本次服務無特殊稽核異常</span>';
                }

                // 4-2. 附件檔案列表邏輯 (修正版)
                const attachListEl = document.getElementById('detailAttachments');
                attachListEl.innerHTML = ''; // 清空

                if(data.attachment_folder_id) {
                    // 路徑規則: Year / FolderID
                    const folderPath = `${data.service_year}/${data.attachment_folder_id}`;
                    
                    // 列出所有檔案
                    const { data: files, error: listError } = await supabaseClient
                        .storage.from('evidence').list(folderPath);

                    if(!listError && files && files.length > 0) {
                        // 針對每個檔案產生 Signed URL
                        for(const file of files) {
                            if(file.name === '.emptyFolderPlaceholder') continue; // 忽略佔位檔

                            const fullPath = `${folderPath}/${file.name}`;
                            const { data: signedData } = await supabaseClient
                                .storage.from('evidence').createSignedUrl(fullPath, 3600); // 1小時

                            if(signedData?.signedUrl) {
                                // 判斷圖示
                                let icon = 'fa-file-alt';
                                if(file.name.endsWith('.pdf')) icon = 'fa-file-pdf text-danger';
                                else if(file.name.match(/\.(jpg|png|jpeg)$/i)) icon = 'fa-file-image text-primary';

                                const li = document.createElement('li');
                                li.className = 'attachment-item';
                                li.innerHTML = `
                                    <i class="fas ${icon} fa-lg me-3"></i>
                                    <a href="${signedData.signedUrl}" target="_blank" class="attachment-link text-truncate">
                                        ${file.name}
                                    </a>
                                    <span class="text-muted small ms-3">${(file.metadata?.size / 1024).toFixed(1)} KB</span>
                                    <a href="${signedData.signedUrl}" target="_blank" class="btn btn-sm btn-outline-secondary ms-3">
                                        <i class="fas fa-download"></i>
                                    </a>
                                `;
                                attachListEl.appendChild(li);
                            }
                        }
                    } else {
                        attachListEl.innerHTML = '<li class="text-muted ms-2">此資料夾內無檔案</li>';
                    }
                } else {
                    attachListEl.innerHTML = '<li class="text-muted ms-2">未指定附件資料夾 (Folder ID Null)</li>';
                }

            } catch (err) {
                console.error(err);
                alert('讀取詳情失敗');
            } finally {
                toggleLoading(false);
            }
        }

        // ==========================================
        // 5. 工具函式
        // ==========================================
        function resetSearch() {
            document.getElementById('searchForm').reset();
            document.getElementById('resultArea').style.display = 'none';
            document.getElementById('noDataMessage').style.display = 'none';
        }

        function toggleLoading(show, text = '處理中...') {
            const el = document.getElementById('loadingOverlay');
            document.getElementById('loadingText').textContent = text;
            el.style.display = show ? 'flex' : 'none';
        }

        function logoutSystem() {
            if(confirm('確定要登出？')) {
                sessionStorage.clear();
                window.location.href = 'login.html';
            }
        }

        function initClock() {
            setInterval(() => {
                document.getElementById('header-clock').textContent = 
                    new Date().toLocaleTimeString('zh-TW', { hour12: false });
            }, 1000);
            
            const now = new Date();
            const days = ['日', '一', '二', '三', '四', '五', '六'];
            document.getElementById('header-date').innerHTML = 
                `<i class="far fa-calendar-alt me-1"></i>今日是 ${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}(${days[now.getDay()]})`;
            
            const u = sessionStorage.getItem('currentUserName');
            if(u) document.getElementById('header-user').innerText = `Hi! ${u}`;
        }
    </script>
</body>
</html>
