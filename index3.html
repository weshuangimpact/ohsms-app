<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>評鑑支援 AI 智慧助理 (Evaluation) | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary-bg: #f4f6f9;
        }
        body {
            background-color: var(--primary-bg);
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            display: block; 
        }

        /* PDCA 說明字卡樣式 */
        .demo-info-card {
            background-color: #fffbeb;
            border-left: 4px solid #f59e0b;
            color: #92400e;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0.375rem;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        /* 搜尋框樣式 */
        .search-input-group {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .search-input-group input {
            border: none;
            padding: 1.25rem;
            font-size: 1rem;
        }
        .search-input-group input:focus {
            box-shadow: inset 0 0 0 2px #3b82f6;
        }

        /* 人員列表樣式 */
        .consultant-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s;
            background: white;
        }
        .consultant-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }

        /* 動畫 */
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 文件列表樣式 */
        .file-item {
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
        }
        .file-item:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
            transform: translateX(5px);
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3 mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="dashboard.html"><i class="fas fa-shield-alt me-2"></i>OHSMS</a>
            <div class="d-flex align-items-center">
                <span class="text-light me-3" id="user-display"></span>
                <a href="dashboard.html" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left me-1"></i> 返回儀表板</a>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-dark"><i class="fas fa-magnifying-glass-chart me-2 text-primary"></i>評鑑支援 AI 智慧助理</h2>
                <p class="text-muted mb-0">Evaluation 階段：智慧稽核、資格勾稽與佐證調閱</p>
            </div>
        </div>

        <div class="demo-info-card">
            <i class="fas fa-database me-2"></i>
            <strong>系統連線狀態：已連接 Supabase 資料庫 (支援參數疊加搜尋)</strong><br>
            搜尋邏輯：輸入 "台灣 2024" 將會搜尋同時符合 "台灣" 與 "2024" 的案件資料。<br>
            搜尋範圍：公司名稱、年度、案號、顧問姓名。
        </div>

        <div id="search-view" class="py-4">
            <div class="row justify-content-center">
                <div class="col-lg-8 text-center mb-5">
                    <div class="bg-primary bg-opacity-10 d-inline-block rounded-circle p-4 mb-4">
                        <i class="fas fa-robot fa-4x text-primary"></i>
                    </div>
                    <h3 class="fw-bold text-dark mb-3">評鑑資料查詢助手</h3>
                    <p class="text-muted mb-4">請輸入關鍵字（可空格隔開多個條件），或從下方快速索引。</p>

                    <div class="search-input-group d-flex mb-3">
                        <span class="input-group-text bg-white border-0 ps-3"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" id="search-input" class="form-control" 
                               value="" 
                               placeholder="例如：鐵高 2024 (支援多關鍵字)">
                        <button class="btn btn-primary px-4 fw-bold" onclick="performSearch('Keyword', '')">
                            查詢調閱
                        </button>
                    </div>
                </div>
            </div>

            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white py-3 border-bottom">
                            <h6 class="mb-0 fw-bold text-dark"><i class="fas fa-user-tie me-2 text-success"></i>認可顧問/醫護人員 快速索引</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                
                                <div class="list-group-item p-4 consultant-card border-bottom">
                                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-light rounded-circle p-3 me-3 text-center" style="width: 60px; height: 60px;">
                                                <i class="fas fa-user-md fa-lg text-secondary"></i>
                                            </div>
                                            <div>
                                                <h5 class="fw-bold mb-1">陳國華 <span class="badge bg-success bg-opacity-10 text-success ms-1" style="font-size: 0.7rem;">勞工健康服務醫師</span></h5>
                                                <small class="text-muted d-block">認可證號：職醫字第 112005 號</small>
                                            </div>
                                        </div>
                                        <button class="btn btn-outline-primary btn-sm" onclick="performSearch('Person', '陳國華')">
                                            <i class="fas fa-folder-open me-2"></i>調閱服務案件
                                        </button>
                                    </div>
                                </div>

                                <div class="list-group-item p-4 consultant-card border-bottom">
                                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-light rounded-circle p-3 me-3 text-center" style="width: 60px; height: 60px;">
                                                <i class="fas fa-user-nurse fa-lg text-secondary"></i>
                                            </div>
                                            <div>
                                                <h5 class="fw-bold mb-1">林美秀 <span class="badge bg-info bg-opacity-10 text-info ms-1" style="font-size: 0.7rem;">勞工健康服務護理人員</span></h5>
                                                <small class="text-muted d-block">認可證號：台南護字第 008899 號</small>
                                            </div>
                                        </div>
                                        <button class="btn btn-outline-primary btn-sm" onclick="performSearch('Person', '林美秀')">
                                            <i class="fas fa-folder-open me-2"></i>調閱服務案件
                                        </button>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="report-view" class="fade-in-up" style="display: none;">
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <button onclick="resetSearch()" class="btn btn-link text-decoration-none text-secondary ps-0">
                    <i class="fas fa-arrow-left me-2"></i>返回查詢頁面
                </button>
                <span class="badge bg-success bg-opacity-10 text-success border border-success px-3 py-2 rounded-pill">
                    <i class="fas fa-check-circle me-1"></i> 資料庫查詢完成
                </span>
            </div>

            <div class="card border-0 shadow-lg overflow-hidden">
                <div class="card-header bg-light border-bottom p-4 d-flex justify-content-between align-items-start">
                    <div>
                        <h4 class="fw-bold text-dark mb-1" id="report-title">案件資料查詢結果</h4>
                        <small class="text-muted">資料來源：Supabase Cloud | 查詢時間：<span id="report-date"></span></small>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm bg-white" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>列印
                    </button>
                </div>

                <div class="card-body p-4 p-lg-5">
                    <div id="report-content"></div>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="pdfModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content h-100">
                <div class="modal-header bg-dark text-white py-2">
                    <h6 class="modal-title" id="pdfModalTitle">文件預覽</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light d-flex align-items-center justify-content-center" style="min-height: 500px;">
                    <div class="text-center text-muted">
                        <i class="far fa-file-pdf fa-5x mb-3"></i>
                        <h5>PDF 文件預覽區</h5>
                        <p id="pdfFileName">filename.pdf</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // === 1. 初始化 Supabase 設定 ===
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
        let supabase = null;
        try {
            if (window.supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
        } catch (e) {
            console.warn("Supabase SDK init failed:", e);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const userName = sessionStorage.getItem('currentUserName') || '管理員';
            document.getElementById('user-display').innerHTML = `<small>User: ${userName}</small>`;
            document.getElementById('report-date').textContent = new Date().toLocaleDateString('zh-TW');
        });

        // === 2. 核心搜尋邏輯 (支援關鍵字疊加) ===
        async function performSearch(type, presetKeyword) {
            const btn = document.querySelector('#search-view button');
            const originalText = btn.innerHTML;
            const searchInput = document.getElementById('search-input').value;
            
            // 決定最終使用的關鍵字串
            const finalKeyword = (type === 'Person') ? presetKeyword : searchInput;

            if (!finalKeyword.trim()) {
                alert("請輸入查詢關鍵字");
                return;
            }

            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>資料庫檢索中...';
            
            try {
                // 模擬網路延遲
                await new Promise(r => setTimeout(r, 500));

                let dbData = [];
                let error = null;

                if (supabase) {
                    // === Supabase 參數疊加搜尋邏輯 ===
                    let query = supabase.from('cases').select('*');

                    // 1. 將輸入字串拆解為單詞 (Space-separated)
                    const tokens = finalKeyword.trim().split(/\s+/);

                    // 2. 對每個單詞加一層 Filter (AND 邏輯)
                    // 只要該單詞出現在任一指定欄位中，即算符合該單詞的條件
                    tokens.forEach(token => {
                        // 建構 OR 語句：檢查 company_name 或 year 或 case_no 或 consultant_name 是否包含 token
                        // 注意：這裡假設 DB 欄位都是 text 類型，若 year 是 int，ilike 可能會報錯，建議 DB 端 year 設為 text 或使用 cast
                        const orFilter = `company_name.ilike.%${token}%,year.ilike.%${token}%,case_no.ilike.%${token}%,consultant_name.ilike.%${token}%`;
                        query = query.or(orFilter);
                    });

                    // 執行查詢
                    const response = await query;
                    dbData = response.data;
                    error = response.error;
                }

                // 切換介面
                document.getElementById('search-view').style.display = 'none';
                document.getElementById('report-view').style.display = 'block';
                btn.innerHTML = originalText;

                const contentDiv = document.getElementById('report-content');
                const title = document.getElementById('report-title');
                
                title.textContent = `查詢結果：${finalKeyword}`;

                // 若 Supabase 報錯或無資料，顯示 Fallback Mock 資料 (防止 Demo 白畫面)
                if (error || !dbData || dbData.length === 0) {
                    console.warn("查無資料或 DB 連線錯誤，使用 Mock Data", error);
                    renderMockData(contentDiv, finalKeyword);
                } else {
                    // === 渲染真實 DB 資料 ===
                    const resultHtml = dbData.map(item => `
                        <div class="card mb-3 shadow-sm border-start border-4 border-primary">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title fw-bold text-dark mb-1">${item.company_name || '未命名公司'}</h5>
                                        <div class="text-muted small">
                                            <span class="me-3"><i class="far fa-calendar me-1"></i>${item.year || '---'} 年度</span>
                                            <span class="me-3"><i class="fas fa-hashtag me-1"></i>案號：${item.case_no || '---'}</span>
                                            <span><i class="fas fa-user-tie me-1"></i>顧問：${item.consultant_name || '---'}</span>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-success bg-opacity-10 text-success mb-2">${item.status || '正常'}</span>
                                        <br>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="alert('開啟案件詳情: ${item.case_no}')">查看詳情</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');

                    contentDiv.innerHTML = `
                        <div class="alert alert-info border-info d-flex align-items-center mb-4">
                            <i class="fas fa-check-circle me-3 fs-4"></i>
                            <div>
                                <strong>檢索成功：</strong> 共找到 ${dbData.length} 筆符合條件 "${finalKeyword}" 的資料。
                            </div>
                        </div>
                        <h5 class="fw-bold text-dark mb-3">案件列表</h5>
                        ${resultHtml}
                    `;
                }

            } catch (err) {
                console.error("Critical Error:", err);
                alert("系統發生錯誤，請檢查 Console");
                btn.innerHTML = originalText;
            }
        }

        // 備用：渲染模擬資料 (當 DB 沒連上或沒資料時顯示)
        function renderMockData(container, keyword) {
            let mockHtml = '';
            // 簡單的本地過濾模擬
            const mocks = [
                { company: '鐵高工業股份有限公司', year: '2024', caseNo: '113001', consultant: '張志明', status: '服務中' },
                { company: '台灣積體電路', year: '2024', caseNo: '113005', consultant: '陳國華', status: '服務中' },
                { company: 'ABC 精密機械', year: '2025', caseNo: '114001', consultant: '林美秀', status: '規劃中' }
            ];

            // 本地過濾邏輯 (模擬 Supabase 的 AND 疊加)
            const tokens = keyword.trim().split(/\s+/);
            const filtered = mocks.filter(m => {
                const searchStr = `${m.company} ${m.year} ${m.caseNo} ${m.consultant}`.toLowerCase();
                return tokens.every(token => searchStr.includes(token.toLowerCase()));
            });

            if (filtered.length > 0) {
                mockHtml = filtered.map(m => generateCaseCard(m.company, m.year, m.caseNo, m.status)).join('');
            } else {
                 mockHtml = `<div class="alert alert-warning">查無符合 "${keyword}" 的資料 (Mock DB)。請確認 Supabase 'cases' 表格已建立且有資料。</div>`;
            }

            container.innerHTML = `
                <div class="alert alert-warning border-warning d-flex align-items-center mb-4">
                    <i class="fas fa-exclamation-triangle me-3 fs-4"></i>
                    <div>
                        <strong>注意：</strong> 目前顯示為備用資料 (Supabase 回傳空值或錯誤)。<br>
                        請確認資料庫 Table 'cases' 是否存在，且欄位包含: company_name, year, case_no, consultant_name。
                    </div>
                </div>
                ${mockHtml}
            `;
        }

        function generateCaseCard(companyName, year, caseId, status) {
            return `
                <div class="card mb-3 shadow-sm border-start border-4 border-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title fw-bold text-dark mb-1">${companyName}</h5>
                                <div class="text-muted small">
                                    <span class="me-3"><i class="far fa-calendar me-1"></i>${year} 年度</span>
                                    <span><i class="fas fa-hashtag me-1"></i>案號：${caseId}</span>
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-success bg-opacity-10 text-success mb-2">${status}</span>
                                <br>
                                <button class="btn btn-sm btn-outline-secondary">查看詳情</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function resetSearch() {
            document.getElementById('report-view').style.display = 'none';
            document.getElementById('search-view').style.display = 'block';
            document.getElementById('search-input').value = '';
        }

        function openPdfModal(filename) {
            document.getElementById('pdfFileName').textContent = filename;
            new bootstrap.Modal(document.getElementById('pdfModal')).show();
        }
    </script>
</body>
</html>
