<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>評鑑支援 AI 智慧助理 (Evaluation) | OHSMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root { --primary-bg: #f4f6f9; }
        body { background-color: var(--primary-bg); font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; display: block; }
        
        /* 樣式優化 */
        .demo-info-card { background-color: #fffbeb; border-left: 4px solid #f59e0b; color: #92400e; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.375rem; font-size: 0.9rem; }
        .search-input-group { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 0.5rem; overflow: hidden; }
        .search-input-group input { border: none; padding: 1.25rem; font-size: 1rem; }
        .consultant-card { border: 1px solid #e2e8f0; border-radius: 8px; transition: all 0.3s; background: white; }
        .consultant-card:hover { border-color: #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); transform: translateY(-2px); }
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3 mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="#"><i class="fas fa-shield-alt me-2"></i>OHSMS</a>
            <div class="d-flex align-items-center">
                <span class="text-light me-3" id="user-display"></span>
                <button class="btn btn-outline-light btn-sm"><i class="fas fa-sign-out-alt me-1"></i> 登出</button>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-dark"><i class="fas fa-magnifying-glass-chart me-2 text-primary"></i>評鑑支援 AI 智慧助理</h2>
                <p class="text-muted mb-0">Evaluation 階段：連結 Service Records 與 Storage 附件庫</p>
            </div>
        </div>

        <div class="demo-info-card">
            <i class="fas fa-database me-2"></i>
            <strong>資料庫連線：Service_Records (Joined) + Storage</strong><br>
            搜尋範圍：同時檢索「公司名稱(Companies)」、「顧問姓名(Medical_Staff)」、「年度」、「案號」。<br>
            附件功能：自動生成 Supabase Storage 下載連結 (Bucket: service_documents)。
        </div>

        <div id="search-view" class="py-4">
            <div class="row justify-content-center">
                <div class="col-lg-8 text-center mb-5">
                    <div class="bg-primary bg-opacity-10 d-inline-block rounded-circle p-4 mb-4">
                        <i class="fas fa-robot fa-4x text-primary"></i>
                    </div>
                    <h3 class="fw-bold text-dark mb-3">評鑑資料查詢助手</h3>
                    
                    <div class="search-input-group d-flex mb-3">
                        <span class="input-group-text bg-white border-0 ps-3"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" id="search-input" class="form-control" 
                               placeholder="請輸入：公司名、年度或顧問 (如：鐵高 2024)">
                        <button class="btn btn-primary px-4 fw-bold" onclick="performSearch('Keyword', '')">
                            查詢調閱
                        </button>
                    </div>
                </div>
            </div>

            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white py-3 border-bottom">
                            <h6 class="mb-0 fw-bold text-dark"><i class="fas fa-user-tie me-2 text-success"></i>認可顧問快速索引</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                <div class="list-group-item p-4 consultant-card border-bottom">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-light rounded-circle p-3 me-3"><i class="fas fa-user-md fa-lg text-secondary"></i></div>
                                            <div><h5 class="fw-bold mb-1">陳國華</h5><small class="text-muted">職醫字第 112005 號</small></div>
                                        </div>
                                        <button class="btn btn-outline-primary btn-sm" onclick="performSearch('Person', '陳國華')">調閱案件</button>
                                    </div>
                                </div>
                                <div class="list-group-item p-4 consultant-card">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-light rounded-circle p-3 me-3"><i class="fas fa-user-nurse fa-lg text-secondary"></i></div>
                                            <div><h5 class="fw-bold mb-1">林美秀</h5><small class="text-muted">台南護字第 008899 號</small></div>
                                        </div>
                                        <button class="btn btn-outline-primary btn-sm" onclick="performSearch('Person', '林美秀')">調閱案件</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="report-view" class="fade-in-up" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <button onclick="resetSearch()" class="btn btn-link text-decoration-none text-secondary ps-0">
                    <i class="fas fa-arrow-left me-2"></i>返回查詢
                </button>
                <span class="badge bg-primary px-3 py-2 rounded-pill">Supabase DB Connected</span>
            </div>
            
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-light border-bottom p-4">
                    <h4 class="fw-bold text-dark mb-1" id="report-title">查詢結果</h4>
                    <small class="text-muted">資料表：service_records (Joined companies, medical_staff)</small>
                </div>
                <div class="card-body p-4">
                    <div id="report-content"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 1. 初始化 Supabase
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
        let supabase = null;
        
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch (e) { console.error("Supabase Init Error", e); }

        document.getElementById('user-display').innerHTML = `<small>User: 管理員</small>`;

        // 2. 搜尋核心函式
        async function performSearch(type, presetKeyword) {
            const btn = document.querySelector('button.btn-primary');
            const originalText = btn.innerHTML;
            const searchInput = document.getElementById('search-input').value;
            const finalKeyword = (type === 'Person') ? presetKeyword : searchInput;
            const keywords = finalKeyword.trim().toLowerCase().split(/\s+/); // 拆分關鍵字

            if (!finalKeyword) { alert("請輸入關鍵字"); return; }
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>資料讀取中...';

            try {
                // A. 從 service_records 抓取資料 (包含關聯資料表)
                // 假設關聯名稱為 companies 與 medical_staff (依據您的 CSV 結構推測)
                let { data: records, error } = await supabase
                    .from('service_records')
                    .select(`
                        *,
                        companies (name, tax_id),
                        medical_staff (name)
                    `)
                    .limit(100); // 限制筆數優化效能

                if (error) throw error;

                // B. 前端過濾 (Client-side Filtering) - 實現精準的參數疊加
                // 這樣可以確保同時檢查 "公司名(關聯表)" 和 "年份(主表)"
                const filteredRecords = records.filter(record => {
                    // 組合所有可搜尋的欄位字串
                    const companyName = record.companies?.name || '';
                    const staffName = record.medical_staff?.name || '';
                    const year = record.year || '';
                    const caseNo = record.case_no || '';
                    const searchStr = `${companyName} ${staffName} ${year} ${caseNo}`.toLowerCase();

                    // 檢查是否所有關鍵字都存在於該筆資料中
                    return keywords.every(k => searchStr.includes(k));
                });

                // C. 渲染結果
                renderResults(filteredRecords, finalKeyword);

            } catch (err) {
                console.error(err);
                // Fallback: 如果資料庫尚未建好，使用 Mock 資料展示 UI
                renderResults([], finalKeyword, true); 
            } finally {
                btn.innerHTML = originalText;
                document.getElementById('search-view').style.display = 'none';
                document.getElementById('report-view').style.display = 'block';
            }
        }

        // 3. 渲染列表與 Storage 連結
        function renderResults(data, keyword, isMock = false) {
            const container = document.getElementById('report-content');
            document.getElementById('report-title').textContent = `查詢結果：${keyword}`;

            if (isMock || data.length === 0) {
                if(isMock) container.innerHTML = `<div class="alert alert-warning">資料庫連線異常或 Table 不存在，請檢查 Supabase 設定。</div>`;
                else container.innerHTML = `<div class="alert alert-info">查無符合 "${keyword}" 的案件資料。</div>`;
                
                // 僅測試用 Mock (當 DB 空時顯示，讓您看到 UI)
                if(isMock) {
                    data = [{
                        companies: { name: '鐵高工業 (Mock)' },
                        year: '2024',
                        case_no: 'MOCK-001',
                        medical_staff: { name: '測試顧問' },
                        file_path: 'demo.pdf' // 測試檔案路徑
                    }];
                } else {
                    return;
                }
            }

            const html = data.map(item => {
                // 處理公司名稱與顧問 (處理關聯表可能的空值)
                const compName = item.companies?.name || '未知公司';
                const staffName = item.medical_staff?.name || '未指派';
                const fileUrl = getStorageUrl(item.file_path); // 獲取附件連結

                return `
                    <div class="card mb-3 border-start border-4 border-primary shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="fw-bold text-dark mb-1">${compName}</h5>
                                    <div class="text-muted small mt-2">
                                        <span class="me-3"><i class="far fa-calendar me-1"></i>${item.year} 年度</span>
                                        <span class="me-3"><i class="fas fa-hashtag me-1"></i>${item.case_no}</span>
                                        <span class="badge bg-secondary bg-opacity-10 text-secondary border">${staffName}</span>
                                    </div>
                                </div>
                                <div class="text-end">
                                    ${fileUrl ? 
                                        `<a href="${fileUrl}" target="_blank" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-paperclip me-1"></i>下載附件
                                         </a>` : 
                                        `<button class="btn btn-outline-secondary btn-sm" disabled>無附件</button>`
                                    }
                                    <button class="btn btn-sm btn-link text-decoration-none" onclick="alert('詳細資料 ID: ${item.id}')">詳情</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<p class="text-muted mb-3">共找到 ${data.length} 筆資料</p>` + html;
        }

        // 4. Supabase Storage URL 產生器
        function getStorageUrl(path) {
            if (!path) return null;
            // 假設 Bucket 名稱為 'service_documents'，請依實際建立名稱修改
            // 若檔案是 Public Bucket，使用 getPublicUrl
            const { data } = supabase.storage.from('service_documents').getPublicUrl(path);
            return data.publicUrl;
        }

        function resetSearch() {
            document.getElementById('report-view').style.display = 'none';
            document.getElementById('search-view').style.display = 'block';
            document.getElementById('search-input').value = '';
        }
    </script>
</body>
</html>
