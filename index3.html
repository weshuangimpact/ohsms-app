<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>OHSMS | 服務軌跡管理 (index3)</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  
  <style>
    /* 自定義樣式 - 維持原有 UI 風格 */
    .content-wrapper { background-color: #f4f6f9; }
    .card-primary:not(.card-outline) > .card-header { background-color: #007bff; }
    .table td, .table th { vertical-align: middle; }
  </style>
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">

  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="#" class="nav-link">首頁</a>
      </li>
    </ul>
  </nav>

  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="#" class="brand-link">
      <span class="brand-text font-weight-light">OHSMS 系統</span>
    </a>
    <div class="sidebar">
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
          <li class="nav-item">
            <a href="#" class="nav-link active">
              <i class="nav-icon fas fa-file-medical-alt"></i>
              <p>服務軌跡管理</p>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </aside>

  <div class="content-wrapper">
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0">服務軌跡列表</h1>
          </div>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="container-fluid">
        <div class="card">
          <div class="card-header border-0">
            <h3 class="card-title">最新服務紀錄</h3>
            <div class="card-tools">
              <a href="#" class="btn btn-tool btn-sm"><i class="fas fa-download"></i></a>
              <a href="#" class="btn btn-tool btn-sm"><i class="fas fa-bars"></i></a>
            </div>
          </div>
          <div class="card-body table-responsive p-0">
            <table class="table table-striped table-valign-middle">
              <thead>
              <tr>
                <th>日期</th>
                <th>客戶名稱</th>
                <th>執行項目</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
              </thead>
              <tbody id="serviceTableBody">
                </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="main-footer">
    <strong>Copyright &copy; 2026 <a href="#">OHSMS</a>.</strong> All rights reserved.
  </footer>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.1/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>

<script>
  // 模擬後端資料 (包含佐證資料與核定紀錄)
  const serviceData = [
    {
      id: 1,
      date: "2026-01-01",
      client: "創思數位科技工作室",
      consultant: "可信顧問",
      location: "創思數位科技工作室",
      item: "無執行項目紀錄",
      status: '<span class="badge badge-success">已核定</span>',
      evidenceFile: "https://via.placeholder.com/800x1100.png?text=Evidence+Preview+Document", // 模擬證據圖片/PDF URL
      appendices: "Q_17699633025.pdf",
      reviewerLogs: [
        { reviewer: "系統紀錄", action: "自動歸檔", time: "2026-01-01 10:00" },
        { reviewer: "Admin", action: "確認無誤", time: "2026-01-02 09:30" }
      ]
    },
    {
      id: 2,
      date: "2026-01-15",
      client: "爆彈汽水有限公司",
      consultant: "資深顧問 A",
      location: "線上會議",
      item: "年度風險評估",
      status: '<span class="badge badge-warning">審核中</span>',
      evidenceFile: "https://via.placeholder.com/800x1100.png?text=Risk+Assessment+Report",
      appendices: "Risk_Report_v1.pdf",
      reviewerLogs: []
    }
  ];

  // 初始化表格
  $(document).ready(function() {
    const tableBody = $('#serviceTableBody');
    serviceData.forEach(item => {
      const row = `
        <tr>
          <td>${item.date}</td>
          <td>${item.client}</td>
          <td>${item.item}</td>
          <td>${item.status}</td>
          <td>
            <a href="#" class="text-primary" onclick="openEvidenceTab(${item.id})">
              <i class="fas fa-search"></i> 檢視詳情
            </a>
          </td>
        </tr>
      `;
      tableBody.append(row);
    });
  });

  /**
   * 核心功能：開啟新分頁顯示詳情與證據
   * Layout: 左側 (25%) 5W1H + 紀錄, 右側 (75%) 證據預覽
   */
  function openEvidenceTab(id) {
    const data = serviceData.find(d => d.id === id);
    if (!data) return;

    // 構建核定紀錄 HTML
    let logsHtml = '';
    if (data.reviewerLogs && data.reviewerLogs.length > 0) {
      data.reviewerLogs.forEach(log => {
        logsHtml += `
          <div class="log-item">
            <div class="log-header"><strong><i class="fas fa-user-check"></i> ${log.reviewer}</strong> <span class="text-muted" style="float:right; font-size:0.85em;">${log.time}</span></div>
            <div class="log-body">${log.action}</div>
          </div>
        `;
      });
    } else {
      logsHtml = '<p class="text-muted">尚無核定紀錄</p>';
    }

    // 構建新分頁的 HTML 內容
    const pageContent = `
      <!DOCTYPE html>
      <html lang="zh-TW">
      <head>
        <meta charset="utf-8">
        <title>服務軌跡詳情與證據預覽 - ${data.client}</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
        <style>
          body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Source Sans Pro', sans-serif; background: #f4f6f9; }
          .main-container { display: flex; height: 100vh; width: 100%; }
          
          /* 左側 25% - 詳情區 */
          .details-panel { 
            width: 25%; 
            height: 100%; 
            background: #fff; 
            border-right: 1px solid #dee2e6; 
            display: flex; 
            flex-direction: column;
            z-index: 10;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
          }
          .details-header { padding: 15px; background: #007bff; color: white; border-bottom: 1px solid #006fe6; }
          .details-content { flex: 1; padding: 20px; overflow-y: auto; }
          
          /* 右側 75% - 證據預覽區 */
          .evidence-panel { 
            width: 75%; 
            height: 100%; 
            background: #525659; /* 深色背景適合閱讀文件 */
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
          }
          
          /* 預覽 iframe/image 樣式 */
          .evidence-frame { width: 100%; height: 100%; border: none; }
          
          /* 細節項目樣式 */
          .info-group { margin-bottom: 20px; }
          .info-label { font-weight: bold; color: #495057; display: block; margin-bottom: 5px; }
          .info-value { color: #212529; background: #f8f9fa; padding: 8px 12px; border-radius: 4px; border: 1px solid #efefef; }
          .log-item { background: #fdfdfd; border-left: 3px solid #17a2b8; padding: 10px; margin-bottom: 10px; border-radius: 2px; border: 1px solid #eee; border-left-width: 3px; }
          
          /* 模擬標籤 */
          .section-title { 
            font-size: 1.1em; 
            font-weight: bold; 
            border-bottom: 2px solid #007bff; 
            padding-bottom: 5px; 
            margin-top: 20px; 
            margin-bottom: 15px; 
            color: #007bff;
          }
        </style>
      </head>
      <body>
        <div class="main-container">
          <div class="details-panel">
            <div class="details-header">
              <h5 class="m-0"><i class="fas fa-info-circle"></i> 服務軌跡詳情</h5>
            </div>
            <div class="details-content">
              <div class="info-group">
                <span class="info-label text-primary">Who (執行者/對象)</span>
                <div class="info-value">${data.consultant} / ${data.client}</div>
              </div>
              <div class="info-group">
                <span class="info-label text-primary">When (時間)</span>
                <div class="info-value">${data.date}</div>
              </div>
              <div class="info-group">
                <span class="info-label text-primary">Where (地點)</span>
                <div class="info-value">${data.location}</div>
              </div>
              <div class="info-group">
                <span class="info-label text-primary">What (執行項目)</span>
                <div class="info-value">${data.item}</div>
              </div>
              
              <div class="info-group">
                <span class="info-label text-primary">其他佐證資料 (Appendices)</span>
                <div class="info-value">
                  <a href="#" target="_blank"><i class="fas fa-paperclip"></i> ${data.appendices}</a>
                </div>
              </div>

              <div class="section-title">管理者核定紀錄</div>
              <div class="logs-container">
                ${logsHtml}
              </div>
            </div>
          </div>

          <div class="evidence-panel">
            <iframe src="${data.evidenceFile}" class="evidence-frame" title="Evidence Preview"></iframe>
          </div>
        </div>
      </body>
      </html>
    `;

    // 開啟新分頁並寫入內容
    const newWindow = window.open('', '_blank');
    if (newWindow) {
      newWindow.document.write(pageContent);
      newWindow.document.close(); // 確保瀏覽器完成渲染
    } else {
      alert('請允許開啟彈出式視窗以檢視詳情。');
    }
  }
</script>
</body>
</html>
