<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OHSMS 歷史軌跡搜尋</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { display: flex; flex-direction: column; background-color: #f8f9fa; font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; }
        .navbar { background-color: #202124 !important; min-height: 60px; color: #fff; padding: 0 20px; flex-shrink: 0; }
        
        /* 搜尋頁模式樣式 */
        .search-container { max-width: 800px; margin: 0 auto; text-align: center; padding: 40px 20px; }
        .google-logo { font-size: 3rem; font-weight: bold; margin-bottom: 30px; letter-spacing: -2px; color: #444; }
        .search-card { background: white; padding: 30px; border-radius: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* 詳情分欄模式樣式 (1/3 vs 2/3) */
        #detailPage { flex: 1; display: none; flex-direction: row; height: 100%; }
        .detail-left { width: 33.33%; background: #fff; border-right: 1px solid #dee2e6; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; }
        .detail-right { width: 66.67%; background: #e9ecef; position: relative; }
        
        .info-group { margin-bottom: 20px; }
        .info-label { font-size: 0.85rem; font-weight: 700; color: #5f6368; margin-bottom: 6px; }
        .info-value { font-size: 1rem; color: #202124; line-height: 1.5; }
        
        .attachment-section { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 15px; }
        .attachment-list { list-style: none; padding: 0; margin: 0; }
        .attachment-item { padding: 8px 0; border-bottom: 1px solid #eee; }
        .attachment-item:last-child { border-bottom: none; }
        .attachment-link { text-decoration: none; color: #0d6efd; font-weight: 500; display: block; }
        .attachment-link:hover { text-decoration: underline; }

        #pdfFrame { width: 100%; height: 100%; border: none; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid d-flex justify-content-between p-0">
            <a class="navbar-brand fw-bold" href="dashboard.html"><i class="fas fa-shield-alt me-2"></i>OHSMS</a>
            <div class="d-flex align-items-center text-white">
                <span id="header-clock" class="me-4">--:--</span>
                <span id="header-user" class="me-4">使用者</span>
                <button id="closeTabBtn" class="btn btn-warning btn-sm me-2" style="display:none;" onclick="window.close()">關閉分頁</button>
                <a id="backBtn" class="btn btn-outline-light btn-sm" href="index3.html">重設搜尋</a>
            </div>
        </div>
    </nav>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary me-3"></div>
        <div class="fw-bold">檔案與資料讀取中...</div>
    </div>

    <div id="searchPage" class="container mt-4" style="overflow-y:auto;">
        <div class="search-container">
            <div class="google-logo">WesmartAI</div>
            <div class="search-card">
                <form onsubmit="event.preventDefault(); performSearch();">
                    <div class="row g-2">
                        <div class="col-md-3"><div class="form-floating"><input type="number" class="form-control" id="searchYear" placeholder="2026"><label>年度</label></div></div>
                        <div class="col-md-6"><div class="form-floating"><input type="text" class="form-control" id="searchCompany" placeholder="公司"><label>公司名稱/統編</label></div></div>
                        <div class="col-md-3"><div class="form-floating"><input type="text" class="form-control" id="searchConsultant" placeholder="顧問"><label>顧問姓名</label></div></div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-4 px-5">搜尋</button>
                </form>
            </div>
        </div>
        <div id="resultArea" class="container mt-4" style="display:none; max-width:1000px;">
            <table class="table table-hover bg-white rounded shadow-sm">
                <thead class="table-light"><tr><th>日期</th><th>年度</th><th>企業名稱</th><th>顧問</th><th class="text-center">操作</th></tr></thead>
                <tbody id="resultBody"></tbody>
            </table>
        </div>
    </div>

    <div id="detailPage">
        <div class="detail-left">
            <h4 class="fw-bold mb-4 border-bottom pb-2 text-primary">服務詳情與原始附件</h4>
            <div class="info-group"><div class="info-label">Who</div><div class="info-value" id="detailWho">--</div></div>
            <div class="info-group"><div class="info-label">When</div><div class="info-value" id="detailWhen">--</div></div>
            <div class="info-group"><div class="info-label">What</div><div class="info-value bg-light p-2 rounded" id="detailWhat">--</div></div>

            <div class="info-group">
                <div class="info-label text-primary"><i class="fas fa-paperclip me-1"></i>原始佐證附件 (Q卷/A卷/補充資料)</div>
                <div class="attachment-section">
                    <ul class="attachment-list" id="detailAttachments">
                        <li class="text-muted small">無原始附件</li>
                    </ul>
                </div>
            </div>

            <div class="info-group mt-auto"><div class="info-label text-danger">Audit Note</div><div id="detailNote" class="audit-note-box">--</div></div>
        </div>

        <div class="detail-right">
            <div id="pdfPlaceholder" class="text-muted text-center p-5 mt-5">
                <i class="fas fa-file-pdf fa-3x mb-3"></i><br>正在搜尋主報告 (Evidence_Final)...
            </div>
            <iframe id="pdfFrame" style="display:none;"></iframe>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://yhehfucgemxnfrdvpdhw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_52emtU-9l-SDxcJTWVTPTA_Yu6qEogh';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        document.addEventListener('DOMContentLoaded', () => {
            const id = new URLSearchParams(window.location.search).get('id');
            if (id) {
                document.getElementById('searchPage').style.display = 'none';
                document.getElementById('detailPage').style.display = 'flex';
                document.getElementById('backBtn').style.display = 'none';
                document.getElementById('closeTabBtn').style.display = 'inline-block';
                loadDetailData(id);
            }
            setInterval(() => { document.getElementById('header-clock').textContent = new Date().toLocaleTimeString(); }, 1000);
        });

        async function performSearch() {
            const year = document.getElementById('searchYear').value;
            toggleLoading(true);
            const { data } = await supabaseClient.from('evidence').select('*, workplaces!inner(companies!inner(name, tax_id)), medical_staff(name)');
            const tbody = document.getElementById('resultBody');
            tbody.innerHTML = '';
            data.filter(i => !year || i.service_year == year).forEach(i => {
                tbody.innerHTML += `<tr><td>${i.visit_date}</td><td>${i.service_year}</td><td>${i.workplaces.companies.name}</td><td>${i.medical_staff.name}</td><td class="text-center"><a href="index3.html?id=${i.id}" target="_blank" class="btn btn-sm btn-outline-primary">檢視</a></td></tr>`;
            });
            document.getElementById('resultArea').style.display = 'block';
            toggleLoading(false);
        }

        async function loadDetailData(id) {
            toggleLoading(true);
            try {
                const { data } = await supabaseClient.from('evidence').select('*, workplaces(companies(name)), medical_staff(name)').eq('id', id).single();
                
                document.getElementById('detailWho').textContent = `${data.medical_staff.name} / ${data.workplaces.companies.name}`;
                document.getElementById('detailWhen').textContent = `${data.visit_date}`;
                document.getElementById('detailWhat').textContent = data.execution_items || '無內容';
                document.getElementById('detailNote').textContent = data.audit_note || '標準程序審核通過';

                const attachUl = document.getElementById('detailAttachments');
                attachUl.innerHTML = '';

                let rawFiles = data.attachment_files || [];
                let mainReportUrl = null;
                let foundRaw = false;

                for (let f of rawFiles) {
                    const filePath = `${data.service_year}/${f.path}`;
                    const { data: signed } = await supabaseClient.storage.from('evidence').createSignedUrl(filePath, 3600);
                    
                    if (!signed) continue;

                    // [修正邏輯] 排除 Evidence_Final 進入左側列表
                    if (f.name.includes('Evidence_Final')) {
                        mainReportUrl = signed.signedUrl;
                    } else {
                        foundRaw = true;
                        attachUl.innerHTML += `<li class="attachment-item"><a href="${signed.signedUrl}" target="_blank" class="attachment-link"><i class="fas fa-file-alt me-2"></i>${f.name}</a></li>`;
                    }
                }

                if (!foundRaw) attachUl.innerHTML = '<li class="text-muted small">無原始附件 (Q卷/佐證)</li>';

                // [預覽邏輯] 優先顯示 Evidence_Final，若無則找第一個 PDF
                if (mainReportUrl) {
                    showPdf(mainReportUrl);
                } else {
                    const firstPdf = rawFiles.find(f => f.name.endsWith('.pdf'));
                    if (firstPdf) {
                        const { data: fallback } = await supabaseClient.storage.from('evidence').createSignedUrl(`${data.service_year}/${firstPdf.path}`, 3600);
                        showPdf(fallback.signedUrl);
                    } else {
                        document.getElementById('pdfPlaceholder').innerHTML = '<i class="fas fa-exclamation-circle fa-2x"></i><br>找不到可預覽的 PDF 報告';
                    }
                }
            } catch(e) { console.error(e); }
            toggleLoading(false);
        }

        function showPdf(url) {
            const frame = document.getElementById('pdfFrame');
            frame.src = url + "#toolbar=0";
            frame.style.display = 'block';
            document.getElementById('pdfPlaceholder').style.display = 'none';
        }

        function toggleLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
    </script>
</body>
</html>
